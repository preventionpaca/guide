name: Supabase keep-alive

on:
  schedule:
    # Tous les 3 jours (cron GitHub = UTC)
    - cron: "17 3 */3 * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Supabase REST
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
  set -euo pipefail

  # Vérifie que les variables existent (sans afficher la clé)
  echo "SUPABASE_URL length: ${#SUPABASE_URL}"
  echo "SUPABASE_ANON_KEY length: ${#SUPABASE_ANON_KEY}"

  # Nettoyage (au cas où il y a un \r ou un espace final)
  SUPABASE_URL="$(echo -n "$SUPABASE_URL" | tr -d '\r' | xargs)"
  SUPABASE_ANON_KEY="$(echo -n "$SUPABASE_ANON_KEY" | tr -d '\r' | xargs)"

  # Jitter
  JITTER=$((RANDOM % 1200))
  echo "Sleeping ${JITTER}s"
  sleep $JITTER

  # Debug URL (sans fuite de clé)
  echo "Calling: ${SUPABASE_URL}/rest/v1/healthcheck?select=id&limit=1"

  curl -v -sS \
    "${SUPABASE_URL}/rest/v1/healthcheck?select=id&limit=1" \
    -H "apikey: ${SUPABASE_ANON_KEY}" \
    -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
    -H "Accept: application/json"

