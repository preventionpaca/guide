<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Portail prévention PACA – Accès DDFPT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- API Grist (lecture des tuiles) -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <!-- CSS commun + portail -->
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-core.css" />
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-portail.css" />

  <!-- pp-config (auth Supabase + helpers) -->
  <script src="https://preventionpaca.github.io/guide/js/pp-config.js?v=20260128a"></script>

  <style>
    .pp-lock-overlay{position:fixed;inset:0;background:rgba(15,23,42,.9);z-index:9999;display:flex;align-items:center;justify-content:center}
    .pp-lock-modal{background:#0b2238;color:#e5f0ff;border-radius:18px;padding:24px 28px;max-width:420px;width:92%;
      box-shadow:0 20px 45px rgba(0,0,0,.6);border:1px solid #f97316;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    .pp-lock-title{margin:0 0 4px;font-size:1.15rem;font-weight:600}
    .pp-lock-sub{margin:0 0 14px;font-size:.85rem;color:#9ca3af}
    .pp-lock-input{width:100%;border-radius:999px;border:1px solid #374151;padding:10px 14px;margin-bottom:8px;background:#020617;color:#e5f0ff;font-size:.95rem}
    .pp-lock-input:focus{outline:none;border-color:#f97316;box-shadow:0 0 0 1px rgba(249,115,22,.7)}
    .pp-lock-actions{display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-top:8px}
    .pp-lock-btn{border-radius:999px;border:none;padding:8px 18px;font-size:.9rem;cursor:pointer;background:transparent;color:#e5f0ff}
    .pp-lock-btn-primary{background:#f97316;color:#111827;font-weight:700}
    .pp-lock-error{margin:6px 0 0;font-size:.85rem;color:#fecaca;min-height:1.1em;white-space:pre-wrap}
    .pp-lock-attempts{margin-top:4px;font-size:.75rem;color:#9ca3af}
  </style>
</head>

<body>
<div class="page-wrap">
  <div id="header-container"></div>
  <section class="tile-frame"><main id="tileGrid" class="tile-grid"></main></section>
</div>

<div id="ppLockOverlay" class="pp-lock-overlay" aria-modal="true" role="dialog">
  <div class="pp-lock-modal">
    <h2 class="pp-lock-title">Accès réservé</h2>
    <p class="pp-lock-sub">Cette page est réservée aux Directeurs Délégués aux Formations. Merci de saisir le code d’accès.</p>
    <input id="ppLockInput" class="pp-lock-input" type="password" autocomplete="off" placeholder="Code DDFPT (ou Admin)" />
    <div id="ppLockError" class="pp-lock-error"></div>
    <div id="ppLockAttempts" class="pp-lock-attempts"></div>
    <div class="pp-lock-actions">
      <button id="ppLockCancel" class="pp-lock-btn" type="button">Annuler</button>
      <button id="ppLockSubmit" class="pp-lock-btn pp-lock-btn-primary" type="button">Valider</button>
    </div>
  </div>
</div>

<script>
  // IMPORTANT: ce widget sert uniquement à authentifier + afficher des tuiles (lecture)
  const PAGE_NAME = 'Accès DDFPT';
  const MAX_ATTEMPTS = 3;
  let attemptCount = 0, accessGranted = false;

  const PORTAL_ROOT = 'https://preventionpaca.github.io/guide/';
  const HOME_URL = PORTAL_ROOT + '#home';

  function goHome(evt){
    if(evt && evt.preventDefault) evt.preventDefault();
    try{ if(window.parent && window.parent!==window){ window.parent.postMessage({type:'pp:navigate', key:'home'}, '*'); } }catch(e){}
    try{ if(window.top && window.top!==window){ window.top.location.href = HOME_URL; return; } }catch(e){}
    try{ window.location.href = HOME_URL; }catch(e){}
  }

  // ✅ FIX: supporte les 2 formats renvoyés par fetchTable:
  // - Format A: {id:[...], fields:{Col:[...]}}
  // - Format B: colonnes directes {Col:{rowId:val}, id:{rowId:rowId}}
  function rowsToRecordsCompat(table){
    // Format A
    if (table && Array.isArray(table.id) && table.fields && typeof table.fields === 'object') {
      const ids = table.id;
      const fields = table.fields;
      const recs = [];
      for (let i = 0; i < ids.length; i++) {
        const r = { id: ids[i] };
        for (const [k, arr] of Object.entries(fields)) r[k] = arr[i];
        recs.push(r);
      }
      return recs;
    }

    // Format B
    if (table && table.id && typeof table.id === 'object' && !Array.isArray(table.id)) {
      const rowIds = Object.keys(table.id).map(x => Number(x)).filter(n => !Number.isNaN(n));
      const cols = Object.keys(table).filter(k => k !== "manualSort");
      return rowIds.map(rid => {
        const r = {};
        for (const c of cols) {
          const col = table[c];
          r[c] = (col && typeof col === 'object') ? col[rid] : undefined;
        }
        return r;
      });
    }

    // Fallback
    if (Array.isArray(table)) return table;
    return [];
  }

  function normalizeName(v){
    if(!v) return '';
    let s = String(v).trim().toLowerCase();
    try{s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');}catch(e){}
    return s.replace(/[_\s]+/g,' ').replace(/\s+/g,' ').trim();
  }

  function colorToClass(c){
    if(!c) return '';
    const v = String(c).toLowerCase();
    if(v.includes('blanc')) return 'tile--white';
    if(v.includes('vert')) return 'tile--green';
    if(v.includes('orange')) return 'tile--orange';
    if(v.includes('noir')) return 'tile--dark';
    if(v.includes('marron clair')) return 'tile--brown-light';
    if(v.includes('marron fon')) return 'tile--brown-dark';
    if(v.includes('gris')) return 'tile--gray-light';
    return '';
  }

  function buildTiles(blocsRowsAll, layoutRow){
    const grid = document.getElementById('tileGrid');
    grid.innerHTML='';
    const cols = layoutRow && layoutRow.Nbre_colonne ? Number(layoutRow.Nbre_colonne)||4 : 4;
    document.documentElement.style.setProperty('--grid-columns', cols);

    if(!Array.isArray(blocsRowsAll) || blocsRowsAll.length===0){
      const empty=document.createElement('div');
      empty.className='pp-empty';
      empty.innerHTML = `<div style="padding:18px 16px;border:1px dashed rgba(249,115,22,.65);border-radius:14px;background:rgba(2,6,23,.35);color:#e5f0ff;">
        <div style="font-weight:700;margin-bottom:6px">Aucune tuile à afficher</div>
        <div style="opacity:.85;font-size:.92rem;line-height:1.35">
          Le widget est chargé, mais aucun bloc n’a été trouvé pour la page <b>${PAGE_NAME}</b>.<br>
          Vérifiez dans la table <b>Blocs</b> la colonne <b>Page</b> (ex : “Accès DDFPT”).
        </div>
      </div>`;
      grid.appendChild(empty);
      return;
    }

    blocsRowsAll
      .slice().sort((a,b)=>(a.num_bloc||0)-(b.num_bloc||0))
      .forEach(bloc=>{
        const tile=document.createElement('div'); tile.className='tile';
        const cc=colorToClass(bloc.Couleur); if(cc) tile.classList.add(cc);

        const icon=document.createElement('div'); icon.className='tile-icon'; icon.textContent=bloc.Initiale_bloc||'';
        const main=document.createElement('div'); main.className='tile-main';
        const t=document.createElement('div'); t.className='tile-title'; t.textContent=bloc.Titre_bloc||'(sans titre)';
        const d=document.createElement('div'); d.className='tile-desc'; d.textContent=bloc.Sous_titre1||'';
        main.appendChild(t); main.appendChild(d);
        tile.appendChild(icon); tile.appendChild(main);

        const url = (bloc.Url_bloc||'').trim();
        if(url){
          tile.tabIndex=0; tile.setAttribute('role','link');
          tile.addEventListener('click', ()=>{ try{ window.top.location.href=url; }catch(e){ window.location.href=url; } });
          tile.addEventListener('keypress', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); try{ window.top.location.href=url; }catch(err){ window.location.href=url; } } });
        }
        grid.appendChild(tile);
      });
  }

  async function loadFromGrist(){
    const doc = grist.docApi;

    const fetchTable = (name) => (doc && typeof doc.fetchTable === 'function')
      ? doc.fetchTable(name)
      : grist.docApi.fetchTable(name);

    const [tAgenc, tBlocs] = await Promise.all([
      fetchTable('Agencement_portail'),
      fetchTable('Blocs')
    ]);

    const agRows = rowsToRecordsCompat(tAgenc);
    const blocsAll = rowsToRecordsCompat(tBlocs);

    const layoutRow = agRows.find(r=>normalizeName(r.Page)===normalizeName(PAGE_NAME)) || agRows[0] || null;

    const pageAliases = [
      PAGE_NAME,
      "Accès DDFPT",
      "Acces DDFPT",
      "DDFPT"
    ].map(normalizeName);

    const blocsRowsAll = blocsAll.filter(b => pageAliases.includes(normalizeName(b.Page)));
    buildTiles(blocsRowsAll, layoutRow);
  }

  function initLock(){
    const overlay=document.getElementById('ppLockOverlay');
    const input=document.getElementById('ppLockInput');
    const err=document.getElementById('ppLockError');
    const at=document.getElementById('ppLockAttempts');
    const btnOk=document.getElementById('ppLockSubmit');
    const btnCancel=document.getElementById('ppLockCancel');

    function updateAttempts(){
      const rem = MAX_ATTEMPTS - attemptCount;
      at.textContent = (rem<MAX_ATTEMPTS && rem>0) ? ('Tentatives restantes : '+rem) : '';
    }
    function freeze(state){
      btnOk.disabled = state; btnCancel.disabled = state; input.disabled = state;
      btnOk.style.opacity = state ? .65 : 1;
      btnCancel.style.opacity = state ? .65 : 1;
    }
    async function handle(){
      if(accessGranted) return;
      const code = String(input.value||'').trim();
      if(!code){ err.textContent='Merci de saisir un code.'; return; }
      err.textContent='';
      freeze(true);
      try{
        // 1) Auth via pp-config
        let data=null;
        if(window.PP && PP.auth && typeof PP.auth.authWithCode==='function'){
          data = await PP.auth.authWithCode(code);
        }else{
          // fallback direct
          const res = await fetch('https://hpiqwvwpxzppxpxhjede.supabase.co/functions/v1/auth-code', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})
          });
          data = await res.json();
          if(!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
          try{ localStorage.setItem('pp_token', data.token);}catch(e){}
          try{ sessionStorage.setItem('pp_auth', JSON.stringify(data)); }catch(e){}
        }

        // 2) Role check: ddfpt OU admin
        const role = (data && data.role) ? String(data.role) : '';
        if(role !== 'ddfpt' && role !== 'admin'){
          throw new Error("Rôle non autorisé ("+role+").");
        }

        // 3) OK => on ouvre
        accessGranted = true;
        overlay.style.transition='opacity 200ms ease-out';
        overlay.style.opacity='0';
        setTimeout(()=>{ overlay.style.display='none'; }, 220);
        await loadFromGrist();
      }catch(e){
        attemptCount++;
        updateAttempts();
        err.textContent = (e && e.message) ? e.message : 'Erreur de connexion.';
        if(attemptCount>=MAX_ATTEMPTS){
          err.textContent += '\nAccès refusé. Retour au portail…';
          setTimeout(()=>goHome(), 900);
        }else{
          freeze(false);
          input.value='';
          input.focus();
        }
      }
    }

    btnOk.addEventListener('click', handle);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handle(); }});
    btnCancel.addEventListener('click', goHome);

    updateAttempts();
    setTimeout(()=>input.focus(), 50);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    if(window.grist){
      grist.ready();
      initLock();
    }else{
      document.getElementById('ppLockError').textContent = "Grist API indisponible : ouvre ce widget dans Grist.";
    }
  });
</script>

<!-- header commun -->
<script src="https://preventionpaca.github.io/guide/js/pp-header.js?v=20260128a"></script>
</body>
</html>
