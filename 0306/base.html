<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Equipements — DDFPT / DREETS (Supabase SB_*)</title>
<!-- Grist widget API : tag séparé (sinon certains navigateurs ignorent le chargement) -->
<script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<script>
  console.log('[PP-TR] LOADED v15.13-FIX-CURRENTREC-FALLBACK');
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ======================= THEME ======================= */
:root{   
  /* palette sombre (portail prévention PACA) */
  --dark-bg:#041221;
  --dark-bg-soft:#07192a;
  --dark-card:#0b2238;
  --dark-card-soft:#12263f;
  --dark-border:#1f3b63;
  --dark-text:#e5f0ff;
  --dark-muted:#8ea2c8;

  /* palette claire */
  --light-bg:#f3f4f6;
  --light-bg-soft:#e5e7eb;
  --light-card:#ffffff;
  --light-card-soft:#f9fafb;
  --light-border:#cbd5e1;
  --light-text:#111827;
  --light-muted:#6b7280;

  /* couleurs transverses */
  --accent-blue:#1b396a;
  --accent-blue-soft:#2f4b86;
  --accent-green:#16a34a;
  --accent-orange:#ea580c;

  /* DDFPT / DREETS panneaux */
  --ddfpt-border:#60a5fa;
  --ddfpt-bg-soft:rgba(37,99,235,0.08);
  --dreets-border:#22c55e;
  --dreets-bg-soft:rgba(22,163,74,0.09);

  /* Travaux : couleurs fortes + pâles (plus vives) */
  --tr-red:#b91c1c;
  --tr-red-soft:#fde8e8;
  --tr-orange:#c2410c;
  --tr-orange-soft:#ffedd5;
  --tr-green:#15803d;
  --tr-green-soft:#dcfce7;

  --badge-danger:#b91c1c;

  /* Rose fluo DREETS (régime "A compléter par la DREETS") */
  --dreets-pink:#db2777;
  --dreets-pink-soft:#f9a8d4;
}

/* Light / dark variables */
body[data-theme="dark"]{
  --bg:var(--dark-bg);
  --bg-soft:var(--dark-bg-soft);
  --card:var(--dark-card);
  --card-soft:var(--dark-card-soft);
  --border:var(--dark-border);
  --text:var(--dark-text);
  --muted:var(--dark-muted);
  --stripe-default:#9ca3af;
}
body[data-theme="light"]{
  --bg:var(--light-bg);
  --bg-soft:var(--light-bg-soft);
  --card:var(--light-card);
  --card-soft:var(--light-card-soft);
  --border:var(--light-border);
  --text:var(--light-text);
  --muted:var(--light-muted);
  --stripe-default:#6b7280;
}

/* ======================= GLOBAL ======================= */
*{box-sizing:border-box}

html,body{
  margin:0;
  padding:0;

  margin:0;
  height:100%;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  font-size:16px;
}

body{
  background:var(--bg);
  color:var(--text);
}

.wrap{
  padding:8px 10px 18px;
  height:100%;
}

/* disposition générale */
.layout{
  display:grid;
  grid-template-columns:320px minmax(0,1fr);
  gap:12px;
  min-height:82vh;
}

/* bouton thème / petits boutons pill */
.theme-toggle{
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card-soft);
  color:var(--muted);
  cursor:pointer;
}
.theme-toggle:hover{
  background:var(--bg-soft);
  color:var(--text);
}

/* bouton "Mode ajout" actif */
.theme-toggle.add-mode-active{
  border-color:var(--accent-green);
  color:var(--accent-green);
}

/* ======================= PANELS ======================= */

/* Panel de base */
.panel{
  position:relative;
  border-radius:18px;
  border:2px solid var(--border);
  background:var(--card);
  padding:8px 10px 12px;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
}

/* Conteneur des deux panneaux : on autorise le chevauchement */
#rightPane{
  position:relative;
  display:block;
}

/* DDFPT : grand bloc extérieur */
.panel-ddfpt{
  border-color:var(--ddfpt-border);
  background:
    linear-gradient(to bottom, var(--ddfpt-bg-soft), transparent 18%),
    var(--card);
  /* réserve pour le bloc imbriqué qui chevauche */
  margin-bottom:0;
  padding-bottom:14px;
  position:relative;
  z-index:1;  /* Inférieur au z-index:10 du bloc caractéristiques */
}

/* DREETS global (panneau vert du bas) */
.panel-dreets{
  border-color:var(--dreets-border);
  background:
    linear-gradient(to bottom, var(--dreets-bg-soft), transparent 18%),
    var(--card);
  position:relative;
  z-index:5;  /* Inférieur au z-index:10 du bloc caractéristiques */
}

/* variante « chevauchement » : panneau DREETS remonte sous le DDFPT */
.panel-dreets.panel-dreets-overlap{
  /* Positionnement demandé : sous "Caractéristiques", sans chevauchement */
  margin-top:0;
  margin-left:0;
  width:100%;
  /* grid-column: 1 / -1; */
}

/* Encapsulage vertical si réutilisation */
.panel-stack{
  display:flex;
  flex-direction:column;
  gap:0;
}

/* ======================= BARRE DE TITRE PANNEAUX ======================= */
.panel-title-bar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:4px;
}
.panel-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:700;
  font-size:14px;
}
.panel-title span:first-child{
  font-size:13px;
}
/* Bouton "Mode ajout" collé au mot DREETS */
.panel-dreets .panel-title-bar{
  justify-content:flex-start;
}

.panel-actions{
  display:flex;
  align-items:center;
  gap:6px;
  margin-left:8px;
}

/* Bouton Supprimer (pilule rouge arrondie) */
.delete-pill{
  margin-left:8px;
  padding:4px 12px;
  border-radius:999px;
  border:1px solid rgba(248,113,113,.9);
  background:rgba(127,29,29,.3);
  color:#fee2e2;
  font-size:12px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.delete-pill:hover{
  background:rgba(127,29,29,.5);
}
body[data-theme="light"] .delete-pill{
  background:#fee2e2;
  color:#991b1b;
  border-color:#fecaca;
}
.delete-pill span{
  font-weight:600;
}

/* ================== BLOC PHOTO / VGP ================== */
.block-photo-vgp{
  position:relative;
  padding-right:670px;      /* réserve pour le bloc vert caractéristiques élargi */
  overflow:visible;
  margin-bottom:100px;      /* marge augmentée pour que les bordures verticales touchent le DREETS */
}

/* ================== BLOC CARACTÉRISTIQUES (encadré vert – ancienne / nouvelle variante) ================== */
.dreets-overlap-block{
  /* ✅ Position absolute à droite du bloc PHOTO/VGP */
  position:absolute;
  right:0;
  top:0;
  width:650px;  /* Élargi pour couvrir environ la moitié de la zone DDFPT */
  margin:0;
  overflow:visible;
  z-index:10;
  padding-bottom:40px;  /* Prolonge les bordures verticales jusqu'au DREETS */

  border-top:2px solid var(--dreets-border);
  border-left:2px solid var(--dreets-border);
  border-right:2px solid var(--dreets-border);
  border-bottom:0;                 /* pour que le cadre DREETS du dessous "touche" */
  border-radius:14px 14px 0 0;
  background:
    linear-gradient(to bottom, var(--dreets-bg-soft), transparent 22%),
    var(--card);
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

.block.dreets-overlap-block{
  /* ✅ Position absolute à droite du bloc PHOTO/VGP */
  position:absolute;
  right:0;
  top:0;
  width:650px;  /* Élargi pour couvrir environ la moitié de la zone DDFPT */
  margin:0;
  overflow:visible;
  z-index:10;
  padding-bottom:40px;  /* Prolonge les bordures verticales jusqu'au DREETS */

  border-top:2px solid var(--dreets-border);
  border-left:2px solid var(--dreets-border);
  border-right:2px solid var(--dreets-border);
  border-bottom:0;                 /* pour que le cadre DREETS du dessous "touche" */
  border-radius:14px 14px 0 0;
  background:
    linear-gradient(to bottom, var(--dreets-bg-soft), transparent 22%),
    var(--card);
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
}

/* ================== PANEL DREETS (cadre vert du bas) ================== */
.panel-dreets{
  position:relative;
  border:2px solid var(--dreets-border);
  border-top-left-radius:18px;
  border-top-right-radius:0;
  border-bottom-left-radius:18px;
  border-bottom-right-radius:18px;
  margin-top:-2px;
}

/* ======================= COLONNE GAUCHE ======================= */
.left-col{
  display:flex;
  flex-direction:column;
  gap:8px;
}

/* Equipement en cours (sticky) */
.current-equip{
  position:sticky;
  top:4px;
  z-index:30;
  padding:6px 10px 8px;
  border-radius:18px;
  background:radial-gradient(circle at top left,#1e293b, var(--bg-soft));
  border:1px solid rgba(148,163,184,.7);
  color:var(--text);
  box-shadow:0 8px 18px rgba(0,0,0,.35);
}
body[data-theme="light"] .current-equip{
  background:var(--light-card);
  border-color:var(--light-border);
}
.current-equip-label{
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.12em;
  text-align:center;
  color:var(--muted);
  margin-top:2px;
}
.current-equip-name{
  margin-top:2px;
  font-size:17px;
  font-weight:800;
  text-align:center;
  line-height:1.25;
  word-break:break-word;
}

/* blocs entrée / filtre */
.left-block{
  border-radius:14px;
  background:var(--card-soft);
  border:1px solid var(--border);
  padding:8px;
}

/* état désactivé (Nouvel équipement grisé) */
.left-block-disabled{
  opacity:0.45;
}
.left-block-disabled input,
.left-block-disabled button{
  pointer-events:none;
}

/* label Nouvel équipement */
.left-block-title{
  font-size:11px;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--muted);
  margin-bottom:4px;
}

.row{
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
}

/* lignes serrées */
.row-nowrap{
  flex-wrap:nowrap;
}
.row-nowrap .text-input{
  flex:1 1 auto;
  min-width:0;
}

input,textarea,select,button{
  font-family:inherit;
  font-size:14px;
}

/* champs texte */
.text-input{
  flex:1;
  padding:7px 9px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card-soft);
  color:var(--text);
}
.text-input::placeholder{color:var(--muted);font-size:13px}
.text-input:focus{
  outline:none;
  border-color:var(--accent-blue);
  box-shadow:0 0 0 1px rgba(37,99,235,.6);
}

/* petits boutons ronds */
.btn-circle{
  width:26px;
  height:26px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--muted);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.btn-circle:hover{background:var(--bg-soft);color:var(--text)}

/* filtre couleur */
.color-filter-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-top:4px;
  font-size:11px;
  color:var(--muted);
}
.color-badges{
  display:flex;
  gap:6px;
}
.color-dot{
  width:14px;
  height:14px;
  border-radius:999px;
  border:1px solid rgba(15,23,42,.4);
  cursor:pointer;
}
.color-dot[data-col="red"]{background:var(--tr-red)}
.color-dot[data-col="orange"]{background:var(--tr-orange)}
.color-dot[data-col="green"]{background:var(--tr-green)}
.color-dot[data-col="none"]{background:var(--stripe-default)}
.color-dot[data-col="pink"]{background:var(--dreets-pink)}
.color-dot.active{
  box-shadow:0 0 0 2px #e5e7eb,0 0 0 4px rgba(15,23,42,.75);
}

/* compteur nb équipements */
#equip-count{
  margin-top:3px;
  font-size:11px;
  color:var(--muted);
}

/* modes de filtrage */
.filter-modes{
  display:flex;
  gap:6px;
  margin-bottom:4px;
  font-size:11px;
  color:var(--muted);
}
.filter-modes label{
  display:inline-flex;
  align-items:center;
  gap:4px;
  padding:2px 7px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
}
.filter-modes input[type="radio"]{
  margin:0;
  accent-color:var(--accent-blue);
}
.filter-modes label.active{
  background:var(--bg-soft);
  color:var(--text);
  border-color:var(--accent-blue);
}

/* liste d'équipements */
.list-wrap{
  margin-top:4px;
  border-radius:14px;
  background:var(--card-soft);
  border:1px solid var(--border);
  padding:4px 4px 4px 6px;
  flex:1;
  min-height:0;
}
.list{
  display:flex;
  flex-direction:column;
  gap:4px;
  max-height:calc(100vh - 220px);
  overflow:auto;
}

.item{
  position:relative;
  display:flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  border-radius:999px;
  padding:4px 10px 4px 22px;
  background:var(--card);
  border:1px solid rgba(148,163,184,.6);
  font-size:13px;
  line-height:1.2;
}
.item::before{
  content:"";
  position:absolute;
  left:6px;
  top:5px;
  bottom:5px;
  width:8px;
  border-radius:999px;
  background:var(--stripe,var(--stripe-default));
}
.item strong{
  font-weight:600;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.item.selected{
  border-color:var(--accent-blue);
  box-shadow:0 0 0 2px rgba(37,99,235,.55);
}
.item.selected::before{
  box-shadow:0 0 0 1px #ffffff;
}

/* ======================= CONTENU DROIT ======================= */
/* barre de progression (overlay : ne doit jamais faire bouger le layout) */
.progress{
  display:block;
  height:4px;
  border-radius:999px;
  background:var(--bg-soft);
  overflow:hidden;
  margin:0 0 6px;
  position:sticky;
  top:0;
  z-index:50;
  opacity:0;
  transition:opacity .12s ease;
  pointer-events:none;
}
.progress.active{ opacity:1; }
.progress i{
  display:block;
  height:100%;
  width:0;
  background:#0ea5e9;
  transition:width .18s ease;
}

/* blocs internes */
.block{
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--card-soft);
  padding:8px 9px 9px;
  margin-bottom:6px;
}
.block-title{
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:var(--muted);
  margin-bottom:4px;
}

/* bloc "Régime" rose quand "A compléter par la DREETS" */
#regimeBlock.regime-dreets-active{
  background:var(--dreets-pink-soft);
  border-color:var(--dreets-pink);
  box-shadow:0 0 0 1px rgba(219,39,119,.4);
}

/* champs du formulaire */
.input-pill{
  width:100%;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}
.input-pill:focus{
  outline:none;
  border-color:var(--accent-blue);
  box-shadow:0 0 0 1px rgba(37,99,235,.5);
}
textarea.input-area{
  border-radius:12px;
  min-height:70px;
  resize:vertical;
}

/* bouton texte générique */
.btn{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  cursor:pointer;
  font-size:13px;
}
.btn:hover{background:var(--bg-soft)}
.btn-small{
  padding:4px 8px;
  font-size:12px;
}

/* bouton destructif (historique – conservé si utilisé ailleurs) */
.btn-danger{
  border-color:transparent;
  color:#fee2e2;
  background:transparent;
}
.btn-danger:hover{background:#991b1b}
body[data-theme="light"] .btn-danger{
  background:transparent;
  color:#111827;
  border-color:transparent;
}
body[data-theme="light"] .btn-danger:hover{
  background:transparent;
  color:#fee2e2;
}
body[data-theme="dark"] .btn-danger{
  background:transparent;
  color:#fee2e2;
  border-color:transparent;
}
body[data-theme="dark"] .btn-danger:hover{
  background:transparent;
}

/* bouton accent orange (Voir diplômes) */
.btn-pill-orange{
  background:var(--accent-orange);
  border-color:transparent;
  color:#ffffff;
  font-weight:600;
  padding:6px 14px;
}

/* ======================= PHOTO / VGP / DOC & DOMAINES ======================= */
.photo-row{
  display:grid;
  grid-template-columns:180px minmax(0,1.8fr);
  gap:10px;
  align-items:flex-start;
}

.photo-box{
  width:100%;
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--card);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  cursor:pointer;
}
.photo-box.disabled{cursor:not-allowed;opacity:.6}
.photo-box img{max-width:100%;max-height:220px;display:block}

/* colonne de texte à droite de la photo, limitée pour ne pas passer sous le bloc vert */
.photo-side{
  display:flex;
  flex-direction:column;
  gap:6px;
  max-width:360px;
}

/* Lien "Choisir un fichier…" */
.file-trigger{
  font-size:13px;
  cursor:pointer;
  text-decoration:none;
  font-weight:500;
}
body[data-theme="light"] .file-trigger{color:#1b396a;}
body[data-theme="dark"] .file-trigger{color:#93c5fd;}
.file-trigger:hover{
  font-weight:700;
  text-decoration:underline;
}
.file-name-pill{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--muted);
  font-size:13px;
  min-height:32px;
  display:flex;
  align-items:center;
  max-width:360px; 
}
.file-name-pill span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* VGP raccourci pour rester à gauche du bloc vert */
#vgp{
  width:100%;
  max-width:360px;
  padding:6px 9px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
}

/* URL doc bureau + bouton ouvrir */
.doc-row{
  display:flex;
  align-items:center;
  gap:8px;
}
.doc-row input{
  flex:1;
  max-width:360px;
}

/* Domaines / secteur */
.domains-col{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.domains-title{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:var(--muted);
}
.domains-lines{
  font-size:13px;
  line-height:1.3;
}
.domains-lines span{
  display:inline-block;
  margin-right:10px;
}

/* ======================= NATURAL TEXT ZONES ======================= */
.natural-multi,
.natural-line{
  font-size:13px;
  margin-top:2px;
  white-space:pre-wrap;
  word-break:break-word;
}
.natural-multi span{
  display:inline-block;
  margin-right:4px;
}
.chip-remove{
  margin-left:6px;
  cursor:pointer;
  font-weight:700;
}

/* ========= NATURE DES TRAVAUX + SECTEUR / DOMAINES ========= */
.trav-sect-grid{
  display:grid;
  grid-template-columns:minmax(0,1.25fr) minmax(0,1fr);
  gap:10px;
  align-items:flex-start;
}
.trav-sect-grid .trav-col,
.trav-sect-grid .sectdom-col{
  display:flex;
  flex-direction:column;
  gap:4px;
}

/* ======================= REGIME BADGE ======================= */
.regime-badge{
  margin-left:auto;
  padding:4px 10px;
  border-radius:999px;
  font-size:14px;
  font-weight:700;
  border:2px solid transparent;
  background:#6b7280;
  color:#f9fafb;
}

/* Token de régime positionné au-dessus du champ "Equipement ou produit" */
.equip-lib-wrapper{
  position:relative;
}
.regime-on-lib{
  position:absolute;
  top:0;
  right:12px;
  transform:translateY(18%);
  z-index:5;
}

/* ======================= TRAVAUX RÉGLEMENTÉS ======================= */
.trav-buttons{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:4px;
}
.trav-list{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.tr-chip{
  position:relative;
  padding:5px 24px 5px 10px;
  border-radius:999px;
  font-size:13px;
  line-height:1.3;
  background:var(--tr-orange-soft);
  border:2px solid var(--tr-orange);
  color:#7c2d12;
}
.tr-chip[data-kind="red"]{
  background:var(--tr-red-soft);
  border-color:var(--tr-red);
  color:#7f1d1d;
}
.tr-chip[data-kind="green"]{
  background:var(--tr-green-soft);
  border-color:var(--tr-green);
  color:#064e3b;
}
.tr-chip-close{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
}

/* Grille du bloc "Caractéristiques du produit / agent chimique" */
.dreets-product-grid{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.dreets-field{
  display:flex;
  align-items:center;
  gap:6px;
}
.dreets-field label{
  flex:0 0 130px;
  margin:0;
  font-size:12px;
}
.dreets-field .input-pill{
  flex:1 1 auto;
}

/* ======================= LIGHTBOX IMAGE ======================= */
#lightbox{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:60;
}
#lightbox[aria-hidden="false"]{display:flex}
#lightbox img{
  max-width:90vw;
  max-height:90vh;
  border-radius:12px;
  box-shadow:0 25px 50px rgba(0,0,0,.6);
}
#lightbox .close{
  position:absolute;
  top:14px;
  right:20px;
  font-size:22px;
  cursor:pointer;
  color:#e5e7eb;
}

/* ======================= LIGHTBOX DIPLOMES ======================= */
#dlgDiplomes{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:55;
}
#dlgDiplomes[aria-hidden="false"]{display:flex}
.modal-inner{
  background:var(--light-card);
  color:#111827;
  border-radius:14px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
  width:90%;
  max-width:880px;
  max-height:80vh;
  display:flex;
  flex-direction:column;
}
.modal-header,
.modal-footer{
  padding:8px 14px;
  border-bottom:1px solid #e5e7eb;
}
.modal-footer{
  border-top:1px solid #e5e7eb;
  border-bottom:none;
  display:flex;
  justify-content:flex-end;
  gap:8px;
}
.modal-body{
  padding:8px 14px;
  overflow:auto;
}
.modal-title{font-weight:700;font-size:14px}
.modal-close{
  border:none;
  background:transparent;
  font-size:18px;
  cursor:pointer;
}
#dlg-di-list{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.dlg-row{
  display:flex;
  align-items:flex-start;
  gap:6px;
  font-size:13px;
}
.dlg-row label{flex:1;cursor:pointer}

/* ======================= LIGHTBOX TRAVAUX ======================= */
#dlgTravaux{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999999;
}
#dlgTravaux[aria-hidden="false"]{display:flex}
.trav-modal{
  background:#f8fafc;
  color:#111827;
  border-radius:12px;
  box-shadow:0 20px 50px rgba(15,23,42,.7);
  display:flex;
  flex-direction:column;
}
.trav-header,
.trav-footer{
  padding:8px 12px;
  border-bottom:1px solid #e5e7eb;
}
.trav-footer{
  border-top:1px solid #e5e7eb;
  border-bottom:none;
  display:flex;
  justify-content:flex-end;
  gap:8px;
}
.trav-body{
  padding:8px 12px 10px;
  overflow:auto;
}
.trav-table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
.trav-table th,
.trav-table td{
  border:1px solid #e5e7eb;
  padding:4px 6px;
  vertical-align:top;
}
.trav-table th{
  position:sticky;
  top:0;
  background:linear-gradient(90deg,#1B396A,#3F72AF);
  color:#ffffff;
  z-index:2;
  font-size:12px;
}
.trav-col-travaux{width:22%}

      .trav-col-fiche{width:9%; background:#ffffff;}
      .trav-col-fiche a{color:#1b396a; font-weight:800; text-decoration:underline;}

.trav-col-red{
  width:26%;
  background:var(--tr-red-soft);
  color:#7f1d1d;
  border-color:var(--tr-red);
}
.trav-col-orange{
  width:26%;
  background:var(--tr-orange-soft);
  color:#7c2d12;
  border-color:var(--tr-orange);
}
.trav-col-green{
  width:26%;
  background:var(--tr-green-soft);
  color:#064e3b;
  border-color:var(--tr-green);
}
.trav-col-red[data-empty="true"]{background:#fee2e2}
.trav-col-orange[data-empty="true"]{background:#ffedd5}
.trav-col-green[data-empty="true"]{background:#dcfce7}
.trav-cell-inner{
  position:relative;
  padding-left:22px;
}
.trav-cell-inner input[type="checkbox"]{
  position:absolute;
  left:2px;
  top:2px;
}

/* liens articles */
.link-like{
  color:#1b396a;
  text-decoration:underline;
  font-weight:800;
}
.link-like:visited{color:#1b396a}
.link-like:hover{
  font-weight:800;
  text-decoration-thickness:2px;
}

/* ======================= STATUS PHOTO ======================= */
.status{font-size:12px;margin-top:3px;color:var(--muted)}
.status.ok{color:var(--accent-green)}
.status.err{color:#b91c1c}

/* ======================= MISC ======================= */
.muted{color:var(--muted);font-size:12px}
.full-width-area{width:100%;}


/* ===== PATCH: désactiver les lightbox de codes (remplacées par saisie inline via prompt) ===== */
#dlgAddMode,#dlgAddModeDreets,#dlgAdminMode{display:none !important;pointer-events:none !important;}
/* ======================= LIGHTBOX MODE AJOUT DDFPT ======================= */
#dlgAddMode{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.75);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:56;
}
#dlgAddMode[aria-hidden="false"]{display:flex}
.addmode-inner{
  background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  color:#111827;
  border-radius:20px;
  box-shadow:0 25px 50px -12px rgba(0,0,0,.45), 0 0 0 1px rgba(0,0,0,.05);
  width:90%;
  max-width:440px;
  padding:24px 24px 20px;
  display:flex;
  flex-direction:column;
  gap:14px;
  border:1px solid rgba(255,255,255,.8);
}
.addmode-title{
  font-weight:800;
  font-size:17px;
  color:#1e293b;
  display:flex;
  align-items:center;
  gap:8px;
  letter-spacing:-0.01em;
}
.addmode-body{
  font-size:14px;
  line-height:1.5;
  color:#475569;
}
.addmode-input{
  width:100%;
  padding:11px 16px;
  border-radius:12px;
  border:2px solid #e2e8f0;
  background:#ffffff;
  font-size:14px;
  transition:all 0.2s ease;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  letter-spacing:0.3em;
  font-weight:600;
}
.addmode-input:focus{
  outline:none;
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.15), 0 4px 6px -1px rgba(0,0,0,.1);
  background:#ffffff;
}
.addmode-input::placeholder{
  letter-spacing:normal;
  font-weight:400;
  color:#94a3b8;
}
.addmode-footer{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:4px;
}
.btn-cancel{
  background:#f1f5f9;
  color:#475569;
  border:1px solid #e2e8f0;
}
.btn-cancel:hover{
  background:#e2e8f0;
  color:#334155;
}
.btn-primary{
  background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  color:#ffffff;
  border:none;
  font-weight:600;
  box-shadow:0 2px 4px rgba(37,99,235,.2);
}
.btn-primary:hover{
  background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
  box-shadow:0 4px 8px rgba(37,99,235,.3);
}
.addmode-error{
  font-size:13px;
  color:#dc2626;
  min-height:18px;
  font-weight:500;
  padding:0 4px;
}

/* ======================= LIGHTBOX MODE AJOUT DREETS ======================= */
#dlgAddModeDreets{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.75);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:57;
}
#dlgAddModeDreets[aria-hidden="false"]{display:flex}

/* ======================= LIGHTBOX MODE ADMIN GLOBAL ======================= */
#dlgAdminMode{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.75);
  backdrop-filter:blur(4px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:59;
}
#dlgAdminMode[aria-hidden="false"]{display:flex}

/* ======================= LIGHTBOX CONFIRM CLEAR TRAV ======================= */
#dlgClearTravaux{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 10000050;
}
#dlgClearTravaux[aria-hidden="false"]{display:flex}

/* ======================= LIGHTBOX SUPPRESSION ADMIN ======================= */
#dlgAdminDelete{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:70;
}
#dlgAdminDelete[aria-hidden="false"]{display:flex}

/* ======================= RESPONSIVE ======================= */
@media (max-width:980px){
  .layout{grid-template-columns:1fr}
  .photo-row{grid-template-columns:1fr}
  .trav-sect-grid{grid-template-columns:1fr}
  .dreets-product-grid{grid-template-columns:1fr}
}

/* ================== FICHE DE POSTE (isolée) ================== */
/* On scope tout sur le conteneur overlay lui-même (#dlgFichePoste) pour éviter toute collision */

/* ================== FICHE DE POSTE ================== */

/* Overlay globale */
.fp-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:200;
}
.fp-overlay[aria-hidden="false"]{
  display:flex;
}

/* Boîte principale */
.fp-dialog{
  background:#f9fafb;
  color:#111827;
  border-radius:18px;
  box-shadow:0 20px 45px rgba(0,0,0,.45);
  width:min(1200px,98vw);
  max-height:95vh;            /* un peu plus haut qu'avant */
  padding:18px 22px 16px;
  display:flex;
  flex-direction:column;
  gap:14px;
  overflow:auto;              /* on laisse défiler si c'est un peu trop long */
  position:relative;
}


/* ================== HEADER ================== */

/* On déborde le padding pour avoir le bandeau bleu pleine largeur */
.fp-header{
  margin:0 -22px 12px;
  position:relative;
  padding-top:0;
}


/* Bandeau bleu dégradé pleine largeur */
.fp-banner{
  margin-right:0;
  position:relative;
width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding: 6px 18px; min-height:110px;
  border-radius:18px;
  background:linear-gradient(90deg,#1b396a 0%,#3f72af 100%);
  box-sizing:border-box;
  gap:24px;
  color:#ffffff;
}

/* Colonne gauche : titre */
.fp-banner-left{
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:2px;
}
.fp-banner-title{
  font-size: 20px;
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.fp-banner-sub{
  font-size: 12px;
  opacity:.9;
}

/* Colonne droite : année + boutons + QR */
.fp-banner-right{
  display:flex;
  align-items:center;
  gap:16px;
}
.fp-year{
  font-size:16px;
  font-weight:700;
}

/* Boutons sur fond bleu */
.fp-actions-top{
  display:flex;
  gap:8px;
}
.fp-actions-top button{
  border-radius:999px;
  padding:6px 14px;
  font-size:13px;
  cursor:pointer;
  border:1px solid #d1d5db;
  background:#ffffff;
  color:#111827;
}
#fpCancel{background:#ffffff;}
#fpExportPDF{background:#ffffff;}
#fpSave{
  background:#22c55e;
  color:#ffffff;
  border-color:#16a34a;
}
.fp-actions-top button:disabled{
  opacity:.45;
  cursor:not-allowed;
}

/* Boîte QR code */
.fp-qrcode-box{
  position:absolute;
  top:0;
  right:0;
  width:220px;
  height:220px;
  padding:10px;
  border-radius:14px;
  background:#fff;
  box-shadow:0 10px 25px rgba(0,0,0,.18);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.fp-qrcode-box canvas,
.fp-qrcode-box img{

  width:100% !important;
  height:100% !important;
  object-fit:contain;
  display:block;
  margin:auto;
}


.fp-qrcode-box table{width:100% !important; height:100% !important; border-collapse:collapse; margin:0 auto;}
.fp-qrcode-box td{padding:0 !important;}
.fp-qrcode-box a{display:flex; width:100%; height:100%; align-items:center; justify-content:center;}

.fp-qrcode-box img{
  max-width:206px;
  max-height:206px;
  object-fit:contain;
}

/* Barre grise avec nom de l'équipement */
.fp-header-bottom{
  margin:10px 28px 0;
}
.fp-display{
  width:100%;
  min-height:42px;
  padding:8px 18px;
  border-radius:999px;
  background:#e5e7eb;
  border:1px solid #cbd5e1;
  font-size:15px;
  font-weight:600;
  display:flex;
  align-items:center;
  box-sizing:border-box;
  white-space:normal;
  word-break:break-word;
}

/* ================== CONTENU GÉNÉRAL ================== */

.fp-content{
  flex:1 1 auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.fp-topline{
  margin-right:0;
margin-top:12px;
}

/* Sections libellées */
.fp-section{
  margin-bottom:10px;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.fp-section > label{
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.06em;
  text-decoration:underline;
  color:#374151;
}

/* Textareas */
.fp-textarea{
  width:100%;
  border-radius:10px;
  padding:8px 10px;
  background:#ffffff;
  border:1px solid #cbd5e1;
  resize:vertical;
  font-size:13px;
  line-height:1.35;
}

/* Nature des travaux – hauteur raisonnable */
#fpNatureTravaux{
  min-height:4.8em; /* >= 3 lignes */
  height:auto;
  max-height:none;
  overflow:hidden; /* auto-grow */
  resize:none;
}

/* Ligne select + bouton Ajouter */
.fp-select-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
.fp-select{
  flex:1 1 auto;
  min-width:0;
  border-radius:999px;
  padding:6px 10px;
  border:1px solid #cbd5e1;
  background:#f9fafb;
  font-size:13px;
}
.fp-select-add{
  border-radius:999px;
  border:1px solid #6b7280;
  padding:6px 10px;
  font-size:12px;
  background:#ffffff;
  cursor:pointer;
}

/* ================== DIPLÔMES ASSOCIÉS ================== */

.fp-section-diplomes{
  margin-top:10px;
  margin-bottom:8px;
}
.fp-section-diplomes > label{
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.06em;
  text-decoration:underline;
  color:#374151;
  margin-bottom:4px;
}

/* 4 colonnes : CAP / BAC PRO / BTS / AUTRES */
.fp-diplomes{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:8px 26px;
}
.fp-diplomes-col-title{
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.08em;
  margin-bottom:3px;
  border-bottom:1px solid #d1d5db;
  padding-bottom:2px;
}
.fp-diplomes ul{
  margin:0;
  padding-left:16px;
  font-size:11px;
  line-height:1.35;
}
.fp-diplomes li{
  margin-bottom:2px;
}

/* ================== GRILLE HAUT : PHOTO / SITUATIONS / PRÉVENTION ================== */

.fp-grid3{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:18px;
}
.fp-grid3 > *{ min-width:0; }          /* évite qu'un enfant force un retour à la ligne */
.fp-card-blue, .fp-card-orange, .fp-card-green, .fp-card-red, .fp-card-brown{ min-width:0; }
.fp-textarea{ min-width:0; }
.fp-col{
  display:flex;
  flex-direction:column;
}
.fp-col h3{
  margin:0;
  font-size:13px;
  font-weight:700;
  letter-spacing:.06em;
  text-transform:uppercase;
}
.fp-col small{
  font-size:11px;
  color:#111827;
}

/* Cartes colorées */
.fp-card-blue,
.fp-card-orange,
.fp-card-green,
.fp-card-red,
.fp-card-brown{
  border-radius:12px;
  padding:8px 10px;
  display:flex;
  flex-direction:column;
}

/* PHOTO / ENVIRONNEMENT (bleu) */
.fp-card-blue{
  background:#e0f2fe;
  border:2px solid #60a5fa;
  color:#111827;
}

/* SITUATIONS (orange) */
.fp-card-orange{
  background:linear-gradient(135deg,#fed7aa,#fb923c);
  border:2px solid #ea580c;
  color:#111827;
}

/* PRÉVENTION (vert) */
.fp-card-green{
  background:linear-gradient(135deg,#bbf7d0,#22c55e);
  border:2px solid #16a34a;
  color:#111827;
}

/* NUMÉROS URGENCE (rouge) */
.fp-card-red{
  background:#dc2626;
  border:2px solid #b91c1c;
  color:#ffffff;
}

/* PRÉREQUIS (noir) */
.fp-card-brown{
  background:#020617;
  border:2px solid #000000;
  color:#f9fafb;
}
.fp-card-brown h3,
.fp-card-brown small,
.fp-card-brown p,
.fp-card-brown li{
  color:#f9fafb;
}

/* Hauteurs harmonisées pour la rangée du haut */
.fp-col-act  > .fp-card-blue,
.fp-col-sit  > .fp-card-orange,
.fp-col-prev > .fp-card-green{
  flex:1 1 auto;
  min-height:260px;
}

/* Textareas qui remplissent la carte dans SITUATIONS / PRÉVENTION */
.fp-col-sit .fp-textarea,
.fp-col-prev .fp-textarea{
  flex:1 1 auto;
  min-height:0;
}

/* PHOTO */
.fp-photo-box{
  margin-top:6px;
  border-radius:10px;
  background:#f3f4f6;
  border:1px solid #cbd5e1;
  height:320px;
  
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.fp-photo-box img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:none;
}
.fp-photo-empty{
  font-size:12px;
  color:#9ca3af;
}

/* ================== GRILLE BAS : ENVIRONNEMENT / URGENCE / PRÉREQUIS ================== */

.fp-grid3-bottom{
  margin-top:18px;
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr)); /* mêmes largeurs */
  gap:18px;
}

/* ENVIRONNEMENT : dégradé bleu foncé */
.fp-col-env > .fp-card-blue{
  background:linear-gradient(135deg,#1b396a 0%,#1f4f9a 45%,#2563eb 100%);
  border-color:#1d4ed8;
  color:#e5f0ff;
}
.fp-col-env > .fp-card-blue h3,
.fp-col-env > .fp-card-blue small,
.fp-col-env > .fp-card-blue p,
.fp-col-env > .fp-card-blue li{
  color:#e5f0ff;
}

/* Textareas plus hautes pour ENVIRONNEMENT et PRÉREQUIS */
.fp-col-env .fp-textarea,
.fp-col-prereq .fp-textarea{
  min-height:150px;
}

/* NUMÉROS D'URGENCE : texte centré + boutons en colonne */
.fp-col-urg h3{
  font-size:11px;
  text-align:center;
}
.fp-urg-buttons{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:stretch;
}
.fp-urg-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:8px 16px;
  border-radius:999px;
  background:#ffffff;
  color:#b91c1c;
  font-weight:700;
  font-size:13px;
}

/* ================== PIED DE PAGE ================== */

/* Pied de page sous le bloc "Numéros d'urgence" */
.fp-footer {
  margin-top: 10px;
  padding-top: 6px;
  border-top: 1px dashed #9ca3af;
  font-size: 11px;
  color: #4b5563;
}

.fp-footer-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.fp-footer-date {
  font-weight: 600;
}

.fp-footer-sign {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.fp-signature-box {
  width: 220px;
  min-height: 32px;
  border-radius: 8px;
  border: 1px dashed #9ca3af;
}



/* ================== RESPONSIVE ================== */
@media (max-width:900px){
  .fp-dialog{
    padding:12px 10px 10px;
  }
  .fp-header{
    margin:0 -10px 10px;
  }
  .fp-banner{
    flex-direction:column;
    align-items:flex-start;
    gap:12px;
  }
  .fp-banner-right{
    width:100%;
    justify-content:space-between;
  }
  .fp-header-bottom{
    margin:8px 16px 0;
  }
  .fp-grid3,
  .fp-grid3-bottom{
    grid-template-columns:1fr;
  }
}
/* ========= OVERRIDES FICHE DE POSTE – BANDEAU COMPACT ========= */

/* Lightbox un peu plus haute */
.fp-dialog{
  max-height:95vh;
}

/* Header : on prépare le positionnement interne */
.fp-header{
  margin:0 -22px 10px;
  position:relative;
}

/* Bandeau bleu moins épais, avec une réserve en bas pour le token gris */
.fp-banner{
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:12px 24px 40px;  /* padding bas = place pour le token */
  border-radius:18px;
  background:linear-gradient(90deg,#1b396a 0%,#3f72af 100%);
  box-sizing:border-box;
  gap:24px;
  color:#ffffff;
}

/* Colonne gauche : on garde ton style */
.fp-banner-left{
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  gap:2px;
}
.fp-banner-title{
  font-size:22px;
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.fp-banner-sub{
  font-size:12px;
  opacity:.9;
}

/* Colonne droite : année + boutons + QR bien en haut */
.fp-banner-right{
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.fp-year{
  font-size:13px;
  font-weight:700;
  color:#ffffff;
  margin-top:2px;
}

/* Boutons sur fond bleu (on garde les couleurs, on compacte un peu) */
.fp-actions-top{
  display:flex;
  gap:6px;
  margin-top:0;
}
.fp-actions-top button{
  border-radius:999px;
  padding:5px 12px;
  font-size:12px;
}

/* QR code plus petit */
.fp-qrcode-box{
  width:70px;
  height:70px;
  border-radius:14px;
  border:2px dashed rgba(255,255,255,.7);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:10px;
  color:#ffffff;
  background:rgba(15,23,42,.15);
}
.fp-qrcode-box img{
  max-width:55px;
  max-height:55px;
}

/* ----- Token gris NOM D'ÉQUIPEMENT À L'INTÉRIEUR DU BANDEAU ----- */

/* On place la barre grise en absolu dans le bandeau bleu */
.fp-header-bottom{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:8px;                         /* un peu au-dessus du bas du bandeau */
  margin:0;
  width:calc(100% - 220px);           /* laisse de la place pour le QR + marge */
  display:flex;
  justify-content:center;
}

/* Token gris : largeur raisonnable, moins haut */
.fp-display{
  max-width:640px;
  width:100%;
  min-height:34px;
  padding:6px 18px;
  border-radius:999px;
  background:#e5e7eb;
  border:1px solid #cbd5e1;
  font-size:14px;
  font-weight:600;
  display:flex;
  align-items:center;
  box-sizing:border-box;
  white-space:normal;
  word-break:break-word;
}

/* ----- Nature des travaux : champ plus compact et police un peu plus grande ----- */
#fpNatureTravaux{
  max-height:2.6em;    /* moins haut visuellement */
  font-size:14px;
  line-height:1.3;
}
/* ========== FICHE DE POSTE – AJUSTEMENTS FINAUX ========== */

/* Marge latérale un peu plus large dans la lightbox */
.fp-dialog{
  padding:18px 32px 16px;     /* avant : 18px 22px 16px */
  max-height:95vh;            /* un peu plus de hauteur dispo */
}

/* On remet de vraies marges, plus de décalage négatif */
.fp-header{
  margin:0 0 12px;
}

/* Bandeau bleu toujours pleine largeur, mais avec le padding ci-dessus */
.fp-banner{
  width:100%;
  border-radius:18px;
}

/* ---------- Boutons & année dans le bandeau ---------- */

/* On masque l'année 2025 */
.fp-year{
  display:none;
}

/* Boutons : on les laisse tels quels, juste un peu compacts sur la hauteur */
.fp-actions-top{
  display:flex;
  gap:6px;
}
.fp-actions-top button{
  padding:5px 12px;
  font-size:12px;
}

/* ---------- QR code un peu plus gros ---------- */

.fp-qrcode-box{
  width:90px;                 /* agrandi homothétiquement */
  height:90px;
  border-radius:16px;
  border:2px dashed rgba(255,255,255,.7);
  background:rgba(15,23,42,.15);
}
.fp-qrcode-box img{
  max-width:70px;
  max-height:70px;
}

/* ---------- Token gris (nom d'équipement) centré dans le bandeau ---------- */

/* La barre reste à l'intérieur du bandeau, au centre */
.fp-header-bottom{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:8px;
  margin:0;
  width:calc(100% - 220px);   /* laisse de la place au QR + marges */
  display:flex;
  justify-content:center;
}

/* Token gris : texte centré */
.fp-display{
  max-width:640px;
  width:100%;
  min-height:34px;
  padding:6px 18px;
  border-radius:999px;
  background:#e5e7eb;
  border:1px solid #cbd5e1;
  font-size:14px;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;     /* <— centrage horizontal */
  text-align:center;
  box-sizing:border-box;
  white-space:normal;
  word-break:break-word;
}

/* ---------- Nature des travaux : champ plus compact et lisible ---------- */

#fpNatureTravaux{
  max-height:2.6em;           /* moins haut visuellement (~2 lignes) */
  font-size:14px;
  line-height:1.3;
}

/* ---------- Diplômes : on garde ton rendu actuel, juste centré lorsqu'on réduira en JS ---------- */
/* (Pour l'instant, seules les colonnes vides disparaîtront quand on modifiera le script) */



/* conteneur */
#fpDiplomes{
  display:flex;
  justify-content:center;
  gap:32px;
}

/* chaque colonne */
.fp-diplomes-col{
  min-width:180px;
}


/* ---------- Rangée du bas : footer centré sous la colonne centrale ---------- */

.fp-footer{
  margin-top:10px;
  padding-top:8px;
  border-top:1px dashed #e5e7eb;
  display:flex;
  justify-content:center;     /* aligné sous les numéros d'urgence (colonne centrale) */
  align-items:flex-end;
  gap:16px;
  font-size:10px;
  color:#4b5563;
}

.fp-signature-box{
  min-width:180px;
  min-height:40px;
  border-radius:8px;
  border:1px dashed #9ca3af;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding:4px 8px;
}

.fp-date-box{
  white-space:nowrap;
}


/* ===== PATCH: styles FICHE DE POSTE (from ficheok) ===== */
/* ================== FICHE DE POSTE ================== */

/* Overlay globale */
.fp-overlay{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:200;
}
.fp-overlay[aria-hidden="false"]{
  display:flex;
}

/* Boîte principale */
.fp-dialog{
  background:#f9fafb;
  color:#111827;
  border-radius:18px;
  box-shadow:0 20px 45px rgba(0,0,0,.45);
  width:min(1200px,98vw);
  max-height:95vh;            /* un peu plus haut qu'avant */
  padding:18px 22px 16px;
  display:flex;
  flex-direction:column;
  gap:14px;
  overflow:auto;              /* on laisse défiler si c'est un peu trop long */
  position:relative;
}


/* ================== HEADER ================== */

/* On déborde le padding pour avoir le bandeau bleu pleine largeur */
.fp-header{
  margin:0 -22px 14px;
}

/* Bandeau bleu dégradé pleine largeur */
Jpx 22px
/* ===== PATCH V28 (CSS UNIQUEMENT) =====
   Objectif: garder la disposition "base2" (référence) tout en sécurisant:
   - Photo/VGP + Caractéristiques collés (grid stable)
   - Fiche de poste: photo base/personnalisée même gabarit (ne casse pas la grille)
*/
.photo-dreets-row,
.photo-prod-row,
.photo-product-row{
  display:grid;
  grid-template-columns: minmax(420px, 1.15fr) minmax(360px, 0.85fr);
  gap: 14px;
  align-items: stretch;
}
@media (max-width: 1050px){
  .photo-dreets-row,
  .photo-prod-row,
  .photo-product-row{
    grid-template-columns: 1fr;
  }
}

/* Encart vert "Caractéristiques" : pas de flottement, collé au bloc photo */
.dreets-product-panel{
  margin: 0;
  height: 100%;
}
.dreets-product-panel .panel-title-bar{
  margin-bottom: 8px;
}

/* Fiche de poste — PHOTO: gabarit fixe, image en cover */
.fp-photo,
.fp-photo .photo-card,
.fp-photo .photo-card-inner{
  width: 100%;
  max-width: 340px;
}
.fp-photo img,
#fpPhotoImg,
#fpPhotoImgBase,
#fpPhotoImgEtab,
#fpPhoto{
  width: 100% !important;
  height: 300px !important;  /* FIXE = les 3 blocs ont la même hauteur */
  object-fit: contain !important;  /* CONTAIN = affiche l'image entière sans la couper */
  display: block !important;
  border-radius: 14px !important;
}

/* Évite qu'un wrapper ajouté ne pousse la grille */
.fp-grid-top{
  align-items: start;
}

  border-radius:18px;
  background:linear-gradient(90deg,#1b396a 0%,#3f72af 100%);
  box-sizing:border-box;
  gap:24px;
  color:#ffffff;
}

/* Colonne gauche : titre */
.fp-banner-left{
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:2px;
}
.fp-banner-title{
  font-size:24px;
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.fp-banner-sub{
  font-size:13px;
  opacity:.9;
}

/* Colonne droite : année + boutons + QR */
.fp-banner-right{
  display:flex;
  align-items:center;
  gap:16px;
}
.fp-year{
  font-size:16px;
  font-weight:700;
}

/* Boutons sur fond bleu */
.fp-actions-top{
  display:flex;
  gap:8px;
}
.fp-actions-top button{
  border-radius:999px;
  padding:6px 14px;
  font-size:13px;
  cursor:pointer;
  border:1px solid #d1d5db;
  background:#ffffff;
  color:#111827;
}
#fpCancel{background:#ffffff;}
#fpExportPDF{background:#ffffff;}
#fpSave{
  background:#22c55e;
  color:#ffffff;
  border-color:#16a34a;
}
.fp-actions-top button:disabled{
  opacity:.45;
  cursor:not-allowed;
}

/* Boîte QR code */
.fp-qrcode-box{
  width:120px;
  height:120px;
  border-radius:16px;
  border:2px dashed rgba(255,255,255,.7);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:12px;
  color:#ffffff;
  background:rgba(15,23,42,.12);
}
.fp-qrcode-box img{
  max-width:90px;
  max-height:90px;
  object-fit:contain;
}

/* Barre grise avec nom de l'équipement */
.fp-header-bottom{
  margin:10px 28px 0;
}
.fp-display{
  width:100%;
  min-height:42px;
  padding:8px 18px;
  border-radius:999px;
  background:#e5e7eb;
  border:1px solid #cbd5e1;
  font-size:15px;
  font-weight:600;
  display:flex;
  align-items:center;
  box-sizing:border-box;
  white-space:normal;
  word-break:break-word;
}

/* ================== CONTENU GÉNÉRAL ================== */

.fp-content{
  flex:1 1 auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.fp-topline{
  margin-top:12px;
}

/* Sections libellées */
.fp-section{
  margin-bottom:10px;
  display:flex;
  flex-direction:column;
  gap:4px;
}
.fp-section > label{
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.06em;
  text-decoration:underline;
  color:#374151;
}

/* Textareas */
.fp-textarea{
  width:100%;
  border-radius:10px;
  padding:8px 10px;
  background:#ffffff;
  border:1px solid #cbd5e1;
  resize:vertical;
  font-size:13px;
  line-height:1.35;
}

/* Nature des travaux – hauteur raisonnable */
#fpNatureTravaux{
  min-height:4.8em; /* >= 3 lignes */
  height:auto;
  max-height:none;
  overflow:hidden; /* auto-grow */
  resize:none;
}

/* Ligne select + bouton Ajouter */
.fp-select-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
.fp-select{
  flex:1 1 auto;
  min-width:0;
  border-radius:999px;
  padding:6px 10px;
  border:1px solid #cbd5e1;
  background:#f9fafb;
  font-size:13px;
}
.fp-select-add{
  border-radius:999px;
  border:1px solid #6b7280;
  padding:6px 10px;
  font-size:12px;
  background:#ffffff;
  cursor:pointer;
}

/* ================== DIPLÔMES ASSOCIÉS ================== */

.fp-section-diplomes{
  margin-top:10px;
  margin-bottom:8px;
}
.fp-section-diplomes > label{
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.06em;
  text-decoration:underline;
  color:#374151;
  margin-bottom:4px;
}

/* 4 colonnes : CAP / BAC PRO / BTS / AUTRES */
.fp-diplomes{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:8px 26px;
}
.fp-diplomes-col-title{
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.08em;
  margin-bottom:3px;
  border-bottom:1px solid #d1d5db;
  padding-bottom:2px;
}
.fp-diplomes ul{
  margin:0;
  padding-left:16px;
  font-size:11px;
  line-height:1.35;
}
.fp-diplomes li{
  margin-bottom:2px;
}

/* ================== GRILLE HAUT : PHOTO / SITUATIONS / PRÉVENTION ================== */

.fp-grid3{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:18px;
}
.fp-grid3 > *{ min-width:0; }          /* évite qu'un enfant force un retour à la ligne */
.fp-card-blue, .fp-card-orange, .fp-card-green, .fp-card-red, .fp-card-brown{ min-width:0; }
.fp-textarea{ min-width:0; }
.fp-col{
  display:flex;
  flex-direction:column;
}
.fp-col h3{
  margin:0;
  font-size:13px;
  font-weight:700;
  letter-spacing:.06em;
  text-transform:uppercase;
}
.fp-col small{
  font-size:11px;
  color:#111827;
}

/* Cartes colorées */
.fp-card-blue,
.fp-card-orange,
.fp-card-green,
.fp-card-red,
.fp-card-brown{
  border-radius:12px;
  padding:8px 10px;
  display:flex;
  flex-direction:column;
}

/* PHOTO / ENVIRONNEMENT (bleu) */
.fp-card-blue{
  background:#e0f2fe;
  border:2px solid #60a5fa;
  color:#111827;
}

/* SITUATIONS (orange) */
.fp-card-orange{
  background:linear-gradient(135deg,#fed7aa,#fb923c);
  border:2px solid #ea580c;
  color:#111827;
}

/* PRÉVENTION (vert) */
.fp-card-green{
  background:linear-gradient(135deg,#bbf7d0,#22c55e);
  border:2px solid #16a34a;
  color:#111827;
}

/* NUMÉROS URGENCE (rouge) */
.fp-card-red{
  background:#dc2626;
  border:2px solid #b91c1c;
  color:#ffffff;
}

/* PRÉREQUIS (noir) */
.fp-card-brown{
  background:#020617;
  border:2px solid #000000;
  color:#f9fafb;
}
.fp-card-brown h3,
.fp-card-brown small,
.fp-card-brown p,
.fp-card-brown li{
  color:#f9fafb;
}

/* Hauteurs harmonisées pour la rangée du haut */
.fp-col-act  > .fp-card-blue,
.fp-col-sit  > .fp-card-orange,
.fp-col-prev > .fp-card-green{
  flex:1 1 auto;
  min-height:260px;
}

/* Textareas qui remplissent la carte dans SITUATIONS / PRÉVENTION */
.fp-col-sit .fp-textarea,
.fp-col-prev .fp-textarea{
  flex:1 1 auto;
  min-height:0;
}

/* PHOTO */
.fp-photo-box{
  margin-top:6px;
  border-radius:10px;
  background:#f3f4f6;
  border:1px solid #cbd5e1;
  height:320px;
  
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.fp-photo-box img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:none;
}
.fp-photo-empty{
  font-size:12px;
  color:#9ca3af;
}

/* ================== GRILLE BAS : ENVIRONNEMENT / URGENCE / PRÉREQUIS ================== */

.fp-grid3-bottom{
  margin-top:18px;
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr)); /* mêmes largeurs */
  gap:18px;
}

/* ENVIRONNEMENT : dégradé bleu foncé */
.fp-col-env > .fp-card-blue{
  background:linear-gradient(135deg,#1b396a 0%,#1f4f9a 45%,#2563eb 100%);
  border-color:#1d4ed8;
  color:#e5f0ff;
}
.fp-col-env > .fp-card-blue h3,
.fp-col-env > .fp-card-blue small,
.fp-col-env > .fp-card-blue p,
.fp-col-env > .fp-card-blue li{
  color:#e5f0ff;
}

/* Textareas plus hautes pour ENVIRONNEMENT et PRÉREQUIS */
.fp-col-env .fp-textarea,
.fp-col-prereq .fp-textarea{
  min-height:150px;
}

/* NUMÉROS D'URGENCE : texte centré + boutons en colonne */
.fp-col-urg h3{
  font-size:11px;
  text-align:center;
}
.fp-urg-buttons{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  align-items:stretch;
}
.fp-urg-btn{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:8px 16px;
  border-radius:999px;
  background:#ffffff;
  color:#b91c1c;
  font-weight:700;
  font-size:13px;
}

/* ================== PIED DE PAGE ================== */

/* Pied de page sous le bloc "Numéros d'urgence" */
.fp-footer {
  margin-top: 10px;
  padding-top: 6px;
  border-top: 1px dashed #9ca3af;
  font-size: 11px;
  color: #4b5563;
}

.fp-footer-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.fp-footer-date {
  font-weight: 600;
}

.fp-footer-sign {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.fp-signature-box {
  width: 220px;
  min-height: 32px;
  border-radius: 8px;
  border: 1px dashed #9ca3af;
}



/* ================== RESPONSIVE ================== */
@media (max-width:900px){
  .fp-dialog{
    padding:12px 10px 10px;
  }
  .fp-header{
    margin:0 -10px 10px;
  }
  .fp-banner{
    flex-direction:column;
    align-items:flex-start;
    gap:12px;
  }
  .fp-banner-right{
    width:100%;
    justify-content:space-between;
  }
  .fp-header-bottom{
    margin:8px 16px 0;
  }
  .fp-grid3,
  .fp-grid3-bottom{
    grid-template-columns:1fr;
  }
}
/* ========= OVERRIDES FICHE DE POSTE – BANDEAU COMPACT ========= */

/* Lightbox un peu plus haute */
.fp-dialog{
  max-height:95vh;
}

/* Header : on prépare le positionnement interne */
.fp-header{
  margin:0 -22px 10px;
  position:relative;
}

/* Bandeau bleu moins épais, avec une réserve en bas pour le token gris */
.fp-banner{
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  padding:12px 24px 40px;  /* padding bas = place pour le token */
  border-radius:18px;
  background:linear-gradient(90deg,#1b396a 0%,#3f72af 100%);
  box-sizing:border-box;
  gap:24px;
  color:#ffffff;
}

/* Colonne gauche : on garde ton style */
.fp-banner-left{
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  gap:2px;
}
.fp-banner-title{
  font-size:22px;
  font-weight:800;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.fp-banner-sub{
  font-size:12px;
  opacity:.9;
}

/* Colonne droite : année + boutons + QR bien en haut */
.fp-banner-right{
  display:flex;
  align-items:flex-start;
  gap:12px;
}
.fp-year{
  font-size:13px;
  font-weight:700;
  color:#ffffff;
  margin-top:2px;
}

/* Boutons sur fond bleu (on garde les couleurs, on compacte un peu) */
.fp-actions-top{
  display:flex;
  gap:6px;
  margin-top:0;
}
.fp-actions-top button{
  border-radius:999px;
  padding:5px 12px;
  font-size:12px;
}

/* QR code plus petit */
.fp-qrcode-box{
  width:70px;
  height:70px;
  border-radius:14px;
  border:2px dashed rgba(255,255,255,.7);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:10px;
  color:#ffffff;
  background:rgba(15,23,42,.15);
}
.fp-qrcode-box img{
  max-width:55px;
  max-height:55px;
}

/* ----- Token gris NOM D'ÉQUIPEMENT À L'INTÉRIEUR DU BANDEAU ----- */

/* On place la barre grise en absolu dans le bandeau bleu */
.fp-header-bottom{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:8px;                         /* un peu au-dessus du bas du bandeau */
  margin:0;
  width:calc(100% - 220px);           /* laisse de la place pour le QR + marge */
  display:flex;
  justify-content:center;
}

/* Token gris : largeur raisonnable, moins haut */
.fp-display{
  max-width:640px;
  width:100%;
  min-height:34px;
  padding:6px 18px;
  border-radius:999px;
  background:#e5e7eb;
  border:1px solid #cbd5e1;
  font-size:14px;
  font-weight:600;
  display:flex;
  align-items:center;
  box-sizing:border-box;
  white-space:normal;
  word-break:break-word;
}

/* ----- Nature des travaux : champ plus compact et police un peu plus grande ----- */
#fpNatureTravaux{
  max-height:2.6em;    /* moins haut visuellement */
  font-size:14px;
  line-height:1.3;
}
/* ========== FICHE DE POSTE – AJUSTEMENTS FINAUX ========== */

/* Marge latérale un peu plus large dans la lightbox */
.fp-dialog{
  padding:18px 32px 16px;     /* avant : 18px 22px 16px */
  max-height:95vh;            /* un peu plus de hauteur dispo */
}

/* On remet de vraies marges, plus de décalage négatif */
.fp-header{
  margin:0 0 12px;
}

/* Bandeau bleu toujours pleine largeur, mais avec le padding ci-dessus */
.fp-banner{
  width:100%;
  border-radius:18px;
}

/* ---------- Boutons & année dans le bandeau ---------- */

/* On masque l'année 2025 */
.fp-year{
  display:none;
}

/* Boutons : on les laisse tels quels, juste un peu compacts sur la hauteur */
.fp-actions-top{
  display:flex;
  gap:6px;
}
.fp-actions-top button{
  padding:5px 12px;
  font-size:12px;
}

/* ---------- QR code un peu plus gros ---------- */

.fp-qrcode-box{
  width:90px;                 /* agrandi homothétiquement */
  height:90px;
  border-radius:16px;
  border:2px dashed rgba(255,255,255,.7);
  background:rgba(15,23,42,.15);
}
.fp-qrcode-box img{
  max-width:70px;
  max-height:70px;
}

/* ---------- Token gris (nom d'équipement) centré dans le bandeau ---------- */

/* La barre reste à l'intérieur du bandeau, au centre */
.fp-header-bottom{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:8px;
  margin:0;
  width:calc(100% - 220px);   /* laisse de la place au QR + marges */
  display:flex;
  justify-content:center;
}

/* Token gris : texte centré */
.fp-display{
  max-width:640px;
  width:100%;
  min-height:34px;
  padding:6px 18px;
  border-radius:999px;
  background:#e5e7eb;
  border:1px solid #cbd5e1;
  font-size:14px;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;     /* <— centrage horizontal */
  text-align:center;
  box-sizing:border-box;
  white-space:normal;
  word-break:break-word;
}

/* ---------- Nature des travaux : champ plus compact et lisible ---------- */

#fpNatureTravaux{
  max-height:2.6em;           /* moins haut visuellement (~2 lignes) */
  font-size:14px;
  line-height:1.3;
}

/* ---------- Diplômes : on garde ton rendu actuel, juste centré lorsqu'on réduira en JS ---------- */
/* (Pour l'instant, seules les colonnes vides disparaîtront quand on modifiera le script) */



/* conteneur */
#fpDiplomes{
  display:flex;
  justify-content:center;
  gap:32px;
}

/* chaque colonne */
.fp-diplomes-col{
  min-width:180px;
}


/* ---------- Rangée du bas : footer centré sous la colonne centrale ---------- */

.fp-footer{
  margin-top:10px;
  padding-top:8px;
  border-top:1px dashed #e5e7eb;
  display:flex;
  justify-content:center;     /* aligné sous les numéros d'urgence (colonne centrale) */
  align-items:flex-end;
  gap:16px;
  font-size:10px;
  color:#4b5563;
}

.fp-signature-box{
  min-width:180px;
  min-height:40px;
  border-radius:8px;
  border:1px dashed #9ca3af;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding:4px 8px;
}

.fp-date-box{
  white-space:nowrap;
}



/* ===== FIN PATCH FP ===== */
/* ===== PRINT ONLY (minimal safe) ===== */
@media print{
html, body {
    margin: 0 !important;
    padding: 0 !important;
    width: 297mm;
    height: 210mm;
    overflow: hidden;
  }

  /* Overlay fiche de poste */
  #dlgFichePoste {
    position: static !important;
    inset: auto !important;
    background: transparent !important;
    width: 297mm !important;
    height: 210mm !important;
    display: block !important;
  }

  /* La fiche elle-même */
  .fp-dialog {
    width: 297mm !important;
    height: 210mm !important;
    max-width: none !important;
    max-height: none !important;
    margin: 0 !important;
    transform: none !important;
    box-shadow: none !important;
  }

  /* Boutons masqués à l'impression */
  #fpCancel,
  #fpExportPDF,
  #fpSave {
    display: none !important;
  }

  /* Photo : jamais étirée */
  .fp-photo img {
    max-width: 100% !important;
    max-height: 100% !important;
    object-fit: contain !important;
  }
}


/* ===== PP-TR CLEAN OVERRIDES (lightbox travaux) ===== */
#dlgTravaux{background:rgba(15,23,42,.35)!important;}
.trav-modal{background:#ffffff!important;border:1px solid #1b396a!important;border-radius:18px!important;box-shadow:0 20px 45px rgba(15,23,42,.35)!important;}
.trav-header{background:linear-gradient(90deg,#1B396A,#3F72AF)!important;color:#ffffff!important;border-radius:18px 18px 0 0!important;}
.trav-header .btn{background:rgba(255,255,255,.12)!important;border:1px solid rgba(255,255,255,.35)!important;color:#ffffff!important;}
.trav-table th{background:#0b2343!important;color:#ffffff!important;}
.trav-table td{color:#111827!important;}
.trav-col-red{background:#f4b4b4!important;}
.trav-col-orange{background:#f7d2a6!important;}
.trav-col-green{background:#aee7c4!important;}
.trav-table td[data-empty="true"]{opacity:.65!important;}
#trav-validate{background:#f59e0b!important;border-color:#f59e0b!important;color:#111827!important;font-weight:800!important;}
#trav-cancel{background:#ffffff!important;border-color:#cbd5e1!important;color:#0b1220!important;}
.trav-col-fiche a{color:#0a58ca!important;text-decoration:underline!important;font-weight:800!important;}
.link-like{color:#0a58ca!important;text-decoration:underline!important;font-weight:800!important;}


/* PATCH v11.50: hide dev stamp */
#pptr-stamp, #pptr-stamp-spacer{display:none!important;height:0!important;}

/* PATCH v11.50: liens lisibles */
#trav-table a{color:#0b57d0;text-decoration:underline;font-weight:700;}
#trav-table .trav-col-fiche{font-weight:800;}

/* PATCH v11.50: bouton PDF retiré */
#fpPdf{display:none!important;}

/* Export snapshot: garder le token centré dans la partie bleue */
.fp-export .fp-header-bottom{
  width: calc(100% - var(--fp-qr-reserve)) !important;
  left: calc(50% - (var(--fp-qr-reserve) / 2)) !important;
  transform: translateX(-50%) !important;
}
.fp-export .fp-qrcode-label{display:none !important;}
.fp-export .fp-qrcode-box{border:0 !important; outline:0 !important;}
.fp-export #fpQR{display:block !important; background:#fff;}



/* PATCH v7: bandeau fiche de poste plus compact */
#dlgFichePoste .fp-banner{padding:6px 18px !important;}
#dlgFichePoste .fp-banner-title{font-size:20px !important;}
#dlgFichePoste .fp-banner-sub{font-size:12px !important;}

/* Nom équipement (remplace le token gris) */
#dlgFichePoste .fp-equip-name{
  margin-top:6px;
  font-size:18px;
  font-weight:800;
  letter-spacing:.2px;
  text-align:left;
  color:#EAF2FF;
  opacity:.98;
  line-height:1.15;
  max-width:640px;
}
@media (max-width: 900px){
  #dlgFichePoste .fp-equip-name{font-size:17px;max-width:100%}
}
/* PATCH v6: supprimer bandeau noir / marges hautes dans le widget */
html,body{margin:0 !important; padding:0 !important;}
#app,.app,.wrap,.page,.pp-root,.main,.container{margin-top:0 !important; padding-top:0 !important;}


/* Désactive le panneau diagnostic (pptrFuse) */
#pptrFuse{display:none !important;}

/* FP Nature des travaux : 2 lignes et ne chevauche pas le QR */
#fpNature{min-height:4.8em !important; resize:vertical !important;}
.fp-nature{max-width:calc(100% - 250px) !important;}


/* Export PNG : figer une mise en page propre */
body.fp-exporting .fp-header-bottom{margin-left:0 !important; margin-right:0 !important; display:flex !important; justify-content:center !important;}
body.fp-exporting .fp-display{margin-left:auto !important; margin-right:auto !important;}
body.fp-exporting #fpMachineName{margin-left:auto !important; margin-right:auto !important; left:auto !important; right:auto !important; transform:none !important;}
body.fp-exporting .fp-header-bottom{padding-left:24px !important; padding-right:24px !important;}
body.fp-exporting .fp-header-top{padding-left:24px !important; padding-right:24px !important;}
body.fp-exporting .fp-actions-top{display:none !important;}

/* Export PNG/PDF: garantir centrage du token dans le bandeau bleu */
.fp-exporting-doc #fpMachineName{
  margin-left:0 !important;
  margin-right:0 !important;
  max-width:100% !important;
  justify-content:center !important;
  text-align:center !important;
}
.fp-exporting-doc .fp-header-bottom{
  display:flex !important;
  justify-content:center !important;
}


/* ===== PATCH V22 - Export PNG : centrage token + largeur utile (hors QR) ===== */
html.fp-exporting-doc #fpWrapper .fp-banner{ position: relative !important; }
html.fp-exporting-doc #fpWrapper .fp-header-bottom{
  width: calc(100% - var(--fp-qr-reserve)) !important;
  margin: 10px 0 0 !important;
  padding: 0 28px !important;
  box-sizing: border-box !important;
  display: flex !important;
  justify-content: center !important;
}
html.fp-exporting-doc #fpWrapper #fpMachineName{
  margin: 0 auto !important;
  max-width: 100% !important;
}


/* ===== V35 PATCH (header layout + buttons + QR) ===== */
.fp-overlay{background: rgba(0,0,0,.55)!important;}
.fp-dialog{background:#fff!important;}
/* Make head row a single plane */
.fp-headrow{display:block!important;}
/* Header as grid with right area */
.fp-header{
  display:grid!important;
  grid-template-columns: 1fr auto;
  align-items:center!important;
  gap:14px!important;
}
/* Right area (buttons + QR) */
.fp-header-right{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:12px;
}
.fp-actions{
  display:flex!important;
  align-items:center!important;
  justify-content:flex-end!important;
  gap:10px!important;
  background:transparent!important;
  padding:0!important;
  margin:0!important;
}
/* keep buttons vertically centered on banner */
.fp-actions button{margin:0!important;}
/* Hide QR settings button */
#fpQrSettings{display:none!important;}
/* QR box inside banner: smaller + no overlap */
.fp-qrcode-box{
  margin:0!important;
  padding:0!important;
  background:transparent!important;
  box-shadow:none!important;
}
.fp-qrcode-box .fp-qr{
  background:#fff;
  border-radius:12px;
  padding:10px;
  box-shadow: 0 10px 28px rgba(0,0,0,.18);
}
/* Equipment name left under label (already) */
.fp-title .fp-equip-name{display:block;text-align:left!important;}


/* V40: QR clickable + centered */
#fpQrBox{display:flex;align-items:center;justify-content:center;overflow:hidden;}
#fpQrBox a{display:flex;align-items:center;justify-content:center;width:100%;height:100%;}
#fpQrBox canvas,#fpQrBox img,#fpQrBox table{max-width:100%;max-height:100%;width:100%!important;height:100%!important;margin:auto;display:block;}
#fpQrBox canvas,#fpQrBox img,#fpQrBox table{pointer-events:none;}

/* Filtre Type (équipement/produit) sous Alpha */
.kind-modes{margin-top:8px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
.kind-mode{display:inline-flex; align-items:center; gap:6px; font-size:12px; cursor:pointer; opacity:.9;}
.kind-mode input{transform: translateY(1px);}
.kind-mode.active{font-weight:700; opacity:1;}

/* Affichage Type dans la fiche de poste (sans radios visibles) */
.fp-kind-display{margin-top:6px; font-size:13px; font-weight:800;}

/* Radios Type dans le panneau et la fiche */
.type-inline{display:flex; gap:14px; align-items:center; flex-wrap:wrap;}
.type-opt{
  display:inline-flex; 
  gap:8px; 
  align-items:center; 
  font-size:14px;
  font-weight:600;
  padding: 8px 16px;
  border: 2px solid rgba(148, 163, 184, 0.3);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  background: rgba(15, 23, 42, 0.3);
}
.type-opt:hover{
  border-color: rgba(148, 163, 184, 0.6);
  background: rgba(15, 23, 42, 0.5);
}
.type-opt input{
  transform: scale(1.4);
  cursor: pointer;
  margin: 0;
}
.type-opt.type-active{
  font-weight:800;
  background: rgba(56, 189, 248, 0.2);
  border: 2px solid rgba(56, 189, 248, 0.8);
  box-shadow: 0 0 12px rgba(56, 189, 248, 0.4);
  color: rgb(125, 211, 252);
}
.type-opt.type-active input{
  accent-color: rgb(56, 189, 248);
}

/* QR : centré et contenu dans le carré (lightbox + export) */
.fp-qrcode-box{
  display:flex !important;
  align-items:center !important;
  justify-content:center !important;
  overflow:hidden !important;
}
#fpQR{width:100%; height:100%; display:flex; align-items:center; justify-content:center;}
#fpQR canvas, #fpQR img, #fpQR table{
  max-width:100% !important;
  max-height:100% !important;
  width:auto !important;
  height:auto !important;
  display:block !important;
  margin:auto !important;
  pointer-events:none;
}



/* Toast sauvegarde (verre fluo) */
#ppSaveToast{
  position:fixed;
  right:10px;
  bottom:54px; /* au-dessus du badge version */
  z-index:99999;
  padding:10px 12px;
  border-radius:14px;
  font:12px system-ui;
  background:rgba(2,6,23,.55);
  color:rgba(226,232,240,.92);
  border:1px solid rgba(34,197,94,.35);
  box-shadow:0 10px 28px rgba(0,0,0,.25), inset 0 0 18px rgba(34,197,94,.08);
  backdrop-filter: blur(8px);
  transform:translateY(6px);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
  max-width:min(340px, calc(100vw - 20px));
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#ppSaveToast.show{ opacity:1; transform:translateY(0); }


/* ====== DREETS : 2 colonnes (gauche = workflow / droite = caractéristiques produit) ====== */
.dreets-layout{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  align-items:start;
}
.dreets-layout .dreets-left .block:last-child{ margin-bottom:0; }
.dreets-layout .dreets-right .block{ margin-top:0; }
@media (max-width: 980px){
  .dreets-layout{ grid-template-columns: 1fr; }
}
/* Quand "Caractéristiques" n'est plus à droite de Photo/VGP, on laisse Photo/VGP prendre toute la ligne */
.photo-product-row{
  display:block;
}
.photo-product-row .photo-left{ width:100%; }



/* ================== PATCH V32 (mise en page DREETS + fiche de poste) ================== */

/* DREETS : panneau sous le DDFPT, dans la colonne de droite uniquement */
#rightPane{display:flex; flex-direction:column;}
.panel.panel-dreets{margin-top:4px;}  /* Réduit de 14px à 4px pour coller au DDFPT */
.dreets-layout{
  display:grid;
  grid-template-columns:1fr 1fr;  /* 50/50 pour Travaux+Régime / Précisions+Observations */
  gap:16px;
  align-items:start;
}
.dreets-bottom{
  grid-column:1 / -1;
  margin-top:8px;
}
.dreets-overlap-block .block-title{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  gap:10px;
}
.tag-dreets{
  font-size:11px;
  font-weight:900;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--dreets-pink);
}

/* DDFPT : le cadre bleu doit englober Photo/VGP */
.panel.panel-ddfpt{padding-bottom:14px;}
.block.block-photo-vgp{margin-top:10px;}

/* FICHE DE POSTE : pas de bloc “parasite” dans la photo */
#fpPersoBlock{display:none !important;}

/* FICHE DE POSTE : garder la grille 3 colonnes même en export/viewport étroit */
@media (max-width:900px){
  .fp-grid3,
  .fp-grid3-bottom{
    grid-template-columns:repeat(3,minmax(0,1fr));
  }
}

/* FICHE DE POSTE : forcer les colonnes à être égales et empêcher le débordement */
.fp-grid3{
  grid-template-columns:repeat(3,minmax(0,1fr)) !important;
  width: 100%;
}
.fp-grid3 .fp-col{
  min-width:0;
  max-width:100%;
  overflow:hidden;
}
.fp-grid3 .fp-card-orange,
.fp-grid3 .fp-card-green,
.fp-grid3 .fp-card-blue{
  width:100%;
  max-width:100%;
  min-width:0;
  box-sizing:border-box;
  word-wrap:break-word;
  overflow-wrap:break-word;
}
.fp-grid3 .fp-textarea{
  width:100%;
  max-width:100%;
  min-width:0;
  box-sizing:border-box;
}
.fp-grid3 .fp-select-row{
  width:100%;
  max-width:100%;
}
.fp-grid3 .fp-select{
  max-width:100%;
}

/* Mêmes contraintes pour la grille du bas */
.fp-grid3-bottom{
  grid-template-columns:repeat(3,minmax(0,1fr)) !important;
  width: 100%;
}
.fp-grid3-bottom .fp-col{
  min-width:0;
  max-width:100%;
  overflow:hidden;
}
.fp-grid3-bottom .fp-card-blue,
.fp-grid3-bottom .fp-card-red,
.fp-grid3-bottom .fp-card-brown{
  width:100%;
  max-width:100%;
  min-width:0;
  box-sizing:border-box;
  word-wrap:break-word;
  overflow-wrap:break-word;
}
.fp-grid3-bottom .fp-textarea{
  width:100%;
  max-width:100%;
  min-width:0;
  box-sizing:border-box;
}



/* DREETS : Limiter la hauteur de la liste des travaux */
.trav-list{
  
  overflow-y:auto;
}

/* DREETS : Ajuster les hauteurs des textareas pour équilibrer avec Travaux + Régime */
#precisions.dreets-tall-textarea{
  min-height:140px !important;  /* Augmenté pour équilibrer */
}

#observations.dreets-tall-textarea{
  min-height:100px !important;  /* Ajusté pour alignement avec Régime */
}

</style>
<style>
/* ===== PATCH SAFE OVERLAYS (no click-block when closed) ===== */
#dlgFichePoste.fp-overlay{display:none; pointer-events:none; z-index:99999;}
#dlgFichePoste.fp-overlay.is-open{display:flex; pointer-events:auto;}
/* Ensure FP dialog centered and scroll internal */
#dlgFichePoste .fp-dialog{margin:0; max-height:92vh; overflow:auto; width:min(1200px,96vw);}
</style>

<style>
/* ===== PP-TR TEST MODAL (debug) ===== */
.pp-test-overlay{
  position:fixed; inset:0;
  background: rgba(15,23,42,.45);
  z-index: 2147483000;
  display:flex; align-items:center; justify-content:center;
}
.pp-test-modal{
  background:#fff; color:#0f172a;
  width:min(520px, 92vw);
  border-radius:16px;
  border:1px solid rgba(27,57,106,.35);
  box-shadow: 0 22px 60px rgba(15,23,42,.35);
  padding:18px 18px 14px;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}
.pp-test-title{
  margin:0 0 8px;
  font-weight:800;
}
.pp-test-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px;}
.pp-test-btn{
  background:#1b396a; color:#fff;
  border:0; border-radius:999px;
  padding:8px 14px; font-weight:700;
  cursor:pointer;
}
.pp-test-btn:active{ transform: translateY(1px); }
</style>
<style>

/* ===== PP-TR NEW LIGHTBOX (independent) ===== */
#dlgTravaux.pptr-open { display:block !important; }
#dlgTravaux { position: fixed; inset: 0; z-index: 9999999; display:none; }
#dlgTravaux .pptr-backdrop { position:absolute; inset:0; background: rgba(2, 6, 23, 0.55); }
#dlgTravaux .pptr-modal {
  position:absolute; left: 4vw; right:4vw; top: 4vh; bottom: 4vh;
  background: #ffffff; color:#0f172a;
  border-radius: 16px;
  box-shadow: 0 25px 70px rgba(2, 6, 23, 0.45);
  border: 1px solid rgba(27,57,106,0.35);
  overflow: hidden;
  display:flex; flex-direction:column;
}
#dlgTravaux .pptr-head{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 14px;
  background: linear-gradient(180deg, rgba(3,23,48,0.96), rgba(3,23,48,0.88));
  color:#e5f0ff;
}
#dlgTravaux .pptr-title{ font-weight: 800; letter-spacing: .2px; }
#dlgTravaux .pptr-sub{ font-size: 12px; opacity: .9; margin-top:2px; }
#dlgTravaux .pptr-close{
  width:32px; height:32px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.10); color:#fff; cursor:pointer;
}
#dlgTravaux .pptr-body{ padding: 0; overflow:auto; background:#f8fafc; }
#dlgTravaux table{ width:100%; border-collapse:collapse; table-layout: fixed; }
#dlgTravaux thead th{
  position: sticky; top:0; z-index:1;
  background: #0b2238; color:#e5f0ff;
  font-size: 12px; text-transform: none;
  padding: 10px 10px;
  border-bottom: 1px solid rgba(255,255,255,0.14);
}
#dlgTravaux tbody td{ padding: 10px 10px; vertical-align: top; border-bottom: 1px solid rgba(15,23,42,0.10); font-size: 13px; }
#dlgTravaux .pptr-col-travaux{ width: 34%; }
#dlgTravaux .pptr-col-red{ width: 22%; }
#dlgTravaux .pptr-col-orange{ width: 22%; }
#dlgTravaux .pptr-col-green{ width: 22%; }
#dlgTravaux .pptr-cell { border-left: 1px solid rgba(15,23,42,0.08); }
#dlgTravaux .pptr-red{ background: rgba(239,68,68,0.18); }
#dlgTravaux .pptr-orange{ background: rgba(245,158,11,0.20); }
#dlgTravaux .pptr-green{ background: rgba(34,197,94,0.18); }
#dlgTravaux .pptr-foot{
  display:flex; justify-content:flex-end; gap:10px;
  padding: 10px 12px;
  background:#ffffff;
  border-top: 1px solid rgba(15,23,42,0.10);
}
#dlgTravaux .pptr-btn{
  padding: 8px 12px; border-radius: 999px; border:1px solid rgba(15,23,42,0.18);
  background: #ffffff; color:#0f172a; cursor:pointer; font-weight: 700;
}
#dlgTravaux .pptr-btn-primary{ background: #f59e0b; border-color:#f59e0b; color:#111827; }
#dlgTravaux .pptr-badge{ font-size:12px; opacity:.95; }

.pptr-chip{ display:inline-flex; align-items:center; gap:8px;
  padding: 6px 10px; border-radius: 999px; font-size: 13px; font-weight: 700;
  border: 1px solid rgba(15,23,42,0.12); margin: 4px 6px 0 0;
}
.pptr-chip small{ font-weight:600; opacity:.85; }
.pptr-chip.red{ background: rgba(239,68,68,0.20); }
.pptr-chip.orange{ background: rgba(245,158,11,0.22); }
.pptr-chip.green{ background: rgba(34,197,94,0.20); }


/* ===== PATCH: dlgClearTravaux toujours au premier plan ===== */
#dlgClearTravaux{
  z-index:2147483646 !important;
}
#dlgClearTravaux .modal-inner, #dlgClearTravaux .confirm-inner{
  position:relative;
  z-index:2147483647 !important;
}


/* ===== PATCH: visibilité lightbox Travaux (robuste malgré CSS empilés) ===== */
#dlgTravaux{
  display:none;
  position:fixed;
  inset:0;
  z-index:2147482000;
}
#dlgTravaux[aria-hidden="false"],
#dlgTravaux.pptr-open{
  display:block !important;
}
#dlgTravaux .trav-modal{
  position:absolute;
  left:3vw; right:3vw; top:3vh; bottom:3vh;
  margin:auto;
  max-width:1400px;
  display:flex;
  flex-direction:column;
}
#dlgTravaux .trav-body{ overflow:auto; }


/* ===== PATCH: Fiche de poste – bandeau + QR 210x210 ===== */
.fp-banner{
  padding:10px 18px 14px !important; /* hauteur réduite */
}
.fp-banner-left{
  margin-left:8px !important; /* titre un poil plus à gauche */
}
.fp-banner-right{
  gap:10px !important;
  margin-right:8px !important;
}
.fp-actions-top{
  margin-top:0 !important;
}
.fp-qrcode-box{
  width:230px !important;
  height:230px !important;
  border-radius:14px !important;
  padding:8px !important;
}
.fp-qrcode-box img#fpQR{
  max-width:210px !important;
  max-height:210px !important;
  width:210px !important;
  height:210px !important;
  display:block !important;
}


/* ================= PATCH v4 — FICHE DE POSTE (BANDEAU + EXPORT) ================= */
/* Objectif:
   - Bandeau bleu qui s'arrête juste avant le QR (sans le toucher)
   - Token gris centré dans la zone bleue (pas sous le QR)
   - QR 210x210 conservé
*/
:root{
  --fp-qr-size: 210px;
  --fp-qr-gap: 14px;
  --fp-qr-reserve: calc(var(--fp-qr-size) + var(--fp-qr-gap) + 16px);
}

/* Fond partiel via pseudo-élément */
.fp-banner{
  position: relative;
  background: none !important;
  padding-left: 18px !important;
  padding-right: 18px !important;
}

/* Zone bleue à gauche, arrêtée avant le QR */
.fp-banner::before{
  content: "";
  position: absolute;
  inset: 0;
  right: var(--fp-qr-reserve);
  border-radius: 18px;
  background: linear-gradient(90deg,#1b396a 0%,#3f72af 100%);
  z-index: 0;
}

/* Contenus au-dessus */
.fp-banner-left,
.fp-banner-right{
  position: relative;
  z-index: 1;
}

/* QR 210x210 */
.fp-qrcode-box{
  width: var(--fp-qr-size) !important;
  height: var(--fp-qr-size) !important;
}
.fp-qrcode-box img,
.fp-qrcode-box canvas{
  max-width: var(--fp-qr-size) !important;
  max-height: var(--fp-qr-size) !important;
  display:block;
}

/* Token gris centré dans la partie bleue (on enlève la réserve QR) */
.fp-header-bottom{
  width: calc(100% - var(--fp-qr-reserve)) !important;
  left: calc(50% - (var(--fp-qr-reserve) / 2)) !important;
  transform: translateX(-50%) !important;
}

/* Titre légèrement plus à gauche */
.fp-banner-title{
  margin-left: 4px;
}

/* Boutons un poil plus à gauche (moins "collés" au QR) */
.fp-actions-top{
  margin-right: 8px;
}


/* ===== PATCH v11 — Fiche de poste: compaction + alignements + supprimer bandeau noir ===== */
#topSpacer{height:0 !important; display:none !important;}

#dlgFichePoste .fp-banner{
  padding:6px 18px 8px !important; /* bandeau bleu plus bas */
}
#dlgFichePoste .fp-banner-title{line-height:1.05;}
#dlgFichePoste .fp-banner-sub{margin-top:2px;}

#dlgFichePoste .fp-banner-right{
  display:grid !important;
  grid-template-columns: 1fr var(--fp-qr-size) !important;
  column-gap: var(--fp-qr-gap) !important;
  align-items:start !important;
}
#dlgFichePoste .fp-year{grid-column:1; justify-self:end; align-self:start;}
#dlgFichePoste .fp-actions-top{
  grid-column:1;
  justify-self:center;
  align-self:center;
  margin:0 !important;
}
#dlgFichePoste .fp-qrcode-box{
  grid-column:2;
  justify-self:end;
  align-self:start;
  margin:0 !important;
}

/* La zone "Nature des travaux" ne doit jamais passer sous le QR */
#dlgFichePoste .fp-topline{
  padding-right: var(--fp-qr-reserve) !important;
  margin-top:4px !important;
}
#dlgFichePoste .fp-section-diplomes{
  padding-right: var(--fp-qr-reserve) !important;
  margin-top:10px !important;
}
/* Remonte un peu le contenu sous le bandeau */
#dlgFichePoste .fp-content{padding-top:10px !important;}

/* FP EXPORT: lock header layout so token stays centered in PNG */
html.fp-exporting-doc #fpHeaderBar{display:flex !important; align-items:stretch !important;}
html.fp-exporting-doc #fpHeaderLeft{flex:1 1 auto !important;}
html.fp-exporting-doc #fpMachineName{margin:0 auto !important; left:auto !important; right:auto !important; transform:none !important; max-width:calc(100% - 10px) !important;}
</style>

<!-- ===== V32 PATCH (layout fiche de poste) ===== -->
<style id="pptr-v32-fp">
#dlgFichePoste.fp-overlay{position:fixed; inset:0; display:none; align-items:flex-start; justify-content:center; padding:16px; background:rgba(2,6,23,.55); z-index:2147483000;}
#dlgFichePoste.fp-overlay.is-open{display:flex;}
#dlgFichePoste .fp-dialog{background:#fff; color:#0f172a; width:min(1280px, 96vw); max-height:92vh; overflow:auto; border-radius:18px; box-shadow:0 25px 70px rgba(2,6,23,.45); border:1px solid rgba(27,57,106,.35);}

/* Header must be in same flow as content */
#dlgFichePoste .fp-header{position:relative; display:block;}
#dlgFichePoste .fp-banner{display:flex; align-items:stretch; justify-content:space-between; gap:16px; padding:16px 18px; background:linear-gradient(180deg,#1B396A,#3F72AF); color:#fff; border-radius:18px 18px 0 0;}
#dlgFichePoste .fp-banner-left{display:flex; flex-direction:column; justify-content:center; min-width:260px;}
#dlgFichePoste .fp-banner-title{font-size:34px; font-weight:900; letter-spacing:2px; margin:0;}
#dlgFichePoste .fp-banner-sub{font-size:18px; opacity:.95; margin-top:2px;}
#dlgFichePoste .fp-equip-name{font-size:18px; font-weight:800; margin-top:10px;}

#dlgFichePoste .fp-banner-right{display:flex; align-items:flex-start; gap:14px;}
#dlgFichePoste .fp-actions-stack{display:flex; flex-direction:column; align-items:flex-end; gap:10px;}
#dlgFichePoste .fp-year{display:none !important;} /* on évite la pastille année qui casse des alignements */
#dlgFichePoste .fp-actions-top{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
#dlgFichePoste .fp-qrcode-box{background:#fff; border-radius:14px; padding:10px; width:180px; height:180px; display:flex; align-items:center; justify-content:center;}
#dlgFichePoste .fp-qr{width:160px; height:160px;}
#dlgFichePoste .fp-qr canvas, #dlgFichePoste .fp-qr img{width:160px !important; height:160px !important; display:block;}

/* Content sits UNDER the header (same sheet) */
#dlgFichePoste .fp-content{padding:18px 18px 22px; background:#fff;}

/* Export PNG: ensure full white background and no internal scroll cropping */
html.fp-exporting-doc #dlgFichePoste .fp-dialog{max-height:none !important; overflow:visible !important;}
html.fp-exporting-doc #dlgFichePoste{padding:0 !important; background:transparent !important;}
</style>

<style id="pptr-v32-ficheposte-fix">
/* ===== V32 — Fiche de poste: même plan, fond blanc, bandeau au-dessus de Nature des travaux ===== */
#dlgFichePoste.fp-overlay{
  position:fixed !important; inset:0 !important;
  background: rgba(2,6,23,0.55) !important;
  z-index: 2147483000 !important;
  display:none;
  align-items:flex-start !important;
  justify-content:center !important;
  padding: 3vh 2vw !important;
}
#dlgFichePoste.fp-overlay.is-open{ display:flex !important; }
#dlgFichePoste .fp-dialog{
  width: min(1200px, 96vw) !important;
  max-height: 94vh !important;
  overflow:auto !important;
  background:#ffffff !important;
  border-radius: 18px !important;
  box-shadow: 0 25px 70px rgba(2,6,23,0.45) !important;
  border: 1px solid rgba(27,57,106,0.35) !important;
}
#dlgFichePoste .fp-header{ margin:0 !important; }
#dlgFichePoste #fpHeaderBar.fp-banner{
  display:flex !important;
  align-items:stretch !important;
  justify-content:space-between !important;
  gap: 16px !important;
  width:100% !important;
  border-radius: 18px 18px 0 0 !important;
}
#dlgFichePoste #fpHeaderLeft{
  flex: 1 1 auto !important;
  min-width: 0 !important;
}
#dlgFichePoste #fpHeaderRight{
  flex: 0 0 auto !important;
  display:flex !important;
  align-items:flex-start !important;
  gap: 12px !important;
}
#dlgFichePoste .fp-actions-stack{
  display:flex !important;
  flex-direction:column !important;
  align-items:flex-end !important;
  gap: 6px !important;
}
#dlgFichePoste #fpQrBox.fp-qrcode-box{
  margin:0 !important;
  background: rgba(255,255,255,0.95) !important;
  border-radius: 12px !important;
  padding: 8px !important;
  border: 1px solid rgba(15,23,42,0.18) !important;
  box-shadow: 0 10px 25px rgba(2,6,23,0.18) !important;
}
#dlgFichePoste #fpQR.fp-qr{
  width: 160px !important;
  height: 160px !important;
}
#dlgFichePoste #fpQR canvas,
#dlgFichePoste #fpQR img{
  width: 160px !important;
  height: 160px !important;
  display:block !important;
}
/* Le titre équipement en texte (sans token) */
#dlgFichePoste #fpMachineName{
  font-size: 18px !important;
  font-weight: 800 !important;
  margin-top: 8px !important;
}
/* Petite marge sous le bandeau pour que Nature des travaux démarre juste dessous */
#dlgFichePoste .fp-content{ padding-top: 10px !important; }

/* ================= PATCH V33 — FICHE DE POSTE : header align + QR clickable + anti-double ================= */
#dlgFichePoste .fp-banner{position:relative !important;}
/* Nom équipement aligné à gauche sous "Equipement – produit" */
#dlgFichePoste .fp-banner-left{align-items:flex-start !important; text-align:left !important;}
#dlgFichePoste .fp-equip-name{display:block; width:100%; text-align:left !important; margin-top:6px !important;}

/* Boutons centrés dans le bandeau bleu */
#dlgFichePoste .fp-actions-stack{position:static !important;}
#dlgFichePoste .fp-actions-top{
  position:absolute !important;
  left:50% !important;
  top:50% !important;
  transform:translate(-50%,-50%) !important;
  justify-content:center !important;
  align-items:center !important;
  gap:10px !important;
  z-index:3 !important;
}

/* Zone QR tout à droite, dans le flux */
#dlgFichePoste .fp-banner-right{align-items:center !important; gap:14px !important;}
#dlgFichePoste .fp-qrcode-box{
  width:190px !important;
  height:190px !important;
  padding:10px !important;
  z-index:2 !important;
}
#dlgFichePoste #fpQR{cursor:pointer;}
#dlgFichePoste #fpQR .fp-qr-tooltip{display:none !important;} /* on garde le title natif */

</style>

<style id="pp-fp-v36-patch">
/* === V36 PATCH: header fiche de poste dans le même plan + boutons alignés === */
#dlgFichePoste .fp-dialog{background:#fff !important;}
#dlgFichePoste .fp-banner{
  display:grid !important;
  grid-template-columns: 1fr auto 230px !important;
  align-items:center !important;
  column-gap:14px !important;
}
#dlgFichePoste .fp-banner-left{align-self:center !important;}
#dlgFichePoste .fp-equip-name{
  text-align:left !important;
  margin-top:6px !important;
  font-size:18px !important;
  font-weight:800 !important;
}
#dlgFichePoste .fp-year{display:none !important;}
#dlgFichePoste .fp-actions-top{
  display:flex !important;
  flex-direction:row !important;
  align-items:center !important;
  justify-content:center !important;
  gap:10px !important;
  margin:0 !important;
}
#dlgFichePoste #fpBtnQrSetup{display:none !important;}
#dlgFichePoste #fpHeaderRight{
  display:contents !important; /* grid children become: actions + qrcode */
}
#dlgFichePoste .fp-qrcode-box{
  width:230px !important;
  justify-self:end !important;
  align-self:center !important;
}
#dlgFichePoste #fpQR{cursor:pointer !important;}
#dlgFichePoste #fpQR a{display:block; width:100%; height:100%;}
#dlgFichePoste #fpQR canvas, #dlgFichePoste #fpQR img{
  width:210px !important;
  height:210px !important;
  display:block !important;
}


</style>


<!-- ===== PATCH V28.6 – ÉQUILIBRAGE FINAL : HAUT -20% + PHOTO + HAUT (écran + PNG) ===== -->
<style id="pp-fp-balance-v28-6">

/* Objectif: rendre la rangée haute plus compacte (écran + export) */
.fp-col-act  > .fp-card-blue,
.fp-col-sit  > .fp-card-orange,
.fp-col-prev > .fp-card-green{
  min-height:170px !important;   /* -20% (par rapport à ~210/200) */
}

/* PHOTO : un peu moins haute (écran) */
.fp-photo-box{
  height:260px !important;       /* était ~280/320 selon versions */
}
.fp-photo-box img{
  width:100% !important;
  height:100% !important;
  object-fit:contain !important;
}

/* Textareas haut (situations/prévention) : suivent la nouvelle compacité */
.fp-col-sit .fp-textarea,
.fp-col-prev .fp-textarea{
  min-height:140px !important;
}

/* Même compacité en PNG (clone html2canvas) */
.fp-exporting-doc .fp-col-act  > .fp-card-blue,
.fp-exporting-doc .fp-col-sit  > .fp-card-orange,
.fp-exporting-doc .fp-col-prev > .fp-card-green{
  min-height:170px !important;
}
.fp-exporting-doc .fp-photo-box{
  height:260px !important;
}
.fp-exporting-doc .fp-col-sit .fp-textarea,
.fp-exporting-doc .fp-col-prev .fp-textarea{
  min-height:140px !important;
}

</style>


<!-- ===== PATCH V28.8 – ÉCRAN : PHOTO LÉGÈREMENT RÉDUITE (PNG inchangé) ===== -->
<style id="pp-fp-photo-screen-v28-8">
/* Photo "à l'écran" : on évite toute sensation de zoom/cadrage en
   laissant le navigateur respecter le ratio natif, avec juste une marge (max 92%).
   Le PNG reste inchangé via .fp-exporting-doc */
.fp-photo-box img{
  width:auto !important;
  height:auto !important;
  max-width:92% !important;
  max-height:92% !important;
  object-fit:contain !important; /* sécurité */
  margin:auto !important;
  display:block !important;
}

/* En export PNG, on reprend 100% pour garder le rendu parfait */
.fp-exporting-doc .fp-photo-box img{
  width:100% !important;
  height:100% !important;
  max-width:100% !important;
  max-height:100% !important;
}
</style>


<!-- ===== PATCH V29.0 – Lightbox modes réactivées + champs code masqués ===== -->
<style id="pp-lightbox-fix-v29-0">
/* Certaines versions forçaient ces lightbox à rester cachées via display:none !important.
   On rétablit l'affichage quand aria-hidden="false" (logique déjà utilisée dans le HTML). */
#dlgAddMode[aria-hidden="false"],
#dlgAddModeDreets[aria-hidden="false"],
#dlgAdminMode[aria-hidden="false"],
#dlgAdminDelete[aria-hidden="false"]{
  display:flex !important;
  pointer-events:auto !important;
}

/* Et quand elles sont cachées, on coupe bien les interactions */
#dlgAddMode[aria-hidden="true"],
#dlgAddModeDreets[aria-hidden="true"],
#dlgAdminMode[aria-hidden="true"],
#dlgAdminDelete[aria-hidden="true"]{
  display:none !important;
  pointer-events:none !important;
}
</style>

</head>

<body data-theme="dark" style="margin:0;padding:0;">

<div id="topSpacer"></div>

<!-- PP-TR VERSION BADGE -->

<div id="ppSaveToast" aria-hidden="true">Modification enregistrée</div>

<div class="wrap">
<div class="layout">
<!-- ================== COLONNE GAUCHE ================== -->
<div class="left-col">
<!-- Equipement en cours -->
<div class="current-equip">
<div class="current-equip-label">Equipement en cours</div>
<div class="current-equip-name" id="currentEquipName">—</div>
</div>
<!-- Nouvel équipement (grisé / verrouillé au départ) -->
<div class="left-block left-block-disabled" id="new-block">
<div class="left-block-title">Nouvel équipement
</div>
<div class="row row-nowrap">
<input class="text-input" disabled="" id="newName" placeholder="Nouvel équipement (libellé)…"/>
<button class="btn-circle" disabled="" id="addBtn">✓</button>
<button class="btn-circle" disabled="" id="clearNew">✗</button>
</div>
</div>
<!-- Filtre texte -->
<div class="left-block">
<div class="left-block-title">Filtrer (alpha/domaine/secteur/diplôme)</div>
<div class="filter-modes">
<label class="filter-mode active">
<input checked="" name="filterMode" type="radio" value="autocomp"/>
            Alpha
          </label>
<label class="filter-mode">
<input name="filterMode" type="radio" value="domaine"/>
            Domaine
          </label>
<label class="filter-mode">
<input name="filterMode" type="radio" value="secteur"/>
            Secteur
          </label>
<label class="filter-mode">
<input name="filterMode" type="radio" value="diplome"/>
            Diplôme
          </label>
</div>

<div class="kind-modes">
  <label class="kind-mode active"><input type="radio" name="kindMode" value="all" checked> Tous</label>
  <label class="kind-mode"><input type="radio" name="kindMode" value="equipement"> Equipements</label>
  <label class="kind-mode"><input type="radio" name="kindMode" value="produit"> Produits</label>
</div>
<div class="row row-nowrap">
<input class="text-input" id="filter" placeholder="Filtrer…" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="search">
<button class="btn-circle" id="applyFilter">✓</button>
<button class="btn-circle" id="clearFilter">✗</button>
</input></div>
<datalist id="dl-filter-domain"></datalist>
<datalist id="dl-filter-secteur"></datalist>
<datalist id="dl-filter-diplome"></datalist>
<!-- Filtre couleur -->
<div class="color-filter-row">
<span>Filtre couleur :</span>
<div class="color-badges">
<div class="color-dot" data-col="none" title="Tous"></div>
<div class="color-dot" data-col="red" title="Interdiction absolue"></div>
<div class="color-dot" data-col="orange" title="Travaux soumis à dérogation"></div>
<div class="color-dot" data-col="green" title="Travaux autorisés"></div>
<div class="color-dot" data-col="pink" title="À compléter par la DREETS"></div>
</div>
</div>
<div id="equip-count">0 équipements affichés</div>
<div class="row row-nowrap" style="margin-top:6px;">
  <button class="theme-toggle" id="exportBtn" type="button" style="width:100%;">Exporter (PDF)</button>
</div>
</div>
<!-- Liste des équipements -->
<div class="list-wrap">
<div class="list" id="list"></div>
</div>
</div>
<!-- ================== COLONNE DROITE ================== -->
<div id="rightPane">
<div class="progress"><i id="pbar"></i></div>
<!-- ================== PANEL DDFPT (cadre bleu) ================== -->
<div class="panel panel-ddfpt">
<div class="panel-title-bar">
<div class="panel-title">
<span>▸</span>
<span>DDFPT</span>
<button class="delete-pill" id="delBtn" type="button">
              Supprimer <span id="delName">—</span>
</button>
</div>
<div class="panel-actions">
<button class="theme-toggle" id="fichePosteBtn" type="button">
              Fiche de poste
            </button>
<button class="theme-toggle" id="themeToggle" type="button">Mode clair</button>
<button class="theme-toggle" id="addModeBtn" type="button">Mode ajout DDFPT</button>
<button class="theme-toggle" id="adminModeBtn" type="button">Admin</button>
<a class="theme-toggle" href="https://preventionpaca.github.io/guide/" id="homeBtn" target="_top">
              Accueil
            </a>
</div>
</div>
<div class="add-mode-info" id="addModeInfo">
          Mode ajout activé pour <span id="addModeEtab">—</span>
</div>
<div class="block">
<div class="block-title"><div class="type-inline"><label class="type-opt"><input type="radio" name="equipTypeMain" id="typeEquipMain" value="equipement"> Equipement</label><label class="type-opt"><input type="radio" name="equipTypeMain" id="typeProduitMain" value="produit"> Produit</label></div></div>
<div class="equip-lib-wrapper">
<input class="input-pill" id="f-lib">
<div class="regime-badge regime-on-lib" id="regimeToken">—</div>
</input></div>
</div>
<!-- Nature des travaux + Secteur / Domaines -->
<div class="block">
<div class="trav-sect-grid">
<div class="trav-col">
<div class="block-title">Nature des travaux</div>
<textarea class="input-pill input-area" id="f-travaux" readonly readonly></textarea>
</div>
<div class="sectdom-col">
<div class="block-title">Secteur d'activité & domaines</div>
<div class="domains-col">
<div>
<div class="domains-title">Secteur d'activité</div>
<div class="domains-lines" id="sect-natural"></div>
</div>
<div>
<div class="domains-title">Domaines professionnels (synthèse)</div>
<div class="domains-lines" id="dp-natural"></div>
</div>
</div>
</div>
</div>
</div>
<div class="block">
<div class="block-title">Check par établissement</div>
<div class="row">
<input autocomplete="off" class="input-pill" id="check-etab-inp" list="dl-check-etab" placeholder="Choisir un établissement…">
<datalist id="dl-check-etab"></datalist>
<!-- bouton voir diplômes : stylé via .btn-pill-orange -->
<button class="btn btn-small btn-pill-orange" id="check-etab-open" type="button">
              Voir diplômes
            </button>
</input></div>
</div>
<div class="block block-dreets-slot">
<div class="block-title">Établissements sélectionnés</div>
<div class="natural-multi" id="et-natural"></div>
</div>
<div class="block block-diplomes-slot">
<div class="block-title">Diplômes concernés</div>
<div class="natural-multi" id="di-natural"></div>
</div>
<!-- VALIDATION DREETS (demande par établissement / admin) -->
<div class="block" id="dreetsRequestBlock">
  <div class="block-title">Validation DREETS</div>
  <div class="row" style="align-items:center; gap:10px; flex-wrap:wrap;">
    <button class="btn btn-small btn-pill-orange" id="btnAskDreets" type="button">A compléter par la Dreets</button>
    <div class="status" id="dreetsAskMsg"></div>
  </div>
  <div style="font-size:12px; opacity:.75; margin-top:6px;">
    Ce bouton sélectionne automatiquement le régime "A compléter par la Dreets" et envoie une notification (FormSubmit).
  </div>
</div>

<!-- CHAMPS PERSONNALISÉS (par établissement) -->
<div class="block" id="persoFieldsBlock" style="display:none;">
  <div class="block-title">Champs personnalisés (établissement)</div>
  <!-- Admin : choisir l’établissement cible (libellé) pour éditer comme l’établissement -->
  <div class="row" id="adminPersoTargetRow" style="display:none; margin-bottom:8px;">
    <input class="input-pill" id="adminTargetEtab" list="dl-check-etab" placeholder="(Admin) Établissement cible…" autocomplete="off" />
  </div>

  <div class="row" style="gap:10px; flex-wrap:wrap;">
    <div style="flex:1 1 180px; min-width:180px;">
      <div class="domains-title">Référence</div>
      <input class="input-pill" id="perso-reference" placeholder="Référence…" />
    </div>
    <div style="flex:1 1 180px; min-width:180px;">
      <div class="domains-title">Atelier</div>
      <input class="input-pill" id="perso-atelier" placeholder="Atelier…" />
    </div>
    <div style="flex:0 0 140px; min-width:140px;">
      <div class="domains-title">Année</div>
      <input class="input-pill" id="perso-annee" placeholder="Année…" />
    </div>
  </div>
  <div style="margin-top:8px;">
    <div class="domains-title">Notes</div>
    <textarea class="input-pill input-area" id="perso-notes" rows="3" placeholder="Notes…"></textarea>
  </div>
  <div class="status" id="persoMsg" style="margin-top:6px;"></div>
</div>
<!-- /CHAMPS PERSONNALISÉS -->

<!-- PHOTO / VGP / DOC -->
<div class="block block-photo-vgp">
<div class="block-title">Photo / VGP / Doc bureau de contrôle</div>
<div class="photo-product-row">
  <div class="photo-left">
<div class="photo-row">
<div>
<div class="photo-box" id="photoThumb" title="Cliquer pour agrandir">
<img alt="Aperçu" id="photoImg"/>
</div>
</div>
<div class="photo-side">
<div>
<div class="domains-title">Fichier image</div>
<a class="file-trigger" id="fileTrigger">Choisir un fichier…</a>
<input accept="image/*" id="filePick" style="display:none" type="file">
<div class="file-name-pill"><span id="fileName">Aucun fichier choisi</span></div>
</input></div>
<div>
<button class="btn btn-small" id="btnUpload">Téléverser</button>
<div class="status" id="photoMsg"></div>
</div>
<div class="row" id="adminPhotoSwitchRow" style="display:none; margin-top:6px; align-items:center; gap:10px;">
  <label style="display:flex; align-items:center; gap:8px; font-size:12px; opacity:.92;">
    <input type="checkbox" id="photoTargetSwitch" checked />
    <span>Photo établissement</span>
  </label>
  <span style="font-size:12px; opacity:.75;">(décocher = photo de base)</span>
</div>
<div>
<div class="domains-title">VGP</div>
<select id="vgp"></select>
</div>
<div>
<div class="domains-title">URL doc bureau de contrôle</div>
<div class="doc-row">
<input class="input-pill" id="docBureau" placeholder="Coller l'URL…"/>
<a class="btn btn-small" id="docOpen" target="_blank">Ouvrir</a>
</div>
</div>
</div>
</div>
  </div><!-- /.photo-left -->
  
  <!-- Bloc Caractéristiques à droite du PHOTO/VGP -->
  <div class="block dreets-overlap-block" id="dreetsProductBlock">
    <div class="block-title">Caractéristiques du produit / agent chimique <span class="tag-dreets">À compléter par la DREETS</span></div>
    <div class="dreets-product-grid">
<div class="dreets-field">
<label class="domains-title" for="dreets-type">Type</label>
<input class="input-pill" id="dreets-type"/>
</div>
<div class="dreets-field">
<label class="domains-title" for="dreets-famille">Famille de produits</label>
<input class="input-pill" id="dreets-famille"/>
</div>
<div class="dreets-field">
<label class="domains-title" for="dreets-agent">Agent chimique</label>
<input class="input-pill" id="dreets-agent"/>
</div>
<div class="dreets-field">
<label class="domains-title" for="dreets-clp">Danger CLP</label>
<input class="input-pill" id="dreets-clp"/>
</div>
<div class="dreets-field">
<label class="domains-title" for="dreets-epi">EPI recommandé</label>
<input class="input-pill" id="dreets-epi"/>
</div>
</div><!-- /.dreets-product-grid -->
  </div><!-- /#dreetsProductBlock -->
  
</div><!-- /.photo-product-row -->
</div>
<!-- fin bloc PHOTO/VGP -->

</div><!-- fin panel DDFPT -->

<!-- ================== PANEL DREETS (cadre vert) ================== -->
<div class="panel panel-dreets panel-dreets-overlap">
<div class="panel-title-bar">
<div class="panel-title">
<span>▸</span>
<span>DREETS</span>
</div>
<div class="panel-actions">
<button class="theme-toggle" id="dreetsAddModeBtn" type="button">MODE AJOUT DREETS</button>
</div>
</div>
<!-- Le reste du panneau DREETS (sous la zone imbriquée) -->
<div class="dreets-layout">
  <div class="dreets-left">
<div class="block">
<div class="block-title">Travaux réglementés</div>
<div class="trav-buttons">
<button class="btn btn-small" id="tr-choose" type="button">Sélectionner</button>
<button class="btn btn-small" id="tr-clear" type="button">Tout effacer</button>
</div>
<div class="trav-list" id="tr-lines"></div>
</div>
<div class="block" id="regimeBlock">
<div class="block-title">Régime d'interdiction / dérogation</div>
<select class="input-pill" id="f-regime"></select>
</div>
</div>
  <div class="dreets-right">
<!-- Précisions et Observations à droite avec hauteurs ajustées pour équilibrer avec Travaux + Régime -->
<div class="block">
<div class="block-title">Précisions sur le régime d'interdiction / dérogation</div>
<textarea class="input-pill input-area full-width-area dreets-tall-textarea" id="precisions" rows="6"></textarea>
</div>
<div class="block">
<div class="block-title">Observations</div>
<textarea class="input-pill input-area full-width-area dreets-tall-textarea" id="observations" rows="5"></textarea>
</div>
  </div><!-- /.dreets-right -->
</div><!-- /.dreets-layout -->
</div><!-- fin panel DREETS -->
</div><!-- fin panel DREETS -->
<!-- ================== /PANEL DREETS ================== -->




</div><!-- /rightPane -->
</div><!-- /layout -->
</div><!-- /wrap -->
<!-- Lightbox image -->
<div aria-hidden="true" id="lightbox">
<span aria-label="Fermer" class="close">✕</span>
<img alt="Aperçu" id="lightboxImg"/>
</div>
<!-- Lightbox diplômes -->
<div aria-hidden="true" id="dlgDiplomes">
<div class="modal-inner">
<div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
<div class="modal-title">Diplômes préparés — <span id="dlg-etab-name"></span></div>
<button aria-label="Fermer" class="modal-close" type="button">✕</button>
</div>
<div class="modal-body">
<div id="dlg-di-list"></div>
</div>
<div class="modal-footer">
<button class="btn btn-small" id="dlg-di-cancel" type="button">Annuler</button>
<button class="btn btn-small" id="dlg-di-ok" type="button">Valider</button>
</div>
</div>
</div>
<!-- Lightbox travaux réglementés -->
<div aria-hidden="true" id="dlgTravaux">
<div class="trav-modal">
<div class="trav-header" style="display:flex;align-items:center;justify-content:space-between">
<div style="font-weight:700;font-size:14px">Travaux réglementés — sélection</div>
<button class="btn btn-small" id="trav-close" type="button">✕</button>
</div>
<div class="trav-body">
<table class="trav-table" id="trav-table">
<thead>
<tr>
<th class="trav-col-travaux">Travaux</th>
<th class="trav-col-fiche">N° fiche</th>
<th class="trav-col-red">Travaux frappés d'interdiction totale</th>
<th class="trav-col-orange">Travaux interdits sous déclaration</th>
<th class="trav-col-green">Travaux autorisés non soumis à déclaration de dérogation</th>
</tr>
</thead>
<tbody id="trav-tbody"></tbody>
</table>
</div>
<div class="trav-footer">
<button class="btn btn-small" id="trav-cancel" type="button">Annuler</button>
<button class="btn btn-small" id="trav-validate" type="button">Valider</button>
</div>
</div>
</div>
<!-- Lightbox FICHE DE POSTE -->
<div aria-hidden="true" class="fp-overlay" id="dlgFichePoste">
<div class="fp-dialog" id="fpWrapper">
<!-- HEADER : bandeau bleu + barre équipement -->
<div class="fp-header" id="fpHeader">
<div class="fp-banner" id="fpHeaderBar">
  <div class="fp-banner-left" id="fpHeaderLeft">
    <div class="fp-banner-title">FICHE DE POSTE</div>
    <div class="fp-kind-line" style="margin-top:4px; display:flex; gap:10px; align-items:center;"><span class="domains-title" style="margin:0;">Type :</span><span id="fpKindDisplay" style="font-weight:800;">—</span></div><div class="type-inline" style="margin-top:4px; display:none;"><label class="type-opt"><input type="radio" name="fpKind" id="fpKindEquip" value="equipement"> Equipement</label><label class="type-opt"><input type="radio" name="fpKind" id="fpKindProduit" value="produit"> Produit</label></div>
    <div class="fp-equip-name" id="fpMachineName">—</div>
  </div>

  <div class="fp-banner-right" id="fpHeaderRight">
    <div class="fp-actions-top">
        <button id="fpBtnQrSetup" class="fp-btn fp-btn-lite" title="Régler l’URL du QR code">Réglage QR</button>
        <button id="fpCancel" type="button">Annuler</button>
        <button id="fpExportShot" type="button">Enregistrer sous</button>
        <button id="fpSave" type="button">Valider</button>
      </div>

    <div class="fp-qrcode-box" id="fpQrBox">
      <a id="fpQrLink" href="#" target="_blank" rel="noopener"><div id="fpQR" class="fp-qr"></div></a>
    </div>
  </div>
</div>
</div>

<!-- CONTENU -->
<div class="fp-content">
<!-- Nature des travaux -->
<div class="fp-topline">
<div class="fp-section">
<label for="fpNatureTravaux">Nature des travaux réalisés</label>
<textarea class="fp-textarea" id="fpNatureTravaux" readonly rows="2" readonly readonly></textarea>
</div>
</div>
<!-- Diplômes associés -->
<div class="fp-section fp-section-diplomes">
<label>Diplômes associés</label>
<div class="fp-diplomes" id="fpDiplomes"></div>
</div>
<!-- Ligne du haut : Photo / Situations / Prévention -->
<div class="fp-grid3">
<!-- PHOTO -->
<div class="fp-col fp-col-act">
<div class="fp-card-blue">
<h3>Photo</h3>
<small> </small>
<div class="fp-photo-box" style="margin-top:8px;">
<img alt="" id="fpPhoto" src=""/>
<div class="fp-photo-empty" id="fpPhotoEmpty">Aucune photo disponible</div>
</div>
<div class="fp-perso" id="fpPersoBlock" style="margin-top:10px; padding:8px 10px; border-radius:12px; border:1px solid rgba(148,163,184,0.35); background: rgba(15,23,42,0.18);">
  <div style="font-weight:800; font-size:12px; margin-bottom:6px; opacity:.95;">Champs établissement</div>
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px 10px; font-size:12px;">
    <div><span style="opacity:.75;">Référence :</span> <span id="fpPersoRef">—</span></div>
    <div><span style="opacity:.75;">Atelier :</span> <span id="fpPersoAtelier">—</span></div>
    <div><span style="opacity:.75;">Année :</span> <span id="fpPersoAnnee">—</span></div>
    <div><span style="opacity:.75;">Notes :</span> <span id="fpPersoNotes">—</span></div>
</div>
</div>
</div>
</div>
<!-- SITUATIONS DANGEREUSES -->
<div class="fp-col fp-col-sit">
<div class="fp-card-orange">
<h3>Situations dangereuses</h3>
<small>Situations à risque, phases délicates, malfaçons possibles…</small>
<div class="fp-select-row">
<select class="fp-select" id="fpSituationsSelect"></select>
<button class="fp-select-add" id="fpSituationsAdd">Ajouter</button>
</div>
<textarea class="fp-textarea" id="fpSituations"></textarea>
</div>
</div>
<!-- PRÉVENTION -->
<div class="fp-col fp-col-prev">
<div class="fp-card-green">
<h3>Prévention</h3>
<small>Mesures de prévention, organisation, consignes, EPC / EPI…</small>
<div class="fp-select-row">
<select class="fp-select" id="fpPreventionSelect"></select>
<button class="fp-select-add" id="fpPreventionAdd">Ajouter</button>
</div>
<textarea class="fp-textarea" id="fpPrevention"></textarea>
</div>
</div>
</div>
<!-- Ligne du bas : Environnement / Numéros d'urgence / Prérequis -->
<!-- Ligne du bas : Environnement / Numéros d'urgence / Prérequis -->
<!-- Ligne du bas : Environnement / Numéros d'urgence / Prérequis -->
<div class="fp-grid3-bottom">
<!-- ENVIRONNEMENT (textarea plus haute) -->
<div class="fp-col fp-col-env">
<div class="fp-card-blue fp-card-env">
<h3>ENVIRONNEMENT</h3>
<small>Local, ambiance, co-activité, circulation, stockage…</small>
<div class="fp-select-row">
<select class="fp-select" id="fpEnvironnementSelect"></select>
<button class="fp-select-add" id="fpEnvironnementAdd">Ajouter</button>
</div>
<textarea class="fp-textarea" id="fpEnvironnement"></textarea>
</div>
</div>
<!-- NUMÉROS D'URGENCE + SIGNATURE / DATE SOUS LE BLOC ROUGE -->
<div class="fp-col fp-col-urg">
<div class="fp-card-red">
<h3>NUMÉROS D'URGENCE</h3>
<div class="fp-urg-buttons">
<span class="fp-urg-btn">15 – SAMU</span>
<span class="fp-urg-btn">18 – Pompiers</span>
<span class="fp-urg-btn">112 – Urgence européenne</span>
</div>
</div>
<!-- Pied de page recentré juste sous le bloc rouge -->
<div class="fp-footer">
<div class="fp-footer-inner">
<div class="fp-footer-date">
                Date : ____ / ____ / ______
              </div>
<div class="fp-footer-sign">
<span>Signature du responsable :</span>
<span class="fp-signature-box"></span>
</div>
</div>
</div>
</div> <!-- /.fp-col-urg -->
<!-- PRÉREQUIS (textarea plus haute) -->
<div class="fp-col fp-col-prereq">
<div class="fp-card-brown">
<h3>Prérequis</h3>
<small>Compétences, habilitations, autorisations nécessaires</small>
<div class="fp-select-row">
<select class="fp-select" id="fpPrerequisSelect"></select>
<button class="fp-select-add" id="fpPrerequisAdd">Ajouter</button>
</div>
<textarea class="fp-textarea" id="fpPrerequis"></textarea>
</div>
</div>
</div> <!-- /.fp-grid3-bottom -->
</div><!-- /.fp-content -->
</div><!-- /.fp-dialog -->
</div><!-- /.fp-overlay -->
<!-- fin dlgFichePoste -->
<!-- Lightbox MODE AJOUT (DDFPT / Codepaca) -->
<div aria-hidden="true" id="dlgAddMode">
<div class="addmode-inner">
<div class="addmode-title">Activer le mode ajout DDFPT</div>
<div class="addmode-body">
      Saisir le code d'établissement (<strong>Codepaca</strong>) pour déverrouiller le bloc « Nouvel équipement ».
    </div>
<input autocomplete="off" class="addmode-input" id="addmode-code" type="password" placeholder="Code établissement…"/ inputmode="numeric">
<div class="addmode-error" id="addmode-error"></div>
<div class="addmode-footer">
<button class="btn btn-small btn-cancel" id="addmode-cancel" type="button">Annuler</button>
<button class="btn btn-small btn-primary" id="addmode-ok" type="button">Valider</button>
</div>
</div>
</div>
<!-- Lightbox MODE AJOUT DREETS -->
<div aria-hidden="true" id="dlgAddModeDreets">
<div class="addmode-inner">
<div class="addmode-title">🔐 Activer le mode DREETS</div>
<div class="addmode-body">
      Saisir le <strong>code DREETS</strong> pour déverrouiller l'encadré « DREETS » (travaux réglementés, régime, précisions, observations).
    </div>
<input autocomplete="off" class="addmode-input" id="dreets-code" type="password" placeholder="Code DREETS…"/>
<div class="addmode-error" id="dreets-error"></div>
<div class="addmode-footer">
<button class="btn btn-small btn-cancel" id="dreets-cancel" type="button">Annuler</button>
<button class="btn btn-small btn-primary" id="dreets-ok" type="button">Valider</button>
</div>
</div>
</div>
<!-- Lightbox MODE ADMIN GLOBAL -->
<div aria-hidden="true" id="dlgAdminMode">
<div class="addmode-inner">
<div class="addmode-title">👤 Mode administrateur</div>
<div class="addmode-body">
      Saisir un <strong>code administrateur</strong> pour déverrouiller tous les blocs (Mode ajout et DREETS).
    </div>
<input autocomplete="off" class="addmode-input" id="admin-mode-code" type="password" placeholder="Code administrateur…"/ inputmode="numeric">
<div class="addmode-error" id="admin-mode-error"></div>
<div class="addmode-footer">
<button class="btn btn-small btn-cancel" id="admin-mode-cancel" type="button">Annuler</button>
<button class="btn btn-small btn-primary" id="admin-mode-ok" type="button">Valider</button>
</div>
</div>
</div>
<!-- Lightbox confirmation effacement TR DREETS -->
<div aria-hidden="true" id="dlgClearTravaux">
<div class="addmode-inner">
<div class="addmode-title">Effacer tous les travaux réglementés</div>
<div class="addmode-body">
      Vous êtes sur le point d'effacer <strong>toute la liste des travaux réglementés</strong> pour cet équipement.<br/><br/>
      Êtes-vous sûr de vouloir continuer ?
    </div>
<div class="addmode-footer">
<button class="btn btn-small" id="clear-trav-cancel" type="button">Non</button>
<button class="btn btn-small" id="clear-trav-ok" type="button">Oui</button>
</div>
</div>
</div>
<!-- Lightbox suppression administrateur -->
<div aria-hidden="true" id="dlgAdminDelete">
<div class="addmode-inner">
<div class="addmode-title">Suppression d'un équipement</div>
<div class="addmode-body">
      Equipement : <strong id="delEquipLabel">—</strong><br>
      Saisir un <strong>code administrateur</strong> pour confirmer la suppression.
    </br></div>
<input autocomplete="off" class="addmode-input" id="adm-del-code" placeholder="Code administrateur…"/ type="password" inputmode="numeric">
<div class="addmode-error" id="adm-del-error"></div>
<div class="addmode-footer">
<button class="btn btn-small" id="adm-del-cancel" type="button">Annuler</button>
<button class="btn btn-small" id="adm-del-ok" type="button">Supprimer</button>
</div>
</div>
</div>
<script>
/* ==========================================================
   FONCTION CRITIQUE : rowsToRecordsCompat
   Définie en premier pour éviter ReferenceError
   ========================================================== */
// Fonction de conversion des données Grist (format colonnes) en tableau d'objets (format lignes)
function rowsToRecordsCompat(t){
  if(Array.isArray(t)) return t;
  if(t && Array.isArray(t.id)){
    const rows=[], n=t.id.length, cols=Object.keys(t).filter(k=>'id'!==k);
    for(let i=0;i<n;i++){
      const o={id:t.id[i]};
      for(const c of cols)o[c]=Array.isArray(t[c])?t[c][i]:t[c];
      rows.push(o);
    }
    return rows;
  }
  if(t&&Array.isArray(t.data))return t.data;
  return [];
}

/* ==========================================================
   CONSTANTES TABLES & COLONNES
   ========================================================== */
const TBL_MAIN='Liste_des_equipements';
const COL_LIB ='Equipements_ou_produits';
const COL_TRAV='Nature_des_travaux';
const COL_TMP_REG='Tampon_regime';
const COL_TMP_DOM='Tampon_Domaines';
const COL_TMP_DIP='Tampon_Diplomes';
const COL_TMP_ETB='Tampon_Etab';
const COL_TMP_TR ='Tampon_Travaux';
const COL_TMP_INTI_TR='Tampon_intitule_travaux';
const COL_TMP_ART='Tampon_Articles';

const COL_TMP_SIT   ='Tampon_situation';
const COL_TMP_PREV  ='Tampon_prevention';
const COL_TMP_ENV   ='Tampon_environnement';
const COL_TMP_PREREQ='Tampon_pre_requis';

/* Colonnes DREETS (caractéristiques produit / agent chimique) */
const COL_PRECI='Precisions_regime_d_interdiction_derogation';
const COL_OBS  ='Observations_particulieres';
const COL_VGP  ='Verification_Generale_Periodique';
const COL_DOC  ='Doc_bureau_de_controle';
const COL_TR_TYPE   = 'TR_Type';
const COL_TR_FAM    = 'TR_Famille_produit';
const COL_TR_AGENT  = 'TR_Agents_chimiques_principaux';
const COL_TR_DANGER = 'TR_Dangers_CLP';
const COL_TR_EPI    = 'TR_EPI_recommandes';

/* Table VGP (liste des libellés VGP) */
const TBL_VGP       = 'VGP';
const COL_VGP_LABEL = 'A';   // colonne texte dans la table VGP

/* Photos : SUPABASE + legacy */
const COL_SB_URL   ='SB_Photo_url';
const COL_SB_THMB  ='SB_Photo_thumb';
const COL_PHOTO_ATT='Photo';
const LEGACY_URL   ='Photo_url';
const LEGACY_THMB  ='Photo_thumb';

/* Supabase */
const SUPABASE_URL         = "https://hpiqwvwpxzppxpxhjede.supabase.co";
const SUPABASE_ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhwaXF3dndweHpwcHhweGhqZWRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTE0NDEsImV4cCI6MjA3ODE4NzQ0MX0.1NTGmtXuSRCFfgampO-gQvAdNOYePm4KZi6kzMOSbII";
const SUPABASE_BUCKET      = "Guide";
const SUPABASE_PATH_PREFIX = "guide/";

// Export PNG (html2canvas) : éviter les carrés noirs (canvas tainted) avec images cross-origin.
// On transforme les URLs Supabase Storage "public" en URL proxy (Edge Function img-proxy) pour l'export.
const SUPABASE_IMG_PROXY_FN = 'img-proxy';
function makeExportSafeImageUrl(url){
  const u = String(url || '').trim();
  if(!u) return '';
  try{
    const U = new URL(u);
    if(U.hostname.endsWith('supabase.co') && U.pathname.includes('/storage/v1/object/public/')){
      const base = SUPABASE_URL.replace(/\/+$/,'');
      return `${base}/functions/v1/${SUPABASE_IMG_PROXY_FN}?url=${encodeURIComponent(u)}`;
    }
  }catch(e){}
  return u;
}


/* Référentiels MR */
const MR_CFG = {
  domaines:{refTable:['Domaine_professionnel'],refLabel:'Domaines',tamponCol:COL_TMP_DOM},
  diplomes:{refTable:['Diplomes_EN_OK'],refLabel:'Concatenation',tamponCol:COL_TMP_DIP},
  etab    :{
    refTable:['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
    refLabel:'appellation_officielle',
    tamponCol:COL_TMP_ETB
  },
};

const COL_DIP_CONCAT    ='Concatenation';
const COL_ETAB_LABEL    ='appellation_officielle';
const COL_ETAB_DIP_TEXT ='Diplomes';
const COL_ETAB_CODE     ='Codepaca';

/* Travaux réglementés : table Liste_travaux */
const TBL_TRAV      ='Liste_travaux';
const COL_TR_LABEL  ='Travaux';
const COL_TR_NUMPOS ='num';
const COL_TR_NUMPOS_FALLBACK ='Num_pos';
const COL_TR_RED    ='Travaux_frappes_d_interdiction_totale';
const COL_TR_ORANGE ='Travaux_interdits_soumis_a_derogation_ou_Travaux_reglementes';
const COL_TR_GREEN  ='Travaux_autorise_non_soumis_a_declaration_de_derogation';

/* Articles du code du travail */
const TBL_ART    ='Articles_code_du_travail';
const COL_ART_NUM='Numero';
const COL_ART_URL='URL';

/* Table dérogation pour la liste déroulante */
const TBL_DEROG      ='Derogation';
const COL_DEROG_LABEL='A';

/* Table de lien Equipement / Etablissement / Diplome */
const TBL_LINK   ='Lien_equip_etab_dipl';
const COL_L_EQUIP='Equipement';
const COL_L_ETAB ='Etablissement';
const COL_L_DIP  ='Diplome';

/* Table historique des actions */
const TBL_HIST      = 'Historique_equipements';
const COL_H_DATE    = 'Date_heure';
const COL_H_ACTION  = 'Action';
const COL_H_EQUIP   = 'Equipement';
const COL_H_ETAB    = 'Etablissement';
const COL_H_DIP     = 'Diplome';
const COL_H_USER    = 'Utilisateur';
const COL_H_DETAILS = 'Details';

/* Table Administrateur */
const TBL_ADMIN         = 'Administrateur';
const COL_ADM_CODE      = 'Code';
const COL_ADM_NOM       = 'Nom';
const COL_ADM_PRENOM    = 'Prenom';
const COL_ADM_ETAB      = 'Etab';
const COL_ADM_CODE_DREETS = 'Code_dreets';

/* ========================== ÉTAT GLOBAL ========================== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));

const norm=s=>(s??'').toString().normalize('NFKD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\s-]/g,' ').replace(/\s+/g,' ').trim().toLowerCase();

function getFirstField(obj, keys){
  for(var i=0;i<keys.length;i++){
    var k = keys[i];
    if(obj && obj[k] !== undefined && obj[k] !== null){
      var v = String(obj[k]).trim();
      if(v) return _sanitizeQrUrl(v);
    }
  }
  return '';
}
function ficheNumFromRow(r){
  return getFirstField(r, ['NumFiches','Num_fiche','NumFiche','Numéro de fiches','Numero de fiches','Numero_de_fiches','NumeroFiches']);
}
function ficheUrlFromRow(r){
  return getFirstField(r, ['URL Fiches','URL_Fiches','Url_fiche','URL_fiche','UrlFiche','URLFiche','UrlFiches','URLFiches','URL fiches']);
}
function clearEl(el){
  while(el && el.firstChild) el.removeChild(el.firstChild);
}
function renderTextWithArticleLinks(container, txt, artIndex){
  clearEl(container);
  var s = (txt || '').toString();
  if(!s){ return; }
  var reArt = /\b([DR])\.?\s*(\d{4}-\d+(?:-\d+)?)\b/g;
  var last = 0, m;
  while((m = reArt.exec(s)) !== null){
    var start = m.index;
    var end = reArt.lastIndex;
    if(start>last){
      container.appendChild(document.createTextNode(s.slice(last, start)));
    }
    var code = m[1] + '. ' + m[2];
    var url = artIndex && artIndex.get ? artIndex.get(norm(code)) : null;
    if(url){
      var a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = code;
      container.appendChild(a);
    }else{
      container.appendChild(document.createTextNode(code));
    }
    last = end;
  }
  if(last < s.length){
    container.appendChild(document.createTextNode(s.slice(last)));
  }
}

const refId=v=>{
  if(v==null) return null;
  if(typeof v==='number') return Number(v);
  if(typeof v==='object' && 'id' in v) return Number(v.id);
  return null;
};

let MAP=new Map();
let ROW=null;
let selectedId=null;
let CACHE={};
let selectionLocked=false;

let colorFilter='none';
let DREETS_UNLOCKED=false;

/* Mode admin global */
let ADMIN_MODE=false;

// --- Synchronisation des flags "mode" pour les blocs ajoutés (perso, bouton DREETS, export) ---
// Le code historique utilise des variables locales (ADMIN_MODE, ADD_MODE_ACTIVE...),
// mais certains ajouts s'appuient sur window.*. On garde les deux cohérents.
function __ppSyncWindowModes(){
  try{
    window.ADMIN_MODE = !!ADMIN_MODE;
    window.DREETS_UNLOCKED = !!DREETS_UNLOCKED;
    // variables add-mode (déclarées plus bas dans le script historique)
    if(typeof ADD_MODE_ACTIVE !== 'undefined') window.ADD_MODE_ACTIVE = !!ADD_MODE_ACTIVE;
    if(typeof ADD_MODE_CODE   !== 'undefined') window.ADD_MODE_CODE   = (ADD_MODE_CODE||'');
    if(typeof ADD_MODE_USER   !== 'undefined') window.ADD_MODE_USER   = (ADD_MODE_USER||'');
    // cible admin (perso)
    if(typeof ADMIN_TARGET_CODE !== 'undefined') window.ADMIN_TARGET_CODE = (ADMIN_TARGET_CODE||'');
  }catch(e){}
}

/* Travaux réglementés */
let travRows=[];
let travSelection={};
let artIndex=new Map();

/* modes de filtrage gauche */
let filterMode='autocomp';
let kindMode='all';
const KIND_COL = 'Type';
const KIND_EQUIP = 'Equipement';
const KIND_PROD  = 'Produit';

function readKindFromRec(rec){
  // Colonne binaire "Type" : valeurs attendues = 'equipement' ou 'produit'
  // Par défaut (valeur vide / inconnue) => 'equipement'
  let raw = '';
  try{
    if(rec && rec[KIND_COL] != null) raw = rec[KIND_COL];
    else if(rec && rec.fields && rec.fields[KIND_COL] != null) raw = rec.fields[KIND_COL];
  }catch(e){ raw=''; }

  // Support si la colonne est finalement un booléen (ex: Produit? true/false)
  if(typeof raw === 'boolean') return raw ? 'produit' : 'equipement';
  if(typeof raw === 'number')  return (raw === 1) ? 'produit' : 'equipement';

  const v = String(raw || '').trim().toLowerCase();
  if(!v) return 'equipement';
  if(v.startsWith('prod')) return 'produit';
  if(v.startsWith('équip') || v.startsWith('equip')) return 'equipement';
  // Valeur inattendue -> on force le défaut
  return 'equipement';
}
function writeKindToRec(rec, kind) {
  return (async () => {
    const rid = rec && rec.id;
    if (!rid) return;

    const kKey = (String(kind||'').trim().toLowerCase().startsWith('prod')) ? 'produit' : 'equipement';
    const k = (kKey === 'produit') ? KIND_PROD : KIND_EQUIP;
    const table =
      (typeof TBL_MAIN !== 'undefined' && TBL_MAIN) ? TBL_MAIN :
      (window.TABLE_EQUIP ? window.TABLE_EQUIP : 'Liste_des_equipements');

    try{
      await applyUA([['UpdateRecord', table, rid, { [KIND_COL]: k }]]);

      // Mise à jour locale (optimiste) pour éviter les effets "ça saute" / "ça n'a pas enregistré"
      try{ rec[KIND_COL] = k; }catch(e){}
      try{ if(ROW && Number(ROW.id) === Number(rid)) ROW[KIND_COL] = k; }catch(e){}
      try{
        const cur = (MAP && MAP.get(Number(rid))) ? MAP.get(Number(rid)) : null;
        if(cur) cur[KIND_COL] = k;
      }catch(e){}
    }catch(err){
      console.error('writeKindToRec failed', err);
      // On laisse le caller gérer le rollback UI
      throw err;
    }
  })();
}

function setFpKindDisplay(kind){
  const el = document.getElementById('fpKindDisplay');
  if(!el) return;
  el.textContent = (kind === 'produit') ? 'Produit' : (kind === 'equipement' ? 'Equipement' : '—');
}
function applyProduitVisibility(kind){
  const blk = document.querySelector('.dreets-overlap-block');
  if(blk) blk.style.display = (kind==='produit') ? '' : 'none';
  try{ setFpKindDisplay(kind); }catch(e){}
}

function updateProduitFieldsEnabled(rec){
  // Champs de l'encart Produit : éditables uniquement si (admin OU DREETS) ET Type = produit
  const r = rec || ROW || {};
  const kind = readKindFromRec(r);
  const ok = (ADMIN_MODE || DREETS_UNLOCKED) && (kind === 'produit');
  ['#dreets-type','#dreets-famille','#dreets-agent','#dreets-clp','#dreets-epi'].forEach(sel=>{
    try{ setSectionEnabled(sel, ok); }catch(e){}
  });
}


function initKindModeUI(){
  const setActive = () => {
    document.querySelectorAll('.kind-modes label').forEach(l=>l.classList.remove('active'));
    const radio = document.querySelector(`input[name="kindMode"][value="${kindMode}"]`);
    if(radio && radio.closest('label')) radio.closest('label').classList.add('active');
  };
  document.querySelectorAll('input[name="kindMode"]').forEach(r=>{
    r.addEventListener('change', ()=>{
      kindMode = r.value;
      setActive();
      renderList();
    });
  });
  setActive();
}

function syncTypeRadiosFromRec(rec){
  const kind = readKindFromRec(rec);
  const mE = document.getElementById('typeEquipMain');
  const mP = document.getElementById('typeProduitMain');
  const fE = document.getElementById('fpKindEquip');
  const fP = document.getElementById('fpKindProduit');
  // Force same radio group names (avoid stuck selection)
  try{ if(mE) mE.name='kindMain'; if(mP) mP.name='kindMain'; }catch(e){}
  try{ if(fE) fE.name='kindFP'; if(fP) fP.name='kindFP'; }catch(e){}

  if(mE && mP){
    mE.checked = (kind==='equipement');
    mP.checked = (kind==='produit');
    if(kind===null){ mE.checked=false; mP.checked=false; }
  }
  // Mise en évidence visuelle (soulignement + cercle) pour savoir tout de suite le Type
  try{
    const le = mE ? mE.closest('label') : null;
    const lp = mP ? mP.closest('label') : null;
    if(le) le.classList.remove('type-active');
    if(lp) lp.classList.remove('type-active');
    if(kind==='equipement' && le) le.classList.add('type-active');
    if(kind==='produit' && lp) lp.classList.add('type-active');
  }catch(e){}
  if(fE && fP){
    fE.checked = (kind==='equipement');
    fP.checked = (kind==='produit');
    if(kind===null){ fE.checked=false; fP.checked=false; }
  }
  applyProduitVisibility(kind);
  try{ updateProduitFieldsEnabled(rec); }catch(e){}
  try{ const d=document.getElementById('fpKindDisplay'); if(d) d.textContent = (kind==='produit') ? 'Produit' : (kind==='equipement' ? 'Equipement' : '—'); }catch(e){}
}

let __TYPE_RADIOS__ = null;
function initTypeRadios(){
  const mE = document.getElementById('typeEquipMain');
  const mP = document.getElementById('typeProduitMain');
  const fE = document.getElementById('fpKindEquip');
  const fP = document.getElementById('fpKindProduit');
  // Force same radio group names (avoid stuck selection)
  try{ if(mE) mE.name='kindMain'; if(mP) mP.name='kindMain'; }catch(e){}
  try{ if(fE) fE.name='kindFP'; if(fP) fP.name='kindFP'; }catch(e){}


  const setDisabled = (dis) => {
    [mE,mP,fE,fP].forEach(el=>{ if(el) el.disabled = dis; });
  };

  const canEdit = () => (ADMIN_MODE || ADD_MODE_ACTIVE);

  __TYPE_RADIOS__ = {mE,mP,fE,fP,setDisabled,canEdit};
  window.refreshTypeRadiosLock = ()=>{ try{ setDisabled(!canEdit()); }catch(e){} };

  const handler = async (ev)=>{
    // Certains clics arrivent avant que ROW soit défini (première ouverture).
    // On retombe alors sur currentRec si disponible.
    const active = (ROW && ROW.id) ? ROW : (window.currentRec && window.currentRec.id ? window.currentRec : null);
    if(!active) {
      console.warn('[KIND v15.5] Pas de ROW actif, annulation');
      return;
    }
    if(!ROW && active && active.id){ ROW = active; }
    const rec = MAP.get(Number(active.id)) || active;
    const src = ev && ev.target ? ev.target : null;
    const kind = (src && String(src.value||'').toLowerCase().startsWith('prod')) ? 'produit' : 'equipement';

    console.log('[KIND v15.5] Handler radio déclenché:', {
      kind,
      canEdit: canEdit(),
      ADD_MODE_ACTIVE,
      ADMIN_MODE,
      current_value: rec[KIND_COL]
    });

    // Si l'utilisateur n'a pas les droits d'édition, on resynchronise sans écrire.
    if(!canEdit()){
      console.log('[KIND v15.5] Permission refusée, resynchronisation');
      syncTypeRadiosFromRec(rec);
  try{ updateProduitFieldsEnabled(rec); }catch(e){}
  try{ const d=document.getElementById('fpKindDisplay'); if(d) d.textContent = (readKindFromRec(rec)==='produit') ? 'Produit' : 'Equipement'; }catch(e){}
      setDisabled(!canEdit());
      return;
    }

    // Tentative d'écriture. En cas d'échec on remet l'état précédent (évite le "bloqué sur produit").
    const prev = (String(rec[KIND_COL]||'').toLowerCase().includes('produit')) ? 'produit' : 'equipement';
    
    console.log('[KIND v15.5] Tentative d\'écriture:', {
      kind: kind,
      prev: prev,
      rec_Type: rec[KIND_COL]
    });
    
    applyProduitVisibility(kind);
    try{ updateProduitFieldsEnabled(rec); }catch(e){}
    try{
      await writeKindToRec(rec, kind);
      await renderList();
    }catch(e){
      console.error('[KIND v15.5] Erreur écriture:', e);
      try{ syncTypeRadiosFromRec(rec);
  try{ const d=document.getElementById('fpKindDisplay'); if(d) d.textContent = (readKindFromRec(rec)==='produit') ? 'Produit' : 'Equipement'; }catch(e){} }catch(_){ }
      try{ applyProduitVisibility(prev); }catch(_){ }
      alert("Écriture refusée ou non disponible. Si vous êtes dans un navigateur externe, ouvrez la page dans Grist.");
    }
    setDisabled(!canEdit());
  };

  // ✅ FIX v15.4 : Ajouter les événements 'click' ET 'change' pour garantir la réactivité au premier clic
  [mE,mP,fE,fP].forEach(el=>{ 
    if(el) {
      el.addEventListener('change', handler);
      el.addEventListener('click', handler);
    }
  });

  // initial lock state
  setDisabled(!canEdit());
}

let domainSectorIndex={};
let domainValues=new Set();
let sectorValues=new Set();
let diplomaValues=new Set();

// Derniere liste rendue (apres filtres) pour export
let lastRenderedListIds=[];

/* Mode ajout DDFPT */
let ADD_MODE_ACTIVE=false;
let ADD_MODE_ETAB_NAME='';
let ADD_MODE_CODE = '';
let ADD_MODE_USER = '';

const pbar=qs('#pbar');
const progressEl=document.querySelector('.progress');

/* ==========================================================
   UTILITAIRES GRIST
   ========================================================== */
function toRows(t){
  if(Array.isArray(t)) return t;
  if(t && Array.isArray(t.id)){
    const rows=[], n=t.id.length, cols=Object.keys(t).filter(k=>'id'!==k);
    for(let i=0;i<n;i++){
      const o={id:t.id[i]};
      for(const c of cols)o[c]=Array.isArray(t[c])?t[c][i]:t[c];
      rows.push(o);
    }
    return rows;
  }
  if(t&&Array.isArray(t.data))return t.data;
  return [];
}


// Lecture robuste d'une valeur de colonne depuis différents formats de record (flat, {fields}, Map)
function getRecVal(rec, col){
  if(!rec || !col) return undefined;
  if(Object.prototype.hasOwnProperty.call(rec, col)) return rec[col];
  if(rec.fields && Object.prototype.hasOwnProperty.call(rec.fields, col)) return rec.fields[col];
  try{ if(typeof rec.get==='function') return rec.get(col); }catch(e){}
  return undefined;
}


/* ==========================================================
   MODE PUBLIC (navigateur neutre) — accès via Supabase Edge Functions
   ----------------------------------------------------------
   - Lecture:  read-app (liste + fiche)
   - Auth:     auth-code (code -> token)
   - Écriture: write-app (filtrée par rôle)
   ========================================================== */
const SB_APP = 'equipements';
const SB_ROOT = 'https://hpiqwvwpxzppxpxhjede.supabase.co/functions/v1';
const SB_API_READ  = SB_ROOT + '/read-app';
const SB_API_AUTH  = SB_ROOT + '/auth-code';
const SB_API_WRITE = SB_ROOT + '/write-app';

const IS_GRIST = !!(window.grist && window.grist.docApi);

function _hashBaseId(){
  try{
    const h = String(window.location.hash||'');
    // attendu: #base?id=67
    const m = h.match(/^#base\?(.+)?$/);
    if(!m) return null;
    const qs = (h.includes('?') ? h.split('?')[1] : '');
    if(!qs) return null;
    const sp = new URLSearchParams(qs);
    const id = Number(sp.get('id'));
    return Number.isFinite(id) && id>0 ? id : null;
  }catch(e){ return null; }
}

async function sbFetchList(){
  const r = await fetch(SB_API_READ + '?app=' + encodeURIComponent(SB_APP), { credentials:'omit' });
  const j = await r.json().catch(()=>null);
  if(!j || !j.ok) throw new Error(j?.error || 'Lecture liste impossible (Supabase)');
  return Array.isArray(j.items) ? j.items : [];
}

async function sbFetchOne(id){
  const r = await fetch(SB_API_READ + '?app=' + encodeURIComponent(SB_APP) + '&id=' + encodeURIComponent(String(id)), { credentials:'omit' });
  const j = await r.json().catch(()=>null);
  if(!j || !j.ok) throw new Error(j?.error || 'Lecture fiche impossible (Supabase)');
  return j.record; // {id, fields}
}

function sbRecToRow(rec){
  try{
    if(!rec) return null;
    const id = Number(rec.id);
    const fields = rec.fields || {};
    return { id, ...fields };
  }catch(e){ return null; }
}

async function sbWrite(id, fields){
  const token = localStorage.getItem('pp_token') || '';
  if(!token) throw new Error('Non authentifié (token absent).');
  const r = await fetch(SB_API_WRITE + '?app=' + encodeURIComponent(SB_APP), {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Bearer ' + token
    },
    body: JSON.stringify({ id: Number(id), fields: fields || {} })
  });
  const j = await r.json().catch(()=>null);
  if(!j || !j.ok) throw new Error(j?.error || 'Écriture impossible (Supabase)');
  return j;
}

async function sbAuth(code){
  const r = await fetch(SB_API_AUTH, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ code: String(code||'').trim() })
  });
  const j = await r.json().catch(()=>null);
  if(!j || !j.ok) throw new Error(j?.error || 'Code invalide');
  try{
    localStorage.setItem('pp_token', j.token);
    localStorage.setItem('pp_role', j.role);
  }catch(e){}
  return j;
}

async function fetchTable(tbl){
  // Mode Grist (dev / widget) : comportement inchangé
  if(window.grist?.docApi?.fetchTable) return toRows(await window.grist.docApi.fetchTable(tbl));
  if(window.grist?.docApi?.getTable)   return toRows(await window.grist.docApi.getTable(tbl));

  // Mode public : on ne charge que la table principale via Supabase (liste)
  try{
    const mainTbl = (typeof TBL_MAIN !== 'undefined' && TBL_MAIN) ? TBL_MAIN : 'Liste_des_equipements';
    if(String(tbl) !== String(mainTbl)) return [];
    const items = await sbFetchList();
    // Normaliser en "row" compatible (id + libellé + Type)
    return items.map(it=>{
      const r = { id: Number(it.id) };
      try{ r[COL_LIB] = (it.label ?? '').toString(); }catch(e){ r[COL_LIB] = (it.label ?? '').toString(); }
      // Type si disponible
      try{ r[ (typeof KIND_COL!=='undefined' ? KIND_COL : 'Type') ] = it.Type ?? it.type ?? ''; }catch(e){}
      try{ r['Type'] = it.Type ?? it.type ?? r['Type'] ?? ''; }catch(e){}
      return r;
    });
  }catch(e){
    console.error('[SB] fetchTable failed', e);
    return [];
  }
}

async function loadFull(){
  const rows=await fetchTable(TBL_MAIN);
  MAP=new Map(rows.map(r=>[Number(r.id),r]));
}

/* progress */
const tick=pct=>{pbar.style.width=`${pct}%`;};
let __ppToastT=null;
function ppToast(msg){
  const el=document.getElementById('ppSaveToast');
  if(!el) return;
  el.textContent = msg || 'Modification enregistrée';
  el.classList.add('show');
  el.setAttribute('aria-hidden','false');
  if(__ppToastT) clearTimeout(__ppToastT);
  __ppToastT = setTimeout(()=>{
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
  }, 1300);
}

async function runQuick(fn){
  try{ progressEl.classList.add('active'); }catch(e){}
  tick(10);
  try{ await fn(); } finally{
    tick(100);
    setTimeout(()=>{
      try{ progressEl.classList.remove('active'); }catch(e){}
      tick(0);
    },120);
  }
}

/* user actions avec verrou (et MAJ du cache local) */
async function applyUA(actions){
  selectionLocked = true;

  const hasGristWrite = !!(window.grist && window.grist.docApi && typeof window.grist.docApi.applyUserActions === 'function');

  console.log('[applyUA HYBRID] Tentative d\'écriture:', {
    hasGristWrite,
    actions: actions
  });

  try{
    if(hasGristWrite){
      await window.grist.docApi.applyUserActions(actions);
    }else{
      // Mode public : on ne supporte ici que UpdateRecord sur la table principale.
      const mainTbl = (typeof TBL_MAIN !== 'undefined' && TBL_MAIN) ? TBL_MAIN : 'Liste_des_equipements';
      const byId = new Map(); // rid -> fields merged

      (actions || []).forEach(a=>{
        if(!Array.isArray(a)) return;
        const typ = a[0];
        if(typ !== 'UpdateRecord'){
          throw new Error('Action non supportée en mode public: ' + typ);
        }
        const tbl = a[1];
        const rid = Number(a[2]);
        const upd = a[3] || {};
        if(String(tbl) !== String(mainTbl)) return; // ignore autres tables
        if(!rid) return;
        const cur = byId.get(rid) || {};
        Object.assign(cur, upd);
        byId.set(rid, cur);
      });

      if(byId.size === 0){
        throw new Error('Aucune mise à jour applicable (mode public).');
      }

      // Écritures séquentielles (sécurité + simplicité)
      for(const [rid, fields] of byId.entries()){
        await sbWrite(rid, fields);
      }
    }

    // MAJ immédiate du cache local (évite "ça n'a pas enregistré")
    try{
      const mainTbl = (typeof TBL_MAIN !== 'undefined' && TBL_MAIN) ? TBL_MAIN : 'Liste_des_equipements';
      (actions || []).forEach(a => {
        if(!Array.isArray(a)) return;
        const typ = a[0];
        if(typ !== 'UpdateRecord') return;
        const tbl = a[1];
        const rid = Number(a[2]);
        const upd = a[3] || {};
        if(String(tbl) !== String(mainTbl) || !rid || !upd) return;
        const cur = (MAP && MAP.get(rid)) ? MAP.get(rid) : ((window.ROW && Number(window.ROW.id)===rid) ? window.ROW : null);
        if(cur){
          Object.assign(cur, upd);
          try{ MAP && MAP.set(rid, cur); }catch(e){}
          if(window.ROW && Number(window.ROW.id)===rid){ Object.assign(window.ROW, upd); }
        }
      });
    }catch(e){
      console.warn('[applyUA HYBRID] Erreur mise à jour cache local:', e);
    }

    try{ ppToast('Modification enregistrée'); }catch(e){}
  } finally {
    selectionLocked = false;
  }
}

function keepCursor(){
  try{ if(selectedId!=null) window.grist.setCursorPos({rowId:Number(selectedId)});}catch{}
}

/* ==========================================================
   HISTORIQUE
   ========================================================== */
async function logHistory(action, {
  equipId,
  equipName,
  etabName,
  diplome,
  details,
  user
} = {}) {
  try {
    const row = ROW || {};
    const idRaw = (equipId != null ? equipId : row.id);
    const equipRef = idRaw != null ? Number(idRaw) : null;

    const etab = (etabName != null ? etabName : ADD_MODE_ETAB_NAME || '').toString().trim() || null;
    const dips = (diplome != null ? diplome : (row[COL_TMP_DIP] || '')).toString().trim() || null;
    const userLabel = (user != null ? user : (ADD_MODE_USER || ADD_MODE_CODE || '')).toString().trim() || null;

    const payload = {
      [COL_H_DATE]:    new Date().toISOString(),
      [COL_H_ACTION]:  action || '',
      [COL_H_EQUIP]:   equipRef,
      [COL_H_ETAB]:    etab,
      [COL_H_DIP]:     dips,
      [COL_H_USER]:    userLabel,
      [COL_H_DETAILS]: (details || '') || null
    };

    await applyUA([['AddRecord', TBL_HIST, null, payload]]);
  } catch (e) {
    console.warn('logHistory error', e);
  }
}

/* ensureTable cache */
async function ensureTable(tableIds,labelColGuess){
  const key=[].concat(tableIds).join('|');
  if(CACHE[key]) return CACHE[key];
  let rows=null,id=null;
  for(const t of [].concat(tableIds)){
    try{ rows=await fetchTable(t); id=t; if(Array.isArray(rows)) break; }catch{}
  }
  rows=rows||[];
  let label=labelColGuess;
  if(rows.length && !(label in rows[0])) label=Object.keys(rows[0]).find(k=>'id'!==k)||'id';
  const values=[], byNorm=new Map();
  for(const r of rows){
    const v=(r?.[label]??'').toString().trim();
    if(v){ values.push(v); byNorm.set(norm(v),r); }
  }
  CACHE[key]={rows,tableId:id,labelCol:label,values,byNorm};
  return CACHE[key];
}

/* ==========================================================
   COULEURS RÉGIME
   ========================================================== */
function colorFromLabel(lbl){
  const map={
    "Interdiction absolue":      {color:'#dc2626', pale:'#fee2e2'},
    "Déclaration de dérogation à l'inspection du travail":{color:'#ea580c', pale:'#ffedd5'},
    "Dérogation de droit si":   {color:'#22c55e', pale:'#bbf7d0'},
    "Pas d'interdiction si":    {color:'#22c55e', pale:'#bbf7d0'},
    "Autorisé":                 {color:'#22c55e', pale:'#bbf7d0'},
    "A compléter par la Dreets":{color:'#db2777', pale:'#f9a8d4'}
  };
  if(map[lbl]) return map[lbl].color;
  const e=norm(lbl||"");
  if(e==="interdiction absolue")return'#dc2626';
  if(e.startsWith("declaration de derogation"))return'#ea580c';
  if(e.startsWith("derogation de droit si")||e.startsWith("pas dinterdiction si"))return'#22c55e';
  if(e.startsWith("autorise"))return'#22c55e';
  if(e.startsWith("a completer par la dreets") || e.startsWith("a completer par drets"))return'#db2777';
  return null;
}

/* ==========================================================
   LISTE GAUCHE + FILTRAGE
   ========================================================== */
function matchDomainForRow(rec,fNorm){
  const idx=domainSectorIndex[Number(rec.id)];
  if(!idx || !idx.domains || !idx.domains.size) return false;
  for(const d of idx.domains){
    if(norm(d).includes(fNorm)) return true;
  }
  return false;
}
function matchSecteurForRow(rec,fNorm){
  const idx=domainSectorIndex[Number(rec.id)];
  if(!idx || !idx.sects || !idx.sects.size) return false;
  for(const s of idx.sects){
    if(norm(s).includes(fNorm)) return true;
  }
  return false;
}
function matchDiplomeForRow(rec,fNorm){
  const idx=domainSectorIndex[Number(rec.id)];
  if(!idx || !idx.diplomes || !idx.diplomes.size) return false;
  for(const d of idx.diplomes){
    if(norm(d).includes(fNorm)) return true;
  }
  return false;
}

function renderList(){
  const cont=qs('#list');
  cont.innerHTML='';
  let rows=[...MAP.values()].sort((a,b)=>String(a[COL_LIB]||'').localeCompare(String(b[COL_LIB]||''),'fr',{sensitivity:'base'}));

  const raw=(qs('#filter').value||'').trim();
  const fNorm=norm(raw);

  if(raw){
    if(filterMode==='autocomp'){
      rows=rows.filter(r=>norm(r[COL_LIB]||'').includes(fNorm));
    }else if(filterMode==='domaine'){
      rows=rows.filter(r=>matchDomainForRow(r,fNorm));
    }else if(filterMode==='secteur'){
      rows=rows.filter(r=>matchSecteurForRow(r,fNorm));
    }else if(filterMode==='diplome'){
      rows=rows.filter(r=>matchDiplomeForRow(r,fNorm));
    }
  }

  // Filtre Type (équipement/produit)
  if(kindMode!=='all'){
    rows = rows.filter(r => readKindFromRec(r) === kindMode);
  }

  if(colorFilter!=='none'){
    rows=rows.filter(r=>{
      const c=colorFromLabel((r[COL_TMP_REG]??'').toString().trim());
      if(!c) return false;
      if(colorFilter==='red')   return c===colorFromLabel('Interdiction absolue');
      if(colorFilter==='orange')return c===colorFromLabel("Déclaration de dérogation à l'inspection du travail");
      if(colorFilter==='green') return c===colorFromLabel('Autorisé') || c===colorFromLabel('Dérogation de droit si') || c===colorFromLabel("Pas d'interdiction si");
      if(colorFilter==='pink')  return c===colorFromLabel('A compléter par la Dreets');
      return true;
    });
  }
  qs('#equip-count').textContent=`${rows.length} équipement${rows.length>1?'s':''} affiché${rows.length>1?'s':''}`;
  lastRenderedListIds = rows.map(r=>Number(r.id));

  for(const r of rows){
    const el=document.createElement('div');
    el.className='item'+(Number(r.id)===Number(selectedId)?' selected':'');
    const color=colorFromLabel((r[COL_TMP_REG]??'').toString().trim()) || 'var(--stripe-default)';
    el.style.setProperty('--stripe',color);
    el.innerHTML=`<strong>${r[COL_LIB]??''}</strong>`;
    el.onclick=()=>selectRow(r.id,true);
    cont.appendChild(el);
  }
}



/* ==========================================================
   EXPORT (liste filtree) -> Impression PDF
   ========================================================== */
function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

async function exportFilteredToPdf(){
  // Export de la liste actuellement affichee (apres filtres) -> page HTML print (PDF)
  let w = null;
  try{
    const ids = (lastRenderedListIds || []).map(Number).filter(n => Number.isFinite(n));
    if(!ids.length){ ppToast('Aucun equipement a exporter'); return; }

    // Ouvrir la fenetre le plus tot possible (sinon pop-up bloque)
    w = window.open('', '_blank');
    if(!w){
      alert("Pop-up bloquee : autorisez l'ouverture de fenetre pour exporter.");
      return;
    }
    w.document.open();
    w.document.write("<!doctype html><html><head><meta charset='utf-8'><title>Export</title></head><body style='font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px'>Export en cours…</body></html>");
    w.document.close();

    // Etablissements / Diplomes (via table de lien)
    let linkRows = [], etabRows = [], dipRows = [];
    try{ linkRows = await fetchTable(TBL_LINK); }catch(e){ linkRows = []; }
    try{ etabRows = await fetchTable(TBL_ETAB); }catch(e){ etabRows = []; }
    try{
      const dipCfg = await ensureTable(['Diplomes_EN_OK'], COL_DIP_CONCAT);
      dipRows = dipCfg.rows || [];
    }catch(e){ dipRows = []; }

    const etabLabelCol = (etabRows[0] ? (Object.keys(etabRows[0]).find(c => norm(c).includes('nom')) || 'Nom') : 'Nom');
    const etabById = new Map(etabRows.map(r => [Number(r.id), r]));

    // Pour les diplomes, on privilegie la colonne "Concatenation" (COL_DIP_CONCAT)
    const dipById = new Map(dipRows.map(r => [Number(r.id), r]));

    const etabsForEquip = Object.create(null);
    const dipsForEquip  = Object.create(null);

    (linkRows || []).forEach(l => {
      const eId = refId(l[COL_L_EQUIP]);
      if(eId == null) return;

      const etId = refId(l[COL_L_ETAB]);
      if(etId != null){
        const er = etabById.get(Number(etId));
        const name = er ? String(er[etabLabelCol] || er.Nom || '').trim() : '';
        if(name){ (etabsForEquip[eId] ||= new Set()).add(name); }
      }

      const dId = refId(l[COL_L_DIP]);
      if(dId != null){
        const dr = dipById.get(Number(dId));
        const lab = dr ? String(dr[COL_DIP_CONCAT] || dr.Concatenation || '').trim() : '';
        if(lab){ (dipsForEquip[eId] ||= new Set()).add(lab); }
      }
    });

    const now = new Date();
    const stamp = String(now.getDate()).padStart(2,'0') + '/' + String(now.getMonth()+1).padStart(2,'0') + '/' + now.getFullYear();

    const css = `      @page{size:A4;margin:11mm;}
      *{box-sizing:border-box;}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0b1220;}

      /* Table report: thead repeats on each printed page */
      table.report{width:100%;border-collapse:separate;border-spacing:0 10px;}
      thead{display:table-header-group;}
      thead th{padding:0 0 6mm 0;text-align:right;vertical-align:bottom;background:#fff;}
      .hdrline{font-size:11px;color:#334155;white-space:nowrap;display:inline-flex;gap:8px;align-items:baseline;}
      .hdrline strong{font-weight:800;color:#0f172a;}
      .hdrsep{opacity:.8;}
      .hdrbar{height:1px;background:#cbd5e1;margin-top:2mm;}

      .wrap{margin:0;}
      .count{font-size:11px;color:#475569;margin:0 0 10px 0;}

      .card{border:2.2px solid #0f172a;border-radius:12px;padding:10px;break-inside:avoid;background:#ffffff;box-shadow:0 1px 0 rgba(15,23,42,.10);}
      .top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
      .title{font-size:14px;font-weight:800;margin:0;line-height:1.15;}
      .badge{display:inline-block;font-size:10px;font-weight:700;padding:3px 8px;border-radius:999px;border:1px solid #cbd5e1;color:#0b1220;}
      .badge.prod{border-color:#10b981;}
      .badge.eq{border-color:#60a5fa;}
      .sub{margin:4px 0 0 0;font-size:11px;color:#475569;}
      .grid{display:grid;grid-template-columns:1.15fr 0.85fr;gap:10px;margin-top:8px;}
      .box{border:1px dashed #e2e8f0;border-radius:10px;padding:8px;}
      .lab{font-size:10px;letter-spacing:.06em;text-transform:uppercase;color:#64748b;margin:0 0 4px 0;}
      .val{font-size:12px;white-space:pre-wrap;line-height:1.25;}
      .muted{color:#64748b;}
      .cols{columns:2;column-gap:18px;}
      .photo{width:150px;max-height:120px;object-fit:cover;border-radius:10px;border:1px solid #e2e8f0;display:block;}
      a{color:#0f172a;text-decoration:underline;word-break:break-all;}
      .regpill{display:inline-block;font-size:10px;font-weight:700;padding:3px 8px;border-radius:999px;border:1px solid #e2e8f0;}
      .regpill.red{border-color:#dc2626;}
      .regpill.orange{border-color:#ea580c;}
      .regpill.green{border-color:#16a34a;}
      .regpill.pink{border-color:#db2777;}`;

    function regClass(lbl){
      const c = colorFromLabel((lbl||'').toString().trim());
      if(!c) return '';
      if(c===colorFromLabel('Interdiction absolue')) return 'red';
      if(c===colorFromLabel("Déclaration de dérogation à l'inspection du travail")) return 'orange';
      if(c===colorFromLabel('A compléter par la Dreets')) return 'pink';
      return 'green';
    }

    let out = "<!doctype html><html><head><meta charset='utf-8'><title>Export</title><style>"+css+"</style></head><body>";
    out += "<div class='wrap'><div class='count'>"+ids.length+" element"+(ids.length>1?'s':'')+" exporte"+(ids.length>1?'s':'')+" (liste filtree)</div>";
    out += "<table class='report'><thead><tr><th><div class='hdrline'><strong>Prévention PACA</strong><span class='hdrsep'>—</span><span>Document édité le "+stamp+"</span></div><div class='hdrbar'></div></th></tr></thead><tbody>";

    for(const id of ids){
      const r = MAP.get(Number(id));
      if(!r) continue;

      const kindRaw = readKindFromRec(r);
      const kindLabel = (kindRaw === 'produit') ? 'Produit' : (kindRaw === 'equipement' ? 'Equipement' : '—');
      const kindCls = (kindRaw === 'produit') ? 'prod' : 'eq';

      const reg = String(r[COL_TMP_REG] || '').trim();
      const regPill = reg ? ("<span class='regpill "+regClass(reg)+"'>"+escapeHtml(reg)+"</span>") : "<span class='regpill'>Regime : —</span>";

      // Établissements : on privilégie la colonne tampon (déjà calculée côté widget),
      // puis on retombe sur la table de lien si besoin.
      const etabsFromRow = String(r[COL_TMP_ETB] || '').trim();
      const etabs = etabsFromRow || (etabsForEquip[id] ? Array.from(etabsForEquip[id]).sort().join(', ') : '');
      const dips  = dipsForEquip[id]  ? Array.from(dipsForEquip[id]).sort().join(', ') : '';

      const doms  = domainSectorIndex[id]?.domains ? Array.from(domainSectorIndex[id].domains).sort().join(', ') : '';
      const sects = domainSectorIndex[id]?.sects   ? Array.from(domainSectorIndex[id].sects).sort().join(', ') : '';

      let photoUrl = '';
      try{ photoUrl = await resolvePhotoUrlFromRow(r); }catch(e){ photoUrl = ''; }

      const vgp = String(r[COL_VGP] || '').trim();
      const doc = String(r[COL_DOC] || '').trim();

      const natureTrav = String(r[COL_TRAV] || '').trim();
      const travauxTxt = String(r[COL_TMP_TR] || '').trim();
      const preci = String(r[COL_PRECI] || '').trim();
      const obs   = String(r[COL_OBS] || '').trim();

      out += "<tr><td><section class='card'>";
      out += "<div class='top'>";
      out += "<div>";
      out += "<h2 class='title'>"+escapeHtml(String(r[COL_LIB]||''))+"</h2>";
      out += "<div class='sub'><span class='badge "+kindCls+"'>"+escapeHtml(kindLabel)+"</span> &nbsp; "+regPill+"</div>";
      out += "</div>";
      out += "</div>";

      out += "<div class='grid'>";

      // Colonne gauche (infos)
      out += "<div>";
      out += "<div class='box'><div class='lab'>Etablissements</div><div class='val'>"+escapeHtml(etabs || '—')+"</div></div>";
      out += "<div class='box'><div class='lab'>Diplomes</div><div class='val'>"+escapeHtml(dips || '—')+"</div></div>";
      out += "<div class='box'><div class='lab'>Domaines / Secteurs</div><div class='val'>"+escapeHtml([doms, sects].filter(Boolean).join('\n') || '—')+"</div></div>";
      out += "<div class='box'><div class='lab'>Nature des travaux</div><div class='val'>"+escapeHtml(natureTrav || '—')+"</div></div>";
      out += "</div>";

      // Colonne droite (doc/photo)
      out += "<div>";
      out += "<div class='box'><div class='lab'>VGP / Doc bureau de controle</div><div class='val'>"+
             escapeHtml(vgp ? ('VGP : '+vgp) : 'VGP : —') + "<br>" +
             (doc ? ("<span class='muted'>URL : </span><a href='"+escapeHtml(doc)+"'>"+escapeHtml(doc)+"</a>") : "<span class='muted'>URL : —</span>") +
             "</div></div>";
      if(photoUrl){
        out += "<div class='box'><div class='lab'>Image</div><img class='photo' src='"+photoUrl+"'></div>";
      }else{
        out += "<div class='box'><div class='lab'>Image</div><div class='val muted'>—</div></div>";
      }
      out += "</div>";

      out += "</div>"; // grid

      // Travaux reglementes
      out += "<div class='box' style='margin-top:10px;'><div class='lab'>Travaux reglementes</div><div class='val "+(travauxTxt.length>220?'cols':'')+"'>"+escapeHtml(travauxTxt || '—')+"</div></div>";

      // Regime + details
      out += "<div class='box' style='margin-top:10px;'><div class='lab'>Regime / Precisions / Observations</div><div class='val'>"+
             escapeHtml((reg ? ('Regime : '+reg) : 'Regime : —')) + "<br>" +
             escapeHtml((preci ? ('Precisions : '+preci) : 'Precisions : —')) + "<br>" +
             escapeHtml((obs ? ('Observations : '+obs) : 'Observations : —')) +
             "</div></div>";      // Produit chimique (si produit)
      if(kindRaw === 'produit'){
        const pType   = String(r[COL_TR_TYPE] || '').trim();
        const pFam    = String(r[COL_TR_FAM] || '').trim();
        const pAgent  = String(r[COL_TR_AGENT] || '').trim();
        const pDanger = String(r[COL_TR_DANGER] || '').trim();
        const pEpi    = String(r[COL_TR_EPI] || '').trim();

        const lines = [
          pType   ? ('Type : '+pType) : 'Type : —',
          pFam    ? ('Famille de produits : '+pFam) : 'Famille de produits : —',
          pAgent  ? ('Agent chimique : '+pAgent) : 'Agent chimique : —',
          pDanger ? ('Danger CLP : '+pDanger) : 'Danger CLP : —',
          pEpi    ? ('EPI recommandes : '+pEpi) : 'EPI recommandes : —'
        ];

        out += "<div class='box' style='margin-top:10px;'><div class='lab'>Caracteristiques du produit</div><div class='val'>"+escapeHtml(lines.join('\n'))+"</div></div>";
      }

      out += "</section></td></tr>";
    }

    out += "</tbody></table></div></body></html>";

    // Injecter dans la fenetre
    w.document.open();
    w.document.write(out);
    w.document.close();
    w.focus();

    setTimeout(()=>{ try{ w.print(); }catch(e){} }, 450);

  }catch(e){
    console.error(e);
    try{
      if(w && !w.closed){
        w.document.body.innerHTML = "<div style='font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px'>"+
          "<h2 style='margin:0 0 10px 0'>Export impossible</h2>"+
          "<pre style='white-space:pre-wrap;background:#f1f5f9;padding:12px;border-radius:10px;border:1px solid #cbd5e1'>"+
          escapeHtml(String(e && (e.message || e)))+"</pre></div>";
      }
    }catch(_){ }
    ppToast('Export impossible : '+String(e && (e.message||e)).slice(0,60));
  }
}

/* modes de filtre */
function setFilterMode(mode){
  filterMode=mode;
  const input=qs('#filter');
  if(input){ input.setAttribute('autocomplete','off'); input.setAttribute('autocorrect','off'); input.setAttribute('autocapitalize','off'); input.setAttribute('spellcheck','false'); }
  if(!input) return;
  input.value='';

  if(mode==='autocomp'){
    input.placeholder='Filtrer…';
    input.removeAttribute('list');
  }else if(mode==='domaine'){
    input.placeholder='Filtrer par domaine…';
    input.setAttribute('list','dl-filter-domain');
  }else if(mode==='secteur'){
    input.placeholder='Filtrer par secteur…';
    input.setAttribute('list','dl-filter-secteur');
  }else if(mode==='diplome'){
    input.placeholder='Filtrer par diplôme…';
    input.setAttribute('list','dl-filter-diplome');
  }

  document.querySelectorAll('.filter-modes label').forEach(l=>l.classList.remove('active'));
  const radio=document.querySelector(`input[name="filterMode"][value="${mode}"]`);
  if(radio && radio.closest('label')) radio.closest('label').classList.add('active');

  renderList();
  // Deep-link QR: si l'URL contient #equip=..., on tente de sélectionner l'équipement
  try{
    const baseId = _hashBaseId();
    if(baseId){ selectRow(baseId, true); return; }
    const h = (window.location.hash||'');
    const m = h.match(/#equip=([^&]+)/);
    if(m){
      const sel = decodeURIComponent(m[1]);
      // tentative par id numérique puis par code
      const num = sel.match(/^\d+$/) ? parseInt(sel,10) : null;
      const foundId = (num && MAP && MAP.has(num)) ? num : null;
      if(foundId!=null){ selectRow(foundId); }
      else{
        const entries = (MAP ? Array.from(MAP.values()) : []);
        const hit = entries.find(r => norm(String(r[COL_LIB]||'')) === norm(sel));
        if(hit && hit.id!=null){ selectRow(hit.id); }
      }
    }
  }catch(e){}

}

// Filtre anti "tests" pour la liste déroulante Diplôme (ex: "ce", "aaa", etc.)
// Objectif : ne proposer que des libellés plausibles.
function isPlausibleDiplomeLabel(label){
  const s = String(label || '').trim();
  if(!s) return false;
  // Écarte les entrées très courtes (souvent des essais)
  if(s.length < 6) return false;
  // Doit contenir au moins une majuscule OU un mot-clé diplôme courant
  const hasUpper = /[A-ZÀ-ÖØ-Þ]/.test(s);
  const hasKeyword = /\b(CAP|BAC|BTS|BP|MC|CS|BUT|TP|TITRE|LICENCE|MASTER)\b/i.test(s);
  // Écarte les chaînes entièrement en minuscules (souvent des tests)
  const allLower = (s === s.toLowerCase());
  return (hasUpper || hasKeyword) && !allLower;
}

/* index domaines / secteurs / diplômes */
async function buildDomainSectorIndex(){
  domainSectorIndex = {};
  domainValues = new Set();
  sectorValues = new Set();
  diplomaValues = new Set();

  // IMPORTANT : on ne dépend pas de la table Lien_equip_etab_dipl (incomplète chez certains)
  // On indexe à partir des colonnes Tampon_* de Liste_des_equipements.
  const rows = (MAP ? Array.from(MAP.values()) : []);

  for(const r of rows){
    const id = r && r.id != null ? Number(r.id) : null;
    if(id == null) continue;

    const doms = parseTextList(r[COL_TMP_DOM] || '');
    const dips = parseTextList(r[COL_TMP_DIP] || '');

    // Sectors are present in the UI right pane as a synthesized string; we keep them out of the index
    // unless you later add a dedicated Tampon_Se... column.

    if(!domainSectorIndex[id]) domainSectorIndex[id] = { domains:new Set(), sects:new Set(), diplomes:new Set() };

    doms.forEach(d => { if(d){ domainSectorIndex[id].domains.add(d); domainValues.add(d);} });

    dips.forEach(d => {
      const lbl = String(d||'').trim();
      if(!lbl) return;
      if(!isPlausibleDiplomeLabel(lbl)) return;
      domainSectorIndex[id].diplomes.add(lbl);
      diplomaValues.add(lbl);
    });
  }

  const dlDom  = document.getElementById('dl-filter-domain');
  const dlSect = document.getElementById('dl-filter-secteur');
  const dlDipl = document.getElementById('dl-filter-diplome');

  if (dlDom) {
    dlDom.innerHTML = '';
    [...domainValues].sort((a,b)=>a.localeCompare(b,'fr')).forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      dlDom.appendChild(o);
    });
  }

  // Secteur: la liste est gardée vide volontairement si on n'a pas de colonne Tampon dédiée
  // (évite de proposer des suggestions trompeuses). Le filtre 'Secteur' continue de fonctionner via autocomplète.
  if (dlSect) {
    dlSect.innerHTML = '';
  }

  if (dlDipl) {
    dlDipl.innerHTML = '';
    [...diplomaValues].sort((a,b)=>a.localeCompare(b,'fr')).forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      dlDipl.appendChild(o);
    });
  }
}


/* ==========================================================
   STICKY NOM + LIBELLÉ COLORÉ
   ========================================================== */
function setSticky(rec){
  const name=String(rec[COL_LIB]||'—');
  qs('#currentEquipName').textContent=name;
  qs('#delName').textContent=name;

  // Libellé "Equipement en cours" / "Produit en cours" selon la colonne Type
  try{
    const kind = readKindFromRec(rec);
    const lbl = document.querySelector('.current-equip-label');
    if(lbl){
      lbl.textContent = (kind === 'produit') ? 'Produit en cours' : 'Equipement en cours';
    }
  }catch(e){}
}

function colorizeLibFromRegime(rec){
  const lib = qs('#f-lib');
  const regime = (rec[COL_TMP_REG] ?? '').toString().trim();
  const color = colorFromLabel(regime);
  const stickyName = qs('#currentEquipName');

  if (!color) {
    lib.style.background = '';
    lib.style.color = '';
    if (stickyName) {
      stickyName.style.color = 'var(--text)';
    }
    return;
  }

  lib.style.background = color;
  const rgb = parseInt(color.slice(1), 16);
  const r = (rgb >> 16) & 255, g = (rgb >> 8) & 255, b = rgb & 255;
  const lum = .299 * r + .587 * g + .114 * b;
  lib.style.color = (lum < 140) ? '#f9fafb' : '#111827';

  if (stickyName) {
    stickyName.style.color = color;
  }
}



/* ==========================================================
   CHAMPS PERSONNALISÉS (Champs_perso) — par établissement + équipement
   - champs : Reference, Atelier, Annee, Notes
   - photo override : Photo_url, Photo_thumb
   ========================================================== */
const TABLE_PERSO = 'Champs_perso';
const COL_PERSO_CODE = 'Codepaca';
const COL_PERSO_EQUIP = 'Equipement';
const COL_PERSO_REF  = 'Reference';
const COL_PERSO_ATEL = 'Atelier';
const COL_PERSO_ANNEE= 'Annee';
const COL_PERSO_NOTES= 'Notes';
const COL_PERSO_PHOTO_URL  = 'Photo_url';
const COL_PERSO_PHOTO_THMB = 'Photo_thumb';

let PERSO_LOADED = false;
let PERSO_INDEX = new Map(); // key: code::equipId -> record
let ADMIN_TARGET_CODE = '';
let ADMIN_TARGET_LABEL = '';

function getRefId(v){
  if(v==null) return null;
  if(Array.isArray(v)) return getRefId(v[0]);
  if(typeof v==='object') return v.id ?? v.rowId ?? v.value ?? null;
  if(typeof v==='number') return v;
  const n = String(v).trim();
  return /^\d+$/.test(n) ? Number(n) : null;
}
function persoKey(code, equipId){
  return String(code||'').trim()+'::'+String(equipId||'');
}

function getEffectivePersoCode(){
  // ⚠️ Règle : en MODE ADMIN, on n'utilise JAMAIS le code "mode ajout" (ADD_MODE_CODE),
  // sinon l'admin peut écraser des données établissement (référence/notes/photos) par erreur.
  const isAdmin = (typeof ADMIN_MODE!=='undefined'?ADMIN_MODE:window.ADMIN_MODE);
  if(isAdmin){
    if(String(ADMIN_TARGET_CODE||'').trim()) return String(ADMIN_TARGET_CODE||'').trim();
    return ''; // admin sans établissement cible => pas de champs perso
  }

  const add = String((typeof ADD_MODE_CODE!=='undefined'?ADD_MODE_CODE:window.ADD_MODE_CODE)||'').trim();
  const addActive = (typeof ADD_MODE_ACTIVE!=='undefined'?ADD_MODE_ACTIVE:window.ADD_MODE_ACTIVE);
  if(addActive && add) return add;

  return '';
}

function adminWantsEtabPhoto(){
  const sw = document.getElementById('photoTargetSwitch');
  const isAdmin = (typeof ADMIN_MODE!=='undefined'?ADMIN_MODE:window.ADMIN_MODE);
  if(!isAdmin) return true; // pas admin: si add-mode, on veut la photo établissement; sinon, base.
  return !!(sw && sw.checked);
}

function shouldUseEtabOverride(){
  // Add-mode (établissement) : oui si code présent
  // Admin : uniquement si switch "Photo établissement" coché ET établissement cible défini
  const isAdmin   = (typeof ADMIN_MODE!=='undefined'?ADMIN_MODE:window.ADMIN_MODE);
  const addActive = (typeof ADD_MODE_ACTIVE!=='undefined'?ADD_MODE_ACTIVE:window.ADD_MODE_ACTIVE);

  if(isAdmin){
    // En admin, on ne fait JAMAIS d'override sans cible (sinon écrasements)
    if(!adminWantsEtabPhoto()) return false; // switch décoché => photo de base
    const code = String(ADMIN_TARGET_CODE||'').trim();
    return !!code;
  }

  const code = getEffectivePersoCode();
  if(addActive && code) return true;
  return false;
}

async function ensurePersoLoaded(force=false){
  // ✅ Charger la table Champs_perso uniquement quand un établissement est réellement "connecté"
  // (code établissement validé en mode ajout, ou établissement cible sélectionné en mode admin).
  const _persoCode = (typeof getEffectivePersoCode === 'function') ? String(getEffectivePersoCode()||'').trim() : '';
  if(!_persoCode){
    // Pas de code => on ne tente pas d'accéder à la table (évite les erreurs au chargement initial)
    PERSO_LOADED = false;
    return;
  }

  if(PERSO_LOADED && !force) return;
  PERSO_INDEX = new Map();

  console.log('[PERSO v15.4] ensurePersoLoaded appelé', {
    force: force,
    code: _persoCode,
    has_grist: !!window.grist,
    has_docApi: !!(window.grist && window.grist.docApi)
  });

  try{
    if(!window.grist || !grist.docApi) {
      console.warn('[PERSO v15.4] Grist API indisponible');
      return;
    }
    
    // Essayer différents noms de table possibles
    const possibleNames = ['Champs_perso', 'Champs perso', 'CHAMPS_PERSO', 'Champs Perso'];
    let t = null;
    let foundTableName = null;
    
    for(const name of possibleNames) {
      try {
        console.log(`[PERSO v15.4] Tentative de lecture de la table "${name}"...`);
        t = await grist.docApi.fetchTable(name);
        foundTableName = name;
        console.log(`[PERSO v15.4] ✅ Table "${name}" trouvée avec ${t.id ? t.id.length : 0} enregistrements`);
        break;
      } catch(err) {
        console.warn(`[PERSO v15.4] ❌ Table "${name}" non trouvée:`, err.message);
      }
    }
    
    if(!t) {
      console.error('[PERSO v15.4] ❌ Aucune table de champs personnalisés trouvée !');
      console.error('[PERSO v15.4] Noms essayés:', possibleNames);
      return;
    }
    
    // Si on a trouvé un nom différent, le sauvegarder
    if(foundTableName && foundTableName !== TABLE_PERSO) {
      console.warn(`[PERSO v15.4] ⚠️ La table s'appelle "${foundTableName}" et non "${TABLE_PERSO}"`);
      console.warn('[PERSO v15.4] Veuillez mettre à jour TABLE_PERSO dans le code');
    }
    
    const recs = rowsToRecordsCompat(t);
    console.log(`[PERSO v15.4] ${recs.length} enregistrements chargés depuis ${foundTableName}`);
    
    recs.forEach((r, idx) => {
      const code = String(r[COL_PERSO_CODE]||'').trim();
      const eid = getRefId(r[COL_PERSO_EQUIP]);
      
      if(idx < 3) { // Log des 3 premiers pour debug
        console.log(`[PERSO v15.4] Enreg ${idx}:`, {
          id: r.id,
          code: code,
          equipId: eid,
          raw_equip: r[COL_PERSO_EQUIP]
        });
      }
      
      if(!code || !eid) {
        if(idx < 3) console.warn(`[PERSO v15.4] Enreg ${idx} ignoré (code ou equipId manquant)`);
        return;
      }
      PERSO_INDEX.set(persoKey(code,eid), r);
    });
    
    console.log(`[PERSO v15.4] Index construit avec ${PERSO_INDEX.size} entrées`);
    PERSO_LOADED = true;
  }catch(e){
    console.error('[PERSO v15.4] ❌ Erreur critique dans ensurePersoLoaded:', e);
  }
}

function setPersoInputsEnabled(enabled){
  ['perso-reference','perso-atelier','perso-annee','perso-notes'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.disabled = !enabled;
    if(!enabled){
      el.setAttribute('readonly','readonly');
    }else{
      el.removeAttribute('readonly');
    }
  });
}

function fillPersoUI(rec){
  const r = rec || {};
  const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.value = (val ?? '').toString(); };
  set('perso-reference', r[COL_PERSO_REF]);
  set('perso-atelier',   r[COL_PERSO_ATEL]);
  set('perso-annee',     r[COL_PERSO_ANNEE]);
  set('perso-notes',     r[COL_PERSO_NOTES]);
}

async function refreshPersoBlock(){
  const block = document.getElementById('persoFieldsBlock');
  if(!block) return;

  const isAdmin = (typeof ADMIN_MODE!=='undefined'?ADMIN_MODE:window.ADMIN_MODE);
  const addActive = (typeof ADD_MODE_ACTIVE!=='undefined'?ADD_MODE_ACTIVE:window.ADD_MODE_ACTIVE);
  const addCode = String((typeof ADD_MODE_CODE!=='undefined'?ADD_MODE_CODE:window.ADD_MODE_CODE)||'').trim();

  // Admin: afficher la ligne "établissement cible"
  const adminRow = document.getElementById('adminPersoTargetRow');
  if(adminRow) adminRow.style.display = (isAdmin ? 'flex' : 'none');

  // Admin: afficher switch photo
  const swRow = document.getElementById('adminPhotoSwitchRow');
  if(swRow) swRow.style.display = (isAdmin ? 'flex' : 'none');

  const code = getEffectivePersoCode();
  const canEdit = (addActive && addCode) || (isAdmin && String(ADMIN_TARGET_CODE||'').trim());
  
  // ✅ NOUVEAU : Masquer/afficher le bloc entier selon la connexion
  const isConnected = !!(addActive && addCode) || isAdmin;
  block.style.display = isConnected ? 'block' : 'none';
  
  // Si pas connecté, on arrête ici (le bloc est masqué)
  if(!isConnected) return;
  
  setPersoInputsEnabled(!!canEdit);

  const msg = document.getElementById('persoMsg');

  if(!code){
    fillPersoUI(null);
    if(msg){
      msg.textContent = isAdmin
        ? 'Sélectionnez un établissement cible pour accéder aux champs personnalisés.'
        : 'Connectez-vous avec un code établissement pour afficher/saisir les champs personnalisés.';
    }
    return;
  }

  const rec = (window.currentRec) || (window.ROW) || (typeof ROW!=='undefined' ? ROW : null) || (window.grist && window.grist.selectedRecord) || null;
  if(!rec){
    fillPersoUI(null);
    if(msg) msg.textContent = '';
    return;
  }
  // Garder les pointeurs globaux cohérents (utile pour les autres blocs : photo, fiche de poste, etc.)
  try{ window.currentRec = rec; }catch(e){}
  try{ window.ROW = rec; }catch(e){}

  const equipId = Number(rec.id || rec.rowId || rec);
  await ensurePersoLoaded(false);
  const perso = PERSO_INDEX.get(persoKey(code, equipId)) || null;
  fillPersoUI(perso);

  if(msg) msg.textContent = perso ? '' : "Aucune saisie existante : modifiez un champ pour créer l'enregistrement.";
}

let __persoSaveTimer = null;
function schedulePersoSave(){
  if(__persoSaveTimer) clearTimeout(__persoSaveTimer);
  __persoSaveTimer = setTimeout(savePersoNow, 450);
}

function initPersoAutosave(){
  console.log('[PERSO-INIT] 🚀 initPersoAutosave() appelée');
  const ids = ['perso-reference','perso-atelier','perso-annee','perso-notes'];
  let foundCount = 0;
  let listenerCount = 0;
  
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) {
      console.warn(`[PERSO-INIT] ❌ Élément #${id} non trouvé`);
      return;
    }
    foundCount++;
    console.log(`[PERSO-INIT] ✅ Élément #${id} trouvé`);
    
    // ✅ FIX v15.4 : Déclencher la sauvegarde différée sur input/change
    const scheduleSave = ()=>{
      console.log(`[PERSO-SAVE] 📝 input/change sur #${id}, disabled=${el.disabled}`);
      if(el.disabled) {
        console.warn(`[PERSO-SAVE] ⚠️ #${id} est disabled, pas de sauvegarde`);
        return;
      }
      schedulePersoSave();
    };
    
    // ✅ FIX v15.4 : Forcer la sauvegarde immédiate sur blur
    const forceSave = ()=>{
      console.log(`[PERSO-SAVE] 💾 blur sur #${id}, disabled=${el.disabled}`);
      if(el.disabled) {
        console.warn(`[PERSO-SAVE] ⚠️ #${id} est disabled, pas de sauvegarde`);
        return;
      }
      if(__persoSaveTimer) clearTimeout(__persoSaveTimer);
      console.log(`[PERSO-SAVE] 🔥 Appel savePersoNow() depuis blur sur #${id}`);
      savePersoNow();
    };
    
    el.addEventListener('input', scheduleSave);
    el.addEventListener('change', scheduleSave);
    el.addEventListener('blur', forceSave); // Sauvegarde immédiate sur perte de focus
    listenerCount += 3;
  });
  
  console.log(`[PERSO-INIT] ✅ Initialisation terminée: ${foundCount}/4 éléments trouvés, ${listenerCount} listeners attachés`);
}


async function savePersoNow(){
  console.log('[PERSO-SAVE] 🔥🔥🔥 savePersoNow() APPELÉE 🔥🔥🔥');
  const msg = document.getElementById('persoMsg');
  const code = getEffectivePersoCode();
  
  // 🔥 NOUVEAU : Chercher l'équipement actuel dans plusieurs sources
  let currentEquip = null;
  
  if(window.currentRec && (window.currentRec.id || window.currentRec.rowId)){
    currentEquip = window.currentRec;
    console.log('[PERSO-SAVE] ✅ Equipement trouvé via window.currentRec');
  } else if(typeof ROW !== 'undefined' && ROW && (ROW.id || ROW.rowId)){
    currentEquip = ROW;
    console.log('[PERSO-SAVE] ✅ Equipement trouvé via ROW (fallback)');
  } else if(window.grist && window.grist.selectedRecord){
    currentEquip = window.grist.selectedRecord;
    console.log('[PERSO-SAVE] ✅ Equipement trouvé via grist.selectedRecord (fallback 2)');
  }
  
  console.log('[PERSO v15.4] savePersoNow appelé:', {
    code: code,
    has_currentRec: !!window.currentRec,
    has_ROW: !!(typeof ROW !== 'undefined' && ROW),
    has_selectedRecord: !!(window.grist && window.grist.selectedRecord),
    currentEquip_found: !!currentEquip,
    currentEquip_id: currentEquip ? (currentEquip.id || currentEquip.rowId) : null,
    has_grist: !!window.grist,
    has_docApi: !!(window.grist && window.grist.docApi),
    has_applyUserActions: !!(window.grist && window.grist.docApi && window.grist.docApi.applyUserActions)
  });
  
  if(!code){ 
    if(msg) msg.textContent = 'Établissement cible manquant.'; 
    console.warn('[PERSO v15.4] Code établissement manquant');
    return; 
  }
  if(!currentEquip){ 
    if(msg) msg.textContent = 'Aucun équipement sélectionné.'; 
    console.error('[PERSO-SAVE] ❌ Aucun équipement trouvé (ni currentRec, ni ROW, ni selectedRecord)');
    return; 
  }

  const equipId = Number(currentEquip.id || currentEquip.rowId || currentEquip);

  const payload = {
    [COL_PERSO_CODE]: code,
    [COL_PERSO_EQUIP]: equipId,
    [COL_PERSO_REF]:  (document.getElementById('perso-reference')?.value || '').trim(),
    [COL_PERSO_ATEL]: (document.getElementById('perso-atelier')?.value || '').trim(),
    [COL_PERSO_ANNEE]:(document.getElementById('perso-annee')?.value || '').trim(),
    [COL_PERSO_NOTES]:(document.getElementById('perso-notes')?.value || '').trim(),
  };

  console.log('[PERSO v15.4] Payload à sauvegarder:', payload);

  try{
    await ensurePersoLoaded(false);
    const key = persoKey(code, equipId);
    const existing = PERSO_INDEX.get(key);
    
    console.log('[PERSO v15.4] Enregistrement existant:', existing ? `id=${existing.id}` : 'nouveau');

    // Écriture Grist (préférer applyUserActions, fallback update/add)
    const api = (window.grist && grist.docApi) ? grist.docApi : null;
    if(!api){ 
      throw new Error('docApi indisponible'); 
    }

    if(typeof api.applyUserActions === 'function'){
      if(existing && existing.id){
        console.log('[PERSO v15.4] 🔥 TENTATIVE UpdateRecord:', TABLE_PERSO, existing.id);
        await api.applyUserActions([[ 'UpdateRecord', TABLE_PERSO, existing.id, payload ]]);
        console.log('[PERSO v15.4] ✅ UpdateRecord réussi !');
      }else{
        console.log('[PERSO v15.4] 🔥 TENTATIVE AddRecord:', TABLE_PERSO);
        await api.applyUserActions([[ 'AddRecord', TABLE_PERSO, null, payload ]]);
        console.log('[PERSO v15.4] ✅ AddRecord réussi !');
      }
    }else if(typeof api.updateRecord === 'function' && typeof api.addRecord === 'function'){
      if(existing && existing.id){
        console.log('[PERSO v15.4] 🔥 TENTATIVE updateRecord (fallback):', TABLE_PERSO, existing.id);
        await api.updateRecord(TABLE_PERSO, existing.id, payload);
        console.log('[PERSO v15.4] ✅ updateRecord réussi !');
      }else{
        console.log('[PERSO v15.4] 🔥 TENTATIVE addRecord (fallback):', TABLE_PERSO);
        await api.addRecord(TABLE_PERSO, payload);
        console.log('[PERSO v15.4] ✅ addRecord réussi !');
      }
    }else{
      throw new Error("Aucune méthode d'écriture Grist disponible");
    }

    await ensurePersoLoaded(true);
    const saved = PERSO_INDEX.get(key);
    if(saved) fillPersoUI(saved);
    if(msg) msg.textContent = 'Enregistré.';
    setTimeout(()=>{ if(msg && msg.textContent==='Enregistré.') msg.textContent=''; }, 1200);

    // Mise à jour de la fiche de poste si elle est ouverte
    try{ if(document.getElementById('dlgFichePoste')?.getAttribute('aria-hidden')==='false'){ await openFichePosteDialog(); } }catch(e){}
  }catch(e){
    console.error('[PERSO v15.4] ❌ Erreur sauvegarde:', e);
    if(msg) msg.textContent = "Erreur d'enregistrement. Vérifiez les droits d'écriture et la console.";
  }
}

async function resolveAdminTargetCodeFromLabel(label){
  const v = (label||'').toString().trim();
  if(!v){ ADMIN_TARGET_CODE=''; ADMIN_TARGET_LABEL=''; return; }
  const cfgE = await ensureTable(['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'], COL_ETAB_LABEL);
  const r = cfgE.byNorm.get(norm(v));
  if(!r){ ADMIN_TARGET_CODE=''; ADMIN_TARGET_LABEL=v; return; }
  ADMIN_TARGET_LABEL = (r[cfgE.labelCol]??v).toString();
  ADMIN_TARGET_CODE  = (r[COL_ETAB_CODE]??'').toString().trim();
}

document.addEventListener('DOMContentLoaded', () => {
  // ✅ FIX v15.4 : Suppression des listeners dupliqués
  // Les listeners sont déjà attachés dans initPersoAutosave()
  // Garder uniquement les listeners pour adminTargetEtab et photoTargetSwitch

  const adminInp = document.getElementById('adminTargetEtab');
  if(adminInp){
    adminInp.addEventListener('change', async ()=>{
      await resolveAdminTargetCodeFromLabel(adminInp.value);
      try{ await refreshPersoBlock(); }catch(e){}
      try{ if(window.ROW){ const rec=MAP.get(Number(ROW.id))||ROW;
  window.currentRec = rec; await renderPhoto(rec); } }catch(e){}
    });
  }

  const sw = document.getElementById('photoTargetSwitch');
  if(sw){
    sw.addEventListener('change', async ()=>{
      try{ if(window.ROW){ const rec=MAP.get(Number(ROW.id))||ROW; await renderPhoto(rec); } }catch(e){}
      try{ await refreshPersoBlock(); }catch(e){}
    });
  }
});

/* ==========================================================
   PHOTOS / SUPABASE
   ========================================================== */
function extractUrl(val){
  if(val==null) return '';
  if(Array.isArray(val)) return extractUrl(val[0]);
  if(typeof val==='object'){return String(val.url||val.href||val.src||'');}
  const s=String(val).trim();
  if(!s) return '';
  if(s.includes('<img')){
    const m=s.match(/src\s*=\s*"(.*?)"/i)||s.match(/src\s*=\s*'(.*?)'/i);
    return m?m[1]:'';
  }
  return s;
}
function firstAttachmentId(v){
  if(v==null) return null;
  if(Array.isArray(v)){
    if(!v.length) return null;
    const x=v[0];
    return typeof x==='number'?x:(x&&typeof x==='object'?x.id??null:null);
  }
  if(typeof v==='number') return v;
  if(typeof v==='object') return v.id??null;
  return null;
}
async function getAttachmentUrlCompat(attId){
  if(!attId) return null;
  if(grist?.docApi?.getAttachmentUrl){
    try{return await window.grist.docApi.getAttachmentUrl(attId);}catch{}
  }
  if(typeof grist?.getAttachmentUrl==='function'){
    try{return window.grist.getAttachmentUrl(attId);}catch{}
  }
  return null;
}
async function resolvePhotoUrlFromRow(row){
  // 1) Override établissement (Champs_perso) si on est en mode établissement ou admin+switch
  try{
    const code = getEffectivePersoCode();
    const equipId = Number(row?.id || row?.rowId || row?.ID || row?.Id);
    if(code && equipId && shouldUseEtabOverride()){
      await ensurePersoLoaded(false);
      const pr = PERSO_INDEX.get(persoKey(code, equipId));
      const pu = extractUrl(pr?.[COL_PERSO_PHOTO_URL]);
      const pt = extractUrl(pr?.[COL_PERSO_PHOTO_THMB]);
      if(pu || pt) return pt || pu;
    }
  }catch(e){ /* silencieux */ }

  // 2) Photos de base (supabase / attachement / legacy)
  const sbMain=extractUrl(row?.[COL_SB_URL]);
  const sbTh=extractUrl(row?.[COL_SB_THMB]);
  if(sbMain||sbTh) return sbTh||sbMain;
  const attId=firstAttachmentId(row?.[COL_PHOTO_ATT]);
  if(attId){
    const u=await getAttachmentUrlCompat(attId);
    if(u) return u;
  }
  const legacy=extractUrl(row?.[LEGACY_THMB]) || extractUrl(row?.[LEGACY_URL]) || '';
  return legacy;
}

async function resizeImage(file,maxBytes=1024*1024){
  if(file.size<=maxBytes) return file;
  const img=await new Promise((res,rej)=>{
    const i=new Image();
    i.onload=()=>res(i);
    i.onerror=rej;
    i.src=URL.createObjectURL(file);
  });
  const canvas=document.createElement('canvas');
  const ctx=canvas.getContext('2d');
  canvas.width=img.width; canvas.height=img.height;
  ctx.drawImage(img,0,0);
  let quality=.9,out;
  for(let step=0;step<8;step++){
    out=await new Promise(r=>canvas.toBlob(b=>r(b),'image/jpeg',quality));
    if(out && out.size<=maxBytes) break;
    quality-=.1;if(quality<=.3)break;
  }
  return out||file;
}
async function uploadSupabase(file){
  const base=SUPABASE_URL.replace(/\/+$/,'');
  const bucket=encodeURIComponent(SUPABASE_BUCKET);
  const prefix=(SUPABASE_PATH_PREFIX||'').replace(/^\/+/,'');
  const path=`${prefix}${Date.now()}-${file.name}`.replace(/\s+/g,'_');
  const putUrl=`${base}/storage/v1/object/${bucket}/${encodeURIComponent(path)}`;
  const res=await fetch(putUrl,{
    method:'POST',
    headers:{
      'Authorization':`Bearer ${SUPABASE_ANON_KEY}`,
      'apikey':SUPABASE_ANON_KEY,
      'Content-Type':file.type||'application/octet-stream'
    },
    body:file
  });
  if(!res.ok) throw new Error(`Supabase: ${res.status}`);
  const publicUrl=`${base}/storage/v1/object/public/${bucket}/${encodeURIComponent(path)}`;
  return{url:publicUrl,thumb:publicUrl};
}

/* ==========================================================
   TEXTE NATUREL / LISTES
   ========================================================== */
function parseTextList(text){
  return (text||'').toString()
    .split(/[;/]/)
    .map(s=>s.trim())
    .filter(Boolean)
    .filter((v,i,a)=>a.findIndex(x=>norm(x)===norm(v))===i);
}

/* Spécifique travaux réglementés : garder ordre et doublons */
function splitTravField(text){
  return (text||'').toString()
    .split(';')
    .map(s=>s.trim())
    .filter(Boolean);
}

function setNaturalTextLines(elId, list){
  const el=document.getElementById(elId);
  if(!el) return;
  el.innerHTML='';
  (list||[]).forEach((t)=>{
    const span=document.createElement('span');
    span.textContent=t;
    el.appendChild(span);
  });
}

/* Affichage spécial des établissements avec croix en mode admin */
function renderEtNatural(labels){
  const cont = document.getElementById('et-natural');
  if (!cont) return;
  cont.innerHTML = '';

  (labels || []).forEach(label => {
    const span = document.createElement('span');
    span.textContent = label;

    if (ADMIN_MODE) {
      span.style.cursor = 'pointer';
      span.addEventListener('click', () => {
        removeEtabForCurrentEquip(label);
      });

      const x = document.createElement('span');
      x.textContent = ' ✕';
      x.className = 'chip-remove';
      x.addEventListener('click', (e) => {
        e.stopPropagation();
        removeEtabForCurrentEquip(label);
      });

      span.appendChild(x);
    }

    cont.appendChild(span);
  });
}

/* Domaines / secteur depuis diplômes */
async function buildDomainesEtSecteurs(rec){
  const cfgD=await ensureTable(['Diplomes_EN_OK'],COL_DIP_CONCAT);
  const rows=cfgD.rows;
  if(!rows.length) {
    setNaturalTextLines('dp-natural',[]);
    setNaturalTextLines('sect-natural',[]);
    return;
  }
  const domainCol = Object.keys(rows[0]||{}).find(c=>norm(c).includes('domaine')) || 'Domaines_professionnels';
  const sectCol   = Object.keys(rows[0]||{}).find(c=>norm(c).includes('secteur')) || 'Secteur_activite';

  const diplLabels=parseTextList((rec[COL_TMP_DIP]??'').toString());
  const domSet=new Set();
  const sectSet=new Set();

  diplLabels.forEach(l=>{
    const r=cfgD.byNorm.get(norm(l));
    if(!r) return;
    parseTextList((r[domainCol]??'').toString()).forEach(d=>domSet.add(d));
    parseTextList((r[sectCol]??'').toString()).forEach(s=>sectSet.add(s));
  });

  setNaturalTextLines('dp-natural',[...domSet]);
  setNaturalTextLines('sect-natural',[...sectSet]);
}

/* ==========================================================
   RE-CALCUL / SUPPRESSION ETAB PAR ÉQUIPEMENT
   ========================================================== */
async function removeEtabForCurrentEquip(label){
  if (!ROW) return;

  const cfgE = await ensureTable(
    ['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
    COL_ETAB_LABEL
  );

  const labelNorm = norm(label);

  let etRow = cfgE.byNorm.get(labelNorm);

  if (!etRow) {
    etRow = cfgE.rows.find(r => {
      const v = (r[cfgE.labelCol] ?? '').toString();
      const vNorm = norm(v);
      return (
        vNorm === labelNorm ||
        vNorm.includes(labelNorm) ||
        labelNorm.includes(vNorm)
      );
    });
  }

  if (!etRow) {
    console.warn('Établissement non trouvé pour suppression', label);
    return;
  }

  const etabId  = Number(etRow.id);
  const equipId = Number(ROW.id);

  const linkRows = await fetchTable(TBL_LINK);
  const actions = [];

  linkRows.forEach(l => {
    const eId = refId(l[COL_L_EQUIP]);
    const etId = refId(l[COL_L_ETAB]);
    if (eId === equipId && etId === etabId) {
      actions.push(['RemoveRecord', TBL_LINK, Number(l.id)]);
    }
  });

  await runQuick(async () => {
    if (actions.length) {
      await applyUA(actions);
    }
    await recomputeAggregatesForCurrentEquip();
  });

  await logHistory('Suppression établissement (équipement)', {
    equipId,
    etabName: label,
    details: `Établissement supprimé des liens pour cet équipement`
  });
}

/* ==========================================================
   RE-CALCUL AGGRÉGATS
   ========================================================== */
async function recomputeAggregatesForCurrentEquip(){
  if(!ROW) return;
  const equipId=Number(ROW.id);

  const linkRows=await fetchTable(TBL_LINK);
  const etabIds=new Set();
  const dipIds=new Set();

  linkRows.forEach(l=>{
    const eId=refId(l[COL_L_EQUIP]);
    const etId=refId(l[COL_L_ETAB]);
    const dId=refId(l[COL_L_DIP]);
    if(eId!==equipId) return;
    const etIdNum=etId!=null?Number(etId):null;
    const dIdNum=dId!=null?Number(dId):null;
    if(etIdNum!=null && dIdNum!=null){
      etabIds.add(etIdNum);
      dipIds.add(dIdNum);
    }
  });

  const cfgE = await ensureTable(
    ['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
    COL_ETAB_LABEL
  );
  const cfgD=await ensureTable(['Diplomes_EN_OK'],COL_DIP_CONCAT);

  const etabLabels=[];
  cfgE.rows.forEach(r=>{
    const idNum=Number(r.id);
    if(etabIds.has(idNum)){
      const label=(r[cfgE.labelCol]??'').toString().trim();
      if(label) etabLabels.push(label);
    }
  });

  const rowsD=cfgD.rows;
  if(rowsD.length){
    const domainCol = Object.keys(rowsD[0]||{}).find(c=>norm(c).includes('domaine')) || 'Domaines_professionnels';
    const sectCol   = Object.keys(rowsD[0]||{}).find(c=>norm(c).includes('secteur')) || 'Secteur_activite';

    const diplLabels=[];
    const domSet=new Set();
    const sectSet=new Set();

    rowsD.forEach(r=>{
      const id=Number(r.id);
      if(!dipIds.has(id)) return;
      const label=(r[cfgD.labelCol]??'').toString().trim();
      if(label && !diplLabels.some(l=>norm(l)===norm(label))) diplLabels.push(label);
      parseTextList((r[domainCol]??'').toString()).forEach(d=>domSet.add(d));
      parseTextList((r[sectCol]??'').toString()).forEach(s=>sectSet.add(s));
    });

    const domaines=[...domSet];
    const secteurs=[...sectSet];

    renderEtNatural(etabLabels);
    setNaturalTextLines('di-natural',diplLabels);
    setNaturalTextLines('dp-natural',domaines);
    setNaturalTextLines('sect-natural',secteurs);

    const updates={};
    updates[COL_TMP_ETB]=etabLabels.length?etabLabels.join('; '):null;
    updates[COL_TMP_DIP]=diplLabels.length?diplLabels.join('; '):null;
    updates[COL_TMP_DOM]=domaines.length?domaines.join('; '):null;

    await applyUA([['UpdateRecord',TBL_MAIN,equipId,updates]]);
    const rec=MAP.get(equipId)||ROW;
    rec[COL_TMP_ETB]=updates[COL_TMP_ETB];
    rec[COL_TMP_DIP]=updates[COL_TMP_DIP];
    rec[COL_TMP_DOM]=updates[COL_TMP_DOM];
    MAP.set(equipId,rec);

    await buildDomainSectorIndex();
  } else {
    renderEtNatural(etabLabels);
    setNaturalTextLines('di-natural',[]);
    setNaturalTextLines('dp-natural',[]);
    setNaturalTextLines('sect-natural',[]);
  }
}

/* ==========================================================
   TRAVAUX RÉGLEMENTÉS – données + tableau
   ========================================================== */
async function ensureTravauxData(){
  if(travRows.length) return;
  const rows = await fetchTable(TBL_TRAV);
  travRows = rows.slice().sort((a,b)=>{
    const av = (a[COL_TR_NUMPOS] ?? a[COL_TR_NUMPOS_FALLBACK] ?? 0);
    const bv = (b[COL_TR_NUMPOS] ?? b[COL_TR_NUMPOS_FALLBACK] ?? 0);
    return Number(av||0) - Number(bv||0);
  });

  const artRows = await fetchTable(TBL_ART);
  artIndex = new Map();
  artRows.forEach(r=>{
    const num = (r[COL_ART_NUM] ?? '').toString().trim();
    const url = (r[COL_ART_URL] ?? '').toString().trim();
    if(num) artIndex.set(norm(num), url);
  });
}

function rebuildTravSelectionFromTampon(rec){
  travSelection = {};
  // 1) mode normal: clés stockées (JSON ou ; séparé)
  var rawKeys = (rec && rec[COL_TMP_INTI_TR]) ? String(rec[COL_TMP_INTI_TR]) : '';
  var keys = [];
  if(rawKeys){
    try{
      var j = JSON.parse(rawKeys);
      if(Array.isArray(j)) { keys = j.map(function(x){return String(x);}); }
    }catch(e){}
    if(!keys.length){
      keys = rawKeys.split(';').map(function(s){return String(s).trim();}).filter(Boolean);
    }
  }
  if(keys.length){
    keys.forEach(function(k){ travSelection[k] = true; });
    return;
  }

  // 2) compat legacy: reconstruction depuis la liste rendue (Tampon_travaux)
  var raw = (rec && rec[COL_TMP_TR]) ? String(rec[COL_TMP_TR]) : '';
  if(!raw) return;

  var lines = raw.replace(/<br\s*\/?\s*>/gi,'\n').split(/\n+/).map(function(s){return s.trim();}).filter(Boolean);

  function extractFicheAndFirstArticle(line){
    var mf = line.match(/N\s*[°o]\s*fiche\s*(\d+)/i);
    var fiche = mf ? mf[1] : '';
    var ma = line.match(/\b([DR])\s*\.?\s*(\d{3,4}\s*[-\.]\s*\d{1,3}\s*[-\.]\s*\d{1,3})\b/i);
    var art = ma ? (ma[1].toUpperCase()+'.'+ma[2].replace(/\s+/g,'').replace(/\./g,'-')) : '';
    return {fiche:fiche, art:art};
  }

  lines.forEach(function(line){
    var info = extractFicheAndFirstArticle(line);
    if(!travRows || !travRows.length) return;
    for(var i=0;i<travRows.length;i++){
      var r = travRows[i];
      var fiche = ficheNumFromRow(r);
      if(info.fiche && fiche && String(fiche) !== String(info.fiche)) continue;

      var red = String(getFirstField(r,['Travaux_frappes_d_interdiction_totale','Travaux_frappes_d_interdiction_totale_','Travaux_frappes_dinterdiction_totale','Red','ROUGE'])||'');
      var org = String(getFirstField(r,['Travaux_interdits_soumis_a_declaration_de_derogation_ou_Travaux_reglementes','Travaux_interdits_soumis_a_declaration_de_derogation_ou_Travaux_reglementes_','Orange','ORANGE'])||'');
      var grn = String(getFirstField(r,['Travaux_autorise_non_soumis_a_declaration_de_derogation','Travaux_autorise_non_soumis_a_declaration_de_derogation_','Green','VERT'])||'');

      function hasArt(txt){ return info.art && txt && txt.toUpperCase().indexOf(info.art.toUpperCase().replace(/\s+/g,''))>=0; }

      if(!info.art){
        travSelection[String(r.id)+'|orange'] = true;
        break;
      }
      if(hasArt(red)){ travSelection[String(r.id)+'|red']=true; break; }
      if(hasArt(org)){ travSelection[String(r.id)+'|orange']=true; break; }
      if(hasArt(grn)){ travSelection[String(r.id)+'|green']=true; break; }
    }
  });
}

function rebuildTravSelectionFromUI(){
  // Reconstruit la sélection TR à partir des chips visibles (clé = rowId|kind)
  travSelection = {};

  const chips = document.querySelectorAll('#tr-lines .tr-chip');
  if (chips && chips.length) {
    chips.forEach(chip => {
      const kind = chip.dataset.kind || 'orange';
      const rowId = (chip.dataset.rowid || '').trim();
      if(rowId){
        const key = `${rowId}|${kind}`;
        travSelection[key] = true;
        return;
      }
      // Fallback legacy (sans rowId) : moins fiable si doublons
      const labelSpan = chip.querySelector('span');
      const label = (labelSpan?.textContent || chip.firstChild?.textContent || '').trim();
      if (!label) return;
      const n = norm(label);
      const row = travRows.find(r => norm((r[COL_TR_LABEL] || '').toString()) === n);
      if (!row) return;
      const k2 = `${row.id}|${kind}`;
      travSelection[k2] = true;
    });

    if (Object.keys(travSelection).length) return;
  }

  // Sinon on relit depuis le tampon (champ texte) pour compat
  rebuildTravSelectionFromTampon(ROW || rec);
}

function buildTravauxTableBody(){
  const tbody = document.getElementById('trav-tbody');
  if(!tbody) return;
  tbody.innerHTML = '';

  travRows.forEach(r=>{
    const tr = document.createElement('tr');

    const tdTrav = document.createElement('td');
    tdTrav.className = 'trav-col-travaux';
    tdTrav.textContent = (r[COL_TR_LABEL] ?? '').toString();
    tr.appendChild(tdTrav);
    // --- Colonne N° fiche (cliquable)
    const tdF = document.createElement('td');
    tdF.className = 'trav-col-fiche';
    const fn = ficheNumFromRow(r);
    const fu = ficheUrlFromRow(r);
    if(fn){
      if(fu){
        const a = document.createElement('a');
        a.href = fu;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = fn;
        tdF.appendChild(a);
      }else{
        tdF.textContent = fn;
      }
    }else{
      tdF.textContent = '—';
      tdF.dataset.empty = 'true';
    }
    tr.appendChild(tdF);


    const kinds = [
      {kind:'red',    col:COL_TR_RED,    tdClass:'trav-col-red'},
      {kind:'orange', col:COL_TR_ORANGE, tdClass:'trav-col-orange'},
      {kind:'green',  col:COL_TR_GREEN,  tdClass:'trav-col-green'},
    ];

    kinds.forEach(({kind,col,tdClass})=>{
      const td = document.createElement('td');
      td.className = tdClass;

      const txt = (r[col] ?? '').toString().trim();
      if(!txt){
        td.dataset.empty = 'true';
        tr.appendChild(td);
        return;
      }

      const inner = document.createElement('div');
      inner.className = 'trav-cell-inner';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.rowId = String(r.id);
      cb.dataset.kind  = kind;

      const key = `${r.id}|${kind}`;
      cb.checked = !!travSelection[key];

      cb.addEventListener('change',()=>{
        if(cb.checked) travSelection[key]=true;
        else delete travSelection[key];
      });

      inner.appendChild(cb);

      const span = document.createElement('span');
      renderTextWithArticleLinks(span, txt, artIndex);
      inner.appendChild(span);

      td.appendChild(inner);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  if(!DREETS_UNLOCKED){
    document.querySelectorAll('#trav-tbody input[type="checkbox"]').forEach(cb=>{
      cb.setAttribute('disabled','disabled');
    });
  }
}

async function renderTravauxFromRec(rec){
  const cont = document.getElementById('tr-lines');
  if (!cont) return;
  cont.innerHTML = '';

  await ensureTravauxData();

  const rowsToRender = [];
  const rawKeys = (getRecVal(rec, COL_TMP_INTI_TR) ?? '').toString().trim();
  if(rawKeys){
    let list = [];
    try{ const j = JSON.parse(rawKeys); if(Array.isArray(j)) list = j.map(x=>String(x)); }catch(e){}
    if(!list.length){ list = rawKeys.split(';').map(s=>s.trim()).filter(Boolean); }
    list.forEach(key=>{
      const [rowId, kind] = key.split('|');
      if(!rowId || !kind) return;
      const row = travRows.find(r=>Number(r.id)===Number(rowId));
      if(!row) return;
      rowsToRender.push({row, kind});
    });
  }else{
    const raw = (getRecVal(rec, COL_TMP_TR) ?? '').toString();
    const labels = splitTravField(raw);
    labels.forEach(lbl=>{
      const n = norm(lbl);
      const row = travRows.find(r=>norm(r[COL_TR_LABEL]||'')===n);
      if(!row) return;
      rowsToRender.push({row, kind:'orange'});
    });
  }

  if(!rowsToRender.length){
    if(!DREETS_UNLOCKED) lockDreetsSection(); else unlockDreetsSection();
    return;
  }

  rowsToRender.forEach(({row, kind})=>{
    const baseLabel = (row[COL_TR_LABEL] ?? '').toString().trim();
    if(!baseLabel) return;

    let colName;
    if(kind === 'red') colName = COL_TR_RED;
    else if(kind === 'green') colName = COL_TR_GREEN;
    else colName = COL_TR_ORANGE;

    const cellText = (row[colName] ?? '').toString();
    const articles = [];
    const artRegex = /\b[DR]\.?\s*\d{3,4}-\d+\b/gi;
    let m;
    while((m = artRegex.exec(cellText)) !== null){
      const num = m[0].replace(/\s+/g,'').toUpperCase();
      articles.push(num);
    }

    const div = document.createElement('div');
    div.className = 'tr-chip';
    div.dataset.kind = kind;
    try{ div.dataset.rowid = row.id; }catch(e){}

    const labelSpan = document.createElement('span');
    labelSpan.textContent = baseLabel;
    div.appendChild(labelSpan);


    // --- Ajout N° fiche cliquable ---
    const ficheNum = ficheNumFromRow(row);
    const ficheUrl = ficheUrlFromRow(row);
    const sepF1 = document.createElement('span');
    sepF1.textContent = ' — ';
    div.appendChild(sepF1);

    const ficheLabel = document.createElement('span');
    ficheLabel.textContent = 'Fiche numéro ';
    div.appendChild(ficheLabel);

    if(ficheNum){
      if(ficheUrl){
        const aF = document.createElement('a');
        aF.href = ficheUrl;
        aF.target = '_blank';
        aF.rel = 'noopener noreferrer';
        aF.className = 'link-like';
        aF.textContent = ficheNum;
        div.appendChild(aF);
      }else{
        const sF = document.createElement('span');
        sF.textContent = ficheNum;
        div.appendChild(sF);
      }
    }else{
      const sF0 = document.createElement('span');
      sF0.textContent = '—';
      div.appendChild(sF0);
    }
    if(articles.length){
      const sep = document.createElement('span');
      sep.textContent = ' — ';
      div.appendChild(sep);
      articles.forEach((num, idx)=>{
        const artKey = norm(num);
        const url = artIndex.get(artKey);
        if(url){
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.className = 'link-like';
          a.textContent = num;
          div.appendChild(a);
        }else{
          const s = document.createElement('span');
          s.textContent = num;
          div.appendChild(s);
        }
        if(idx < articles.length - 1){
          const comma = document.createElement('span');
          comma.textContent = ', ';
          div.appendChild(comma);
        }
      });
    }

    cont.appendChild(div);
  });

  if(!DREETS_UNLOCKED) lockDreetsSection(); else unlockDreetsSection();
}

/* UI Travaux + confirmation clear */
function initTravauxUi(){
  const dlg = document.getElementById('dlgTravaux');
    if(dlg && dlg.parentElement !== document.body){ document.body.appendChild(dlg); }
  const btnChoose = document.getElementById('tr-choose');
  const btnClear  = document.getElementById('tr-clear');
  const btnClose  = document.getElementById('trav-close');
  const btnCancel = document.getElementById('trav-cancel');
  const btnValidate = document.getElementById('trav-validate');

  const dlgClear = document.getElementById('dlgClearTravaux');
  const btnClearCancel = document.getElementById('clear-trav-cancel');
  const btnClearOk = document.getElementById('clear-trav-ok');

  async function openDlg(){
    if(!ROW) { console.warn('[TRAVAUX] openDlg: no ROW'); return; }
    console.log('[TRAVAUX] openDlg start', {id: ROW && ROW.id, unlocked: DREETS_UNLOCKED});
await ensureTravauxData();
    const rec = MAP.get(Number(ROW.id)) || ROW;
    rebuildTravSelectionFromTampon(rec);
    buildTravauxTableBody();
    console.log('[TRAVAUX] openDlg built', {travRows: (travRows||[]).length, selection: Object.keys(travSelection||{}).length});
    dlg.classList.add('pptr-open');
    dlg.style.display = 'block';
    dlg.style.pointerEvents = 'auto';
    dlg.setAttribute('aria-hidden','false');
  }
  // Expose l'ouverture de la lightbox Travaux au scope global (utile pour le click-guard)
  window.openDlg = openDlg;
  window.openTravauxDialog = openDlg;
  window.openDLGTravaux = openDlg;


  function closeDlg(){
    dlg.classList.remove('pptr-open');
    dlg.style.display = 'none';
    dlg.setAttribute('aria-hidden','true');
  }

  // Expose pour forcer l'ouverture même si un autre script intercepte le clic
  window.__pp_openTravauxDlg = openDlg;
  window.__pp_closeTravauxDlg = closeDlg;

  if(btnChoose){
    btnChoose.addEventListener('click',(e)=>{
      // Capture + stop to prevent Grist navigation/handlers, but only for this button
      try{ e.preventDefault(); }catch(_){ }
      try{ e.stopPropagation(); }catch(_){ }
      try{ if(e.stopImmediatePropagation) e.stopImmediatePropagation(); }catch(_){ }
      openDlg();
    }, true);
  }
  if(btnClose)   btnClose.addEventListener('click', closeDlg);
  if(btnCancel)  btnCancel.addEventListener('click', closeDlg);

  if(btnValidate){
    btnValidate.addEventListener('click', async ()=>{
      if(!ROW) { closeDlg(); return; }


      // PATCH v7: éviter l'effet "tout s'efface" si la reconstruction UI échoue :
      // on repart de la sélection déjà enregistrée, puis on applique l'état réel des checkbox.
      const rec = MAP.get(Number(ROW.id)) || ROW;

      // BaseSet = ce qui est déjà stocké (JSON ou ';')
      const baseSet = new Set();
      try{
        const raw = (rec && rec[COL_TMP_INTI_TR]) ? String(rec[COL_TMP_INTI_TR]).trim() : '';
        if(raw){
          try{
            const j = JSON.parse(raw);
            if(Array.isArray(j)) j.forEach(x=>baseSet.add(String(x)));
          }catch(e){}
          if(!baseSet.size){
            raw.split(';').map(s=>s.trim()).filter(Boolean).forEach(k=>baseSet.add(k));
          }
        }
      }catch(e){}

      // Applique l'état des checkbox affichées
      document.querySelectorAll('#trav-tbody input[type="checkbox"][data-row-id]').forEach(cb=>{
        const rowId = (cb.dataset.rowId||'').trim();
        const kind  = (cb.dataset.kind||'orange').trim();
        if(!rowId) return;
        const key = rowId + '|' + kind;
        if(cb.checked) baseSet.add(key);
        else baseSet.delete(key);
      });

      // On synchronise travSelection à partir du baseSet
      travSelection = {};
      baseSet.forEach(k=>travSelection[k]=true);

      const keys = Array.from(baseSet);
      const labels = [];
      const keyList = [];
      const articlesSet = new Set();

      keys.forEach(key=>{
        const parts = String(key).split('|');
        const rowId = parts[0];
        const kind = parts[1] || 'orange';
        if(!rowId) return;
        const row = travRows.find(r=>Number(r.id)===Number(rowId));
        if(!row) return;

        const baseLabel = (row[COL_TR_LABEL] ?? '').toString().trim();
        if(baseLabel){
          labels.push(baseLabel); // pas de déduplication : doublons = lignes différentes
        }
        keyList.push(rowId + '|' + kind);

        let colName;
        if(kind === 'red') colName = COL_TR_RED;
        else if(kind === 'green') colName = COL_TR_GREEN;
        else colName = COL_TR_ORANGE;

        const cellText = (row[colName] ?? '').toString();
        const artRegex = /\b[DR]\.?\s*\d{3,4}-\d+\b/gi;
        let m;
        while((m = artRegex.exec(cellText)) !== null){
          const num = m[0].replace(/\s+/g,'').toUpperCase();
          articlesSet.add(num);
        }
      });

      await runQuick(async ()=>{
        const valueTR   = labels.length ? labels.join('; ') : null;
        const valueKeys = keyList.length ? keyList.join(';') : null;
        const valueArt  = articlesSet.size ? Array.from(articlesSet).join('; ') : null;

        await applyUA([['UpdateRecord', TBL_MAIN, Number(ROW.id), {
          [COL_TMP_TR]: valueTR,
          [COL_TMP_INTI_TR]: valueKeys,
          [COL_TMP_ART]: valueArt
        }]]);
        const r = MAP.get(Number(ROW.id)) || ROW;
        r[COL_TMP_TR] = valueTR;
        r[COL_TMP_INTI_TR] = valueKeys;
        r[COL_TMP_ART] = valueArt;
        MAP.set(Number(ROW.id), r);
        await renderTravauxFromRec(r);
      });

      closeDlg();
    });
  }

  if (btnClear && dlgClear && btnClearCancel && btnClearOk){
    btnClear.addEventListener('click', () => {
      if (!ROW || !DREETS_UNLOCKED) return;
      dlgClear.style.display = 'flex';
      dlgClear.setAttribute('aria-hidden','false');
    });

    btnClearCancel.addEventListener('click', () => {
      dlgClear.style.display = 'none';
      dlgClear.setAttribute('aria-hidden','true');
    });

    btnClearOk.addEventListener('click', async () => {
      if (!ROW || !DREETS_UNLOCKED) {
        dlgClear.style.display = 'none';
        dlgClear.setAttribute('aria-hidden','true');
        return;
      }
      await runQuick(async () => {
        await applyUA([['UpdateRecord', TBL_MAIN, Number(ROW.id), {
          [COL_TMP_TR]: null,
          [COL_TMP_INTI_TR]: null,
          [COL_TMP_ART]: null
        }]]);
        const r = MAP.get(Number(ROW.id)) || ROW;
        r[COL_TMP_TR] = null;
        r[COL_TMP_INTI_TR] = null;
        r[COL_TMP_ART] = null;
        MAP.set(Number(ROW.id), r);
        travSelection = {};
        await renderTravauxFromRec(r);
      });

      dlgClear.style.display = 'none';
      dlgClear.setAttribute('aria-hidden','true');
    });
  }
}

/* ==========================================================
   SÉLECTION / REFRESH DROITE
   ========================================================== */
async function refreshRight(){
  if(!ROW) return;
  const _rp = document.getElementById('rightPane');
  const _scrollTop = _rp ? _rp.scrollTop : 0;
  const rec=MAP.get(Number(ROW.id))||ROW;
  try{
    if(window.__PP_PENDING_RIGHTS_REFRESH__){
      window.__PP_PENDING_RIGHTS_REFRESH__ = false;
      try{ if(typeof refreshTypeRadiosLock==='function') refreshTypeRadiosLock(); }catch(e){}
    }
  }catch(e){}

  qs('#f-lib').value = rec[COL_LIB] ?? '';
  
  // Protection focus pour f-travaux
  try{
    const focused = document.activeElement ? document.activeElement.id : null;
    if(focused !== 'f-travaux') qs('#f-travaux').value = rec[COL_TRAV] ?? '';
  }catch(e){
    qs('#f-travaux').value = rec[COL_TRAV] ?? '';
  }
  
  try{
    const canEditTrav = (ADMIN_MODE || ADD_MODE_ACTIVE);
    if(canEditTrav){
      qs('#f-travaux').removeAttribute('readonly');
    }else{
      qs('#f-travaux').setAttribute('readonly','readonly');
    }
  }catch(e){}
  
  // Protection focus pour précisions et observations
  try{
    const focused = document.activeElement ? document.activeElement.id : null;
    if(focused !== 'precisions')   qs('#precisions').value = rec[COL_PRECI] ?? '';
    if(focused !== 'observations') qs('#observations').value = rec[COL_OBS] ?? '';
  }catch(e){
    qs('#precisions').value = rec[COL_PRECI] ?? '';
    qs('#observations').value = rec[COL_OBS] ?? '';
  }
  // [RIGHTS] verrouillage champs DREETS (precisions/observations)
  const canEditDreets = (DREETS_UNLOCKED || ADMIN_MODE);
  try{
    const p = qs('#precisions'); const o = qs('#observations');
    if(p){ canEditDreets ? p.removeAttribute('readonly') : p.setAttribute('readonly','readonly'); }
    if(o){ canEditDreets ? o.removeAttribute('readonly') : o.setAttribute('readonly','readonly'); }
  }catch(e){}
  
  // ✅ Protection : ne pas remplir docBureau si l'utilisateur est en train de taper
  try{
    const focused = document.activeElement ? document.activeElement.id : null;
    if(focused !== 'docBureau') {
      qs('#docBureau').value = rec[COL_DOC] ?? '';
    }
  }catch(e){
    qs('#docBureau').value = rec[COL_DOC] ?? '';
  }
  qs('#docOpen').href = rec[COL_DOC] ? String(rec[COL_DOC]) : '#';

  // Caractéristiques produit / agent chimique
  // Protection : ne pas remplir si l'utilisateur est en train de taper (a le focus)
  try{
    const focused = document.activeElement ? document.activeElement.id : null;
    if(focused !== 'dreets-type')    qs('#dreets-type').value   = rec[COL_TR_TYPE]   ?? '';
    if(focused !== 'dreets-famille') qs('#dreets-famille').value= rec[COL_TR_FAM]    ?? '';
    if(focused !== 'dreets-agent')   qs('#dreets-agent').value  = rec[COL_TR_AGENT]  ?? '';
    if(focused !== 'dreets-clp')     qs('#dreets-clp').value    = rec[COL_TR_DANGER] ?? '';
    if(focused !== 'dreets-epi')     qs('#dreets-epi').value    = rec[COL_TR_EPI]    ?? '';
  }catch(e){
    // Fallback : remplir normalement si erreur
    qs('#dreets-type').value   = rec[COL_TR_TYPE]   ?? '';
    qs('#dreets-famille').value= rec[COL_TR_FAM]    ?? '';
    qs('#dreets-agent').value  = rec[COL_TR_AGENT]  ?? '';
    qs('#dreets-clp').value    = rec[COL_TR_DANGER] ?? '';
    qs('#dreets-epi').value    = rec[COL_TR_EPI]    ?? '';
  }

  setSticky(rec);

  const regimeLabel = rec[COL_TMP_REG] ?? '';
  renderRegimeToken(regimeLabel);
  colorizeRegimeSelect(regimeLabel);
  colorizeLibFromRegime(rec);

  await ensureVgpOptions();
  await renderPhoto(rec);
  await renderEtabDiplDom(rec);
  try{ await refreshPersoBlock(); }catch(e){}
  await buildDomainesEtSecteurs(rec);
  syncTypeRadiosFromRec(rec);
  try{ updateProduitFieldsEnabled(rec); }catch(e){}
  try{ const d=document.getElementById('fpKindDisplay'); if(d) d.textContent = (readKindFromRec(rec)==='produit') ? 'Produit' : 'Equipement'; }catch(e){}
  await renderTravauxFromRec(rec);
  if(_rp){ _rp.scrollTop = _scrollTop; }
}

async function renderPhoto(rec){
  const url=await resolvePhotoUrlFromRow(rec);
  const empty='data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="220"><rect width="160" height="220" fill="%230f172a"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="12" fill="%239ca3af">Aperçu</text></svg>';
  const finalUrl=url||'';
  qs('#photoImg').src=finalUrl||empty;
  const thumbBox=qs('#photoThumb');
  if(finalUrl){
    thumbBox.classList.remove('disabled');
    thumbBox.title='Cliquer pour agrandir';
  } else {
    thumbBox.classList.add('disabled');
    thumbBox.title='Aucune image';
  }
}

async function renderEtabDiplDom(rec){
  const etLabels=parseTextList((rec[COL_TMP_ETB]??'').toString());
  renderEtNatural(etLabels);

  const diLabels=parseTextList((rec[COL_TMP_DIP]??'').toString());
  setNaturalTextLines('di-natural',diLabels);
}

async function selectRow(id,userClick=false){
  if(selectionLocked && !userClick){keepCursor();return;}
  selectedId = Number(id);

  // 1) Essai depuis le cache (liste)
  ROW = MAP.get(Number(id)) || null;

  // 2) Mode public : charge la fiche complète via Supabase
  if(!IS_GRIST){
    try{
      const rec = await sbFetchOne(selectedId);
      const full = sbRecToRow(rec);
      if(full){
        ROW = full;
        try{ MAP && MAP.set(selectedId, full); }catch(e){}
      }
    }catch(e){
      console.error('[SB] selectRow -> sbFetchOne failed', e);
    }
  }

  try{ window.ROW = ROW; }catch(e){}
  try{ window.currentRec = ROW; }catch(e){}
  try{ if(window.grist) window.grist.selectedRecord = ROW; }catch(e){}
  await runQuick(async()=>{renderList();await refreshRight();keepCursor();});
}

/* ==========================================================
   VGP
   ========================================================== */
let VGP_LOADED=false;
let VGP_OPTIONS = [];

async function ensureVgpOptions(){
  const sel = qs('#vgp');
  if (!sel) return;

  if (!VGP_LOADED){
    const cfg = await ensureTable([TBL_VGP], COL_VGP_LABEL);
    const values = (cfg.values || [])
      .map(v => v.toString().trim())
      .filter(Boolean)
      .filter((v,i,a) => a.findIndex(x => norm(x) === norm(v)) === i)
      .sort((a,b) => a.localeCompare(b, 'fr', {sensitivity:'base'}));

    sel.innerHTML = '';

    const blank = document.createElement('option');
    blank.value = '';
    blank.textContent = '—';
    sel.appendChild(blank);

    values.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });

    VGP_OPTIONS = values;
    VGP_LOADED  = true;
  }

  const rec = MAP.get(Number(ROW?.id)) || ROW;
  if (!rec) return;

  const cur = (rec[COL_VGP] ?? '').toString();

  if (cur && !VGP_OPTIONS.includes(cur)) {
    const o = document.createElement('option');
    o.value = cur;
    o.textContent = cur;
    sel.appendChild(o);
    VGP_OPTIONS.push(cur);
  }

  // ✅ Protection : ne pas remplir si l'utilisateur est en train de choisir
  try{
    const focused = document.activeElement ? document.activeElement.id : null;
    if(focused !== 'vgp') {
      sel.value = cur || '';
    }
  }catch(e){
    sel.value = cur || '';
  }
}

qs('#vgp').addEventListener('change', async () => {
  if (!ROW) return;
  const sel = qs('#vgp');
  const v = sel.value || '';
  await runQuick(async () => {
    await applyUA([['UpdateRecord', TBL_MAIN, Number(ROW.id), { [COL_VGP]: v || null }]]);
    const r = MAP.get(Number(ROW.id));
    if(r) {
      r[COL_VGP] = v || null;
      MAP.set(Number(ROW.id), r);
    }
  });

  await logHistory('Mise à jour VGP', {
    details: `VGP = ${v || '—'}`
  });
});

/* Caractéristiques produit / agent chimique : binding générique */
function bindDreetsCharField(inputId, colName){
  const el = document.getElementById(inputId);
  if (!el) return;

  let t = null;

  async function saveNow(){
    if (!ROW) return;
    if (!(ADMIN_MODE || DREETS_UNLOCKED)) return; // admin ou DREETS

    // Snapshot pour éviter les "mauvaises lignes" si l'utilisateur change d'équipement pendant l'enregistrement
    const rid = Number(ROW.id);
    const v = el.value.trim();

    async function doSave(){
      await applyUA([['UpdateRecord', TBL_MAIN, rid, { [colName]: v || null }]]);
      const r = MAP.get(rid);
      if(r) {
        r[colName] = v || null;
        MAP.set(rid, r);
      } else {
        console.warn(`[DREETS CHAR] Row ${rid} not in MAP`);
      }
    }

    await runQuick(async () => {
      // Retry léger : certaines actions Grist peuvent se télescoper si on change vite de ligne
      try{
        await doSave();
      }catch(e1){
        await new Promise(res => setTimeout(res, 150));
        await doSave();
      }
    });
    ppToast('Modification enregistrée');
  }

  function scheduleSave(){
    if (t) clearTimeout(t);
    t = setTimeout(() => { saveNow(); }, 350);
  }

  // change/blur = sauvegarde immédiate, input = debounce
  el.addEventListener('change', saveNow);
  el.addEventListener('blur',  saveNow);
  el.addEventListener('input', scheduleSave);
}
bindDreetsCharField('dreets-type',    COL_TR_TYPE);
bindDreetsCharField('dreets-famille', COL_TR_FAM);
bindDreetsCharField('dreets-agent',   COL_TR_AGENT);
bindDreetsCharField('dreets-clp',     COL_TR_DANGER);
bindDreetsCharField('dreets-epi',     COL_TR_EPI);

/* ==========================================================
   RÉGIME D'INTERDICTION (select + badge)
   ========================================================== */
async function initRegimeSelect(){
  const sel=qs('#f-regime');
  sel.innerHTML='';
  const cfg=await ensureTable([TBL_DEROG],COL_DEROG_LABEL);
  const blank=document.createElement('option');
  blank.value="";
  blank.textContent="— Choisir —";
  sel.appendChild(blank);
  cfg.values.forEach(v=>{
    const o=document.createElement('option');
    o.value=v;
    o.textContent=v;
    sel.appendChild(o);
  });
  sel.addEventListener('change',async ()=>{
    if(!ROW) return;
    const rec = MAP.get(Number(ROW.id)) || ROW;
    if(!(ADMIN_MODE || DREETS_UNLOCKED)) return;
    const label = sel.value || '';
    await runQuick(async()=>{
      await applyUA([['UpdateRecord',TBL_MAIN,Number(ROW.id),{[COL_TMP_REG]:label||null}]]);
      
      // IMPORTANT : Ne PAS créer d'objet vide, utiliser l'objet existant dans MAP
      const r = MAP.get(Number(ROW.id));
      if(r) {
        r[COL_TMP_REG] = label || null;
        MAP.set(Number(ROW.id), r);
      } else {
        console.warn('[REGIME] Row not in MAP, using ROW as fallback');
        const newR = {...ROW};
        newR[COL_TMP_REG] = label || null;
        MAP.set(Number(ROW.id), newR);
      }

      renderRegimeToken(label);
      colorizeRegimeSelect(label);
      // ✅ CORRECTION : Utiliser r (mis à jour) au lieu de rec (ancien)
      const updatedRec = MAP.get(Number(ROW.id)) || ROW;
      colorizeLibFromRegime(updatedRec);
      renderList();
    });
  });
}

function renderRegimeToken(label){
  const el=qs('#regimeToken');
  const txt=(label||'').toString().trim()||'—';
  el.textContent=txt;
  const color=colorFromLabel(txt);
  if(color){
    el.style.background=color;
    const rgb=parseInt(color.slice(1),16);
    const r=(rgb>>16)&255,g=(rgb>>8)&255,b=rgb&255;
    const lum=.299*r+.587*g+.114*b;
    el.style.color=(lum<140)?'#f9fafb':'#111827';
    el.style.borderColor=color;
  }else{
    el.style.background='#6b7280';
    el.style.color='#f9fafb';
    el.style.borderColor='transparent';
  }
}

function colorizeRegimeSelect(label){
  const sel = qs('#f-regime');
  if(!sel) return;

  const color = colorFromLabel(label || '');
  const block = document.getElementById('regimeBlock');
  const isDreets = norm(label||'') === 'a completer par la dreets' || norm(label||'') === 'a completer par drets';

  if(color){
    sel.style.background = color;
    const rgb = parseInt(color.slice(1),16);
    const r = (rgb>>16)&255, g = (rgb>>8)&255, b = (rgb)&255;
    const lum = .299*r + .587*g + .114*b;
    sel.style.color = (lum < 140) ? '#f9fafb' : '#111827';
    sel.style.borderColor = color;

    if(block){
      block.style.borderColor = color;
      block.classList.toggle('regime-dreets-active', !!isDreets);
      if(!isDreets){
        block.classList.remove('regime-dreets-active');
      }
    }
  }else{
    sel.style.background = '';
    sel.style.color = '';
    sel.style.borderColor = '';
    if(block){
      block.style.borderColor = '';
      block.classList.remove('regime-dreets-active');
    }
  }
}

/* ==========================================================
   ÉVÉNEMENTS DE SAISIE DDFPT / DREETS
   ========================================================== */
qs('#f-lib').addEventListener('change',async()=>{
  if(!ROW) return;
  const v=qs('#f-lib').value.trim();
  await runQuick(async()=>{
    await applyUA([['UpdateRecord',TBL_MAIN,Number(ROW.id),{[COL_LIB]:v}]]);
    const r=MAP.get(Number(ROW.id));
    if(r){
      r[COL_LIB]=v;
      MAP.set(Number(ROW.id),r);
      renderList();
      setSticky(r);
    }
  });
});

// f-travaux = lecture seule (colonne de référence) : pas de sauvegarde

// --- Sauvegarde instantanée (debounce) : précisions + observations ---
function bindInstantTextArea(id, colName, canWrite){
  const el = document.getElementById(id);
  if(!el) return;
  let t = null;
  const save = async (showToast)=>{
    if(!ROW) {
      console.log(`[BIND ${id}] Pas de ROW, sauvegarde annulée`);
      return;
    }
    const hasPermission = canWrite();
    console.log(`[BIND ${id}] Tentative de sauvegarde:`, {
      hasPermission,
      ADD_MODE_ACTIVE,
      ADMIN_MODE,
      DREETS_UNLOCKED,
      value: el.value.substring(0, 50)
    });
    if(!hasPermission) {
      console.log(`[BIND ${id}] Permission refusée, sauvegarde annulée`);
      return;
    }
    const rid = Number(ROW.id);
    const v = (el.value||'').trim();
    await runQuick(async()=>{
      await applyUA([['UpdateRecord', TBL_MAIN, rid, { [colName]: v || null }]]);
      
      // CRITIQUE : Ne PAS créer d'objet vide, sinon ça efface tout le reste de MAP !
      const r = MAP.get(rid);
      if(r) {
        r[colName] = v || null;
        MAP.set(rid, r);
        console.log(`[BIND ${id}] ✅ Sauvegarde réussie - MAP mis à jour`);
      } else {
        console.warn(`[BIND ${id}] Row ${rid} not in MAP, using ROW as fallback`);
        const newR = {...ROW};
        newR[colName] = v || null;
        MAP.set(rid, newR);
        console.log(`[BIND ${id}] ✅ Sauvegarde réussie - MAP créé depuis ROW`);
      }
    });
    if(showToast) ppToast('Modification enregistrée');
  };
  const schedule = ()=>{
    if(t) clearTimeout(t);
    t = setTimeout(()=>{ save(false).catch(e => console.error(`[BIND ${id}] Erreur:`, e)); }, 320);
  };
  el.addEventListener('input', schedule);
  el.addEventListener('change', ()=>{ if(t) clearTimeout(t); save(true).catch(e => console.error(`[BIND ${id}] Erreur:`, e)); });
  el.addEventListener('blur',   ()=>{ if(t) clearTimeout(t); save(true).catch(e => console.error(`[BIND ${id}] Erreur:`, e)); });
}

bindInstantTextArea('f-travaux', COL_TRAV, ()=> (ADMIN_MODE || ADD_MODE_ACTIVE));
bindInstantTextArea('precisions', COL_PRECI, ()=> (DREETS_UNLOCKED || ADMIN_MODE));
bindInstantTextArea('observations', COL_OBS,   ()=> (DREETS_UNLOCKED || ADMIN_MODE));


qs('#docBureau').addEventListener('input',()=>{
  const v=qs('#docBureau').value.trim();
  qs('#docOpen').href=v||'#';
});

qs('#docBureau').addEventListener('change', async () => {
  if (!ROW) return;
  const v = qs('#docBureau').value.trim();
  await runQuick(async () => {
    await applyUA([['UpdateRecord', TBL_MAIN, Number(ROW.id), { [COL_DOC]: v || null }]]);
    const r = MAP.get(Number(ROW.id));
    if(r) {
      r[COL_DOC] = v || null;
      MAP.set(Number(ROW.id), r);
    }
  });

  await logHistory('Mise à jour URL bureau de contrôle', {
    details: v || '(URL vide)'
  });
});

/* suppression */
qs('#delBtn').onclick = () => {
  openAdminDeleteDialog();
};

/* ajout + filtre texte */
qs('#addBtn').onclick = async () => {
  const val = qs('#newName').value.trim();
  if (!val) return;

  let newId = null;

  await runQuick(async () => {
    const r = await window.grist.docApi.applyUserActions([
      ['AddRecord', TBL_MAIN, null, { [COL_LIB]: val, [KIND_COL]: 'Equipement' }]
    ]);
    newId = r?.retValues?.[0] ?? null;
    qs('#newName').value = '';
    await loadFull();
    if (newId != null) {
      await selectRow(newId, true);
    } else {
      renderList();
    }
  });

  await logHistory('Création équipement', {
    equipId: newId,
    equipName: val,
    details: 'Equipement créé depuis le mode ajout DDFPT'
  });
};

qs('#clearNew').onclick=()=>{qs('#newName').value='';};

qs('#applyFilter').onclick=()=>renderList();
qs('#clearFilter').onclick=()=>{qs('#filter').value='';renderList();};

qs('#exportBtn').onclick=()=>exportFilteredToPdf();

document.querySelectorAll('.color-dot').forEach(dot=>{
  dot.addEventListener('click',()=>{
    document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active'));
    dot.classList.add('active');
    colorFilter=dot.dataset.col;
    renderList();
  });
});
document.querySelector('.color-dot[data-col="none"]').classList.add('active');

document.querySelectorAll('input[name="filterMode"]').forEach(radio=>{
  radio.addEventListener('change',()=>{
    if(radio.checked) setFilterMode(radio.value);
  });
});

// Init filtre type + radios Type
try{ initKindModeUI(); }catch(e){}
try{ initTypeRadios(); }catch(e){}
try{ initPersoAutosave(); }catch(e){}

/* ==========================================================
   PHOTO : UI
   ========================================================== */
qs('#fileTrigger').addEventListener('click',()=>qs('#filePick').click());
qs('#filePick').addEventListener('change',()=>{
  const f=qs('#filePick').files?.[0];
  qs('#fileName').textContent=f?f.name:'Aucun fichier choisi';
});

qs('#btnUpload').addEventListener('click', async () => {
  if (!ROW) return;
  const f = qs('#filePick').files?.[0];
  if (!f) { setPhotoMsg("Choisir un fichier d'abord."); return; }

  try {
    setPhotoMsg('Redimensionnement…');
    const resized = await resizeImage(f, 1024 * 1024);
    setPhotoMsg('Téléversement…');
    const up = await uploadSupabase(resized);
    await runQuick(async () => {
      const useEtab = shouldUseEtabOverride();
      const code = getEffectivePersoCode();
      const equipId = Number(ROW.id);

      if (useEtab && code) {
        await ensurePersoLoaded(false);
        const key = persoKey(code, equipId);
        const existing = PERSO_INDEX.get(key);
        const payload = {
          [COL_PERSO_CODE]: code,
          [COL_PERSO_EQUIP]: equipId,
          [COL_PERSO_PHOTO_URL]: up.url,
          [COL_PERSO_PHOTO_THMB]: up.thumb
        };
        if (existing && existing.id) {
          await grist.docApi.applyUserActions([[ 'UpdateRecord', TABLE_PERSO, existing.id, payload ]]);
        } else {
          await grist.docApi.applyUserActions([[ 'AddRecord', TABLE_PERSO, null, payload ]]);
        }
        await ensurePersoLoaded(true);
        await renderPhoto(MAP.get(Number(ROW.id)) || ROW);
        setPhotoMsg('Image établissement enregistrée.', true);
      } else {
        // photo de base (visible en consultation) : on enregistre dans Liste_des_equipements
        // + on renseigne aussi les colonnes legacy (Photo_url/Photo_thumb) si elles existent,
        //   pour compatibilité avec d'autres pages/scripts plus anciens.
        const rid = Number(ROW.id);
        const updates = { [COL_SB_URL]: up.url, [COL_SB_THMB]: up.thumb, [LEGACY_URL]: up.url, [LEGACY_THMB]: up.thumb };

        // Tentative "tout-en-un" (si toutes les colonnes existent)
        try{
          await applyUA([['UpdateRecord', TBL_MAIN, rid, updates]]);
        }catch(e1){
          // Fallback 1 : Supabase uniquement
          try{
            await applyUA([['UpdateRecord', TBL_MAIN, rid, { [COL_SB_URL]: up.url, [COL_SB_THMB]: up.thumb }]]);
          }catch(e2){
            // Fallback 2 : URL seule
            await applyUA([['UpdateRecord', TBL_MAIN, rid, { [COL_SB_URL]: up.url }]]);
          }
          // Fallback legacy (silencieux)
          try{
            await applyUA([['UpdateRecord', TBL_MAIN, rid, { [LEGACY_URL]: up.url, [LEGACY_THMB]: up.thumb }]]);
          }catch(_e3){}
        }

        const r = MAP.get(rid);
        if(r) {
          r[COL_SB_URL] = up.url; r[COL_SB_THMB] = up.thumb;
          r[LEGACY_URL] = up.url; r[LEGACY_THMB] = up.thumb;
          MAP.set(rid, r);
        }

        await renderPhoto(r || ROW);
        setPhotoMsg('Image de base enregistrée.', true);
      }
    }); // --- PHOTO UPLOAD PATCH

    await logHistory('Téléversement image', {
      details: `Image ${f.name || ''} téléversée`
    });

  } catch (e) {
    setPhotoMsg('Erreur : ' + (e?.message || e), false);
  }
});

function setPhotoMsg(t,ok){
  const el=qs('#photoMsg');
  el.textContent=t||'';
  el.className='status '+(ok?'ok':'err');
}

qs('#photoThumb').onclick=()=>{
  const src=qs('#photoImg').src||'';
  if(!src || src.startsWith('data:image/svg+xml')) return;
  qs('#lightboxImg').src=src;
  qs('#lightbox').style.display='flex';
  qs('#lightbox').setAttribute('aria-hidden','false');
};
qs('#lightbox').onclick=e=>{
  if(e.target.id==='lightbox' || e.target.classList.contains('close')){
    qs('#lightbox').style.display='none';
    qs('#lightbox').setAttribute('aria-hidden','true');
    qs('#lightboxImg').src='';
  }
};
document.addEventListener('keydown',e=>{
  if(e.key==='Escape' && qs('#lightbox').getAttribute('aria-hidden')==='false'){
    qs('#lightbox').click();
  }
});

/* ==========================================================
   CHECK ÉTABLISSEMENT + LIGHTBOX DIPLÔMES
   ========================================================== */
async function initCheckEtabPicker(){
  const cfgE = await ensureTable(
    ['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
    COL_ETAB_LABEL
  );
  const dl=qs('#dl-check-etab');
  if(dl && !dl.childElementCount){
    const frag=document.createDocumentFragment();
    cfgE.rows.forEach(r=>{
      const label=(r[cfgE.labelCol]??'').toString().trim();
      if(!label) return;
      const o=document.createElement('option');
      o.value=label;
      frag.appendChild(o);
    });
    dl.appendChild(frag);
  }
  const inp=qs('#check-etab-inp');
  const btn=qs('#check-etab-open');
  const fire=()=>{
    const val=(inp.value||'').trim();
    if(!val) return;
    runQuick(async()=>{await openDiplomeLightbox(val);});
  };
  inp.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();fire();}});
  btn.addEventListener('click',()=>fire());
}

function syncCheckEtabWithAddMode(etabName) {
  const inp = document.getElementById('check-etab-inp');
  if (!inp) return;
  inp.value = etabName || '';
  if (etabName) {
    LAST_ETAB_FOR_DIALOG = etabName;
  }
}

function isDiplomeActif(row){
  const st=(row.Statut ?? row.statut ?? '').toString().trim().toLowerCase();
  return st==='on';
}

let LAST_ETAB_FOR_DIALOG='';
async function openDiplomeLightbox(etabLabel){
  if(!ROW) return;
  const cfgE=await ensureTable(
    ['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
    COL_ETAB_LABEL
  );
  const etabRow=cfgE.byNorm.get(norm(etabLabel));
  const cleanName=etabRow?(etabRow[cfgE.labelCol]||etabLabel):etabLabel;
  LAST_ETAB_FOR_DIALOG=cleanName;

  const cfgD=await ensureTable(['Diplomes_EN_OK'],COL_DIP_CONCAT);
  const cont=qs('#dlg-di-list');cont.innerHTML='';

  let list=[];
  if(etabRow){
    const txt=(etabRow[COL_ETAB_DIP_TEXT] ?? '').toString();
    const labels=parseTextList(txt);
    const seen=new Set();
    labels.forEach(lbl=>{
      const r=cfgD.byNorm.get(norm(lbl));
      if(!r) return;
      if(!isDiplomeActif(r)) return;
      const idNum=Number(r.id);
      if(seen.has(idNum)) return;
      seen.add(idNum);
      list.push(r);
    });
  }

  const equipId=Number(ROW.id);
  const linkRows=await fetchTable(TBL_LINK);
  const selectedDipIds=new Set();
  if(etabRow){
    const etabId=Number(etabRow.id);
    linkRows.forEach(l=>{
      const eId=refId(l[COL_L_EQUIP]);
      const etId=refId(l[COL_L_ETAB]);
      const dId=refId(l[COL_L_DIP]);
      if(eId===equipId && etId===etabId && dId!=null){
        selectedDipIds.add(Number(dId));
      }
    });
  }

  if(!list.length){
    const p=document.createElement('p');
    p.textContent="Aucun diplôme trouvé pour cet établissement (ou aucun en statut « On »).";
    cont.appendChild(p);
  }else{
    list.forEach(r=>{
      const label=(r[cfgD.labelCol]??'').toString().trim();
      if(!label) return;
      const dipId=Number(r.id);
      const rowDiv=document.createElement('div');rowDiv.className='dlg-row';
      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.value=label;
      cb.dataset.dipId=String(dipId);
      if(selectedDipIds.has(dipId)) cb.checked=true;
      const lab=document.createElement('label');
      lab.appendChild(cb);
      lab.appendChild(document.createTextNode(' '+label));
      rowDiv.appendChild(lab);
      cont.appendChild(rowDiv);
    });
  }

  qs('#dlg-etab-name').textContent=cleanName||'—';
  const dlg=qs('#dlgDiplomes');
  dlg.style.display='flex';dlg.setAttribute('aria-hidden','false');
}
function closeDiplomeDialog(){
  const dlg=qs('#dlgDiplomes');
  dlg.style.display='none';
  dlg.setAttribute('aria-hidden','true');
}
qs('#dlg-di-cancel').onclick=()=>closeDiplomeDialog();
qs('#dlgDiplomes .modal-close').onclick=()=>closeDiplomeDialog();
qs('#dlgDiplomes').addEventListener('click',e=>{if(e.target.id==='dlgDiplomes')closeDiplomeDialog();});

qs('#dlg-di-ok').onclick = async () => {
  if (!ROW) return;

  console.log('[DIPLOMES v14] Validation démarrée pour équipement:', ROW.id);

  const cfgE = await ensureTable(
    ['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
    COL_ETAB_LABEL
  );

  const etabRow = cfgE.byNorm.get(norm(LAST_ETAB_FOR_DIALOG));
  if (!etabRow) {
    console.warn('[DIPLOMES v14] Établissement introuvable:', LAST_ETAB_FOR_DIALOG);
    closeDiplomeDialog();
    return;
  }

  const etabId  = Number(etabRow.id);
  const equipId = Number(ROW.id);

  console.log('[DIPLOMES v14] Equipement:', equipId, '| Établissement:', etabId);

  const linkRows = await fetchTable(TBL_LINK);
  const currentLinks = linkRows.filter(l =>
    refId(l[COL_L_EQUIP]) === equipId &&
    refId(l[COL_L_ETAB]) === etabId
  );

  const currentByDip = new Map();
  currentLinks.forEach(l => {
    const dId = refId(l[COL_L_DIP]);
    if (dId != null) currentByDip.set(Number(dId), l);
  });

  const checkboxes = document.querySelectorAll('#dlg-di-list input[type="checkbox"][data-dip-id]');
  const wantedDipIds = new Set();
  checkboxes.forEach(cb => {
    const dipId = Number(cb.dataset.dipId);
    if (cb.checked) wantedDipIds.add(dipId);
  });

  console.log('[DIPLOMES v14] Diplômes cochés:', Array.from(wantedDipIds));

  const actions = [];

  currentLinks.forEach(l => {
    const dId = refId(l[COL_L_DIP]);
    if (dId != null && !wantedDipIds.has(dId)) {
      actions.push(['RemoveRecord', TBL_LINK, Number(l.id)]);
    }
  });

  wantedDipIds.forEach(dId => {
    if (!currentByDip.has(dId)) {
      actions.push(['AddRecord', TBL_LINK, null, {
        [COL_L_EQUIP]: equipId,
        [COL_L_ETAB]:  etabId,
        [COL_L_DIP]:   dId
      }]);
    }
  });

  console.log('[DIPLOMES v14] Actions à appliquer:', actions.length);

  await runQuick(async () => {
    if (actions.length) {
      await applyUA(actions);
      console.log('[DIPLOMES v14] Actions appliquées');
    }
    
    await recomputeAggregatesForCurrentEquip();
    console.log('[DIPLOMES v14] Agrégats recalculés');
  });

  // FORCER RAFRAÎCHISSEMENT
  console.log('[DIPLOMES v14] Rafraîchissement dans 300ms...');
  setTimeout(async () => {
    try {
      if (typeof window.refreshRight === 'function') {
        await window.refreshRight();
        console.log('[DIPLOMES v14] ✅ refreshRight() terminé');
      }
    } catch(e) {
      console.error('[DIPLOMES v14] ❌ Erreur refresh:', e);
    }
  }, 300);

  await logHistory('Mise à jour diplômes', {
    equipId,
    etabName: LAST_ETAB_FOR_DIALOG,
    details: `Diplômes sélectionnés pour ${LAST_ETAB_FOR_DIALOG}`
  });

  closeDiplomeDialog();
  console.log('[DIPLOMES v14] Modale fermée');
};

/* ==========================================================
   MODE AJOUT DDFPT (Codepaca)
   ========================================================== */
function setSectionEnabled(selector, enabled) {
  document.querySelectorAll(selector).forEach(el => {
    if (enabled) {
      el.removeAttribute('disabled');
      el.removeAttribute('readonly');
      el.classList.remove('left-block-disabled');
      el.style.pointerEvents = 'auto';
      el.style.opacity = '1';
      el.style.cursor = 'text';  // Curseur normal pour les inputs
    } else {
      // Utiliser readonly au lieu de disabled pour conserver les valeurs
      el.setAttribute('readonly', 'readonly');
      el.classList.add('left-block-disabled');
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.45';
      el.style.cursor = 'not-allowed';
    }
  });
}

function setAddModeUI(active, etabName){
  ADD_MODE_ACTIVE    = !!active;
  ADD_MODE_ETAB_NAME = active ? (etabName || '') : '';

  const block    = document.getElementById('new-block');
  const newInput = document.getElementById('newName');
  const addBtn   = document.getElementById('addBtn');
  const clearBtn = document.getElementById('clearNew');
  const info     = document.getElementById('addModeInfo');
  const infoName = document.getElementById('addModeEtab');
  const btn      = document.getElementById('addModeBtn');
  const checkInp = document.getElementById('check-etab-inp');
  const checkBtn = document.getElementById('check-etab-open');

  if (!active){
    if (block && newInput && addBtn && clearBtn){
      block.classList.add('left-block-disabled');
      newInput.disabled = true;
      addBtn.disabled   = true;
      clearBtn.disabled = true;
      newInput.value    = '';
    }

    if (info && infoName){
      infoName.textContent = '—';
      info.style.display   = 'none';
    }
    if (btn){
      btn.classList.remove('add-mode-active');
    }

    if (checkInp){
      checkInp.value = '';
      checkInp.disabled = !ADMIN_MODE;
      checkInp.style.pointerEvents = ADMIN_MODE ? 'auto' : 'none';
    }
    if (checkBtn){
      checkBtn.disabled = !ADMIN_MODE;
      checkBtn.style.pointerEvents = ADMIN_MODE ? 'auto' : 'none';
    }

    if (!ADMIN_MODE){
      // Nature des travaux : lecture seule, on ne change pas l'état ici

      setSectionEnabled('#fileTrigger',false);
      setSectionEnabled('#btnUpload',  false);
      setSectionEnabled('#filePick',   false);
      setSectionEnabled('#vgp',        false);
      setSectionEnabled('#docBureau',  false);
    }

    try{ __ppSyncWindowModes(); }catch(e){}
    try{ window.__ppRefreshAskDreets && window.__ppRefreshAskDreets(); }catch(e){}
    return;
  }

  // Nature des travaux : lecture seule, on ne change pas l'état ici

  setSectionEnabled('#fileTrigger',true);
  setSectionEnabled('#btnUpload',  true);
  setSectionEnabled('#filePick',   true);
  setSectionEnabled('#vgp',        true);
  setSectionEnabled('#docBureau',  true);

  if (block && newInput && addBtn && clearBtn){
    block.classList.remove('left-block-disabled');
    newInput.disabled = false;
    addBtn.disabled   = false;
    clearBtn.disabled = false;
  }

  if (info && infoName){
    if (etabName){
      infoName.textContent = etabName;
      info.style.display   = 'block';
    } else {
      infoName.textContent = '—';
      info.style.display   = 'none';
    }
  }
  if (btn){
    btn.classList.add('add-mode-active');
  }

  if (checkInp){
    checkInp.value = etabName || checkInp.value || '';
    if (ADMIN_MODE){
      checkInp.disabled = false;
      checkInp.style.pointerEvents = 'auto';
    } else {
      checkInp.disabled = true;
      checkInp.style.pointerEvents = 'none';
    }
  }
  if (checkBtn){
    checkBtn.disabled = false;
    checkBtn.style.pointerEvents = 'auto';
  }
  try{ window.refreshTypeRadiosLock && window.refreshTypeRadiosLock(); }catch(e){}
  try{ refreshPersoBlock && refreshPersoBlock(); }catch(e){}

  try{ __ppSyncWindowModes(); }catch(e){}
  try{ window.__ppRefreshAskDreets && window.__ppRefreshAskDreets(); }catch(e){}
}

function initAddModeDialog() {
  console.log('[INIT] 📋 initAddModeDialog() appelée');
  const btn       = document.getElementById('addModeBtn');
  const dlg       = document.getElementById('dlgAddMode');
  const inp       = document.getElementById('addmode-code');
  const err       = document.getElementById('addmode-error');
  const btnCancel = document.getElementById('addmode-cancel');
  const btnOk     = document.getElementById('addmode-ok');

  console.log('[INIT] Éléments trouvés:', {
    btn: !!btn,
    dlg: !!dlg,
    inp: !!inp,
    err: !!err,
    btnCancel: !!btnCancel,
    btnOk: !!btnOk
  });

  if (!btn || !dlg || !inp || !err || !btnCancel || !btnOk) {
    console.error('[INIT] ❌ initAddModeDialog: éléments manquants, sortie');
    return;
  }

  console.log('[INIT] ✅ Tous les éléments présents, attachement des listeners...');

  function openDlg() {
    console.log('[INIT] 🔓 openDlg() appelée - ouverture dialogue Mode ajout');
    if (ADD_MODE_ACTIVE && !ADMIN_MODE) {
      setAddModeUI(false, '');
      return;
    }
    inp.value      = '';
    err.textContent= '';
    
    // 🔥 FORCER L'AFFICHAGE AVEC STYLES INLINE AGRESSIFS
    dlg.style.cssText = `
      display: flex !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 999999 !important;
      background: rgba(0, 0, 0, 0.8) !important;
      align-items: center !important;
      justify-content: center !important;
      pointer-events: auto !important;
      visibility: visible !important;
      opacity: 1 !important;
    `;
    
    dlg.setAttribute('aria-hidden', 'false');
    inp.focus();
    
    console.log('[INIT] ✅ Dialogue Mode ajout affiché - styles forcés');
    console.log('[INIT] 📐 Position dlg:', {
      display: dlg.style.display,
      zIndex: dlg.style.zIndex,
      position: dlg.style.position,
      computed: window.getComputedStyle(dlg).display
    });
  }

  function closeDlg() {
    dlg.style.display = 'none';
    dlg.setAttribute('aria-hidden', 'true');
  }

  btn.addEventListener('click', openDlg);
  btnCancel.addEventListener('click', closeDlg);

  dlg.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'dlgAddMode') {
      closeDlg();
    }
  });

  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      btnOk.click();
    }
  });

  btnOk.addEventListener('click', async () => {
    const codeSaisi = (inp.value || '').trim();
    if (!codeSaisi) {
      err.textContent = 'Saisir un code.';
      return;
    }
    err.textContent = '';

    const cfgE  = await ensureTable(
      ['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
      COL_ETAB_LABEL
    );
    const rowsE = cfgE.rows || [];

    const normalizeCode = (s) =>
      (s ?? '')
        .toString()
        .toUpperCase()
        .trim()
        .replace(/\s+/g, '')
        .replace(/[–—]/g, '-')
        .replace(/[^0-9A-Z-]/g, '');

    const inputNorm = normalizeCode(codeSaisi);
    const inputBase = inputNorm.split('-')[0];

    let etRow = null;
    for (const r of rowsE) {
      const rawCode = (r[COL_ETAB_CODE] ?? '').toString();
      const rowNorm = normalizeCode(rawCode);
      if (!rowNorm) continue;

      const rowBase = rowNorm.split('-')[0];

      if (rowNorm === inputNorm) {
        etRow = r;
        break;
      }
      if (rowBase && rowBase === inputBase) {
        etRow = r;
        break;
      }
    }

    if (!etRow) {
      err.textContent = 'Code établissement inconnu.';
      return;
    }

    const etabName = (etRow[cfgE.labelCol] ?? '').toString().trim() || codeSaisi;

    ADD_MODE_ACTIVE = true;
    ADD_MODE_CODE   = codeSaisi;
    ADD_MODE_USER   = codeSaisi;

    setAddModeUI(true, etabName);
    syncCheckEtabWithAddMode(etabName);
    // Si aucun equipement n'est selectionne au moment de l'activation,
    // on memorise l'intention et on appliquera les droits au premier refresh.
    window.__PP_PENDING_RIGHTS_REFRESH__ = true;
    try{ const nt=document.getElementById('f-travaux'); if(nt){ nt.removeAttribute('readonly'); } }catch(e){}

    // Appliquer immédiatement les droits (sinon readonly jusqu'au prochain refresh)
    try{ if(typeof refreshTypeRadiosLock==='function') refreshTypeRadiosLock(); }catch(e){}
    try{ await refreshRight(); }catch(e){}
    // Force l'activation immediate de Nature des travaux, meme si la selection arrive apres
    try{ const nt=document.getElementById('f-travaux'); if(nt){ nt.removeAttribute('readonly'); nt.removeAttribute('disabled'); nt.style.pointerEvents='auto'; nt.style.opacity='1'; } }catch(e){}

    await logHistory('Activation mode ajout', {
      equipId: ROW?.id,
      etabName,
      user: ADD_MODE_USER,
      details: `Mode ajout DDFPT activé pour Codepaca ${codeSaisi}`
    });

    closeDlg();
  });
}

/* ==========================================================
   MODE AJOUT DREETS
   ========================================================== */
function initDreetsModeDialog(){
  const btn = document.getElementById('dreetsAddModeBtn');
  const dlg = document.getElementById('dlgAddModeDreets');
  const inp = document.getElementById('dreets-code');
  const err = document.getElementById('dreets-error');
  const btnCancel = document.getElementById('dreets-cancel');
  const btnOk = document.getElementById('dreets-ok');

  if(!btn || !dlg || !inp || !err || !btnCancel || !btnOk) return;

  function openDlg(){
    inp.value = '';
    err.textContent = '';
    dlg.style.display = 'flex';
    dlg.style.pointerEvents = 'auto';
    dlg.setAttribute('aria-hidden','false');
    inp.focus();
  }
  function closeDlg(){
    dlg.style.display = 'none';
    dlg.setAttribute('aria-hidden','true');
  }

  btn.addEventListener('click', openDlg);
  btnCancel.addEventListener('click', closeDlg);
  dlg.addEventListener('click', e=>{
    if(e.target && e.target.id === 'dlgAddModeDreets'){
      closeDlg();
    }
  });
  inp.addEventListener('keydown', e=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      btnOk.click();
    }
  });

  btnOk.addEventListener('click', async ()=>{
    const code = (inp.value || '').trim();
    if(!code){
      err.textContent = 'Saisir un code.';
      return;
    }
    err.textContent = '';

    const admins = await fetchTable(TBL_ADMIN);
    const adminRow = admins.find(a => (a[COL_ADM_CODE_DREETS] ?? '').toString().trim() === code);
    if(!adminRow){
      err.textContent = 'Code DREETS invalide.';
      return;
    }

    DREETS_UNLOCKED = true;
    unlockDreetsSection();
    // Appliquer immediatement les droits DREETS (evite le cote 'bancal')
    try{ const rec = (ROW ? (MAP.get(Number(ROW.id))||ROW) : null); if(rec){ updateProduitFieldsEnabled(rec); await renderTravauxFromRec(rec); } }catch(e){ console.error('[DREETS] post-unlock refresh failed', e); }
    try{ await refreshRight(); }catch(e){ console.error('[DREETS] refreshRight failed', e); }
    // Appliquer immediatement les droits DREETS
    try{ const rec = (ROW ? (MAP.get(Number(ROW.id))||ROW) : null); if(rec){ updateProduitFieldsEnabled(rec); await renderTravauxFromRec(rec); } }catch(e){ console.error('[DREETS] post-unlock refresh failed', e); }
    try{ await refreshRight(); }catch(e){ console.error('[DREETS] refreshRight failed', e); }
    // Appliquer immediatement les droits DREETS (evite le cote "bancal")
    try{ const rec = (ROW ? (MAP.get(Number(ROW.id))||ROW) : null); if(rec){ updateProduitFieldsEnabled(rec); await renderTravauxFromRec(rec); } }catch(e){ console.error('[DREETS] post-unlock refresh failed', e); }
    try{ await refreshRight(); }catch(e){ console.error('[DREETS] refreshRight failed', e); }
    closeDlg();
  });
}

/* ==========================================================
   MODE ADMIN GLOBAL
   ========================================================== */
function applyAdminModeUI() {
  const btnAdmin = document.getElementById('adminModeBtn');

  if (btnAdmin) {
    if (ADMIN_MODE) {
      btnAdmin.classList.add('add-mode-active');
    } else {
      btnAdmin.classList.remove('add-mode-active');
    }
  }

  if (ADMIN_MODE) {
    setSectionEnabled('#f-lib', true);
    setSectionEnabled('#f-travaux', (ADMIN_MODE || ADD_MODE_ACTIVE));
    setSectionEnabled('#fileTrigger', true);
    setSectionEnabled('#btnUpload', true);
    setSectionEnabled('#filePick', true);
    setSectionEnabled('#vgp', true);
    setSectionEnabled('#docBureau', true);

    const checkInp = document.getElementById('check-etab-inp');
    const checkBtn = document.getElementById('check-etab-open');
    if (checkInp) {
      checkInp.disabled = false;
      checkInp.style.pointerEvents = 'auto';
    }
    if (checkBtn) {
      checkBtn.disabled = false;
      checkBtn.style.pointerEvents = 'auto';
    }

    DREETS_UNLOCKED = true;
    unlockDreetsSection();

    setAddModeUI(true, ADD_MODE_ETAB_NAME || '');
  } else {
    if (!DREETS_UNLOCKED) {
      lockDreetsSection();
    }
    setAddModeUI(ADD_MODE_ACTIVE, ADD_MODE_ETAB_NAME);
  }

  if (ROW) {
    const rec = MAP.get(Number(ROW.id)) || ROW;
    const etLabels = parseTextList((rec[COL_TMP_ETB] ?? '').toString());
    renderEtNatural(etLabels);
  }

  // Appliquer immédiatement les droits (sinon certains champs restent verrouillés)
  try{ if(typeof refreshTypeRadiosLock==='function') refreshTypeRadiosLock(); }catch(e){}
  try{ refreshRight(); }catch(e){}
  if(ADMIN_MODE){ try{ const nt=document.getElementById('f-travaux'); if(nt){ nt.removeAttribute('readonly'); nt.removeAttribute('disabled'); nt.style.pointerEvents='auto'; nt.style.opacity='1'; } }catch(e){} }

  try{ refreshPersoBlock && refreshPersoBlock(); }catch(e){}

  // maintenir window.* cohérent pour les modules additionnels (perso / bouton DREETS / export)
  try{ __ppSyncWindowModes(); }catch(e){}
  try{ window.__ppRefreshAskDreets && window.__ppRefreshAskDreets(); }catch(e){}
}

function initAdminModeDialog(){
  console.log('[INIT] 👤 initAdminModeDialog() appelée');
  const btn = document.getElementById('adminModeBtn');
  const dlg = document.getElementById('dlgAdminMode');
  const inp = document.getElementById('admin-mode-code');
  const err = document.getElementById('admin-mode-error');
  const btnCancel = document.getElementById('admin-mode-cancel');
  const btnOk = document.getElementById('admin-mode-ok');

  console.log('[INIT] Éléments trouvés:', {
    btn: !!btn,
    dlg: !!dlg,
    inp: !!inp,
    err: !!err,
    btnCancel: !!btnCancel,
    btnOk: !!btnOk
  });

  if (!btn || !dlg || !inp || !err || !btnCancel || !btnOk) {
    console.error('[INIT] ❌ initAdminModeDialog: éléments manquants, sortie');
    return;
  }

  console.log('[INIT] ✅ Tous les éléments présents, attachement des listeners...');

  function openDlg(){
    inp.value = '';
    err.textContent = '';
    
    // 🔥 FORCER L'AFFICHAGE AVEC STYLES INLINE AGRESSIFS
    dlg.style.cssText = `
      display: flex !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 999999 !important;
      background: rgba(0, 0, 0, 0.8) !important;
      align-items: center !important;
      justify-content: center !important;
      pointer-events: auto !important;
      visibility: visible !important;
      opacity: 1 !important;
    `;
    
    dlg.setAttribute('aria-hidden','false');
    inp.focus();
    
    console.log('[INIT] ✅ Dialogue Admin affiché - styles forcés');
    console.log('[INIT] 📐 Position dlg:', {
      display: dlg.style.display,
      zIndex: dlg.style.zIndex,
      computed: window.getComputedStyle(dlg).display
    });
  }
  function closeDlg(){
    dlg.style.display = 'none';
    dlg.setAttribute('aria-hidden','true');
  }

  btn.addEventListener('click', () => {
    console.log('[INIT] 👤 Bouton Admin cliqué, ADMIN_MODE=' + ADMIN_MODE);
    if (ADMIN_MODE) {
      ADMIN_MODE = false;
      DREETS_UNLOCKED = false;
      lockDreetsSection();
      if (!ADD_MODE_ACTIVE) {
        setAddModeUI(false, '');
      }
      applyAdminModeUI();
      try{ window.refreshTypeRadiosLock && window.refreshTypeRadiosLock(); }catch(e){}
    } else {
      console.log('[INIT] 🔓 Ouverture dialogue Admin');
      openDlg();
    }
  });

  btnCancel.addEventListener('click', closeDlg);
  dlg.addEventListener('click', e=>{
    if(e.target && e.target.id === 'dlgAdminMode'){
      closeDlg();
    }
  });
  inp.addEventListener('keydown', e=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      btnOk.click();
    }
  });

  btnOk.addEventListener('click', async ()=>{
    const code = (inp.value || '').trim();
    if (!code){
      err.textContent = 'Saisir un code.';
      return;
    }
    err.textContent = '';

    const admins = await fetchTable(TBL_ADMIN);
    const adminRow = admins.find(a => (a[COL_ADM_CODE] ?? '').toString().trim() === code);
    if (!adminRow){
      err.textContent = 'Code administrateur invalide.';
      return;
    }

    const adminName = `${adminRow[COL_ADM_NOM] || ''} ${adminRow[COL_ADM_PRENOM] || ''}`.trim();

    ADMIN_MODE    = true;

// En mode admin, on coupe explicitement le mode ajout établissement pour éviter toute confusion.
try{ ADD_MODE_ACTIVE = false; window.ADD_MODE_ACTIVE = false; }catch(e){}
try{ ADD_MODE_CODE = ''; window.ADD_MODE_CODE = ''; }catch(e){}

// Identité admin (utile pour historique)
try{ ADD_MODE_USER = adminName || code; window.ADD_MODE_USER = ADD_MODE_USER; }catch(e){}

    DREETS_UNLOCKED = true;
    unlockDreetsSection();

    applyAdminModeUI();

    try{ window.refreshTypeRadiosLock && window.refreshTypeRadiosLock(); }catch(e){}

    closeDlg();
  });
}

/* ==========================================================
   THÈME CLAIR / SOMBRE
   ========================================================== */
function initThemeToggle() {
  const btn = document.getElementById('themeToggle');
  if (!btn) return;

  function applyTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    btn.textContent = (theme === 'dark') ? 'Mode clair' : 'Mode sombre';
  }

  let current = document.body.getAttribute('data-theme') || 'dark';
  applyTheme(current);

  btn.addEventListener('click', () => {
    current = (current === 'dark') ? 'light' : 'dark';
    applyTheme(current);
  });
}

/* ==========================================================
   SUPPRESSION ADMINISTRATEUR
   ========================================================== */
function openAdminDeleteDialog() {
  if (!ROW) return;
  const dlg = document.getElementById('dlgAdminDelete');
  if (!dlg) return;

  const lbl = document.getElementById('delEquipLabel');
  const inp = document.getElementById('adm-del-code');
  const err = document.getElementById('adm-del-error');

  if (lbl) lbl.textContent = ROW[COL_LIB] || '—';
  if (inp) inp.value = '';
  if (err) err.textContent = '';

  dlg.style.display = 'flex';
  dlg.setAttribute('aria-hidden', 'true');
  dlg.setAttribute('aria-hidden', 'false');
  if (inp) inp.focus();
}

function closeAdminDeleteDialog() {
  const dlg = document.getElementById('dlgAdminDelete');
  if (!dlg) return;
  dlg.style.display = 'none';
  dlg.setAttribute('aria-hidden', 'true');
}

document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'dlgAdminDelete') {
    closeAdminDeleteDialog();
  }
});

const admCodeInput = document.getElementById('adm-del-code');
if (admCodeInput) {
  admCodeInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const btn = document.getElementById('adm-del-ok');
      if (btn) btn.click();
    }
  });
}

const admCancelBtn = document.getElementById('adm-del-cancel');
if (admCancelBtn) {
  admCancelBtn.addEventListener('click', () => {
    closeAdminDeleteDialog();
  });
}

const admOkBtn = document.getElementById('adm-del-ok');
if (admOkBtn) {
  admOkBtn.addEventListener('click', async () => {
    if (!ROW) return;
    const inp = document.getElementById('adm-del-code');
    const err = document.getElementById('adm-del-error');
    if (!inp || !err) return;

    const code = (inp.value || '').trim();
    if (!code) {
      err.textContent = 'Saisir un code.';
      return;
    }
    err.textContent = '';

    const admins = await fetchTable(TBL_ADMIN);
    const adminRow = admins.find(a => (a[COL_ADM_CODE] ?? '').toString().trim() === code);
    if (!adminRow) {
      err.textContent = 'Code administrateur invalide.';
      return;
    }

    const equipId = Number(ROW.id);
    const equipName = ROW[COL_LIB] || '';
    const etabName = ADD_MODE_ETAB_NAME || '';
    const adminName = `${adminRow[COL_ADM_NOM] || ''} ${adminRow[COL_ADM_PRENOM] || ''}`.trim();

    await runQuick(async () => {
      await applyUA([['RemoveRecord', TBL_MAIN, Number(ROW.id)]]);
      await loadFull();
      selectedId = null;
      ROW = null;
      renderList();
      qs('#currentEquipName').textContent = '—';
      qs('#delName').textContent = '—';
    });

    await logHistory('Suppression équipement', {
      equipId,
      equipName,
      etabName,
      user: adminName || code,
      details: `Supprimé par ${adminName || '(admin)'} (code ${code})`
    });

    closeAdminDeleteDialog();
  });
}

/* ==========================================================
   LOCK / UNLOCK DREETS
   ========================================================== */
function setButtonEnabled(selector, enabled) {
  document.querySelectorAll(selector).forEach(btn => {
    if (enabled) {
      btn.removeAttribute('disabled');
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    } else {
      btn.setAttribute('disabled', 'disabled');
      btn.style.opacity = '0.45';
      btn.style.cursor = 'not-allowed';
    }
  });
}

function lockDreetsSection() {
  DREETS_UNLOCKED = false;
  setButtonEnabled('#tr-choose', false);  // Utiliser setButtonEnabled au lieu de setSectionEnabled
  setButtonEnabled('#tr-clear', false);
  setSectionEnabled('#f-regime', false);
  try{ const p=document.getElementById('precisions'); if(p){ p.setAttribute('readonly','readonly'); p.removeAttribute('disabled'); p.style.opacity='1'; p.style.pointerEvents='auto'; p.style.cursor='not-allowed'; } }catch(e){}
  try{ const o=document.getElementById('observations'); if(o){ o.setAttribute('readonly','readonly'); o.removeAttribute('disabled'); o.style.opacity='1'; o.style.pointerEvents='auto'; o.style.cursor='not-allowed'; } }catch(e){}

  document.querySelectorAll('#trav-tbody input[type="checkbox"]').forEach(cb => {
    cb.setAttribute('disabled', 'disabled');
  });
}

function unlockDreetsSection() {
  DREETS_UNLOCKED = true;
  setButtonEnabled('#tr-choose', true);  // Utiliser setButtonEnabled au lieu de setSectionEnabled
  setButtonEnabled('#tr-clear', true);
  setSectionEnabled('#f-regime', true);
  // Pour précisions/observations, gérer manuellement (pas setSectionEnabled)
  try{ const p=document.getElementById('precisions'); if(p){ p.removeAttribute('readonly'); p.removeAttribute('disabled'); p.style.opacity='1'; p.style.pointerEvents='auto'; p.style.cursor='text'; } }catch(e){}
  try{ const o=document.getElementById('observations'); if(o){ o.removeAttribute('readonly'); o.removeAttribute('disabled'); o.style.opacity='1'; o.style.pointerEvents='auto'; o.style.cursor='text'; } }catch(e){}

  document.querySelectorAll('#trav-tbody input[type="checkbox"]').forEach(cb => {
    cb.removeAttribute('disabled');
  });
}

/* ==========================================================
   FICHE DE POSTE – tables & suggestions
   ========================================================== */

/* Tables fiche de poste (listes déroulantes) – versions définitives */
const TBL_FP_SIT    = 'Fiche_poste_Situation_dangereuse';
const COL_FP_SIT    = 'Designation';

const TBL_FP_PREV   = 'Fiche_poste_prevention';
const COL_FP_PREV   = 'Designation';

const TBL_FP_ENV    = 'Fiche_poste_environnement';
const COL_FP_ENV    = 'Designation';

const TBL_FP_PREREQ = 'Fiche_poste_pre_requis';
const COL_FP_PREREQ = 'Designation';

/* Caches des suggestions */
let FP_SIT_SUGG    = [];
let FP_PREV_SUGG   = [];
let FP_ENV_SUGG    = [];
let FP_PREREQ_SUGG = [];

// Suggestions depuis les 4 tables dédiées
async function buildFichePosteSuggestions(){
  const cfgSit  = await ensureTable([TBL_FP_SIT],    COL_FP_SIT);
  const cfgPrev = await ensureTable([TBL_FP_PREV],   COL_FP_PREV);
  const cfgEnv  = await ensureTable([TBL_FP_ENV],    COL_FP_ENV);
  const cfgPr   = await ensureTable([TBL_FP_PREREQ], COL_FP_PREREQ);

  FP_SIT_SUGG    = cfgSit?.values  || [];
  FP_PREV_SUGG   = cfgPrev?.values || [];
  FP_ENV_SUGG    = cfgEnv?.values  || [];
  FP_PREREQ_SUGG = cfgPr?.values   || [];
}

function fillSelectFromList(selectId, values){
  const sel = document.getElementById(selectId);
  if (!sel) return;

  const opts = (values || [])
    .map(v => v.toString().trim())
    .filter(Boolean)
    .filter((v,i,a) => a.findIndex(x => norm(x) === norm(v)) === i)
    .sort((a,b) => a.localeCompare(b,'fr',{sensitivity:'base'}));

  sel.innerHTML = '';
  const blank = document.createElement('option');
  blank.value = '';
  blank.textContent = '— Choisir —';
  sel.appendChild(blank);

  opts.forEach(v => {
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}

function appendFromSelectToTextarea(selectId, textareaId){
  const sel = document.getElementById(selectId);
  const ta  = document.getElementById(textareaId);
  if (!sel || !ta) return;

  const txt = (sel.value || '').trim();
  if (!txt) return;

  const current = ta.value.trim();
  const line = `• ${txt}`;
  ta.value = current ? `${current}\n${line}` : line;
}

/* ==========================================================
   FICHE DE POSTE – modale
   ========================================================== */
function autoGrowTextarea(ta){
  if(!ta) return;
  try{
    ta.style.height = "auto";
    ta.style.height = Math.max(ta.scrollHeight, 72) + "px";
  }catch(e){}
}

function initFichePosteDialog(){
  const btn      = document.getElementById('fichePosteBtn');
  const dlg      = document.getElementById('dlgFichePoste');
  const btnCancel= document.getElementById('fpCancel');
  const btnShot = document.getElementById('fpExportShot');
  const btnPDF  = document.getElementById('fpExportPDF');
  const btnSave  = document.getElementById('fpSave');
  const btnQrSetup = document.getElementById('fpBtnQrSetup');
  if (btnQrSetup){
    btnQrSetup.addEventListener('click', () => {
      const cur = (typeof localStorage !== 'undefined') ? (localStorage.getItem('FP_QR_BASE') || '') : '';
      const msg = [
        "Collez ici l’URL de la page Grist *sans* sélection de cellule (ex :",
        "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/119",
        "",
        "Le QR code ajoutera automatiquement #?table=…&rowId=… pour pointer sur l’équipement en cours."
      ].join("\n");
      const val = prompt(msg, cur);
      if(val === null) return;
      const v = String(val).trim();
      if(!v){
        try{ localStorage.removeItem('FP_QR_BASE'); }catch(e){}
        alert("Réglage QR supprimé (aucune URL).");
        updateFichePosteQr(MAP.get(Number(ROW?.id)) || ROW);
        return;
      }
      const norm = v.replace(/^https:\/\/doc\.getgrist\.com\//, 'https://docs.getgrist.com/');
      if(!/^https:\/\/docs\.getgrist\.com\//.test(norm)){
        alert("URL refusée : elle doit commencer par https://docs.getgrist.com/");
        return;
      }
      try{ localStorage.setItem('FP_QR_BASE', norm); }catch(e){}
      alert("Réglage QR enregistré.");
      // rafraîchir le QR si la fiche est ouverte
      updateFichePosteQr(MAP.get(Number(ROW?.id)) || ROW);
    });
  }


  if (!btn || !dlg) return;

  btn.addEventListener('click', () => {
    if (!ROW) return;
    openFichePosteDialog();
  });

  if (btnCancel){
    btnCancel.addEventListener('click', () => {
      closeFichePosteDialog();
    });
  }
  if (btnShot){
    btnShot.addEventListener('click', async (e) => {
      e.preventDefault();
      try{ await exportFichePosteSnapshot('png'); }catch(err){ console.error('[FP SNAP]', err); }
    });
  }

  if (btnPDF){
    btnPDF.addEventListener('click', async (e) => {
      e.preventDefault();
      try{ await exportFichePosteSnapshot('pdf'); }catch(err){ console.error('[FP PDF]', err); }
    });
  }

  if (btnSave){
    btnSave.addEventListener('click', () => {
      saveFichePosteDialog();
    });
  }

  dlg.addEventListener('click', (e) => {
    if (e.target === dlg){
      closeFichePosteDialog();
    }
  });

  const map = [
    ['fpSituationsAdd','fpSituationsSelect','fpSituations'],
    ['fpPreventionAdd','fpPreventionSelect','fpPrevention'],
    ['fpEnvironnementAdd','fpEnvironnementSelect','fpEnvironnement'],
    ['fpPrerequisAdd','fpPrerequisSelect','fpPrerequis'],
  ];
  map.forEach(([btnId, selId, taId])=>{
    const b = document.getElementById(btnId);
    if (!b) return;
    b.addEventListener('click', ()=>appendFromSelectToTextarea(selId, taId));
  });
}
// --- Fiche de poste : QR code (deep link) ---
// Nouvelle stratégie (plus robuste) :
// - Le lien final à encoder est stocké dans la colonne "QR_code_URL" (formule Grist).
// - Le script de fiche de poste NE DOIT PLUS réécrire cette colonne.
// - Ce script ne fait que RENDRE le QR (image) à partir de l'URL stockée.
// Fallback : si la colonne n'existe pas encore / est vide sur un ancien enregistrement,
// on reconstruit un lien compatible portail.
const FP_QR_BASE_DEFAULT  = 'https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/119';
const FP_QR_BASE_OVERRIDE = ''; // Optionnel: forcer la base (ex: 'https://docs.getgrist.com/.../p/119')

function _normalizeGristHostUrl(raw){
  const s = (raw || '').trim();
  if(!s) return '';
  try{
    const u = new URL(s);
    // Si on a déjà un domaine Grist, on garde.
    if(/(^|\.)getgrist\.com$/i.test(u.hostname)) return u.toString();
    // Si l'URL contient un chemin Grist ("/<docId>/.../p/<n>"), on force le host officiel.
    if(/\/p\/\d+/.test(u.pathname)){
      u.protocol = 'https:';
      u.hostname = 'docs.getgrist.com';
      u.port = '';
      return u.toString();
    }
  }catch(e){}
  return s;
}

// Section Grist (page 119) : IMPORTANT
// -> Mets 452 si c'est bien celui de ta page 119
const GRIST_SECTION_119_DEFAULT = 453;
function _detectGristSectionId(){
  try{
    const h = String(window.location.hash||"");
    const m = h.match(/\.s(\d+)\./);
    if(m) return Number(m[1])||GRIST_SECTION_119_DEFAULT;
  }catch(e){}
  return GRIST_SECTION_119_DEFAULT;
}



function _sanitizeQrUrl(raw){
  let s = (raw || '').toString().trim();
  if(!s) return '';
  // Retire les fragments qui renvoient vers l'accueil du portail (ex: #home)
  s = s.replace(/#\/?home\/?\s*$/i, '');
  // Retire un # final isolé
  s = s.replace(/#\s*$/i, '');
  return s;
}


function _decodeMaybe(s){
  let out = (s || '').toString();
  for(let i=0;i<3;i++){
    try{
      const dec = decodeURIComponent(out);
      if(dec === out) break;
      out = dec;
    }catch(e){
      break;
    }
  }
  return out;
}

function _resolveTargetUrl(raw){
  const s = (raw || '').toString().trim();
  if(!s) return '';
  try{
    const u = new URL(s);
    const src = u.searchParams.get('src');
    if(src){
      const inner = _decodeMaybe(src).trim();
      if(/^https?:\/\//i.test(inner)) return inner;
    }
  }catch(e){}
  return s;
}


function _getDeepLinkUrlForFiche(rec){
  if(!rec || !rec.id) return '';

  // 0) PRIORITE : URL depuis la colonne QR_code_URL de la table Liste des équipements
  //    Cette colonne contient l'URL complète pré-calculée (formule Grist)
  //    Avantage : rapide + maintenable + centralisé
  try{
    const colUrl = ('QR_code_URL' in rec) ? 'QR_code_URL' : (('QR code URL' in rec) ? 'QR code URL' : null);
    const v = colUrl ? String(rec[colUrl] || '').trim() : '';
    if(v) return _sanitizeQrUrl(v);
  }catch(e){}

  // 1) Fallback (anciens enregistrements) : on reconstruit un lien portail via ?src=
  const rowId = Number(rec.id);
  if(!rowId) return '';

  // Base Grist : soit surcharge manuelle, soit base par defaut, soit auto-detection depuis l'URL courante.
  let gristBase = FP_QR_BASE_OVERRIDE ? FP_QR_BASE_OVERRIDE : FP_QR_BASE_DEFAULT;
  try{
    const m = String(window.location.href||'').match(/https:\/\/docs\.getgrist\.com\/([^\/]+)\/([^\/]+)\//i);
    if(m){
      // Conserve le p/119 (ou ce que contient FP_QR_BASE_DEFAULT)
      const p = String(gristBase||'').match(/\/p\/(\d+)/);
      const pageId = p ? p[1] : '119';
      gristBase = 'https://docs.getgrist.com/' + m[1] + '/' + m[2] + '/p/' + pageId;
    }
  }catch(e){}

  const gristUrl =
    gristBase +
    '?embed=true&style=singlePage&exclude-headers=true' +
    '#a1.s' + _detectGristSectionId() + '.r' + rowId;

  const portalBase = (window.PP_PORTAL_BASE_URL || 'https://preventionpaca.github.io/guide/').replace(/\?+.*/,'');
  // L'index du portail sait gerer ?src= (QR) et ouvre dans une vue "widget".
  return portalBase.replace(/\/$/,'/') + '?src=' + encodeURIComponent(gristUrl);
}







function updateFichePosteQr(rec){
  const box = document.getElementById('fpQR');
  if(!box) return;
  box.innerHTML = '';
  // Anchor wrapper to make QR clearly clickable
  const link = document.createElement('a');
  link.href = 'about:blank';
  link.target = '_blank';
  link.rel = 'noopener noreferrer';
  link.style.display = 'inline-block';
  link.style.lineHeight = '0';
  box.appendChild(link);
  let deepUrl = _getDeepLinkUrlForFiche(rec);
  deepUrl = _sanitizeQrUrl(deepUrl);
  const targetUrl = _resolveTargetUrl(deepUrl);
  // Rend le QR cliquable (ouvre l’URL dans un nouvel onglet)
  try{
    box.dataset.qrUrl = targetUrl;
    box.setAttribute('title', targetUrl);
    try{ link.href = targetUrl; link.setAttribute('title', targetUrl); }catch(e){}
    box.onclick = (ev) => { try{ ev && ev.preventDefault && ev.preventDefault(); }catch(e){} window.open(targetUrl, '_blank', 'noopener,noreferrer'); };
    box.onkeydown = (ev) => { if(ev && (ev.key==='Enter' || ev.key===' ')){ try{ ev.preventDefault(); }catch(e){} window.open(targetUrl, '_blank', 'noopener,noreferrer'); } };
    box.setAttribute('tabindex','0');
    box.setAttribute('role','link');
  }catch(e){}
  if(!deepUrl){
    // Rien de fiable -> on laisse le fond "QR code" (pas de QR mensonger)
    return;
  }

  // 1) Si qrcodejs est dispo (CDN parfois bloqué), on l'utilise
  if(window.QRCode){
    try{
      const pad = 0;
      const size = Math.max(64, Math.floor(Math.min((box.clientWidth||210)-pad,(box.clientHeight||210)-pad)));
      new QRCode(link, { text: targetUrl, width:size, height:size, correctLevel: QRCode.CorrectLevel.M });
      try{ box.setAttribute('title', targetUrl); box.dataset.qrUrl = targetUrl; }catch(e){}
      // Tooltip visible (optionnel)
      try{
        let tip = box.querySelector('.fp-qr-tooltip');
        if(!tip){ tip = document.createElement('div'); tip.className='fp-qr-tooltip'; box.appendChild(tip); }
        tip.textContent = deepUrl;
      }catch(e){}
            // Anti-doublon : ne conserver qu’un seul rendu (canvas OU img)
      try{
        const nodes = Array.from(link.querySelectorAll('canvas,img,table'));
        if(nodes.length > 1){
          // On garde le dernier canvas/img si présent, sinon le dernier nœud
          const keep = nodes.slice().reverse().find(n => n.tagName==='CANVAS' || n.tagName==='IMG') || nodes[nodes.length-1];
          nodes.forEach(n => { if(n !== keep) n.remove(); });
        }
      }catch(e){}
      const c = link.querySelector('img,canvas');
      if(c){ c.style.width='210px'; c.style.height='210px'; c.style.display='block'; }
      return;
    }catch(e){ /* fallback ci-dessous */ }
  }

  // 2) Fallback image QR (souvent autorisé même si les scripts externes sont bloqués)
  const img = document.createElement('img');
  img.alt = 'QR';
  const s2 = Math.max(64, Math.floor(Math.min((box.clientWidth||210),(box.clientHeight||210))));
  img.width = s2; img.height = s2;
  img.loading = 'eager';
  img.referrerPolicy = 'no-referrer';
  img.crossOrigin = 'anonymous';
  img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=' + s2 + 'x' + s2 + '&data=' + encodeURIComponent(deepUrl);
  img.style.display = 'block';
  img.style.width = '100%';
  img.style.height = '100%';
  img.onerror = () => {
    // Dernier recours : afficher l'URL (cliquable)
    box.innerHTML = '';
  // Anchor wrapper to make QR clearly clickable
  const link = document.createElement('a');
  link.href = 'about:blank';
  link.target = '_blank';
  link.rel = 'noopener noreferrer';
  link.style.display = 'inline-block';
  link.style.lineHeight = '0';
  box.appendChild(link);
    const a = document.createElement('a');
    a.href = deepUrl;
    a.textContent = deepUrl;
    a.style.fontSize = '10px';
    a.style.wordBreak = 'break-all';
    a.target = '_blank';
    link.appendChild(a);
  };
  try{ box.innerHTML=''; }catch(e){}
  link.appendChild(img);
}



async function _getPhotoExportUrlForRow(rowId){
  try{
    if(!rowId) return '';
    if(Number(window.__FP_CURRENT_ROWID) === Number(rowId) && window.__FP_PHOTO_EXPORT_URL) {
      return String(window.__FP_PHOTO_EXPORT_URL || '').trim();
    }
    if(grist?.docApi?.fetchTable){
      const tbl = (typeof TBL_MAIN!=='undefined' && TBL_MAIN) ? TBL_MAIN : 'Liste_des_equipements';
      const data = await window.grist.docApi.fetchTable(tbl);
      const ids = data.id || data.ID || data.Id;
      const col = data.Photo_URL_export || data['Photo_URL_export'];
      if(ids && col){
        const idx = ids.indexOf(Number(rowId));
        if(idx >= 0){
          const v = col[idx];
          return (v == null) ? '' : String(v).trim();
        }
      }
    }
  }catch(e){}
  return '';
}

async function openFichePosteDialog(){
  if (!ROW) return;
  const rec = MAP.get(Number(ROW.id)) || ROW;
  // Store current record info for exports / QR
  try{
    window.__FP_CURRENT_ROWID = Number(ROW.id);
    // Photo pour fiche de poste / export PNG : on utilise la même logique que l'aperçu
    // (photo établissement si présente, sinon photo de base)
    try{
      // priorité : photo établissement (URL "main" si dispo, sinon thumb)
      let p = '';
      try{
        const isAdmin = (typeof ADMIN_MODE!=='undefined'?ADMIN_MODE:window.ADMIN_MODE);
        const addActive = (typeof ADD_MODE_ACTIVE!=='undefined'?ADD_MODE_ACTIVE:window.ADD_MODE_ACTIVE);
        const code = isAdmin ? String(ADMIN_TARGET_CODE||'').trim() : (addActive ? String((typeof ADD_MODE_CODE!=='undefined'?ADD_MODE_CODE:window.ADD_MODE_CODE)||'').trim() : '');
        const eid = Number(ROW.id);
        if(code && eid && (addActive || isAdmin)){
          await ensurePersoLoaded(false);
          const pr = PERSO_INDEX.get(persoKey(code,eid));
          p = extractUrl(pr?.[COL_PERSO_PHOTO_URL]) || extractUrl(pr?.[COL_PERSO_PHOTO_THMB]) || '';
        }
      }catch(e){}
      if(!p){
        // photo de base : SB_Photo_url prioritaire, puis SB_Photo_thumb, puis legacy
        p = extractUrl(rec?.[COL_SB_URL]) || extractUrl(rec?.[COL_SB_THMB]) ||
            extractUrl(rec?.[LEGACY_URL]) || extractUrl(rec?.[LEGACY_THMB]) || '';
      }
      window.__FP_PHOTO_EXPORT_URL = (p || '').toString().trim();
    }catch(e){
      window.__FP_PHOTO_EXPORT_URL = '';
    }

    // Fallback ancien champ si présent (pour compat)
    if(!window.__FP_PHOTO_EXPORT_URL){
      window.__FP_PHOTO_EXPORT_URL = ((rec && (rec['Photo_URL_export'] ?? rec.Photo_URL_export)) || '').toString().trim();
    }
    if(!window.__FP_PHOTO_EXPORT_URL){
      window.__FP_PHOTO_EXPORT_URL = await _getPhotoExportUrlForRow(Number(ROW.id));
    }
  }catch(e){}


  // QR code (deep link)
  updateFichePosteQr(rec);

  const name = (rec[COL_LIB] ?? '').toString().trim() || '—';
  const mName = document.getElementById('fpMachineName');
  if (mName) mName.textContent = name;

  const nt = document.getElementById('fpNatureTravaux');
  if (nt) { nt.value = (rec[COL_TRAV] ?? '').toString(); autoGrowTextarea(nt); nt.addEventListener('input', ()=>autoGrowTextarea(nt)); }

  // diplômes
  const diplContainer = document.getElementById('fpDiplomes');
  if (diplContainer) {
    diplContainer.innerHTML = '';

    const caps   = [];
    const bacs   = [];
    const bts    = [];
    const autres = [];

    const srcText = (rec[COL_TMP_DIP] ?? '').toString();

    parseTextList(srcText).forEach(label => {
      const n = norm(label);
      if (n.startsWith('cap ')) {
        caps.push(label);
      } else if (n.startsWith('bac pro') || n.includes(' bac professionnel')) {
        bacs.push(label);
      } else if (n.startsWith('bts ') || n.includes('brevet de technicien superieur')) {
        bts.push(label);
      } else {
        autres.push(label);
      }
    });

    const groups = [
      { title: 'CAP',             list: caps   },
      { title: 'BAC PRO',         list: bacs   },
      { title: 'BTS',             list: bts    },
      { title: 'Autres diplômes', list: autres }
    ];

        // On ne crée une colonne que si la liste n'est pas vide
    groups
      .filter(g => g.list.length > 0)
      .forEach(g => {
        const col = document.createElement('div');
        col.className = 'fp-diplomes-col';  // pour ton flex / centrage

        const h = document.createElement('div');
        h.className = 'fp-diplomes-col-title';
        h.textContent = g.title;
        col.appendChild(h);

        const ul = document.createElement('ul');
        g.list.forEach(d => {
          const li = document.createElement('li');
          li.textContent = d;
          ul.appendChild(li);
        });
        col.appendChild(ul);

        diplContainer.appendChild(col);
      });

  }

  // photo
  // On privilégie l'URL préparée pour l'export (main URL quand dispo), sinon on retombe sur la résolution standard.
  const url = (window.__FP_PHOTO_EXPORT_URL || await resolvePhotoUrlFromRow(rec));
  const img = document.getElementById('fpPhoto');
  const emptyMsg = document.getElementById('fpPhotoEmpty');
  if(img){
    try{ img.crossOrigin = 'anonymous'; }catch(e){}
    try{ img.referrerPolicy = 'no-referrer'; }catch(e){}
  }
  if (img && emptyMsg){
    // sécurité: si l'image ne charge pas, on évite le "carré noir" et on affiche le message.
    img.onerror = () => {
      try{ img.style.display = 'none'; }catch(_){}
      try{ emptyMsg.style.display = 'flex'; }catch(_){}
    };
    img.onload = () => {
      try{ img.style.display = 'block'; }catch(_){}
      try{ emptyMsg.style.display = 'none'; }catch(_){}
    };

    if (url){
      img.src = url;
      try{ await (img.decode ? img.decode() : Promise.resolve()); }catch(e){}
      img.style.display = 'block';
      emptyMsg.style.display = 'none';
    }else{
      img.src = '';
      img.style.display = 'none';
      emptyMsg.style.display = 'flex';
    }
  }


  // Champs établissement (Champs_perso)
  try{
    const code = getEffectivePersoCode();
    const equipId = Number(rec?.id);
    let perso = null;
    if(code && equipId){
      await ensurePersoLoaded(false);
      perso = PERSO_INDEX.get(persoKey(code, equipId)) || null;
    }
    const setT = (id, v) => { const el=document.getElementById(id); if(el) el.textContent = (v==null || String(v).trim()==='') ? '—' : String(v); };
    setT('fpPersoRef',    perso?.[COL_PERSO_REF]);
    setT('fpPersoAtelier',perso?.[COL_PERSO_ATEL]);
    setT('fpPersoAnnee',  perso?.[COL_PERSO_ANNEE]);
    // Notes: on compacte pour l'export, sans casser l'affichage
    const notes = perso?.[COL_PERSO_NOTES];
    setT('fpPersoNotes',  (notes||'').toString().trim().replace(/\s+/g,' ').slice(0,140));
  }catch(e){}

  const s  = document.getElementById('fpSituations');
  const p  = document.getElementById('fpPrevention');
  const e  = document.getElementById('fpEnvironnement');
  const pr = document.getElementById('fpPrerequis');

  if (s)  s.value  = (rec[COL_TMP_SIT]    ?? '').toString();
  if (p)  p.value  = (rec[COL_TMP_PREV]   ?? '').toString();
  if (e)  e.value  = (rec[COL_TMP_ENV]    ?? '').toString();
  if (pr) pr.value = (rec[COL_TMP_PREREQ] ?? '').toString();

  const y = document.getElementById('fpYear');
  if (y) y.textContent = new Date().getFullYear();

  // suggestions et listes déroulantes
  await buildFichePosteSuggestions();
  fillSelectFromList('fpSituationsSelect',    FP_SIT_SUGG);
  fillSelectFromList('fpPreventionSelect',    FP_PREV_SUGG);
  fillSelectFromList('fpEnvironnementSelect', FP_ENV_SUGG);
  fillSelectFromList('fpPrerequisSelect',     FP_PREREQ_SUGG);

  const editable = !!(ADD_MODE_ACTIVE || ADMIN_MODE || DREETS_UNLOCKED);

  [s,p,e,pr].forEach(el=>{
    if (!el) return;
    el.readOnly = !editable;
  });

  ['fpSituationsSelect','fpPreventionSelect','fpEnvironnementSelect','fpPrerequisSelect'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = !editable;
  });
  ['fpSituationsAdd','fpPreventionAdd','fpEnvironnementAdd','fpPrerequisAdd'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.disabled = !editable;
  });

  const btnSave = document.getElementById('fpSave');
  if (btnSave) btnSave.disabled = !editable;

  const dlg = document.getElementById('dlgFichePoste');
  if (dlg){
    dlg.style.display = 'flex';
    dlg.style.pointerEvents = 'auto';
    dlg.setAttribute('aria-hidden','false');
  }

  try{ __ppSyncWindowModes(); }catch(e){}
  try{ window.__ppRefreshAskDreets && window.__ppRefreshAskDreets(); }catch(e){}
}

function closeFichePosteDialog(){
  const dlg = document.getElementById('dlgFichePoste');
  if (!dlg) return;
  dlg.style.display = 'none';
  dlg.style.pointerEvents = 'none';
  dlg.setAttribute('aria-hidden','true');
}

async function saveFichePosteDialog(){
  if (!ROW) return;
  // Nature des travaux : lecture seule (on ne sauvegarde pas depuis la fiche)
  const sit    = (document.getElementById('fpSituations')?.value    || '').trim();
  const prev   = (document.getElementById('fpPrevention')?.value    || '').trim();
  const env    = (document.getElementById('fpEnvironnement')?.value || '').trim();
  const prereq = (document.getElementById('fpPrerequis')?.value     || '').trim();
  const updates = {};
  updates[COL_TMP_SIT]    = sit    || null;
  updates[COL_TMP_PREV]   = prev   || null;
  updates[COL_TMP_ENV]    = env    || null;
  updates[COL_TMP_PREREQ] = prereq || null;

  await runQuick(async () => {
    await applyUA([['UpdateRecord', TBL_MAIN, Number(ROW.id), updates]]);
    const r = MAP.get(Number(ROW.id)) || ROW;
    Object.assign(r, updates);
    MAP.set(Number(ROW.id), r);
  });

  await logHistory('Mise à jour fiche de poste', {
    equipId: ROW.id,
    details: 'Tampons situations / prévention / environnement / prérequis mis à jour'
  });

  closeFichePosteDialog();
}



/* ==========================================================
   PATCH: saisie "inline" sans lightbox (compat Suite Numérique)
   - Mode ajout : prompt Codepaca
   - Mode DREETS : prompt Code DREETS
   - Admin : prompt Code admin
   (les anciennes lightbox sont forcées en display:none via CSS)
   ========================================================== */

// === Export "Enregistrer sous" (PNG/PDF) sans impression, en mode paysage A4 ===
// --- FP EXPORT: inline images to avoid black boxes in html2canvas ---
async function _inlineImagesForCapture(rootEl){
  // Returns a restore() function or null
  const imgs = Array.from(rootEl.querySelectorAll('img'))
    .filter(img => img && img.src && !img.src.startsWith('data:') && !String(img.src).includes('docs.getgrist.com'));
  if(!imgs.length) return null;

  const originals = imgs.map(img => ({img, src: img.getAttribute('src') || img.src}));

  async function toDataURL(url, imgEl){
    try{
      // Make absolute
      const abs = new URL(url, window.location.href).toString();
      const safe = makeExportSafeImageUrl(abs);
      const isBlob = safe.startsWith('blob:');
      const fetchUrl = isBlob ? safe : (safe + (safe.includes('?') ? '&' : '?') + 't=' + Date.now());
      console.log('[FP toDataURL] Fetching:', fetchUrl.substring(0, 100));
      const resp = isBlob ? await fetch(fetchUrl) : await fetch(fetchUrl, {mode:'cors', credentials:'omit', cache:'no-store'});
      if(!resp.ok) throw new Error('HTTP '+resp.status);
      const blob = await resp.blob();
      return await new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(new Error('FileReader error'));
        r.readAsDataURL(blob);
      });
    }catch(e){
      console.warn('[FP toDataURL] Fetch failed, trying canvas fallback:', e.message);
      // Fallback: try to draw already-loaded image into a canvas (works only if not tainted)
      try{
        if(imgEl && imgEl.complete && imgEl.naturalWidth>0){
          const c = document.createElement('canvas');
          c.width = imgEl.naturalWidth; c.height = imgEl.naturalHeight;
          const ctx = c.getContext('2d');
          ctx.drawImage(imgEl,0,0);
          const result = c.toDataURL('image/png');
          console.log('[FP toDataURL] ✅ Canvas fallback successful');
          return result;
        }
      }catch(fallbackErr){ 
        console.warn('[FP toDataURL] Canvas fallback failed:', fallbackErr.message);
      }
      return null;
    }
  }

  for(const {img, src} of originals){
    console.log('[FP IMG] Converting image:', img.id || img.className, 'src:', src.substring(0, 100));
    const dataUrl = await toDataURL(src, img);
    if(dataUrl){
      console.log('[FP IMG] ✅ Successfully converted to base64:', img.id || img.className);
      img.setAttribute('src', dataUrl);
      // Ensure load
      await new Promise(res => {
        if(img.complete) return res();
        img.onload = () => res();
        img.onerror = () => res();
      });
      try{ if(typeof img.decode==='function') await img.decode().catch(()=>{}); }catch(e){}
    }else{
      console.warn('[FP IMG] ❌ Failed to convert to base64:', img.id || img.className);
    }
  }

  return function restore(){
    for(const {img, src} of originals){
      try{ img.setAttribute('src', src); }catch(_){ }
    }
  };
}
async function _waitForImages(rootEl, timeoutMs=15000){
  const imgs = Array.from(rootEl.querySelectorAll('img')).filter(im => im && im.src);
  if(!imgs.length) return;
  const waitOne = (im) => new Promise(res => {
    const done = () => res();
    try{
      // decode() is best when available
      if(typeof im.decode === 'function'){
        Promise.race([
          im.decode().catch(()=>{}),
          new Promise(r => setTimeout(r, timeoutMs))
        ]).then(done);
        return;
      }
    }catch(e){}
    // fallback on load/error/timeout
    if(im.complete && im.naturalWidth>0) return done();
    const t = setTimeout(done, timeoutMs);
    im.onload = () => { try{clearTimeout(t);}catch(e){} done(); };
    im.onerror = () => { try{clearTimeout(t);}catch(e){} done(); };
  });
  await Promise.all(imgs.map(waitOne));
}
async function exportFichePosteSnapshot(format){
  const src = document.getElementById('fpWrapper');
  if(!src) return;

  // On capture la fiche telle qu'elle s'affiche (même layout), et on masque uniquement l'UI dans le clone html2canvas.
  const filenameBase = `fiche_poste_equip_${new Date().toISOString().slice(0,10)}_${String((window.__FP_REC__ && window.__FP_REC__.id) || 'x')}`;
  const scale = 2;

  const opts = {
  scale: 2,
  useCORS: true,
  allowTaint: false,
  backgroundColor: '#ffffff',
  logging: false,
  onclone: (doc) => {
    doc.documentElement.classList.add('fp-exporting-doc');
    const root = doc.getElementById('fpWrapper');

      // Export PNG : n'afficher que le type coché (Equipement ou Produit) au lieu des deux radios
      try{
        const typeLine = root.querySelector('.type-inline');
        if(typeLine){
          const checked = typeLine.querySelector('input[type="radio"]:checked');
          const label = checked ? (checked.value || checked.id || '') : '';
          const txt = (label || '').toLowerCase().includes('prod') ? 'Produit' : 'Equipement';
          const only = doc.createElement('div');
          only.className = 'type-inline';
          only.style.marginTop = '4px';
          only.style.fontSize = '12px';
          only.style.color = '#e5e7eb';
          only.textContent = '• ' + txt;
          typeLine.replaceWith(only);
        }
      }catch(e){}

    if(!root) return;
    
    // CRITICAL: Masquer TOUS les autres dialogs pour éviter la duplication
    try{
      const allDialogs = ['dlgDiplomes', 'dlgTravaux', 'dlgAddMode', 'dlgAddModeDreets', 'dlgAdminMode'];
      allDialogs.forEach(id => {
        const el = doc.getElementById(id);
        if(el){
          el.style.display = 'none !important';
          el.style.visibility = 'hidden !important';
        }
      });
      
      doc.querySelectorAll('[aria-hidden="true"]').forEach(el => {
        if(el.id !== 'dlgFichePoste' && !el.closest('#dlgFichePoste')){
          el.style.display = 'none !important';
        }
      });
      
      console.log('[FP CLONE] Dialogs masked');
    }catch(e){ console.warn('[FP CLONE] Dialog masking error', e); }

    // Ensure photo is exportable (avoid Grist attachments -> tainted canvas)
    // NOTE: Si l'image est déjà en base64 (grâce à _inlineImagesForCapture), on la garde telle quelle
    try{
      const img = root.querySelector('#fpPhoto');
      const empty = root.querySelector('#fpPhotoEmpty');
      if(img){
        const currentSrc = img.getAttribute('src') || img.src || '';
        // Si l'image est déjà en base64 ou blob, ne rien changer car c'est déjà safe
        if(currentSrc.startsWith('data:') || currentSrc.startsWith('blob:')){
          console.log('[FP CLONE] Photo already base64/blob, keeping it');
          img.style.display = 'block';
          if(empty) empty.style.display = 'none';
        }else{
          // Sinon, essayer d'utiliser l'URL d'export
          let exportUrl = (window.__FP_PHOTO_EXPORT_URL || '').toString().trim();
          if(exportUrl){
            exportUrl = makeExportSafeImageUrl(exportUrl);
            exportUrl = exportUrl + (exportUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
            try{ img.crossOrigin = 'anonymous'; img.referrerPolicy = 'no-referrer'; }catch(e){}
            img.setAttribute('src', exportUrl);
            img.style.display = 'block';
            if(empty) empty.style.display = 'none';
          }else{
            // No export URL => hide image to keep export possible
            img.setAttribute('src','');
            img.style.display = 'none';
            if(empty) empty.style.display = 'flex';
          }
        }
      }
    }catch(e){ console.warn('[FP CLONE] Photo setup error', e); }

    // --- PNG export: work around html2canvas object-fit inconsistencies (portrait photos squished) ---
    // We render the photo as a background-image (background-size:contain) in the clone.
    try{
      const pb = root.querySelector('.fp-photo-box');
      const im = pb ? pb.querySelector('#fpPhoto') : null;
      if(pb && im){
        const s = (im.getAttribute('src') || im.src || '').toString();
        if(s){
          pb.style.position = 'relative';
          pb.style.overflow = 'hidden';
          // remove any previous helper (safety)
          const old = pb.querySelector('.fp-photo-bg-export');
          if(old) old.remove();

          const bg = doc.createElement('div');
          bg.className = 'fp-photo-bg-export';
          bg.style.position = 'absolute';
          bg.style.inset = '0';
          bg.style.backgroundImage = 'url("' + s.replace(/"/g,'\\"') + '")';
          bg.style.backgroundRepeat = 'no-repeat';
          bg.style.backgroundPosition = 'center';
          bg.style.backgroundSize = 'contain';
          // keep rounded corners consistent
          try{
            const cs = doc.defaultView.getComputedStyle(pb);
            if(cs && cs.borderRadius) bg.style.borderRadius = cs.borderRadius;
          }catch(_){}
          pb.insertBefore(bg, im);
          // hide the <img> so it doesn't stretch in the canvas render
          im.style.visibility = 'hidden';
          im.style.opacity = '0';
        }
      }
    }catch(e){ console.warn('[FP CLONE] Photo bg-export error', e); }


    root.querySelectorAll('img').forEach(im=>{ try{ im.setAttribute('referrerpolicy','no-referrer'); }catch(e){} });
    root.querySelectorAll('#fpCancel,#fpExportShot,#fpSave,.fp-actions-top').forEach(el => el && el.remove());
    root.querySelectorAll('select').forEach(el => el.remove());
    root.querySelectorAll('button').forEach(el => {
      const txt = (el.textContent || '').trim().toLowerCase();
      if(txt === 'ajouter' || /\bajouter\b/.test(txt) || /Add$/i.test(el.id || '') || (el.id || '').includes('Add')) el.remove();
    });
    root.querySelectorAll('*').forEach(el => {
      const tx = (el.textContent || '').trim();
      if(/^—\s*Choisir\s*—$/i.test(tx) || /^Choisir$/i.test(tx)) el.remove();
    });
    // Force textarea height + preserve line breaks (avoid truncation in PNG)
    try{
      root.querySelectorAll('textarea').forEach(ta=>{
        // Replace textarea by a div for html2canvas: better wrapping + respects \n
        const div = doc.createElement('div');
        div.className = ta.className;
        div.setAttribute('data-fp-ta', (ta.id||ta.name||''));
        div.textContent = ta.value || ta.textContent || '';

        // Copier le rendu réel (sinon html2canvas "rétrécit" les zones et casse la mise en page)
        try{
          const cs = doc.defaultView.getComputedStyle(ta);
          // dimensions
          div.style.width = cs.width;
          div.style.height = cs.height;
          // on garde au minimum la hauteur visible de l'écran
          div.style.minHeight = (cs.height && cs.height !== 'auto') ? cs.height : (cs.minHeight || '72px');

          // typographie / spacing
          div.style.boxSizing = cs.boxSizing;
          div.style.fontFamily = cs.fontFamily;
          div.style.fontSize = cs.fontSize;
          div.style.fontWeight = cs.fontWeight;
          div.style.lineHeight = cs.lineHeight;

          // décor
          div.style.padding = cs.padding;
          div.style.border = cs.border;
          div.style.borderRadius = cs.borderRadius;
          div.style.background = cs.backgroundColor;
          div.style.color = cs.color;

          // divers
          div.style.overflow = cs.overflow;
        }catch(e){
          // fallback safe
          div.style.minHeight = (ta.offsetHeight ? (ta.offsetHeight+'px') : '72px');
          div.style.width = ta.offsetWidth ? (ta.offsetWidth+'px') : '100%';
        }

        // texte : préserver les retours à la ligne
        div.style.whiteSpace = 'pre-wrap';
        div.style.wordBreak = 'break-word';
        div.style.overflowWrap = 'anywhere';

        ta.parentNode && ta.parentNode.replaceChild(div, ta);
      });
    }catch(e){}

    const qr = root.querySelector('#fpQR');
    if(qr) qr.style.background = '#fff';
  }
};

    // Inline des images (évite les carrés noirs dans le PNG)
  let _restoreImgs = null;
  try{ _restoreImgs = await _inlineImagesForCapture(src); }catch(e){ console.warn('[FP IMG] inline error', e); }

  // Attendre le chargement/décodage des images avant capture (sinon carrés noirs)
  try{ await _waitForImages(src, 15000); }catch(e){ console.warn('[FP IMG] waitImages error', e); }

// html2canvas est déjà chargé dans ton fichier
  if(!window.html2canvas){
    alert("html2canvas n'est pas chargé : export PNG impossible.");
    return;
  }

  
  // Ensure we have an exportable photo URL (public) for PNG export
  try{
    if((!window.__FP_PHOTO_EXPORT_URL || !String(window.__FP_PHOTO_EXPORT_URL).trim()) && window.__FP_CURRENT_ROWID){
      window.__FP_PHOTO_EXPORT_URL = await _getPhotoExportUrlForRow(Number(window.__FP_CURRENT_ROWID));
    }
  }catch(e){}

window.html2canvas(src, opts).then(async (canvas) => {
    console.log('[FP PNG] Canvas captured - CSS object-fit:contain preserved');
    console.log('[FP PNG] Canvas dimensions:', canvas.width, 'x', canvas.height);
    
    // Restaurer les images originales
    try{ 
      if(typeof _restoreImgs==='function') _restoreImgs(); 
      console.log('[FP PNG] Images restored');
    }catch(e){ 
      console.warn('[FP IMG] restore error', e); 
    }

    canvas.toBlob((blob) => {
      if(!blob){ console.error('[FP PNG] blob null'); return; }
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url;
      a.download = `${filenameBase}.png`;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 250);
      console.log('[FP PNG] PNG downloaded');
    }, 'image/png');
  }).catch(err => {
    console.error('[FP SNAP]', err);
    alert("Erreur export PNG (voir console).");
  });
}




/* ============================================================================
   ⚠️ FONCTIONS EN DOUBLE DÉSACTIVÉES ⚠️
   
   Les trois fonctions ci-dessous (initAddModeDialog, initDreetsModeDialog, 
   initAdminModeDialog) sont des ANCIENNES versions qui utilisaient 
   window.prompt() au lieu des belles boîtes de dialogue custom.
   
   ⛔ CES FONCTIONS SONT DÉSACTIVÉES PAR COMMENTAIRE ⛔
   
   Les versions actives (et correctes) de ces fonctions se trouvent aux lignes:
   - initAddModeDialog: ligne 7593 ✅
   - initDreetsModeDialog: ligne 7718 ✅
   - initAdminModeDialog: ligne 7848 ✅
   
   NE PAS DÉCOMMENTER CE BLOC !
   ============================================================================ */
/*
function initAddModeDialog(){
  const btn = document.getElementById('addModeBtn');
  if(!btn) return;

  // remove any previous listeners (best-effort)
  btn.replaceWith(btn.cloneNode(true));
  const freshBtn = document.getElementById('addModeBtn');

  freshBtn.addEventListener('click', async ()=>{
    if (ADD_MODE_ACTIVE && !ADMIN_MODE) {
      setAddModeUI(false, '');
      return;
    }

    const codeSaisi = (window.prompt("Code établissement (Codepaca) :", "") || "").trim();
    if(!codeSaisi) return;

    const cfgE  = await ensureTable(
      ['Etablissements_edi','Etablissements_EDI','ETABLISSEMENTS_EDI'],
      COL_ETAB_LABEL
    );
    const rowsE = cfgE.rows || [];

    const normalizeCode = (s) =>
      (s ?? '')
        .toString()
        .toUpperCase()
        .trim()
        .replace(/\s+/g, '')
        .replace(/[–—]/g, '-')
        .replace(/[^0-9A-Z-]/g, '');

    const inputNorm = normalizeCode(codeSaisi);
    const inputBase = inputNorm.split('-')[0];

    let etRow = null;
    for (const r of rowsE) {
      const rawCode = (r[COL_ETAB_CODE] ?? '').toString();
      const rowNorm = normalizeCode(rawCode);
      if (!rowNorm) continue;

      const rowBase = rowNorm.split('-')[0];

      if (rowNorm === inputNorm || (rowBase && rowBase === inputBase)) {
        etRow = r;
        break;
      }
    }

    if (!etRow) {
      alert('Code établissement inconnu.');
      return;
    }

    const etabName = (etRow[cfgE.labelCol] ?? '').toString().trim() || codeSaisi;

    ADD_MODE_ACTIVE = true;
    ADD_MODE_CODE   = codeSaisi;
    ADD_MODE_USER   = codeSaisi;

    setAddModeUI(true, etabName);
    syncCheckEtabWithAddMode(etabName);
    // Si aucun equipement n'est selectionne au moment de l'activation,
    // on memorise l'intention et on appliquera les droits au premier refresh.
    window.__PP_PENDING_RIGHTS_REFRESH__ = true;
    try{ const nt=document.getElementById('f-travaux'); if(nt){ nt.removeAttribute('readonly'); } }catch(e){}

    await logHistory('Activation mode ajout', {
      equipId: ROW?.id,
      etabName,
      user: ADD_MODE_USER,
      details: `Mode ajout DDFPT activé (prompt) pour Codepaca ${codeSaisi}`
    });
  });
}

function initDreetsModeDialog(){
  const btn = document.getElementById('dreetsAddModeBtn');
  if(!btn) return;

  btn.replaceWith(btn.cloneNode(true));
  const freshBtn = document.getElementById('dreetsAddModeBtn');

  freshBtn.addEventListener('click', async ()=>{
    const code = (window.prompt("Code DREETS :", "") || "").trim();
    if(!code) return;

    const admins = await fetchTable(TBL_ADMIN);
    const adminRow = admins.find(a => (a[COL_ADM_CODE_DREETS] ?? '').toString().trim() === code);
    if(!adminRow){
      alert('Code DREETS invalide.');
      return;
    }

    DREETS_UNLOCKED = true;
    unlockDreetsSection();
    // Appliquer immediatement les droits DREETS (evite le cote "bancal")
    try{ const rec = (ROW ? (MAP.get(Number(ROW.id))||ROW) : null); if(rec){ updateProduitFieldsEnabled(rec); await renderTravauxFromRec(rec); } }catch(e){ console.error('[DREETS] post-unlock refresh failed', e); }
    try{ await refreshRight(); }catch(e){ console.error('[DREETS] refreshRight failed', e); }
  });
}

function initAdminModeDialog(){
  const btn = document.getElementById('adminModeBtn');
  if(!btn) return;

  btn.replaceWith(btn.cloneNode(true));
  const freshBtn = document.getElementById('adminModeBtn');

  freshBtn.addEventListener('click', async ()=>{
    if (ADMIN_MODE) {
      ADMIN_MODE = false;
      DREETS_UNLOCKED = false;
      lockDreetsSection();
      if (!ADD_MODE_ACTIVE) {
        setAddModeUI(false, '');
      }
      applyAdminModeUI();
      return;
    }

    const code = (window.prompt("Code administrateur :", "") || "").trim();
    if(!code) return;

    const admins = await fetchTable(TBL_ADMIN);
    const adminRow = admins.find(a => (a[COL_ADM_CODE] ?? '').toString().trim() === code);
    if (!adminRow){
      alert('Code administrateur invalide.');
      return;
    }

    const adminName = `${adminRow[COL_ADM_NOM] || ''} ${adminRow[COL_ADM_PRENOM] || ''}`.trim();

    ADMIN_MODE    = true;
    ADD_MODE_CODE = code;
    ADD_MODE_USER = adminName || code;

    DREETS_UNLOCKED = true;
    unlockDreetsSection();

    applyAdminModeUI();
  });
}
*/
/* ============================================================================
   FIN DES FONCTIONS DÉSACTIVÉES
   ============================================================================ */


/* ==========================================================
   PATCH: export PDF fiche de poste SANS pop-up (window.print)
   ========================================================== */
(function(){
  function whenImagesReady(root, cb){
    const imgs = Array.from((root||document).querySelectorAll('img') || []);
    if(!imgs.length) return cb();
    let left = imgs.length;
    const done = ()=>{ left--; if(left<=0) cb(); };

    imgs.forEach(img=>{
      if(img.complete) return done();
      img.addEventListener('load', done, {once:true});
      img.addEventListener('error', done, {once:true});
    });

    setTimeout(cb, 1200);
  }

  function wire(){
    const btn = document.getElementById('fpExportPDF');
    if(!btn || btn.__pp_wired) return;
    btn.__pp_wired = true;

    btn.addEventListener('click', async (e)=>{
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      // s'assurer que la fiche est ouverte et à jour
      try{ await openFichePosteDialog(); }catch{}
      const dlg = document.getElementById('dlgFichePoste');
      if(dlg){
        dlg.classList.add('is-open');
        dlg.style.display = 'flex';
        dlg.setAttribute('aria-hidden','false');
      }

      const wrapper = document.getElementById('fpWrapper') || dlg;
      whenImagesReady(wrapper, ()=>{
        setTimeout(()=>{ window.print(); }, 60);
      });
    }, true);
  }

  wire();
  new MutationObserver(wire).observe(document.documentElement, {subtree:true, childList:true});
})();


/* ==========================================================
   INITIALISATION GLOBALE
   ========================================================== */

/* ==========================================================
   BOUTON : "A compléter par la Dreets" (zone DDFPT)
   - force Tampon_regime = "A compléter par la Dreets" (même sans mode DREETS)
   - envoie une notif par FormSubmit (comme page Contact)
   Accessible : Admin ou Mode ajout établissement (Codepaca)
   ========================================================== */
const DREETS_REGIME_LABEL = 'A compléter par la Dreets';
const DREETS_FORMSUBMIT_ENDPOINT = 'https://formsubmit.co/guide.preventionpaca@lycee-les-eucalyptus.org';


// === Web3Forms (remplace FormSubmit : accepte les URLs longues) ===
const WEB3FORMS_ENDPOINT = 'https://api.web3forms.com/submit';
// ⚠️ Remplace par ta clé Web3Forms (idéalement régénérée)
const WEB3FORMS_ACCESS_KEY = '43852939-d6f2-468e-b9e4-cefda2c3010a';
function __ppCanAskDreets(){
  const addActive = (typeof ADD_MODE_ACTIVE!=='undefined'?ADD_MODE_ACTIVE:window.ADD_MODE_ACTIVE);
  const addCode   = String((typeof ADD_MODE_CODE!=='undefined'?ADD_MODE_CODE:window.ADD_MODE_CODE)||'').trim();
  const isAdmin   = (typeof ADMIN_MODE!=='undefined'?ADMIN_MODE:window.ADMIN_MODE);
  const hasEtab = !!(addActive && addCode);
  return !!(isAdmin || hasEtab);
}

async function __ppAskDreetsActor(){
  // Pour le mail : établissement demandeur + nom
  const addActive = (typeof ADD_MODE_ACTIVE!=='undefined'?ADD_MODE_ACTIVE:window.ADD_MODE_ACTIVE);
  const addCode   = String((typeof ADD_MODE_CODE!=='undefined'?ADD_MODE_CODE:window.ADD_MODE_CODE)||'').trim();
  const isAdmin   = (typeof ADMIN_MODE!=='undefined'?ADMIN_MODE:window.ADMIN_MODE);
  
  let code = '';
  let origin = '';
  let etabName = '';
  
  if(addActive && addCode){
    code = addCode;
    origin = 'Établissement';
  } else if(isAdmin){
    // Admin : si un établissement cible est sélectionné, on l'indique
    const t = String((typeof ADMIN_TARGET_CODE!=='undefined'?ADMIN_TARGET_CODE:window.ADMIN_TARGET_CODE)||'').trim();
    if(t){
      code = t;
      origin = 'Admin (établissement cible)';
    } else {
      return { code: 'ADMIN', origin: 'Admin', etabName: '' };
    }
  } else {
    // Cas par défaut : ni DDFPT ni Admin
    console.warn('[DREETS ASK] Ni mode DDFPT ni Admin actif');
    return { code: '', origin: 'Inconnu', etabName: '' };
  }
  
  // Récupérer le nom de l'établissement depuis la table Etablissements
  if(code){
    try{
      const etabRows = await fetchTable('Etablissements_edi');
      const etab = etabRows.find(r => String(r[COL_ETAB_CODE]||'').trim().toLowerCase() === code.toLowerCase());
      if(etab){
        etabName = String(etab[COL_ETAB_LABEL] || '').trim();
      }
    }catch(e){
      console.warn('[DREETS ASK] Cannot fetch établissement name:', e);
    }
  }
  
  return { code, origin, etabName };
}

async function __ppSendFormSubmitMail({subject, fields}){
  try{
    const payload = {
      access_key: WEB3FORMS_ACCESS_KEY,
      subject: subject || 'Demande – Guide Prévention PACA',
      from_name: 'Guide Prévention PACA',
      message: `Bonjour,

Une nouvelle demande a été soumise depuis le Portail Prévention PACA.
Merci de trouver ci-dessous les informations détaillées.

Hello,

A new request has been submitted from the Prevention PACA Portal.
Please find the detailed information below.`,
      ...((fields && typeof fields === 'object') ? fields : {})
    };

    const resp = await fetch(WEB3FORMS_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await resp.json().catch(()=>null);
    if(resp.ok && data && data.success){ return true; }
    console.error('[WEB3FORMS] Failed:', resp.status, data);
    return false;
  }catch(e){
    console.error('[WEB3FORMS] Exception:', e);
    return false;
  }
}
function initAskDreetsButton(){
  const btn = document.getElementById('btnAskDreets');
  const msg = document.getElementById('dreetsAskMsg');
  if(!btn) return;

  const refresh = () => {
    const ok = __ppCanAskDreets();
    btn.disabled = !ok;
    btn.style.opacity = ok ? '1' : '.45';
    btn.style.cursor = ok ? 'pointer' : 'not-allowed';
    if(msg){
      msg.textContent = ok ? '' : 'Connexion établissement ou admin requise.';
    }
  };

  btn.addEventListener('click', async ()=>{
    console.log('[DREETS BUTTON] ========== Click détecté ==========');
    refresh();
    console.log('[DREETS BUTTON] Après refresh, disabled:', btn.disabled);
    if(btn.disabled) {
      console.log('[DREETS BUTTON] Bouton disabled, arrêt');
      return;
    }
    if(!ROW){ 
      console.log('[DREETS BUTTON] Pas de ROW');
      if(msg) msg.textContent = 'Aucun équipement sélectionné.'; 
      return; 
    }

    console.log('[DREETS BUTTON] ROW.id:', ROW.id);
    const rid = Number(ROW.id);
    const rec = MAP.get(rid) || ROW;
    console.log('[DREETS BUTTON] rec:', {id: rec.id, libelle: rec[COL_LIB]});

    // 1) force select regime + update Grist
    const sel = document.getElementById('f-regime');
    if(sel){
      // si l'option n'existe pas, on ajoute temporairement (sécurité)
      const opt = Array.from(sel.options||[]).find(o => (o.value||'').trim() === DREETS_REGIME_LABEL);
      if(!opt){
        const o = document.createElement('option');
        o.value = DREETS_REGIME_LABEL;
        o.textContent = DREETS_REGIME_LABEL;
        sel.appendChild(o);
      }
      sel.value = DREETS_REGIME_LABEL;
    }

    try{
      if(msg) msg.textContent = 'Mise à jour du statut…';
      console.log('[DREETS BUTTON] Début runQuick...');
      await runQuick(async()=>{
        await applyUA([['UpdateRecord', TBL_MAIN, rid, { [COL_TMP_REG]: DREETS_REGIME_LABEL }]]);
      });
      console.log('[DREETS BUTTON] runQuick terminé');
      const r = MAP.get(rid);
      if(r) {
        r[COL_TMP_REG] = DREETS_REGIME_LABEL;
        MAP.set(rid, r);
      }
      try{ renderRegimeToken(DREETS_REGIME_LABEL); }catch(e){}
      try{ colorizeRegimeSelect(DREETS_REGIME_LABEL); }catch(e){}
      try{ colorizeLibFromRegime(r || ROW); }catch(e){}
      try{ renderList(); }catch(e){}

      // 2) mail notif
      console.log('[DREETS BUTTON] Appel __ppAskDreetsActor...');
      const actor = await __ppAskDreetsActor();
      console.log('[DREETS BUTTON] actor:', actor);
      const equipLabel = (rec[COL_LIB] ?? '').toString().trim();
      
      // Générer le lien vers la fiche (lien QR code)
      console.log('[DREETS BUTTON] Génération lien fiche...');
      const ficheUrl = _getDeepLinkUrlForFiche(rec);
      console.log('[DREETS BUTTON] ficheUrl:', ficheUrl);
      
      const subject = `Demande validation DREETS – ${equipLabel || 'Equipement'}`;
      console.log('[DREETS BUTTON] Envoi mail FormSubmit...');
      
      // ✅ CORRECTION : RETIRER TOUS LES ACCENTS DES NOMS DE CHAMPS
      const okMail = await __ppSendFormSubmitMail({
        subject,
        fields: {
          'Action': DREETS_REGIME_LABEL,
          'Equipement': equipLabel || '—',           // ← Sans accent
          'ID_equipement': rid,                      // ← Sans accent
          'Code_etablissement': actor.code,          // ← Sans accent
          'Nom_etablissement': actor.etabName || '—', // ← Sans accent
          'Origine': actor.origin,
          'Lien_fiche': ficheUrl || '—',
        }
      });
      console.log('[DREETS BUTTON] Mail envoyé, okMail:', okMail);

      if(msg) msg.textContent = okMail ? 'Demande envoyée.' : 'Statut mis à jour (mail non envoyé).';
      setTimeout(()=>{ if(msg && (msg.textContent==='Demande envoyée.' || msg.textContent==='Statut mis à jour (mail non envoyé).')) msg.textContent=''; }, 1600);
    }catch(e){
      console.error('[DREETS BUTTON] ❌ ERREUR:', e);
      console.error('[DREETS BUTTON] Stack:', e.stack);
      if(msg) msg.textContent = "Erreur : impossible de mettre à jour.";
    }
  });

  // mise à jour régulière (mode change, target etc.)
  refresh();
  // hooks légers
  try{ window.__ppRefreshAskDreets = refresh; }catch(e){}
}

function bootOnce(){
  console.log('[BOOT v15.13] 🚀 bootOnce() démarrage...');
  if(bootOnce._done) {
    console.log('[BOOT v15.13] ⚠️ bootOnce déjà exécuté, sortie');
    return;
  }
  bootOnce._done = true;
  console.log('[BOOT v15.13] ✅ Premier boot, initialisation...');

  // ---- Version visible (utile pour verifier qu'on teste le bon fichier) ----
  try{
    const v = 'v15.13-FIX';
    const badge = document.getElementById('ppVersionBadge');
    if(badge){
      badge.textContent = v;
      badge.addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText(v); }catch(e){}
      });
      // masquer facilement: ajouter ?noversion=1 dans l'URL du widget
      try{ if(new URLSearchParams(location.search).get('noversion') === '1') badge.style.display='none'; }catch(e){}
    }
  }catch(e){}
  // Nature des travaux : droits geres par refreshRight() (pas de verrouillage force ici)

  initThemeToggle();
  initAddModeDialog();
  initDreetsModeDialog();
  initAdminModeDialog();
  setAddModeUI(false, '');
  setFilterMode('autocomp');
  initCheckEtabPicker();
  initRegimeSelect();
  initAskDreetsButton();
  initTravauxUi();

  // Filet de sécurité : certains environnements (Suite Numérique / Grist)
  // peuvent intercepter les clics et provoquer une navigation "vue brute".
  // On intercepte en CAPTURE pour forcer l'ouverture de la lightbox Travaux.

  lockDreetsSection();
  initFichePosteDialog();
  console.log('[BOOT v15.13] ✅ Initialisation terminée avec succès !');
}

// --- Grist API guard ---
function __ppHasGristApi(){
  return !!(
    window.grist && 
    window.grist.docApi && 
    typeof window.grist.onRecord === 'function' &&
    typeof window.grist.docApi.applyUserActions === 'function'
  );
}

if(!__ppHasGristApi()){
  // ✅ Mode public (navigateur neutre) : lecture/écriture via Supabase, sans Grist visible.
  (async ()=>{
    try{
      await loadFull();
      try{ await buildDomainSectorIndex(); }catch(e){}
      try{ initTypeRadios && initTypeRadios(); }catch(e){}
      try{ renderList(); }catch(e){}
      const deepId = _hashBaseId();
      if(deepId){ await selectRow(deepId, true); }
    }catch(e){
      console.error('[SB] boot public failed', e);
      try{
        const warn=document.createElement('div');
        warn.style.cssText='position:fixed;right:14px;bottom:14px;z-index:99999;background:rgba(2,6,23,.85);border:1px solid rgba(148,163,184,.25);color:#e2e8f0;padding:10px 12px;border-radius:10px;font:12px system-ui;max-width:380px;backdrop-filter:blur(6px)';
        warn.textContent = "Erreur de chargement (mode public). Vérifiez Supabase (read-app).";
        document.body.appendChild(warn);
        setTimeout(()=>{ try{ warn.remove(); }catch(e){} }, 9000);
      }catch(_){}
    }

    // Deep-link QR : si l'utilisateur scanne un autre QR pendant que la page est ouverte
    window.addEventListener('hashchange', async ()=>{
      const id = _hashBaseId();
      if(id){ await selectRow(id, true); }
    });
  })();
}else{
  window.grist.ready();
  
  // ✅ TEST DE DIAGNOSTIC AU DÉMARRAGE
  setTimeout(async () => {
    console.log('[DIAGNOSTIC v15.5] ========================================');
    console.log('[DIAGNOSTIC v15.5] Vérification des fonctions critiques...');
    
    // Vérifier que rowsToRecordsCompat est définie
    if(typeof rowsToRecordsCompat === 'function') {
      console.log('[DIAGNOSTIC v15.5] ✅ rowsToRecordsCompat définie');
    } else {
      console.error('[DIAGNOSTIC v15.5] ❌ rowsToRecordsCompat NON définie !');
    }
    
        // Test de la table Champs_perso uniquement si un établissement est actif
    const __persoCode = (typeof getEffectivePersoCode === 'function') ? (getEffectivePersoCode() || '') : '';
    if(!__persoCode){
      console.log('[DIAGNOSTIC v15.5] ℹ️ Pas de code établissement actif : test Champs_perso ignoré.');
    } else {
      console.log('[DIAGNOSTIC v15.5] Test de la table Champs_perso...');
      try {
        await ensurePersoLoaded(true);

      if(PERSO_LOADED && PERSO_INDEX.size > 0) {
        console.log('[DIAGNOSTIC v15.5] ✅ Table Champs_perso accessible');
        console.log('[DIAGNOSTIC v15.5] ✅', PERSO_INDEX.size, 'enregistrements trouvés');
      } else if(PERSO_LOADED && PERSO_INDEX.size === 0) {
        console.warn('[DIAGNOSTIC v15.5] ⚠️ Table accessible mais vide');
      } else {
        console.error('[DIAGNOSTIC v15.5] ❌ Impossible d\'accéder à la table');
      }
      } catch(err) {
        console.error('[DIAGNOSTIC v15.5] ❌ Erreur durant le test:', err);
      }
    }

// Test d'écriture
      console.log('[DIAGNOSTIC v15.5] Test des permissions d\'écriture...');
      const hasWriteAccess = !!(
        window.grist && 
        window.grist.docApi && 
        typeof window.grist.docApi.applyUserActions === 'function'
      );
      
      if(hasWriteAccess) {
        console.log('[DIAGNOSTIC v15.5] ✅ API d\'écriture disponible');
      } else {
        console.error('[DIAGNOSTIC v15.5] ❌ API d\'écriture NON disponible');
        console.error('[DIAGNOSTIC v15.5] Vérifiez que le widget a access=full');
      }

    
    console.log('[DIAGNOSTIC v15.5] ========================================');
  }, 2000);
  
  window.grist.onRecord(async (rec) => {
  try { bootOnce(); } catch (e) { console.error('[BOOT] bootOnce failed', e); }

// ================== PP-TR FUSE (left list watchdog) ==================
(function(){
  const FUSE = {
    started: Date.now(),
    errors: [],
    logs: [],
    lastLeftCount: 0,
    overlay: null,
    push(type, args){
      try{
        const msg = Array.from(args||[]).map(a=>{
          try{ return (typeof a==='string')?a:JSON.stringify(a); }catch(e){ return String(a); }
        }).join(' ');
        this.logs.push({t:new Date().toISOString(), type, msg});
        if(this.logs.length>200) this.logs.shift();
      }catch(e){}
    },
    addError(err){
      try{
        const e = (err && err.reason) ? err.reason : err;
        const rec = {
          t: new Date().toISOString(),
          name: e && e.name ? e.name : 'Error',
          message: e && e.message ? e.message : String(e),
          stack: e && e.stack ? String(e.stack) : ''
        };
        this.errors.push(rec);
        if(this.errors.length>50) this.errors.shift();
        this.show('Erreur détectée: ' + rec.message);
      }catch(_){ }
    },
    ensureOverlay(){
      if(this.overlay) return this.overlay;
      const el = document.createElement('div');
      el.id = 'pptrFuse';
      el.style.cssText = [
        'position:fixed','left:12px','bottom:12px','z-index:9999999',
        'max-width:520px','background:rgba(10,18,32,.92)','color:#eaf2ff',
        'border:1px solid rgba(120,160,220,.35)','border-radius:14px',
        'box-shadow:0 10px 30px rgba(0,0,0,.35)','padding:10px 12px',
        'font:12px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial'
      ].join(';');
      el.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="width:10px;height:10px;border-radius:50%;background:#ffb020;"></div>
          <div style="font-weight:800;letter-spacing:.2px;">PP‑TR — diagnostic</div>
          <div style="margin-left:auto;display:flex;gap:6px;">
            <button id="pptrFuseCopy" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.15);">Copier</button>
            <button id="pptrFuseRetry" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;background:rgba(46,204,113,.18);border:1px solid rgba(46,204,113,.35);">Relancer liste</button>
            <button id="pptrFuseClose" style="all:unset;cursor:pointer;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);">×</button>
          </div>
        </div>
        <div id="pptrFuseMsg" style="margin-top:6px;opacity:.95;">Surveillance en cours…</div>
        <div id="pptrFuseMeta" style="margin-top:6px;opacity:.8;font-size:11px;"></div>
      `;
      document.body.appendChild(el);
      el.querySelector('#pptrFuseClose').addEventListener('click', ()=>{ el.remove(); this.overlay=null; });
      el.querySelector('#pptrFuseCopy').addEventListener('click', ()=>{
        const payload = {
          href: location.href,
          ts: new Date().toISOString(),
          leftCount: this.lastLeftCount,
          errors: this.errors,
          logs: this.logs.slice(-80)
        };
        const txt = JSON.stringify(payload, null, 2);
        navigator.clipboard?.writeText(txt).then(()=>{
          this.setMsg('Copié. Colle-moi ça ici.');
        }).catch(()=>{
          this.setMsg('Impossible de copier automatiquement. Ouvre la console et copie les logs.');
        });
      });
      el.querySelector('#pptrFuseRetry').addEventListener('click', ()=>{
        this.setMsg('Relance demandée…');
        try{
          if(typeof window.renderList==='function') window.renderList();
          if(typeof window.refreshLeft==='function') window.refreshLeft();
          if(typeof window.refreshAll==='function') window.refreshAll();
        }catch(e){ this.addError(e); }
      });
      this.overlay = el;
      return el;
    },
    setMsg(msg){
      const el = this.ensureOverlay();
      const m = el.querySelector('#pptrFuseMsg');
      if(m) m.textContent = msg;
      const meta = el.querySelector('#pptrFuseMeta');
      if(meta){
        const secs = Math.round((Date.now()-this.started)/1000);
        meta.textContent = `Temps: ${secs}s • erreurs: ${this.errors.length} • items liste: ${this.lastLeftCount}`;
      }
    },
    show(msg){
      this.ensureOverlay();
      this.setMsg(msg || 'Diagnostic actif');
    },
    monitor(){
      // left list container candidates
      const cands = [
        document.getElementById('list'),
        document.getElementById('equipList'),
        document.querySelector('[data-role="equip-list"]'),
        document.querySelector('.equip-list'),
        document.querySelector('#leftPane .list'),
        document.querySelector('#leftPane')
      ].filter(Boolean);
      let count = 0;
      for(const el of cands){
        // count list entries (li/div buttons)
        const items = el.querySelectorAll('button,li,.equip-item,.item');
        if(items && items.length>count) count = items.length;
      }
      this.lastLeftCount = count;

      // If after 3 seconds still empty, show fuse (but don't spam)
      const elapsed = Date.now()-this.started;
      if(elapsed>3000 && count===0){
        // detect if a fatal syntax error occurred (script stopped)
        this.show('La liste de gauche ne se charge pas (0 élément). Clique sur “Copier” et envoie-moi le diagnostic.');
      }

      // Update meta if open
      if(this.overlay) this.setMsg(this.overlay.querySelector('#pptrFuseMsg')?.textContent || '');

      setTimeout(()=>this.monitor(), 1200);
    }
  };

  // Hook errors
  window.addEventListener('error', (ev)=>{ FUSE.addError(ev.error || ev.message); }, true);
  window.addEventListener('unhandledrejection', (ev)=>{ FUSE.addError(ev); }, true);

  // Hook console (keep original)
  const _err = console.error.bind(console);
  console.error = function(){ FUSE.push('error', arguments); _err.apply(console, arguments); };
  const _warn = console.warn.bind(console);
  console.warn = function(){ FUSE.push('warn', arguments); _warn.apply(console, arguments); };
  const _log = console.log.bind(console);
  console.log = function(){ FUSE.push('log', arguments); _log.apply(console, arguments); };

  // Expose for manual access
  window.__PPTR_FUSE__ = FUSE;

  // Start monitor when DOM ready
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', ()=>FUSE.monitor());
  } else {
    FUSE.monitor();
  }
})();
// ================== /PP-TR FUSE ==================


  if (!rec) {
    ROW = null;
    selectedId = null;
    try{ window.ROW = null; }catch(e){}
    try{ window.currentRec = null; }catch(e){}
    try{ if(window.grist) window.grist.selectedRecord = null; }catch(e){}
    document.getElementById('currentEquipName').textContent = '—';
    document.getElementById('delName').textContent = '—';
    return;
  }

  ROW = rec;
  selectedId = rec.id;
  // ✅ Sync global pointers for all sub-modules (perso, photo, export, etc.)
  try{ window.ROW = ROW; }catch(e){}
  try{ window.currentRec = rec; }catch(e){}
  try{ if(window.grist) window.grist.selectedRecord = rec; }catch(e){}

  if (!MAP.size) {
    await loadFull();
    await buildDomainSectorIndex();
  }

  try { await refreshRight(); } catch (e) { console.error('[RIGHT] refreshRight failed', e); }
  renderList();
  });

window.grist.onRecords(async (records, mappings) => {
  // Signature officielle : (records, mappings)
  // NB: certaines versions de l'API passent aussi (tableId, records). On supporte les deux.
  if (Array.isArray(records) && !Array.isArray(mappings) && mappings && typeof mappings === 'object' && 'id' in mappings && Array.isArray(mappings.id)) {
    // Cas rarissime: (records, mappings) inversé — on ne touche pas.
  }

  // Si on nous appelle avec l'ancienne signature (tableId, records), on corrige ici.
  // Dans ce cas, le 1er paramètre n'est PAS un tableau de records.
  if (!Array.isArray(records) && Array.isArray(mappings)) {
    records = mappings;
    mappings = undefined;
  }

  if (!Array.isArray(records)) return;

  // ✅ CORRECTION : Merger au lieu d'écraser pour conserver les colonnes hors vue
  // Colonnes importantes à TOUJOURS conserver si absentes du nouveau record
  const CRITICAL_COLS = ['Type', 'TR_Type', 'TR_Famille_produit', 'TR_Agents_chimiques_principaux', 'TR_Dangers_CLP', 'TR_EPI_recommandes'];
  
  if(!MAP || MAP.size === 0) {
    // Premier chargement : créer MAP normalement
    MAP = new Map(records.map(r => [Number(r.id), r]));
  } else {
    // Mise à jour : merger intelligemment
    for(const r of records) {
      const rid = Number(r.id);
      const existing = MAP.get(rid);
      if(existing) {
        // Merger : garder les colonnes critiques si absentes du nouveau record
        const merged = {...r};  // Partir du nouveau record
        for(const col of CRITICAL_COLS) {
          if(!(col in r) && (col in existing)) {
            // Si la colonne n'est pas dans le nouveau mais existe dans l'ancien, garder l'ancienne
            merged[col] = existing[col];
          }
        }
        MAP.set(rid, merged);
      } else {
        // Nouveau record
        MAP.set(rid, r);
      }
    }
  }
  
  if (ROW && ROW.id != null) {
    const updated = MAP.get(Number(ROW.id));
    if (updated) ROW = updated;
    // garder aussi les pointeurs window.* cohérents
    try{ window.ROW = ROW; }catch(e){}
    try{ window.currentRec = ROW; }catch(e){}
    try{ if(window.grist) window.grist.selectedRecord = ROW; }catch(e){}
  }

  try { renderList(); } catch (e) { console.error('[LEFT] renderList failed', e); }

  try { buildFichePosteSuggestions(); } catch (e) { console.warn('[FP] suggestions failed', e); }

  if (ADMIN_MODE) {
    try { applyAdminModeUI(); } catch (e) { console.warn('[ADMIN] applyAdminModeUI failed', e); }
  }
});

}


/* ==========================================================
   PATCH TRAVAUX RÉGLEMENTÉS (SAFE)
   - garde le renderer "checkbox + texte"
   - injecte uniquement du CSS (ne surcharge PAS buildTravauxTableBody)
   ========================================================== */
(function(){
  const CSS = `
  /* cellules travaux : rendre checkbox + texte lisibles */
  .trav-cell{ display:flex; align-items:flex-start; gap:8px; padding:10px 12px; line-height:1.25; }
  .trav-cell input[type="checkbox"]{ margin-top:2px; transform:scale(1.05); }
  .trav-cell .trav-txt{ display:block; white-space:normal; color:#0b1220; }

  /* fonds plus doux pour lecture */
  td.trav-col-red{ background:rgba(239,68,68,0.22) !important; }
  td.trav-col-orange{ background:rgba(245,158,11,0.25) !important; }
  td.trav-col-green{ background:rgba(34,197,94,0.22) !important; }

  /* éviter qu'un style global masque les lignes */
  #dlgTravaux table tr{ display:table-row; }
  #dlgTravaux table td, #dlgTravaux table th{ visibility:visible; opacity:1; }
  `;
  if (!document.getElementById('pp-travaux-css')) {
    const st = document.createElement('style');
    st.id = 'pp-travaux-css';
    st.textContent = CSS;
    document.head.appendChild(st);
  }



/* ==========================================================
   FIX OUVERTURE LIGHTBOX TRAVAUX (sans casser les clics Grist)
   - quand dlgTravaux devient visible, on force le build du tbody
   ========================================================== */

})();

(function(){
  const dlg = document.getElementById('dlgTravaux');
  const btn = document.getElementById('tr-choose');
  if(!dlg) return;

  const isOpen = () => (dlg.getAttribute('aria-hidden') === 'false') || (dlg.style.display && dlg.style.display !== 'none') || dlg.classList.contains('open');

  const render = async () => {
    try{
      if (typeof ensureTravauxData === 'function') await ensureTravauxData();
      if (typeof rebuildTravSelectionFromUI === 'function') rebuildTravSelectionFromUI();
      if (typeof buildTravauxTableBody === 'function') buildTravauxTableBody();
      console.log('[TRAVAUX] render ok', {rows: (Array.isArray(travRows)?travRows.length:0), sel: Object.keys(travSelection||{}).length});
    }catch(e){
      console.error('[TRAVAUX] render error', e);
    }
  };

  // 1) Observer d'ouverture (aucun stopPropagation -> ne bloque pas l'app)
  const obs = new MutationObserver(() => { if(isOpen()) setTimeout(render, 0); });
  try{
    obs.observe(dlg, {attributes:true, attributeFilter:['aria-hidden','style','class']});
  }catch(e){}

  // 2) Filet de sécurité sur le bouton "Choisir"
  if(btn){
    btn.addEventListener('click', () => { setTimeout(render, 0); }, {capture:false});
  }
})();






/* ==========================================================
   PATCH A — "Choisir" Travaux : empêcher la navigation Grist
   et forcer l'ouverture de la lightbox
   ========================================================== */
(function(){
  function isTravauxChoisirClick(e){
    const el = e.target.closest('a,button,div,span');
    if(!el) return false;

    // 1) texte "Choisir"
    const txt = (el.textContent || '').trim().toLowerCase();
    if(txt !== 'choisir') return false;

    // 2) on cherche un contexte "travaux réglementés" en remontant plusieurs niveaux
    const norm = (s)=> (s||'')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,''); // retire les accents
    let node = el;
    for(let i=0;i<12 && node;i++){
      const ctx = norm(node.textContent);
      if(ctx.includes('travaux') && (ctx.includes('reglement') || ctx.includes('reglementes'))){
        return true;
      }
      node = node.parentElement;
    }

    // fallback : si le bouton est dans un bloc dont l'id/class mentionne "travaux"
    const attr = norm((el.id||'') + ' ' + (el.className||''));
    if(attr.includes('travaux')) return true;

    return false;
  }

  document.addEventListener('click', function(e){
    if(!isTravauxChoisirClick(e)) return;

    // STOP navigation / STOP handlers concurrents
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();

    // Ouvre la lightbox (peu importe le nom exact dispo)
    if(typeof window.openDlg === 'function') {
      window.openDlg();
      return;
    }
    if(typeof window.openTravauxDialog === 'function') {
      window.openTravauxDialog();
      return;
    }
    if(typeof window.openDLGTravaux === 'function') {
      window.openDLGTravaux();
      return;
    }

    console.warn('[TRAVAUX] Aucun opener trouvé (openDlg/openTravauxDialog/openDLGTravaux).');
  }, true); // capture=true => passe avant les handlers Grist
})();
</script>







<script>
/* ==========================================================
   HARD GUARD OPEN LIGHTBOX TRAVAUX (anti-navigation)
   - garantit que #tr-choose ouvre #dlgTravaux en overlay,
     même si un handler Grist/ancien code tente autre chose.
   - ES5 compatible.
   ========================================================== */
(function(){
  function closestBtn(node){
    while(node){
      if(node.id === 'tr-choose') return node;
      node = node.parentElement;
    }
    return null;
  }
  function openTravaux(){
    // essaie tous les openers connus
    try{
      if(typeof window.openTravauxDialog === 'function') return window.openTravauxDialog();
      if(typeof window.openDlg === 'function') return window.openDlg();
      if(typeof window.openDLGTravaux === 'function') return window.openDLGTravaux();
      if(typeof window.__pp_openTravauxDlg === 'function') return window.__pp_openTravauxDlg();
    }catch(e){}
    // fallback ultra simple : juste afficher le conteneur si déjà construit
    var dlg = document.getElementById('dlgTravaux');
    if(dlg){
      dlg.style.display = 'flex';
      dlg.style.pointerEvents = 'auto';
      dlg.setAttribute('aria-hidden','false');
    }
  }

  // CSS de sécurité (z-index, scroll, centrage)
  if(!document.getElementById('pptr-dlgTravaux-guard-css')){
    var st = document.createElement('style');
    st.id = 'pptr-dlgTravaux-guard-css';
    st.textContent =
      '#dlgTravaux{position:fixed !important; inset:0 !important; z-index:2147483647 !important; ' +
      'display:none; align-items:center !important; justify-content:center !important; }' +
      '#dlgTravaux[aria-hidden="false"]{display:flex !important;}' +
      'html.pptr-modal-open, body.pptr-modal-open{overflow:hidden !important;}' +
      '#dlgTravaux .trav-modal{width:min(1200px,96vw); max-height:92vh; overflow:auto; ' +
      'border-radius:14px; border:1px solid #1b396a; box-shadow:0 20px 45px rgba(15,23,42,.35);}';
    document.head.appendChild(st);
  }

  // Capture globale AVANT tout le monde (et sans dépendre d'initTravauxUi)
  document.addEventListener('click', function(e){
    var btn = closestBtn(e.target);
    if(!btn) return;

    // bloque la navigation (même si un autre handler tente de changer de page)
    try{ e.preventDefault(); }catch(_){}
    try{ e.stopPropagation(); }catch(_){}
    try{ if(e.stopImmediatePropagation) e.stopImmediatePropagation(); }catch(_){}

    // marque le mode modal (bloque le scroll)
    try{ document.documentElement.classList.add('pptr-modal-open'); }catch(_){}
    try{ document.body.classList.add('pptr-modal-open'); }catch(_){}

    openTravaux();
  }, true);

  // Quand on ferme la lightbox, on réactive le scroll
  function unscroll(){
    try{ document.documentElement.classList.remove('pptr-modal-open'); }catch(_){}
    try{ document.body.classList.remove('pptr-modal-open'); }catch(_){}
  }
  document.addEventListener('click', function(e){
    var id = (e.target && e.target.id) ? e.target.id : '';
    if(id === 'trav-close' || id === 'trav-cancel'){
      unscroll();
    }
  }, true);
})();

/* ============================
   PP-TR PATCH v11.46
   - Fix: Travaux modal scroll restore
   - Fix: Export PNG hides dropdowns & tries to inline images to avoid black square
   - Disable: PDF export button removed
   ============================ */
(function(){
  // ---- Travaux modal: preserve/restore page scroll
  function rememberOverflow(){
    try{
      if(window.__pp_prev_overflow === undefined){
        window.__pp_prev_overflow = document.documentElement.style.overflow || '';
        window.__pp_prev_overflow_body = document.body.style.overflow || '';
      }
    }catch(e){}
  }
  function setNoScroll(){
    try{ document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; }catch(e){}
  }
  function restoreScroll(){
    try{
      document.documentElement.style.overflow = (window.__pp_prev_overflow!==undefined?window.__pp_prev_overflow:'');
      document.body.style.overflow = (window.__pp_prev_overflow_body!==undefined?window.__pp_prev_overflow_body:'');
      window.__pp_prev_overflow = undefined;
      window.__pp_prev_overflow_body = undefined;
    }catch(e){}
  }
  // hook if functions exist
  var _openDlg = window.__pp_openTravauxDlg;
  if(typeof _openDlg === 'function'){
    window.__pp_openTravauxDlg = function(){
      rememberOverflow(); setNoScroll();
      return _openDlg.apply(this, arguments);
    };
  }
  var _closeDlg = window.__pp_closeTravauxDlg;
  if(typeof _closeDlg === 'function'){
    window.__pp_closeTravauxDlg = function(){
      try{ var r=_closeDlg.apply(this, arguments); return r; } finally { restoreScroll(); }
    };
  }
  // also restore when clicking overlay buttons, just in case
  document.addEventListener('click', function(ev){
    var id = ev && ev.target && ev.target.id;
    if(id==='trav-close' || id==='trav-cancel' || id==='trav-validate'){ restoreScroll(); }
  }, true);

  // ---- Export PNG: hide dropdown controls & inline images (best effort)
  async function toDataUrlFromImg(img){
    try{
      var src = img.getAttribute('src');
      if(!src) return null;
      if(/^data:/i.test(src)) return src;
      // try fetch -> blob -> dataURL
      var resp = await fetch(src, {mode:'cors', credentials:'omit', cache:'no-cache'});
      if(!resp.ok) return null;
      var blob = await resp.blob();
      return await new Promise(function(resolve){
        var r = new FileReader();
        r.onload = function(){ resolve(r.result); };
        r.onerror = function(){ resolve(null); };
        r.readAsDataURL(blob);
      });
    }catch(e){ return null; }
  }

  function hideSelectLikeControls(root){
    if(!root) return;
    // hide selects
    root.querySelectorAll('select').forEach(function(s){ s.style.display='none'; });
    // hide "— Choisir —" chips/buttons (your UI uses buttons with text)
    root.querySelectorAll('button, .pp-chip, .pp-btn, .fp-select-chip').forEach(function(b){
      var t = (b.textContent||'').trim();
      if(t === '— Choisir —' || t === 'Choisir' || t === '— Choisir' ){ b.style.display='none'; }
    });
  }

  async function exportFichePngClean(){
  // Compat: on exporte la fiche (clone propre) depuis fpWrapper
  try{
    await exportFichePosteSnapshot('png');
  }catch(e){
    console.error('[FP PNG CLEAN]', e);
  }
}
// (bind supprimé volontairement : l’handler officiel est dans initFichePosteDialog)
})();
(function(){
  var btnPdf = document.getElementById('fpExportPDF');
  if(btnPdf){ btnPdf.style.display='none'; btnPdf.setAttribute('disabled','disabled'); }
})();

</script>

<!-- ===== PP-TR CLEAN: pas de lightbox alternative / pas de patchs empilés ===== -->

<script>
/* PATCH v11.62 CLEAR TRAVAUX + ZINDEX (désactivé: gestion native + CSS) */
(function(){
  return;

  const dlg = document.getElementById('dlgClearTravaux');
  const btn = document.getElementById('tr-clear');
  if(!dlg || !btn) return;
  // force top-most
  dlg.style.zIndex = '10000050';
  const open = ()=>{ dlg.classList.add('pptr-open'); try{ if(window.setNoScroll) window.setNoScroll(); }catch(e){} };
  const close= ()=>{ dlg.classList.remove('pptr-open'); try{ if(window.restoreScroll) window.restoreScroll(); }catch(e){} };
  btn.addEventListener('click', (e)=>{ e.preventDefault(); open(); });
  dlg.addEventListener('click', (e)=>{ if(e.target===dlg) close(); });
  const yes = document.getElementById('btnClearTravauxYes');
  const no  = document.getElementById('btnClearTravauxNo');
  if(no) no.addEventListener('click', (e)=>{ e.preventDefault(); close(); });
  if(yes) yes.addEventListener('click', async (e)=>{
    e.preventDefault();
    try{
      // clear UI list
      const wrap = document.getElementById('trListWrap') || document.getElementById('trChips') || document.querySelector('.tr-list');
      if(wrap) wrap.innerHTML = '';
      // clear record fields (best effort)
      if(window.currentRec && window.grist && window.grist.docApi){
        const rid = window.currentRec.id || window.currentRec.rowId;
        if(rid){
          const updates = {};
          if(window.COL_TR_ORANGE) updates[window.COL_TR_ORANGE] = '';
          if(window.COL_TR_RED) updates[window.COL_TR_RED] = '';
          if(window.COL_TR_GREEN) updates[window.COL_TR_GREEN] = '';
          if(window.COL_TMP_TR) updates[window.COL_TMP_TR] = '';
          if(window.COL_TMP_INTI_TR) updates[window.COL_TMP_INTI_TR] = '';
          await window.grist.docApi.applyUserActions([['UpdateRecord', window.TABLE_EQUIP || 'Equipements', rid, updates]]);
        }
      }
    }catch(err){
      console.warn('Clear travaux failed', err);
    } finally{
      close();
    }
  });
})();
</script>

<script>

/* ===== V35 PATCH (DOM moves + clickable QR URL) ===== */
(function(){
  function onReady(fn){
    if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', fn); }
    else { fn(); }
  }

  function setQrClickable(){
    const box = document.getElementById('fpQrBox');
    if(!box) return;
    // If existing code already set dataset.qrUrl, keep it
    const url0 = (box.dataset && box.dataset.qrUrl) ? String(box.dataset.qrUrl) : '';
    if(!url0) return;

    // Ensure rowId est présent (deep-link Grist)
    let url = url0;
    try{
      // Handle URLs with hash query (e.g. .../#?table=...&rowId=12)
      const hasHashQuery = url.includes('#?');
      if(hasHashQuery){
        const [base, hash] = url.split('#?');
        const u = new URL(base, window.location.href);
        const hp = new URLSearchParams(hash);
        const id = hp.get('rowId') || hp.get('recordId');
        if(id){
          if(!hp.get('rowId')) hp.set('rowId', id);
        }
        url = u.toString() + '#?' + hp.toString();
      }else{
        const u = new URL(url, window.location.href);
        const id = u.searchParams.get('rowId') || u.searchParams.get('recordId');
        if(id){
          if(!u.searchParams.get('rowId')) u.searchParams.set('rowId', id);
        }
        url = u.toString();
      }
    }catch(e){ /* leave as-is */ }

    // Make QR box behave as a link (click / keyboard)
    try{
      box.dataset.qrUrl = url;
      box.setAttribute('title', url);
      box.setAttribute('tabindex','0');
      box.setAttribute('role','link');
      const open = (ev) => { try{ ev && ev.preventDefault && ev.preventDefault(); }catch(e){} window.open(url, '_blank', 'noopener,noreferrer'); };
      box.onclick = open;
      box.onkeydown = (ev) => { if(ev && (ev.key==='Enter' || ev.key===' ')) open(ev); };
    }catch(e){}
  }

  function fixHeaderLayout(){
    const dlg = document.querySelector('.fp-dialog');
    const header = document.querySelector('.fp-header');
    const actions = document.querySelector('.fp-actions');
    const qrBox = document.getElementById('fpQrBox');

    if(!header || !actions || !qrBox) return;

    // Remove "Réglage QR" button entirely (not just hidden)
    const b = document.getElementById('fpQrSettings');
    if(b && b.parentNode){ b.parentNode.removeChild(b); }

    // Build right container inside banner
    let right = header.querySelector('.fp-header-right');
    if(!right){
      right = document.createElement('div');
      right.className = 'fp-header-right';
      header.appendChild(right);
    }

    // Move actions + QR box inside banner right area (single plane)
    if(actions.parentNode !== right) right.appendChild(actions);
    if(qrBox.parentNode !== right) right.appendChild(qrBox);

    // Ensure equipment name is left-aligned under label
    const nm = header.querySelector('.fp-equip-name');
    if(nm){
      nm.style.textAlign = 'left';
      nm.style.marginTop = '6px';
    }
  }

  onReady(function(){
    try{ fixHeaderLayout(); }catch(e){}
    // Re-apply when dialog opens / rerenders
    const dlg = document.querySelector('.fp-dialog');
    if(dlg){
      const obs = new MutationObserver(() => {
        try{ fixHeaderLayout(); }catch(e){}
        try{ setQrClickable(); }catch(e){}
      });
      try{ obs.observe(dlg, {subtree:true, childList:true, attributes:true}); }catch(e){}
    }
    try{ setQrClickable(); }catch(e){}
  });
})();

</script>

<script>
/* ========================================================================
   CORRECTIF v14 - VRAIMENT FINAL
   ======================================================================== */
(function(){
  'use strict';
  
  console.log('[CORRECTIF v14] Démarrage...');
  
  // ============================================
  // 1. FIX SCROLL
  // ============================================
  
  function forceScrollUnlock() {
    const html = document.documentElement;
    const body = document.body;
    
    if (html.style.overflow === 'hidden') html.style.overflow = '';
    if (body.style.overflow === 'hidden') body.style.overflow = '';
    
    html.classList.remove('pptr-modal-open');
    body.classList.remove('pptr-modal-open');
  }
  
  setInterval(() => {
    const modal = document.getElementById('dlgTravaux');
    const isOpen = modal && modal.style.display !== 'none' && modal.offsetParent !== null;
    if (!isOpen) forceScrollUnlock();
  }, 200);
  
  const scrollObserver = new MutationObserver(() => {
    const modal = document.getElementById('dlgTravaux');
    const isOpen = modal && modal.style.display !== 'none';
    if (!isOpen) setTimeout(forceScrollUnlock, 100);
  });
  
  scrollObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['style', 'class'] });
  scrollObserver.observe(document.body, { attributes: true, attributeFilter: ['style', 'class'] });
  
  if (window.__pp_closeTravauxDlg) {
    const origClose = window.__pp_closeTravauxDlg;
    window.__pp_closeTravauxDlg = function() {
      const result = origClose.apply(this, arguments);
      setTimeout(forceScrollUnlock, 100);
      setTimeout(forceScrollUnlock, 300);
      setTimeout(forceScrollUnlock, 500);
      return result;
    };
  }
  
  document.addEventListener('click', function(e) {
    const id = e.target && e.target.id;
    if (id === 'trav-close' || id === 'trav-cancel' || id === 'trav-validate') {
      setTimeout(forceScrollUnlock, 100);
      setTimeout(forceScrollUnlock, 300);
      setTimeout(forceScrollUnlock, 500);
      setTimeout(forceScrollUnlock, 1000);
    }
  }, true);
  
  console.log('[CORRECTIF v14] ✅ Fix scroll');
  
  // ============================================
  // 2. FICHE DE POSTE : AFFICHER TYPE EN TEXTE
  // ============================================
  
  const fichePosteObserver = new MutationObserver(() => {
    const dialog = document.getElementById('dlgFichePoste');
    if (!dialog || !dialog.classList.contains('is-open')) return;
    
    if (!window.ROW) return;
    
    const kindCol = window.KIND_COL || 'Type';
    const kindVal = String(window.ROW[kindCol] || 'Equipement').trim();
    
    console.log('[FICHE POSTE v14] Type:', kindVal);
    
    // Trouver le container des radios
    const typeContainer = dialog.querySelector('.type-inline');
    if (typeContainer && !typeContainer.hasAttribute('data-fp-v14')) {
      // REMPLACER LES RADIOS PAR DU TEXTE
      typeContainer.innerHTML = `<strong style="color: #1e40af; font-size: 15px;">${kindVal}</strong>`;
      typeContainer.setAttribute('data-fp-v14', 'true');
      console.log('[FICHE POSTE v14] Radios remplacés par texte:', kindVal);
    }
    
    // Bloquer la PREMIÈRE textarea (nature des travaux)
    const fpTextareas = dialog.querySelectorAll('textarea');
    if (fpTextareas.length > 0) {
      const firstTextarea = fpTextareas[0];
      if (!firstTextarea.hasAttribute('data-fp-locked-v14')) {
        const canEditFP = (window.ADMIN_MODE || window.ADD_MODE_ACTIVE);
        if(!canEditFP){
          firstTextarea.readOnly = true;
          firstTextarea.style.cursor = 'not-allowed';
          firstTextarea.style.opacity = '0.8';
          firstTextarea.style.backgroundColor = '#f3f4f6';
          firstTextarea.style.pointerEvents = 'none';
        }else{
          firstTextarea.readOnly = false;
          firstTextarea.style.cursor = '';
          firstTextarea.style.opacity = '';
          firstTextarea.style.backgroundColor = '';
          firstTextarea.style.pointerEvents = '';
        }
        firstTextarea.setAttribute('data-fp-locked-v14', 'true');
        console.log('[FICHE POSTE v14] Nature travaux', canEditFP ? 'editable' : 'locked');
      }
    }
  });
  
  fichePosteObserver.observe(document.body, { 
    childList: true, 
    subtree: true, 
    attributes: true, 
    attributeFilter: ['class'] 
  });
  
  console.log('[CORRECTIF v14] ✅ Observer fiche de poste');
  
  // ============================================
  // 3. TITRE ENCART PRODUIT
  // ============================================
  
  setTimeout(() => {
    const blockTitle = document.querySelector('.dreets-overlap-block .block-title');
    if (blockTitle && !blockTitle.textContent.includes('À compléter')) {
      const currentText = blockTitle.textContent;
      blockTitle.innerHTML = `
        ${currentText}
        <span style="color: #db2777; font-weight: 700; margin-left: 10px; font-size: 0.9em;">
          (À compléter par la DREETS)
        </span>
      `;
    }
  }, 1000);
  
  console.log('[CORRECTIF v14] ✅ Installation terminée');
})();
</script>

</body>

</html>
