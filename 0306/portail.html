<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portail pr√©vention PACA</title>

  <!-- CSS commun + CSS portail -->
  <link rel="stylesheet" href="../css/pp-core.css" />
  <link rel="stylesheet" href="../css/pp-portail.css" />

  <!-- Config (routes + Supabase) -->
  <script src="../js/pp-config.js"></script>

  <style>
    /* Ajout : bouton Tableau de bord pouss√© √† gauche dans le footer de la card */
    .ppaca-card-footer { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .ppaca-btn-dashboard { margin-right:auto; }
  </style>

  <script>
  // D√©tection fiable : on est dans un widget Grist (iframe) ?
  function isInGristWidget() {
    try {
      return !!(window.grist && window.grist.docApi && window.parent !== window);
    } catch (e) {
      return false;
    }
  }

  /* ==========================================================
     PP_DATA_LAYER (GitHub Pages + Grist)
     - Dans Grist : grist.docApi.fetchTable
     - Sur GitHub : Supabase Edge Function read-app (via ppAPI.read)
     ========================================================== */
  (function(){
    // APP Grist/Supabase √† utiliser (registre -> Apps)
    // üëâ Par d√©faut on suit le pp-config : "equipements"
    const APP = (window.PP_APP_DEFAULT || "equipements");

    function rowsToGristTableFromRecords(records){
      // records = [{id, fields:{...}}, ...] (format Grist REST)
      const ids = [];
      const cols = new Set();
      for (const r of (records||[])) {
        ids.push(r.id);
        const f = (r && r.fields) ? r.fields : {};
        Object.keys(f).forEach(k => cols.add(k));
      }
      const table = { id: ids };
      for (const c of cols) table[c] = [];
      for (const r of (records||[])) {
        const f = (r && r.fields) ? r.fields : {};
        for (const c of cols) table[c].push(f[c]);
      }
      return table;
    }

    async function sbFetchTable(tableName){
      // read-app?app=...&table=...
      const data = await window.ppAPI.read(APP, { table: tableName });

      // Cas 1 : d√©j√† un tableau "table" au format {id:[...], Col:[...]}
      if (data.table && data.table.id) return data.table;

      // Cas 2 : records Grist REST
      if (Array.isArray(data.records)) return rowsToGristTableFromRecords(data.records);

      // Cas 3 : items simplifi√©s (Liste_des_equipements) => on reconstruit
      if (Array.isArray(data.items)) {
        const ids = data.items.map(x => x.id);
        return { id: ids, label: data.items.map(x=>x.label), Type: data.items.map(x=>x.Type) };
      }

      throw new Error(data.error || "R√©ponse read-app inattendue");
    }

    window.PP_IS_GRIST = isInGristWidget() && (window.grist && window.grist.docApi && typeof window.grist.docApi.fetchTable === "function");

    window.PP_fetchTable = async function(tableName){
      if (window.PP_IS_GRIST) return window.grist.docApi.fetchTable(tableName);
      return sbFetchTable(tableName);
    };
  })();
  </script>
</head>

<body>
<div class="page-wrap">
  <div id="header-container"></div>

  <!-- ===== CARTOUCHE PPP (texte d‚Äôintro) ===== -->
  <section class="ppaca-section">
    <div class="ppaca-card">
      <div class="ppaca-card-header">
        <div class="ppaca-avatar">PPP</div>
        <div>
          <h2 class="ppaca-card-title">Portail Pr√©vention PACA ‚Äì Accueil</h2>
          <p class="ppaca-card-subtitle"></p>
        </div>
      </div>

      <div class="ppaca-card-body">
        <p>
          Le portail Pr√©vention PACA est la version num√©rique, enrichie
          et collaborative du Guide de pr√©vention PACA.
          <strong>Guide de pr√©vention</strong> co-√©dit√© par la DREETS PACA,
          la R√©gion acad√©mique Provence‚ÄìAlpes‚ÄìC√¥te d‚ÄôAzur avec le soutien du CFA acad√©mique de Nice.
        </p>

        <p>
          Il donne acc√®s au guide, aux ressources de pr√©vention, √† la base r√©gionale des √©quipements
          et travaux r√©glement√©s. Les directeurs d√©l√©gu√©s peuvent enrichir la base, associer leurs
          dipl√¥mes et g√©n√©rer le formulaire de demande de d√©rogation, des fiches de poste et des formulaires
          d‚Äôavis m√©dicaux par dipl√¥me.
        </p>

        <div class="ppaca-card-footer">
          <a href="../0306/tableaubord.html"
             class="ppaca-btn-secondary ppaca-btn-dashboard"
             target="_top" rel="noopener">Tableau de bord</a>

          <a href="../0306/savoirplus.html"
             class="ppaca-btn-secondary"
             target="_top" rel="noopener">En savoir plus</a>

          <a href="../guide_iframe.html?src=https%3A%2F%2Fdocs.getgrist.com%2FgvPEJV3qAHS9%2FEquipements-de-travail-et-produits%2Fp%2F102%3Fembed%3Dtrue%26style%3DsinglePage%26exclude-headers%3Dtrue"
             class="ppaca-btn-secondary ppaca-btn-secondary--ghost"
             target="_top" rel="noopener">Sch√©ma fonctionnel</a>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== CADRE ORANGE + TUILES ===== -->
  <section class="tile-frame">
    <main id="tileGrid" class="tile-grid"></main>
  </section>
</div>

<script src="../js/pp-header.js"></script>

<script>
  const PAGE_NAME = "Portail";

  const PORTAL_ROOT = (window.PP_SITE_BASE || "https://preventionpaca.github.io/guide/");

  const WRAPPER_BASE   = PORTAL_ROOT + "guide_iframe.html?src=";
  const WRAPPER_MARKER = "guide_iframe.html";

  // mapping Grist -> route interne (pages cl√©s)
  const GRIST_KEY_ROUTES = [
    { match: "/p/59",  to: (window.PP_LINKS && window.PP_LINKS.home) ? window.PP_LINKS.home : (PORTAL_ROOT + "#home") },
    { match: "/p/119", to: (window.PP_LINKS && window.PP_LINKS.base) ? window.PP_LINKS.base : (PORTAL_ROOT + "#base") },
    { match: "/p/67",  to: (window.PP_LINKS && window.PP_LINKS.avism) ? window.PP_LINKS.avism : (PORTAL_ROOT + "#avism") },
    { match: "/p/141", to: (window.PP_LINKS && window.PP_LINKS.avisp) ? window.PP_LINKS.avisp : (PORTAL_ROOT + "#avisp") }
  ];

  function rowsToRecordsCompat(table) {
    // Accepte {id:[...], Col:[...]} ou {id:[...], fields:{Col:[...]}}
    const ids = table.id || [];
    const records = [];

    let columnArrays = {};
    if (table.fields && typeof table.fields === "object") {
      columnArrays = table.fields;
    } else {
      for (const [key, value] of Object.entries(table)) {
        if (key === "id") continue;
        if (Array.isArray(value)) columnArrays[key] = value;
      }
    }

    for (let i = 0; i < ids.length; i++) {
      const rec = { id: ids[i] };
      for (const [col, values] of Object.entries(columnArrays)) rec[col] = values[i];
      records.push(rec);
    }
    return records;
  }

  function normalizeName(v) {
    if (!v) return "";
    let s = String(v).trim().toLowerCase();
    try { s = s.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); } catch (e) {}
    s = s.replace(/[_\s]+/g, " ").replace(/\s+/g, " ");
    return s;
  }

  function colorToClass(c) {
    if (!c) return "";
    const v = String(c).toLowerCase();
    if (v.includes("blanc"))        return "tile--white";
    if (v.includes("vert"))         return "tile--green";
    if (v.includes("orange"))       return "tile--orange";
    if (v.includes("noir"))         return "tile--dark";
    if (v.includes("marron clair")) return "tile--brown-light";
    if (v.includes("marron fon"))   return "tile--brown-dark";
    if (v.includes("gris"))         return "tile--gray-light";
    return "";
  }

  function truncate(str, n) {
    const s = String(str || "");
    return s.length > n ? s.slice(0, n - 1) + "‚Ä¶" : s;
  }

  function normalizeUrl(url) {
    if (!url) return "";
    const u = String(url).trim();
    if (!u) return "";
    if (/^https?:\/\//i.test(u)) return u;
    return "https://" + u;
  }

  function decodeMany(s, max) {
    let out = String(s || "");
    for (let i = 0; i < (max || 6); i++) {
      try {
        const d = decodeURIComponent(out);
        if (d === out) break;
        out = d;
      } catch (e) { break; }
    }
    return out;
  }

  function makeWrapperUrl(url) {
    const raw = String(url || "").trim();
    if (!raw) return "";

    // ‚úÖ IMPORTANT : si on a des liens du type /guide/0306/#avisp -> on les renvoie vers /guide/#avisp (routeur index)
    if (raw.includes("/guide/0306/#")) {
      return raw.replace("/guide/0306/#", "/guide/#");
    }

    // Si d√©j√† un hash route du site
    if (raw.startsWith(PORTAL_ROOT + "#")) return raw;

    // Normalisation
    let u = normalizeUrl(raw);
    if (!u) return "";

    // Si wrapper, on extrait la cible
    if (u.includes(WRAPPER_MARKER)) {
      try {
        const uu = new URL(u);
        const src = uu.searchParams.get("src");
        if (src) {
          const decoded = decodeMany(src, 10);
          if (/^https?:\/\//i.test(decoded)) u = decoded;
        } else if (uu.hash && uu.hash.length > 1) {
          const decoded = decodeMany(uu.hash.slice(1), 8);
          if (/^https?:\/\//i.test(decoded)) u = decoded;
        }
      } catch (e) {}
    }

    // Externe non Grist : tel quel
    if (!u.includes("docs.getgrist.com")) return u;

    // Pages cl√©s : routes internes
    for (const r of GRIST_KEY_ROUTES) {
      if (u.includes(r.match)) return r.to;
    }

    // Sinon : wrapper ?src=
    return WRAPPER_BASE + encodeURIComponent(u);
  }

  function navigateTop(url) {
    if (!url) return;
    try { window.top.location.href = url; return; } catch(e) {}
    try { window.open(url, "_top"); return; } catch(e) {}
    window.location.href = url;
  }

  function sortHistoriqueRows(rows) {
    return rows.slice().sort((a, b) => {
      const da = a.Date_heure ? new Date(a.Date_heure).getTime() : NaN;
      const db = b.Date_heure ? new Date(b.Date_heure).getTime() : NaN;
      if (!isNaN(da) && !isNaN(db)) return db - da;
      const ia = typeof a.id === "number" ? a.id : 0;
      const ib = typeof b.id === "number" ? b.id : 0;
      return ib - ia;
    });
  }

  function buildTiles(blocsRowsAll, filInfoRows, histRows, layoutRow) {
    const grid = document.getElementById("tileGrid");
    grid.innerHTML = "";

    const layoutCols = layoutRow && layoutRow.Nbre_colonne ? (Number(layoutRow.Nbre_colonne) || 4) : 4;
    const maxBlocks  = layoutRow && layoutRow.Nbre_Bloc    ? (Number(layoutRow.Nbre_Bloc) || blocsRowsAll.length) : blocsRowsAll.length;

    if (!blocsRowsAll.length) {
      const msg = document.createElement("div");
      msg.style.gridColumn = "1 / -1";
      msg.style.padding = "12px 16px";
      msg.style.borderRadius = "12px";
      msg.style.background = "rgba(220, 38, 38, 0.12)";
      msg.style.border = "1px solid rgba(248, 113, 113, 0.4)";
      msg.style.fontSize = "0.8rem";
      msg.textContent = `Aucun bloc trouv√© pour la page "${PAGE_NAME}". V√©rifie la colonne "Page" dans la table "Blocs".`;
      grid.appendChild(msg);
      return;
    }

    const blocsRows = blocsRowsAll.slice()
      .sort((a, b) => (a.num_bloc || 0) - (b.num_bloc || 0))
      .slice(0, maxBlocks);

    document.documentElement.style.setProperty("--grid-columns", Math.min(layoutCols, blocsRows.length || layoutCols));

    const cols = layoutCols;
    const counts = {};
    blocsRows.forEach(b => { const t = b.Titre_bloc || ""; counts[t] = (counts[t] || 0) + 1; });
    const duplicates = new Set(Object.keys(counts).filter(t => counts[t] > 1));
    const already = new Set();
    const newsNorm = normalizeName("Fil info");

    const byTitle = {};
    blocsRows.forEach(b => { const t = b.Titre_bloc || ""; (byTitle[t] ||= []).push(b); });

    blocsRows.forEach(bloc => {
      const title = bloc.Titre_bloc || "";
      const dup = duplicates.has(title);
      if (dup) { if (already.has(title)) return; already.add(title); }

      const tile = document.createElement("div");
      tile.className = "tile";
      const colorClass = colorToClass(bloc.Couleur);
      if (colorClass) tile.classList.add(colorClass);

      if (dup && byTitle[title].length === 2) {
        const [b1, b2] = byTitle[title].sort((x, y) => x.num_bloc - y.num_bloc);
        const pos1 = (b1.num_bloc || 1) - 1, pos2 = (b2.num_bloc || 1) - 1;
        const r1 = Math.floor(pos1 / cols), c1 = pos1 % cols;
        const r2 = Math.floor(pos2 / cols), c2 = pos2 % cols;
        if (normalizeName(title) === newsNorm) tile.classList.add("tile--tall");
        else if (r1 === r2 && Math.abs(c1 - c2) === 1) tile.classList.add("tile--wide");
        else if (c1 === c2 && Math.abs(r1 - r2) === 1) tile.classList.add("tile--tall");
      }

      const icon = document.createElement("div");
      icon.className = "tile-icon";
      icon.textContent = bloc.Initiale_bloc || "";
      tile.appendChild(icon);

      const main = document.createElement("div");
      main.className = "tile-main";
      tile.appendChild(main);

      const titleEl = document.createElement("div");
      titleEl.className = "tile-title";
      titleEl.textContent = title || "(sans titre)";
      main.appendChild(titleEl);

      const descEl = document.createElement("div");
      descEl.className = "tile-desc";
      descEl.textContent = bloc.Sous_titre1 || "";
      main.appendChild(descEl);

      const isNews = normalizeName(title) === newsNorm;

      if (isNews) {
        const hasAny = (filInfoRows && filInfoRows.length) || (histRows && histRows.length);
        if (!hasAny) {
          const msg = document.createElement("div");
          msg.style.fontSize = "0.8rem";
          msg.style.opacity = "0.7";
          msg.textContent = "Aucune information √† afficher pour le moment.";
          main.appendChild(msg);
        } else {
          tile.style.cursor = "default";
          const viewport = document.createElement("div");
          viewport.className = "news-viewport";
          const track = document.createElement("div");
          track.className = "news-track";
          viewport.appendChild(track);

          const makeItemFilInfo = row => {
            const a = document.createElement("a");
            a.className = "news-item";
            const t  = row.Titre || "";
            const st = row.Sous_titre || "";
            const c  = truncate(row.Contenu || "", 20);
            a.textContent = `${t} ‚Äî ${st} : ${c}`;
            const url = makeWrapperUrl(row.Lien);
            a.href = url || "#";
            a.target = "_top";
            return a;
          };

          const filItems = (filInfoRows || []).map(makeItemFilInfo);
          const histItems = (histRows || []).map(row => {
            const div = document.createElement("div");
            div.className = "news-item";
            div.textContent = truncate((row.Details || row.DETAILS || ""), 80);
            return div;
          });

          const baseItems = [...filItems, ...histItems];
          const effectiveBase = baseItems.length ? baseItems : [(() => {
            const d = document.createElement("div");
            d.className = "news-item";
            d.textContent = "Aucune information √† afficher pour le moment.";
            return d;
          })()];

          const TARGET_COUNT = 20;
          for (let i = 0; i < TARGET_COUNT; i++) track.appendChild(effectiveBase[i % effectiveBase.length].cloneNode(true));
          main.appendChild(viewport);
        }
      } else {
        const sousG = bloc.Sous_titre_G;
        const sousD = bloc.Sous_titre_D;

        if (sousG || sousD) {
          const bottom = document.createElement("div");
          bottom.className = "tile-bottom-links";

          if (sousG) {
            const aG = document.createElement("a");
            aG.className = "tile-link";
            aG.textContent = sousG;
            const urlG = makeWrapperUrl(bloc.Url_G);
            aG.href = urlG || "#";
            aG.target = "_top";
            bottom.appendChild(aG);
          }

          if (sousD) {
            const aD = document.createElement("a");
            aD.className = "tile-link";
            aD.textContent = sousD;
            const urlD = makeWrapperUrl(bloc.Url_D);
            aD.href = urlD || "#";
            aD.target = "_top";
            bottom.appendChild(aD);
          }
          main.appendChild(bottom);
        } else if (bloc.Url_bloc) {
          const urlBloc = makeWrapperUrl(bloc.Url_bloc);
          tile.addEventListener("click", () => urlBloc && navigateTop(urlBloc));
          tile.tabIndex = 0;
          tile.setAttribute("role", "link");
          tile.addEventListener("keypress", e => {
            if ((e.key === "Enter" || e.key === " ") && urlBloc) { e.preventDefault(); navigateTop(urlBloc); }
          });
        }
      }

      grid.appendChild(tile);
    });
  }

  async function loadTiles() {
    const [tAgenc, tBlocs, tFil] = await Promise.all([
      PP_fetchTable("Agencement_portail"),
      PP_fetchTable("Blocs"),
      PP_fetchTable("Fil_info")
    ]);

    let tHist = null;
    try { tHist = await PP_fetchTable("Historique_equipements"); } catch(e) {}

    const agRows = rowsToRecordsCompat(tAgenc);
    const blocsAll = rowsToRecordsCompat(tBlocs);
    const filInfo = rowsToRecordsCompat(tFil);
    const histAll = tHist ? rowsToRecordsCompat(tHist) : [];
    const histLast10 = sortHistoriqueRows(histAll).slice(0,10);

    const currentNorm = normalizeName(PAGE_NAME);
    let agencementName = PAGE_NAME;
    if (currentNorm === normalizeName("Portail")) agencementName = "Accueil";
    else if (currentNorm === normalizeName("Acces_Admin")) agencementName = "Acc√®s Admin";
    else if (currentNorm === normalizeName("Acces_DDFPT")) agencementName = "Acc√®s DDFPT";

    const layoutRow = agRows.find(r => normalizeName(r.Page) === normalizeName(agencementName)) || agRows[0] || null;
    const blocsRowsAll = blocsAll.filter(b => normalizeName(b.Page) === normalizeName(PAGE_NAME));

    buildTiles(blocsRowsAll, filInfo, histLast10, layoutRow);
  }

  document.addEventListener("DOMContentLoaded", () => {
    // En GitHub Pages : pas de grist.ready()
    // En widget Grist : ok, mais optionnel pour fetchTable
    if (window.PP_IS_GRIST && window.grist && window.grist.ready) {
      try { window.grist.ready(); } catch(e) {}
    }
    loadTiles().catch(err => console.error("Erreur chargement tuiles", err));
  });
</script>

</body>
</html>
