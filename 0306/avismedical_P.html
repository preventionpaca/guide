<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avis m√©dical ‚Äì Travaux r√©glement√©s</title>

  <!-- App + Supabase -->
  <script>window.PP_APP_NAME = "equipements";</script>
<link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-core.css">
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-portail.css">
  <!-- CSS commun portail + CSS sp√©cifique avis m√©dical -->
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-core.css" />
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-avis.css" />

<script>
(function(){
const DEFAULT_SB = "https://hpiqwvwpxzppxpxhjede.supabase.co";
const sbBase = (window.PP_SUPABASE_URL || DEFAULT_SB).replace(/\/+$/,'');
const SB_ROOT = sbBase + "/functions/v1";
window.PP_SB_ROOT = SB_ROOT;
window.PP_SB_API_READ  = SB_ROOT + "/read-app";
window.PP_SB_API_AUTH  = SB_ROOT + "/auth-code";
window.PP_SB_API_WRITE = SB_ROOT + "/write-app";
function getAppName(){ return (window.PP_APP_DEFAULT || window.PP_APP_NAME || "equipements"); }
function getToken(){
  try {
    const st = (window.PP_AUTH && typeof window.PP_AUTH.get === "function") ? window.PP_AUTH.get() : null;
    return (st && st.token) ? String(st.token) : (localStorage.getItem("pp_token") || "");
  } catch(e) { return (localStorage.getItem("pp_token") || ""); }
}
function rowsToTable(rows){
  if(!Array.isArray(rows) || !rows.length) return {id:[]};
  const cols = new Set();
  for(const r of rows) Object.keys(r||{}).forEach(k=>cols.add(k));
  cols.delete('id');
  const t={id:[]};
  for(const c of cols) t[c]=[];
  for(const r of rows){ t.id.push(r.id); for(const c of cols) t[c].push(r[c]); }
  return t;
}
async function sbFetchTable(tableName){
  const url1 = window.PP_SB_API_READ + "?app=" + encodeURIComponent(getAppName()) + "&table=" + encodeURIComponent(tableName);
  let r = await fetch(url1, {credentials:'omit', headers: (getToken()? {Authorization: 'Bearer ' + getToken()} : {})});
  let j = await r.json().catch(()=>null);
  if(j && j.ok){
    if (Array.isArray(j.records)) {
      const rows = j.records.map(r => ({ id: r.id, ...(r.fields || {}) }));
      return rowsToTable(rows);
    }
    if(j.table) return j.table;
    if(Array.isArray(j.rows)) return rowsToTable(j.rows);
    if(j.tables && j.tables[tableName]) return j.tables[tableName];
  }
  const url2 = window.PP_SB_API_READ + "?app=" + encodeURIComponent(getAppName());
  r = await fetch(url2, {credentials:'omit', headers: (getToken()? {Authorization: 'Bearer ' + getToken()} : {})});
  j = await r.json().catch(()=>null);
  if(j && j.ok && j.tables && j.tables[tableName]) return j.tables[tableName];
  throw new Error(j?.error || "Lecture Supabase impossible");
}
window.PP_fetchTable = async function(tableName){
  return sbFetchTable(tableName);
};
})();
</script>

  <style>
  

    /* ===== IMPRESSION : FORCER UN VERSO (PAGE 2) ===== */
    @media print {
      .page-break {
        break-before: page;
        page-break-before: always;
      }
    }

    /* ===== VERSO ===== */
    .verso {
      margin-top: 10px;
      font-size: 11px;
      line-height: 1.18;
    }
    .verso h2 {
      margin: 0 0 6px;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .verso-meta {
      font-size: 11px;
      color: #111827;
      margin: 0 0 8px;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f8fafc;
    }
    .verso-meta strong { color: #0b2238; }
    .trav-card {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 6px 8px;
      margin: 6px 0;
      background: #ffffff;
      page-break-inside: avoid;
    }
    .trav-title {
      font-weight: 700;
      margin-bottom: 4px;
      color: #0b2238;
      font-size: 12px;
    }
    .equip-list {
      margin: 0;
      padding-left: 16px;
    }
    .equip-list li {
      margin: 0;
      padding: 0;
      line-height: 1.15;
    }
    /* 2 colonnes seulement quand la liste est longue */
    .equip-list.two-cols {
      column-count: 2;
      column-gap: 18px;
    }
    .equip-empty {
      margin: 0;
      color: #6b7280;
      font-size: 11px;
    }
    .doc-edited {
      margin-top: 14px;
      font-size: 12px;
      color: #374151;
      text-align: right;
    }

  </style>
</head>

<body>
<div class="page-wrap">

  <!-- ===== CONTENU AVIS M√âDICAL ===== -->
  <main class="pp-main">

    <div id="header-container"></div>
    <div class="wrapper">

      <!-- RECHERCHE (dipl√¥me + √©tablissement) ‚Äì non imprim√©e -->
      <div class="search-card non-printable">
        <h3>Recherche</h3>
        <div class="non-printable" style="margin:6px 0 10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button type="button" id="pp-reconnect-btn" class="export-btn" style="padding:6px 10px; font-size:13px;">Reconnexion √©tablissement</button>
          <button type="button" id="pp-change-etab-btn" class="export-btn" style="padding:6px 10px; font-size:13px;">Changer d‚Äô√©tablissement</button>
        </div>
        <p>
          1. Choisissez une <strong>formation</strong> (dipl√¥me).<br>
          2. Choisissez un <strong>√©tablissement</strong>.<br>
          Ces choix alimentent automatiquement le formulaire ci-dessous.
        </p>

        <div class="field-block">
          <label for="diplome-input">Recherche de dipl√¥me</label>
          <input
            id="diplome-input"
            class="search-input"
            type="text"
            placeholder="Ex. : Bac pro syst√®mes num√©riques‚Ä¶"
            autocomplete="off"
          />
          <div id="diplome-dropdown" class="dropdown"></div>
        </div>

        <div class="field-block">
          <label for="etab-input">Recherche d'√©tablissement</label>
          <input
            id="etab-input"
            class="search-input"
            type="text"
            placeholder="Ex. : Lyc√©e Les Eucalyptus‚Ä¶"
            autocomplete="off"
          />
          <div id="etab-dropdown" class="dropdown"></div>
        </div>
      </div>

      <!-- EN-T√äTE AVIS M√âDICAL -->
      <table class="header-table" style="width: 100%; margin-bottom: 4px;">
        <tr>
          <td style="width: 30%;">
            <img src="https://static.wixstatic.com/media/b708d4_8534e9250eab4f72aa6294d167e58a23~mv2.png/v1/fill/w_600,h_385,al_c,q_85,usm_1.20_1.00_0.01,enc_auto/b708d4_8534e9250eab4f72aa6294d167e58a23~mv2.png"
                 alt="logo" style="width: 160px; height: auto;" />
          </td>
          <td>
            <h2>AVIS M√âDICAL D'APTITUDE AUX TRAVAUX R√âGLEMENT√âS</h2>
            <p class="header-subtitle">pour les jeunes √¢g√©s de 15 √† 18 ans</p>
          </td>
        </tr>
      </table>

      <!-- ETABLISSEMENT + R√âF√âRENCES JURIDIQUES SUR UNE LIGNE -->
      <div class="header-info-row">
        <div id="etab-text" class="etab-text">
          <!-- Contenu rempli dynamiquement -->
        </div>
        <div class="legal-box">
          <ul>
            <li>D√©cret n¬∞2015-443 du 17 avril 2015 relatif √† la proc√©dure de d√©rogation pr√©vue √† l‚Äôarticle L4153-9 du code du travail.</li>
            <li>D√©cret n¬∞2013-915 du 11 octobre 2013 relatif aux travaux interdits et r√©glement√©s pour les jeunes de moins de 18 ans.</li>
            <li>D√©cret n¬∞2015-444 du 17 avril 2015 modifiant les articles D 4153-30 et D 4153-31 du code du travail.</li>
            <li>Instruction interminist√©rielle n¬∞2016-273 du 7 septembre 2016.</li>
          </ul>
        </div>
      </div>

      <hr style="margin-top: 15px;"/>

      <!-- IDENTIT√â DU JEUNE + FORMATION -->
      <table style="width: 100%; margin-bottom: 10px;">
        <tr>
          <td><strong>Nom :</strong></td>
          <td><input type="text" class="field"></td>
        </tr>
        <tr>
          <td><strong>Pr√©nom :</strong></td>
          <td><input type="text" class="field"></td>
        </tr>
        <tr>
          <td><strong>Date de naissance :</strong></td>
          <td><input type="text" placeholder="JJ/MM/AAAA" class="field"></td>
        </tr>
        <tr>
          <td><strong>Formation :</strong></td>
          <td>
            <div class="field">
              <strong><span id="formation-text"></span></strong>
            </div>
          </td>
        </tr>
      </table>

      <!-- TRAVAUX R√âGLEMENT√âS -->
      <h3 style="margin-top: 20px;"><u>Liste des travaux r√©glement√©s :</u></h3>
      <ul id="travaux-list"></ul>

      <!-- AVIS M√âDICAL + DATE + CACHETS SUR UN BLOC COMMUN -->
      <div class="avoid-break">
        <!-- En-t√™te : Avis m√©dical + Date -->
        <div class="avis-header">
          <h3 class="avis-title"><u>Avis m√©dical</u></h3>

          <div class="avis-date">
            <strong>Date :</strong>
            <span class="tat-wrapper">
              <input id="tat-input" type="text" class="tat-input" placeholder="JJ/MM/AAAA">
              <button
                type="button"
                id="tat-today-btn"
                class="tat-btn non-printable"
                title="Ins√©rer la date du jour"
              >
                üìÖ
              </button>
            </span>
          </div>
        </div>

        <!-- Choix d'avis -->
        <form class="avis-medical-container">
          <input type="radio" id="avis1" name="avis_medical">
          <input type="radio" id="avis2" name="avis_medical">
          <input type="radio" id="avis3" name="avis_medical">

          <div class="avis-choix">
            <label for="avis1">Aptitude avec r√©serves</label>
            <label for="avis2">Inaptitude</label>
            <label for="avis3">Aptitude sans r√©serve</label>
          </div>

          <div class="avis1">
            <div class="avis-bloc">
              <label><strong>Aptitude avec r√©serves :</strong></label>
              <input type="text" placeholder="D√©tail des r√©serves">
            </div>
          </div>

          <div class="avis2">
            <div class="avis-bloc">
              <label><strong>Inaptitude :</strong></label>
              <input type="text" placeholder="Motif d'inaptitude">
            </div>
          </div>

          <div class="avis3">
            <div class="avis-bloc">
              <label><strong>Aptitude sans r√©serve</strong></label>
            </div>
          </div>

          <div class="non-printable" style="margin-top: 10px;">
            <button type="reset" style="padding: 6px 12px; font-size: 14px; cursor: pointer;">
              R√©initialiser
            </button>
          </div>
        </form>

        <!-- CACHETS -->
        <table class="cachets-table" style="width: 100%; font-size: 12px;">
          <tr>
            <td style="width: 48%;">
              <strong>Cachet + signature du m√©decin :</strong>
              <div style="border: 2px dashed #999; height: 110px; margin-top: 5px;"></div>
            </td>
            <td style="width: 4%;"></td>
            <td style="width: 48%;">
              <strong>Cachet + signature du Proviseur de l'√©tablissement :</strong>
              <div style="border: 2px dashed #999; height: 110px; margin-top: 5px;"></div>
            </td>
          </tr>
        </table>
      </div>

      <!-- BOUTON EXPORT PDF ‚Äì non imprim√© -->
      <div class="non-printable" style="text-align: right;">
        <button id="export-pdf-btn" class="export-btn">Exporter en PDF</button>
      </div>

    

      <!-- ===== VERSO (PAGE 2) : TRAVAUX + EQUIPEMENTS/PRODUITS ===== -->
      <div class="page-break"></div>
      <section class="verso">
        <h2>ANNEXE ‚Äì D√©tail des travaux r√©glement√©s et √©quipements associ√©s</h2>
        <div class="verso-meta">
          <div><strong>√âtablissement :</strong> <span id="verso-etab"></span></div>
          <div><strong>Formation :</strong> <span id="verso-formation"></span></div>
        </div>

        <div id="verso-content"></div>

        <div class="doc-edited">Document √©dit√© le <span id="doc-edited-date"></span></div>
      </section>

    </div><!-- /.wrapper -->

  </main>
</div><!-- /.page-wrap -->


</div>

<!-- ================== SCRIPTS + LOGIQUE FORMULAIRE ================== -->
<script>
  // -----------------------------
  // CONSTANTES DONN√âES
  // -----------------------------
  const COLUMN_CONCAT = "Concatenation";          // Diplomes_EN_OK
  const TABLE_DIPLOMES   = "Diplomes_EN_OK";        // table utilis√©e  (GitHub)

  const TABLE_TRAVAUX      = "Liste_des_equipements";
  const COL_TRAV_DIPLOME   = "Tampon_Diplomes";            // texte, liste de dipl√¥mes s√©par√©s par ;

  // Source des libell√©s de travaux (OK)
  const COL_TRAV_LIBELLE   = "Tampon_Travaux";
  const COL_TRAV_CODES    = "Tampon_intitule_travaux";  // ex: "22|red;31|orange"
  const COL_TRAV_ETAB     = "Tampon_Etab"; // ‚úÖ rattachement √©tablissement (colonne verrouill√©e)

  const TABLE_ETAB         = "Etablissements_edi";

  // Pistes de noms pour les colonnes √©tablissements
  const HINT_ETAB_NOM       = "appellation_officielle";
  const HINT_ETAB_ADR1      = "Adresse";
  const HINT_ETAB_CP        = "Code_postal";
  const HINT_ETAB_VILLE     = "Ville";
  const HINT_ETAB_MAIL      = "email_etab";
  const HINT_ETAB_CODE      = "Codepaca";   // colonne de code √©tablissement (Codepaca / UAI / etc.)
  const HINT_ETAB_DIPLOMES  = "Diplomes";   // colonne listant les dipl√¥mes affect√©s √† l'√©tablissement

  // -----------------------------
  // VARIABLES GLOBALES
  // -----------------------------
  let allDiplomes = [];
  // Dans cette variante, on filtre par diplome ET par etablissement (code)
  let travauxByDiplomeEtab = {}; // { diplomeNorm: { etabCodeNorm: [travaux...] } }
  let equipByDiplomeEtabTrav = {}; // { diplomeNorm: { etabCodeNorm: { travailLabel: Set(equipements) } } }
  let etablissements = [];
  let auxTablesLoaded = false;

  // map ID de dipl√¥me -> libell√© Concatenation (au cas o√π)
  let diplomaIdToLabel = {};

  let colEtabNom       = null;
  let colEtabAdr1      = null;
  let colEtabCP        = null;
  let colEtabVille     = null;
  let colEtabMail      = null;
  let colEtabCode      = null;
  let colEtabDiplomes  = null;

  // key = code √©tablissement normalis√©, value = Set de libell√©s de dipl√¥mes (texte)
  let diplomeByEtabCode = {};
  let selectedEtabCodeNorm = null;  // code √©tablissement normalis√© choisi via lightbox
  let selectedEtabNameNorm = null;  // nom √©tablissement normalis√© (pour Tampon_Etab)
  let selectedEtabNameLoose = null; // nom √©tablissement normalis√© sans ponctuation

  let codeAttempts = 0;
  let etabsLoaded = false;

  const inputDiplome   = document.getElementById("diplome-input");
  const dropDiplome    = document.getElementById("diplome-dropdown");
  const formationText  = document.getElementById("formation-text");
  const travauxListEl  = document.getElementById("travaux-list");

  // ===== VERSO =====
  const versoEtabEl      = document.getElementById("verso-etab");
  const versoFormEl      = document.getElementById("verso-formation");
  const versoContentEl   = document.getElementById("verso-content");
  const docEditedDateEl  = document.getElementById("doc-edited-date");

  let currentEtabName = "";


  const inputEtab   = document.getElementById("etab-input");
  const dropEtab    = document.getElementById("etab-dropdown");
  const etabText    = document.getElementById("etab-text");

  const codeModal   = document.getElementById("code-modal");
  const codeInput   = document.getElementById("code-input");
  const codeError   = document.getElementById("code-error");
  const codeValidateBtn = document.getElementById("code-validate");
  const codeCancelBtn   = document.getElementById("code-cancel");

  function normalize(str) {
    if (str == null) return "";
    return String(str)
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .trim();
  }

  // D√©coupe texte "A; B; C" en ["A", "B", "C"]
  function splitItems(str) {
    if (str == null) return [];
    return String(str)
      .split(/[;\n]/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  // D√©termine le r√©gime (interdit / derog / autorise / non_classe) √† partir d'un code du type '22|red'
  function regimeFromColorCode(code) {
    if (!code) return "non_classe";
    const parts = String(code).split("|");
    const colorPart = parts[1] ? parts[1].trim() : "";
    const n = normalize(colorPart);
    if (n.includes("red") || n.includes("rouge")) return "interdit";
    if (n.includes("orange")) return "derog";
    if (n.includes("green") || n.includes("vert")) return "autorise";
    return "non_classe";
  }

  // Ne garde que les libell√©s commen√ßant par 'travail' ou 'travaux' (insensible √† la casse/accents)
  function startsWithTravauxWord(label) {
    const n = normalize(label);
    return n.startsWith("travail") || n.startsWith("travaux");
  }

  function formatTodayFR() {
    const d = new Date();
    const jj = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const aa = d.getFullYear();
    return jj + "/" + mm + "/" + aa;
  }

  function renderVerso() {
    if (!versoContentEl) return;

    // Meta
    if (versoEtabEl) versoEtabEl.textContent = currentEtabName || "";
    if (versoFormEl) versoFormEl.textContent = (formationText && formationText.textContent) ? formationText.textContent : "";
    if (docEditedDateEl) docEditedDateEl.textContent = formatTodayFR();

    versoContentEl.innerHTML = "";

    const diplLbl = (formationText && formationText.textContent) ? formationText.textContent.trim() : "";
    const k = normalize(diplLbl);

    if (!selectedEtabCodeNorm) {
      const p = document.createElement("p");
      p.className = "equip-empty";
      p.textContent = "S√©lectionnez un √©tablissement pour g√©n√©rer le verso.";
      versoContentEl.appendChild(p);
      return;
    }

    if (!k) {
      const p = document.createElement("p");
      p.className = "equip-empty";
      p.textContent = "S√©lectionnez une formation pour g√©n√©rer le verso.";
      versoContentEl.appendChild(p);
      return;
    }

    const travaux = (function(){
      const byDipl = travauxByDiplomeEtab[k] || {};
      if (!selectedEtabCodeNorm) return [];
      if (byDipl[selectedEtabNameNorm]) return [...byDipl[selectedEtabNameNorm]];
      const looseSel = String(selectedEtabNameNorm || "").replace(/[^a-z0-9]/g, "");
      for (const key of Object.keys(byDipl)) {
        if (String(key).replace(/[^a-z0-9]/g, "") === looseSel) return [...byDipl[key]];
      }
      return [];
    })();
    if (!travaux.length) {
      const p = document.createElement("p");
      p.className = "equip-empty";
      p.textContent = "Aucun travail r√©glement√© (d√©rogation) trouv√© pour cette formation.";
      versoContentEl.appendChild(p);
      return;
    }

    const mapTrav = (function(){
      const byDipl = equipByDiplomeEtabTrav[k] || {};
      if (!selectedEtabCodeNorm) return {};
      if (byDipl[selectedEtabNameNorm]) return byDipl[selectedEtabNameNorm];
      // fallback "loose" (codes avec tirets/espaces)
      const looseSel = String(selectedEtabNameNorm || "").replace(/[^a-z0-9]/g, "");
      for (const key of Object.keys(byDipl)) {
        if (String(key).replace(/[^a-z0-9]/g, "") === looseSel) return byDipl[key];
      }
      return {};
    })();

    travaux.forEach(trav => {
      const card = document.createElement("div");
      card.className = "trav-card";

      const title = document.createElement("div");
      title.className = "trav-title";
      title.textContent = trav;
      card.appendChild(title);

      const setEq = mapTrav[trav];
      if (setEq && setEq.size) {
        const ul = document.createElement("ul");
        ul.className = "equip-list";

        const items = Array.from(setEq)
          .map(x => String(x || "").trim())
          .filter(Boolean)
          .sort((a,b) => a.localeCompare(b, "fr"));

        // Passage automatique en 2 colonnes si la liste est longue (objectif : tenir sur 1 verso)
        if (items.length >= 7) {
          ul.classList.add("two-cols");
        }

        items.forEach(it => {
          const li = document.createElement("li");
          li.textContent = it;
          ul.appendChild(li);
        });

        card.appendChild(ul);
      } else {
        const p = document.createElement("p");
        p.className = "equip-empty";
        p.textContent = "Aucun mat√©riel / produit class√© pour ce travail.";
        card.appendChild(p);
      }

      versoContentEl.appendChild(card);
    });
  }



  // Convertit le format colonnes de fetchTable en lignes {id, fields:{...}}
  function tableToRows(raw) {
    if (!raw || !Array.isArray(raw.id)) return [];
    const cols = Object.keys(raw).filter(k => k !== "id");
    const n = raw.id.length;
    const rows = [];
    for (let i = 0; i < n; i++) {
      const fields = {};
      for (const col of cols) {
        const arr = raw[col] || [];
        fields[col] = arr[i];
      }
      rows.push({ id: raw.id[i], fields });
    }
    return rows;
  }

  // Devine une colonne √† partir d‚Äôun nom pr√©f√©r√© + motifs
  function guessColumn(keys, preferred, patterns) {
    if (!keys || !keys.length) return null;

    if (preferred && keys.includes(preferred)) return preferred;

    if (preferred) {
      const pLow = preferred.toLowerCase();
      const exact = keys.find(k => k.toLowerCase() === pLow);
      if (exact) return exact;
    }

    for (const pat of patterns) {
      const found = keys.find(k => k.toLowerCase().includes(pat));
      if (found) return found;
    }
    return null;
  }

  // -----------------------------
  // AUTOCOMPL√âTION DIPL√îMES (filtr√©e par √©tablissement s√©lectionn√©)
  // -----------------------------
  function getCurrentDiplomePool() {
    console.log("  ‚Üí getCurrentDiplomePool");
    console.log("    allDiplomes:", allDiplomes.length);
    console.log("    selectedEtabCodeNorm:", selectedEtabCodeNorm);
    if (selectedEtabCodeNorm) {
      const set = diplomeByEtabCode[selectedEtabCodeNorm];
      if (set && set.size) {
        return Array.from(set).sort((a, b) => a.localeCompare(b, "fr"));
      }
    }
    return allDiplomes;
  }

  function buildDiplomeDropdown(query) {
    console.log("üîç buildDiplomeDropdown:", query);
    console.log("  allDiplomes.length:", allDiplomes.length);
    dropDiplome.innerHTML = "";
    const q = normalize(query);
    if (!q) { dropDiplome.style.display = "none"; return; }

    const pool = getCurrentDiplomePool();
    const matches = pool.filter(lbl => normalize(lbl).includes(q));
    if (!matches.length) { dropDiplome.style.display = "none"; return; }

    matches.slice(0, 40).forEach(lbl => {
      const item = document.createElement("div");
      item.className = "dropdown-item";
      item.textContent = lbl;
      item.addEventListener("mousedown", () => {
        inputDiplome.value = lbl;
        dropDiplome.style.display = "none";
        formationText.textContent = lbl;
        updateTravauxForDiplome(lbl);
      });
      dropDiplome.appendChild(item);
    });
    dropDiplome.style.display = "block";
  }

  inputDiplome.addEventListener("input", () => buildDiplomeDropdown(inputDiplome.value));
  inputDiplome.addEventListener("change", () => {
    const lbl = inputDiplome.value || "";
    formationText.textContent = lbl;
    updateTravauxForDiplome(lbl);
  });

  // -----------------------------
  // AUTOCOMPL√âTION ETABLISSEMENTS
  // -----------------------------
  function buildEtabDropdown(query) {
    if (inputEtab.readOnly) return;

    dropEtab.innerHTML = "";
    const q = normalize(query);
    if (!q) { dropEtab.style.display = "none"; return; }

    const matches = etablissements.filter(e => normalize(e.label).includes(q));
    if (!matches.length) { dropEtab.style.display = "none"; return; }

    matches.slice(0, 40).forEach(e => {
      const item = document.createElement("div");
      item.className = "dropdown-item";
      item.textContent = e.label;
      item.addEventListener("mousedown", () => {
        inputEtab.value = e.label;
        dropEtab.style.display = "none";
        updateEtabInfo(e);
      });
      dropEtab.appendChild(item);
    });
    dropEtab.style.display = "block";
  }

  inputEtab.addEventListener("input", () => {
    if (!inputEtab.readOnly) buildEtabDropdown(inputEtab.value);
  });

  inputEtab.addEventListener("change", () => {
    if (inputEtab.readOnly) return;
    const q = normalize(inputEtab.value || "");
    const found = etablissements.find(e => normalize(e.label) === q);
    if (found) updateEtabInfo(found);
  });

  function updateEtabInfo(e) {
    if (!e) { etabText.innerHTML = ""; return; }
    const lines = [];

    if (e.nom) lines.push("<strong>" + e.nom + "</strong>");
    if (e.adresse) lines.push(e.adresse);

    const cpVille = [e.cp || "", e.ville || ""].join(" ").trim();
    if (cpVille) lines.push(cpVille);

    if (e.mail) lines.push("Courriel : " + e.mail);

    etabText.innerHTML = lines.join("<br>");

    // Meta verso (annexe)
    currentEtabName = e.nom || e.label || "";
    if (versoEtabEl) versoEtabEl.textContent = currentEtabName;
    renderVerso();
  }

  // -----------------------------
  // TRAVAUX R√âGLEMENT√âS
  // -----------------------------
  function keepOnlyTravailItems(label) {
    const n = normalize(label);
    return n.startsWith("travail") || n.startsWith("travaux");
  }

  function updateTravauxForDiplome(lbl) {
    const label = (lbl || "").trim();
    const q = normalize(label);
    travauxListEl.innerHTML = "";
    if (versoContentEl) versoContentEl.innerHTML = "";

    if (!label) return;

    // 1) correspondance exacte (filtr√©e par √©tablissement verrouill√©)
    if (!selectedEtabCodeNorm) {
      // pas d'√©tablissement ‚Üí on n'affiche rien dans cette variante
      renderVerso();
      return;
    }

    const byDipl = travauxByDiplomeEtab[q] || {};
    let travaux = [];
    if (byDipl[selectedEtabNameNorm]) {
      travaux = [...byDipl[selectedEtabNameNorm]];
    } else {
      const looseSel = String(selectedEtabNameNorm || "").replace(/[^a-z0-9]/g, "");
      for (const key of Object.keys(byDipl)) {
        if (String(key).replace(/[^a-z0-9]/g, "") === looseSel) {
          travaux = [...byDipl[key]];
          break;
        }
      }
    }

    // 2) si rien trouv√©, correspondance ¬´ floue ¬ª : contient / contenu dans
    if (!travaux.length) {
      const vus = new Set();
      for (const [k, arr] of Object.entries(byDipl)) {
        if (!k) continue;
        if (k.includes(q) || q.includes(k)) {
          for (const t of arr) {
            if (!vus.has(t)) {
              vus.add(t);
              travaux.push(t);
            }
          }
        }
      }
    }

    if (!travaux.length) return;

    // ‚úÖ Filtre demand√© : ne garder que les intitul√©s qui commencent par "Travail" / "Travaux"
    travaux = travaux
      .map(t => String(t || "").trim())
      .filter(Boolean)
      .filter(keepOnlyTravailItems);

    if (!travaux.length) return;

    // Tri des libell√©s pour un affichage propre
    travaux.sort((a, b) => a.localeCompare(b, "fr"));

    travaux.forEach(t => {
      const li = document.createElement("li");
      li.textContent = t;
      travauxListEl.appendChild(li);
    });

    // Met a jour le verso (page 2)
    renderVerso();

  }

  // -----------------------------
// INT√âGRATION GITHUB
// -----------------------------
async function initDiplomesSource() {
  try {
    const raw = await window.PP_fetchTable(TABLE_DIPLOMES);
    const rows = tableToRows(raw);
    const vals = [];
    diplomaIdToLabel = {};
    for (const r of rows) {
      const f = r.fields || r;
      const label = f[COLUMN_CONCAT];
      if (label != null) vals.push(label);
      if (r.id != null && label != null) diplomaIdToLabel[r.id] = label;
    }
    allDiplomes = Array.from(new Set(vals.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b), 'fr'));
  } catch (e) {
    console.warn("initDiplomesSource: impossible de charger Diplomes_EN_OK", e);
    allDiplomes = [];
  }
}
}

  // Chargement des travaux + √©tablissements (dont mapping code ‚Üî dipl√¥mes)
// Chargement des travaux + √©tablissements (dont mapping code ‚Üî dipl√¥mes)
  
async function loadAuxTables() {
  try {
    // ‚úÖ Important : ce fichier tourne dans 2 contextes
    // - Dans  window.PP_fetchTable(...)
    // - Sur GitHub : PP_fetchTable(...) (Supabase Edge)
    const [rawTravTable, rawEtabTable] = await Promise.all([
      window.PP_fetchTable(TABLE_TRAVAUX),
      window.PP_fetchTable(TABLE_ETAB)
    ]);

    const travRecs = tableToRows(rawTravTable);
    const etabRecs = tableToRows(rawEtabTable);

      // ===== TRAVAUX =====
      if (travRecs.length) {
        const travSample = travRecs[0].fields || travRecs[0];
        const travKeys   = Object.keys(travSample || {});

        const travColDiplome = guessColumn(travKeys, COL_TRAV_DIPLOME, ["diplome", "formation"]);
        const travColLib     = guessColumn(
          travKeys,
          COL_TRAV_LIBELLE,
          ["tampon_travaux", "travaux", "travail", "intitul"]
        );

        const travColCodes   = guessColumn(
          travKeys,
          COL_TRAV_CODES,
          ["tampon_intitule", "intitule_travaux", "travaux_code", "code", "couleur"]
        );

        // Colonne d"equipement/produit (pour l"annexe verso)
        const travColEquip   = guessColumn(
          travKeys,
          null,
          [
            "appellation",
            "designation",
            "descript",
            "equip",
            "materiel",
            "mat√©riel",
            "produit",
            "machine",
            "outillage",
            "nom"
          ]
        );


        // Colonne permettant de rattacher une ligne d'√©quipement √† un √©tablissement (code / UAI / nom)
        const travColEtab = guessColumn(
          travKeys,
          COL_TRAV_ETAB,
          [
            "codepaca",
            "uai",
            "code_etab",
            "etab_code",
            "etablissement",
            "etab",
            "etablissements",
            "tampon_etab"
          ]
        );

        if (travColDiplome && travColLib) {
          const tmp = {};

          for (const rec of travRecs) {
            const f = rec.fields || {};
            const diplText  = f[travColDiplome];
            const libText   = f[travColLib];
            const codesText = travColCodes ? f[travColCodes] : null;
            const equipText = travColEquip ? f[travColEquip] : null;
            const etabRaw   = travColEtab ? f[travColEtab] : null;
            // Tampon_Etab peut contenir plusieurs √©tablissements s√©par√©s par ';'
            const etabKeys = splitItems(etabRaw).map(x => normalize(x)).filter(Boolean);

            // ‚úÖ Exclusion des mat√©riels non class√©s : pas de dipl√¥me OU pas de travaux
            if (!diplText || !libText) continue;
            // ‚úÖ Exclusion des lignes non rattach√©es √† un √©tablissement (dans cette variante)
            if (!etabKeys.length) continue;

            const diplomesLigne = splitItems(diplText);
            const travauxLigne  = splitItems(libText);
            const codesLigne    = splitItems(codesText);

            if (!diplomesLigne.length || !travauxLigne.length) continue;

            // On aligne (au mieux) libell√©s et codes comme dans ton autre fichier.
            const maxLen = Math.max(travauxLigne.length, codesLigne.length);

            diplomesLigne.forEach(oneDipl => {
              const key = normalize(oneDipl);
              if (!key) return;
              if (!tmp[key]) tmp[key] = {};

              etabKeys.forEach(etabKey => {
                if (!tmp[key][etabKey]) tmp[key][etabKey] = [];

              for (let idx = 0; idx < maxLen; idx++) {
                const travailLabel = travauxLigne[idx] || travauxLigne[travauxLigne.length - 1];
                if (!travailLabel) continue;

                // 1) On ne garde QUE ce qui commence par Travail / Travaux
                if (!startsWithTravauxWord(travailLabel)) continue;

                // 2) On ne garde QUE les travaux en d√©rogation (orange),
                //    pour coller √† l‚Äôautre fichier et √©viter les faux positifs.
                const code = codesLigne[idx];
                const regime = regimeFromColorCode(code);
                if (regime !== "derog") continue;

                tmp[key][etabKey].push(String(travailLabel).trim());

                // Verso : rattacher les equipements/produits au travail
                const eq = (equipText == null) ? "" : String(equipText).trim();
                if (eq) {
                  if (!equipByDiplomeEtabTrav[key]) equipByDiplomeEtabTrav[key] = {};
                  if (!equipByDiplomeEtabTrav[key][etabKey]) equipByDiplomeEtabTrav[key][etabKey] = {};
                  if (!equipByDiplomeEtabTrav[key][etabKey][String(travailLabel).trim()]) {
                    equipByDiplomeEtabTrav[key][etabKey][String(travailLabel).trim()] = new Set();
                  }
                  equipByDiplomeEtabTrav[key][etabKey][String(travailLabel).trim()].add(eq);
                }
              }

              });            });
          }

// D√©duplication + tri : chaque travail n‚Äôappara√Æt qu‚Äôune seule fois par dipl√¥me ET par √©tablissement
          for (const dKey of Object.keys(tmp)) {
            const byEtab = tmp[dKey] || {};
            for (const eKey of Object.keys(byEtab)) {
              byEtab[eKey] = Array.from(new Set(byEtab[eKey]))
                .sort((a, b) => a.localeCompare(b, "fr"));
            }
          }
          travauxByDiplomeEtab = tmp;
        }
      }

      // ===== ETABLISSEMENTS + MAPPING CODE ‚Üí DIPL√îMES =====
      if (!etabRecs.length) {
        etabsLoaded = true;
        return;
      }

      const sample = etabRecs[0].fields || etabRecs[0];
      const keys = Object.keys(sample || {});

      colEtabNom       = guessColumn(keys, HINT_ETAB_NOM,      ["appel", "nom"]);
      colEtabAdr1      = guessColumn(keys, HINT_ETAB_ADR1,     ["adr", "adresse"]);
      colEtabCP        = guessColumn(keys, HINT_ETAB_CP,       ["code_postal", "cp"]);
      colEtabVille     = guessColumn(keys, HINT_ETAB_VILLE,    ["ville", "commune"]);
      colEtabMail      = guessColumn(keys, HINT_ETAB_MAIL,     ["mail", "mel", "email", "courriel"]);
      colEtabCode      = guessColumn(keys, HINT_ETAB_CODE,     ["codepaca", "uai", "code"]);
      colEtabDiplomes  = guessColumn(keys, HINT_ETAB_DIPLOMES, ["diplome"]);

      const etabs = [];
      diplomeByEtabCode = {};

      for (const rec of etabRecs) {
        const f = rec.fields || rec;
        const nom   = colEtabNom      ? (f[colEtabNom]      || "") : "";
        const adr1  = colEtabAdr1     ? (f[colEtabAdr1]     || "") : "";
        const cp    = colEtabCP       ? (f[colEtabCP]       || "") : "";
        const ville = colEtabVille    ? (f[colEtabVille]    || "") : "";
        const mail  = colEtabMail     ? (f[colEtabMail]     || "") : "";
        const code  = colEtabCode     ? (f[colEtabCode]     || "") : "";
        const dipl  = colEtabDiplomes ? (f[colEtabDiplomes] || "") : "";

        if (!nom) continue;

        const labelParts = [nom, ville || cp].filter(Boolean);
        const label = labelParts.join(" ‚Äì ");
        etabs.push({ label, nom, adresse: adr1, cp, ville, mail, code });

        // Construction du mapping code √©tablissement ‚Üí dipl√¥mes d√©clar√©s
        const codeNorm = normalize(code);
        if (codeNorm && dipl) {
          const diplList = splitItems(dipl);
          if (diplList.length) {
            if (!diplomeByEtabCode[codeNorm]) diplomeByEtabCode[codeNorm] = new Set();
            diplList.forEach(dlbl => { if (dlbl) diplomeByEtabCode[codeNorm].add(dlbl); });
          }
        }
      }

      etabs.sort((a, b) => a.label.localeCompare(b.label, "fr"));
      etablissements = etabs;
      etabsLoaded = true;

    } catch (e) {
      console.error(e);
      etabsLoaded = true;
    }
  }

  // -----------------------------
// PERSISTENCE "SESSION" √âTABLISSEMENT (navigateur)
// -----------------------------
// Objectif : si tu fermes l‚Äôonglet puis tu reviens, on retrouve automatiquement l‚Äô√©tablissement
// (sans r√©afficher la lightbox) tant que la dur√©e n‚Äôest pas d√©pass√©e.
const PP_ETAB_SESSION_KEY = "pp_etab_session_v1";
const PP_ETAB_SESSION_TTL_MS = 30 * 60 * 1000; // 30 minutes

function saveEtabSession(codeNorm) {
  try {
    if (!codeNorm) return;
    const payload = { code: String(codeNorm), ts: Date.now() };
    localStorage.setItem(PP_ETAB_SESSION_KEY, JSON.stringify(payload));
  } catch (e) { /* stockage indisponible (mode priv√©, etc.) */ }
}

function clearEtabSession() {
  try { localStorage.removeItem(PP_ETAB_SESSION_KEY); } catch (e) {}
}

function loadEtabSession() {
  try {
    const raw = localStorage.getItem(PP_ETAB_SESSION_KEY);
    if (!raw) return null;
    const j = JSON.parse(raw);
    if (!j || !j.code || !j.ts) return null;
    if ((Date.now() - Number(j.ts)) > PP_ETAB_SESSION_TTL_MS) return null;
    return { codeNorm: normalize(j.code) };
  } catch (e) { return null; }
}

// Tentative de restauration : on attend que les √©tablissements soient charg√©s.
function tryRestoreEtabSession() {
  const s = loadEtabSession();
  if (!s || !s.codeNorm) return false;
  const match = etablissements.find(e => normalize(e.code || "") === s.codeNorm);
  if (!match) return false;
  lockEtablissement(match);
  return true;
}

// -----------------------------
  // LIGHTBOX CODE √âTABLISSEMENT
  // -----------------------------
  function redirectHome() {
    window.location.href = 'https://preventionpaca.github.io/guide/#home';
  }

  function lockEtablissement(e) {
    if (!e) return;
    selectedEtabCodeNorm = normalize(e.code || "");

    // Persistance (30 min) pour √©viter l‚Äô√©tablissement vide apr√®s fermeture d‚Äôonglet
    saveEtabSession(selectedEtabCodeNorm);

    // Pour filtrer Liste_des_equipements.Tampon_Etab (qui peut contenir des noms multiples)
    selectedEtabNameNorm = normalize(e.nom || e.label || "");
    selectedEtabNameLoose = String(selectedEtabNameNorm || "").replace(/[^a-z0-9]/g, "");

    inputEtab.value = e.label;
    inputEtab.readOnly = true;
    inputEtab.classList.add("locked");
    updateEtabInfo(e);

    // Meta verso (annexe)
    currentEtabName = e.nom || e.label || "";
    if (versoEtabEl) versoEtabEl.textContent = currentEtabName;
    renderVerso();

    inputDiplome.value = "";
    formationText.textContent = "";
    travauxListEl.innerHTML = "";
  }

  function validateCode() {
    if (!etabsLoaded) {
      codeError.textContent = "Chargement des √©tablissements, veuillez r√©essayer dans un instant.";
      return;
    }

    const raw = (codeInput.value || "").trim();
    if (!raw) {
      codeError.textContent = "Merci de saisir un code √©tablissement.";
      return;
    }

    const codeNorm = normalize(raw);
    const match = etablissements.find(e => normalize(e.code || "") === codeNorm);

    if (match) {
      lockEtablissement(match);
      codeError.textContent = "";
      if (codeModal) codeModal.style.display = "none";
      return;
    }

    codeAttempts++;
    if (codeAttempts >= 3) {
      redirectHome();
      return;
    }
    codeError.textContent = "Code inconnu. Tentative " + codeAttempts + " / 3.";
    codeInput.focus();
  }

  if (codeValidateBtn) codeValidateBtn.addEventListener("click", validateCode);
  if (codeCancelBtn) {
    codeCancelBtn.addEventListener("click", () => {
      redirectHome();
    });
  }
  if (codeInput) {
    codeInput.addEventListener("keydown", (evt) => {
      if (evt.key === "Enter") {
        evt.preventDefault();
        validateCode();
      }
    });

}

// Boutons : (re)connexion / changement d'√©tablissement
const btnReconnect = document.getElementById("pp-reconnect-btn");
const btnChangeEtab = document.getElementById("pp-change-etab-btn");

function showCodeModal() {
  if (codeModal && codeInput) {
    codeModal.style.display = "flex";
    setTimeout(() => codeInput.focus(), 50);
    return true;
  }
  return false;
}

function unlockEtablissement() {
  selectedEtabCodeNorm = null;
  selectedEtabNameNorm = null;
  selectedEtabNameLoose = null;
  currentEtabName = "";
  if (versoEtabEl) versoEtabEl.textContent = "";
  if (etabText) etabText.innerHTML = "";
  if (inputEtab) {
    inputEtab.readOnly = false;
    inputEtab.classList.remove("locked");
    inputEtab.value = "";
  }
  if (inputDiplome) inputDiplome.value = "";
  if (formationText) formationText.textContent = "";
  if (travauxListEl) travauxListEl.innerHTML = "";
  renderVerso();
}

if (btnReconnect) btnReconnect.addEventListener("click", () => showCodeModal());
if (btnChangeEtab) btnChangeEtab.addEventListener("click", () => {
  clearEtabSession();
  unlockEtablissement();
  showCodeModal();
});

window.addEventListener("load", async () => {
  if (docEditedDateEl) docEditedDateEl.textContent = formatTodayFR();

  // 1) Auth centralis√©e (pp-config.js)
  try {
    if (window.PP_AUTH && typeof window.PP_AUTH.requireDdfpt === "function") {
      await window.PP_AUTH.requireDdfpt();
    }
  } catch (e) {
    // La lightbox centrale est ouverte : on laisse l'utilisateur saisir son code.
    // La suite (init) se fera via l'√©v√®nement pp:auth-changed.
  }

  // 2) Init donn√©es
  try {
    await loadAuxTables();
    await initDiplomesSource();
  } catch (e) {
    console.warn("Init tables/dipl√¥mes:", e);
  }

  // 3) Applique l'√©tablissement depuis la session (si disponible)
  function applyAuthState(st) {
    if (!st) return;

    const code = String(st.codepaca || "").trim();
    const name = String(st.etabName || "").trim();

    if (!code && !name) return;

    // Masque la lightbox locale si elle existe encore dans le HTML (legacy)
    if (codeModal) codeModal.style.display = "none";

    // On tente d'abord de retrouver l'√©tablissement dans la liste charg√©e
    let match = null;
    if (code && Array.isArray(etablissements) && etablissements.length) {
      match = etablissements.find(e => normalize(e.code || "") === normalize(code));
    }
    if (!match) {
      match = { code, name: name || "" };
    }
    lockEtablissement(match);
  }

  // √©tat initial
  try {
    if (window.PP_AUTH && typeof window.PP_AUTH.get === "function") {
      applyAuthState(window.PP_AUTH.get());
    }
  } catch (e) {}

  // √©coute les changements (reconnexion / changement d'√©tablissement)
  document.addEventListener("pp:auth-changed", (ev) => {
    const st = ev && ev.detail ? ev.detail : null;
    if (!st) {
      clearEtabSession();
      unlockEtablissement();
      return;
    }
    applyAuthState(st);
  });
});
// -----------------------------
  // DATE + EXPORT PDF
  // -----------------------------
  const tatInput = document.getElementById("tat-input");
  const tatBtn   = document.getElementById("tat-today-btn");
  if (tatBtn && tatInput) {
    tatBtn.addEventListener("click", () => {
      const d = new Date();
      const jj = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const aa = d.getFullYear();
      tatInput.value = jj + "/" + mm + "/" + aa;
    });
  }

  const exportBtn = document.getElementById("export-pdf-btn");
  if (exportBtn) exportBtn.addEventListener("click", () => window.print());

  document.addEventListener("click", (evt) => {
    if (!dropDiplome.contains(evt.target) && evt.target !== inputDiplome) {
      dropDiplome.style.display = "none";
    }
    if (!dropEtab.contains(evt.target) && evt.target !== inputEtab) {
      dropEtab.style.display = "none";
    }
  });
</script>

<!-- ===== JS commun pour le header (th√®me + liens) ===== -->
<script>
  window.PP_PAGE = 'ddfpt';
  window.PP_LINKS = {
    home:   'https://preventionpaca.github.io/guide/#home',
    portal: 'https://preventionpaca.github.io/guide/#home',
    admin:  'https://preventionpaca.github.io/guide/#admin',
    ddfpt:  'https://preventionpaca.github.io/guide/#ddfpt'
  };
  window.PP_HEADER_TEXT = {
    title: 'PORTAIL PR√âVENTION PACA',
    subtitle: 'Avis m√©dical d‚Äôaptitude aux travaux r√©glement√©s.'
  };
</script>
<script src="https://preventionpaca.github.io/guide/js/pp-config.js"></script>
<script src="https://preventionpaca.github.io/guide/js/pp-header.js"></script>

</body>
</html>
