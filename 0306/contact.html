<!DOCTYPE html>
<html lang="fr">
<head>
  
  <script>
    window.PP_APP_NAME = "site";
  </script>
<meta charset="UTF-8" />
  <title>Questions / Contact – Portail prévention PACA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon ✚ -->
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✚</text></svg>"/>

  <!-- CSS commun portail (fond standard inclus ici) -->
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-core.css" />
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-portail.css" />

  <!-- API Grist -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  

<script>
  // ===============================
  // PPP Data Layer (GitHub + Grist)
  // - Lecture: PP_fetchTable(table)
  // - En dehors de Grist: utilise Supabase Edge Function read-app
  // ===============================
  (function () {
    const DEFAULT_SB = "https://hpiqwvwpxzppxpxhjede.supabase.co";
    const sbBase = (window.PP_SUPABASE_URL || DEFAULT_SB).replace(/\/+$/, "");
    const SB_ROOT = sbBase + "/functions/v1";

    // IMPORTANT: dans votre cas, le docId est résolu via resolve-app => app= "equipements"
    window.PP_APP_NAME = window.PP_APP_NAME || "equipements";

    window.PP_SB_ROOT = SB_ROOT;
    window.PP_SB_API_READ = SB_ROOT + "/read-app";
    window.PP_SB_API_AUTH = SB_ROOT + "/auth-code";
    window.PP_SB_API_WRITE = SB_ROOT + "/write-app";

    window.PP_IS_GRIST = !!(
      window.grist &&
      window.grist.docApi &&
      typeof window.grist.docApi.fetchTable === "function" &&
      window.parent !== window
    );

    function rowsToGristTable(rows) {
      if (!Array.isArray(rows) || !rows.length) return { id: [] };
      const cols = new Set();
      for (const r of rows) Object.keys(r || {}).forEach((k) => cols.add(k));
      cols.delete("id");
      const t = { id: [] };
      for (const c of cols) t[c] = [];
      for (const r of rows) {
        t.id.push(r.id);
        for (const c of cols) t[c].push(r[c]);
      }
      return t;
    }

    async function sbFetchTable(tableName) {
      const url = window.PP_SB_API_READ +
        "?app=" + encodeURIComponent(window.PP_APP_NAME) +
        "&table=" + encodeURIComponent(tableName);

      const r = await fetch(url, { credentials: "omit" });
      const j = await r.json().catch(() => null);

      if (!r.ok || !j || !j.ok) {
        throw new Error(j?.error || "Lecture Supabase impossible");
      }

      // ✅ Support formats possibles:
      // 1) { table: {id:[], ...} }
      if (j.table) return j.table;

      // 2) { rows: [...] } ou { data:[...] } ou { items:[...] }
      if (Array.isArray(j.rows)) return rowsToGristTable(j.rows);
      if (Array.isArray(j.data)) return rowsToGristTable(j.data);
      if (Array.isArray(j.items)) return rowsToGristTable(j.items);

      // 3) { records: [{id, fields:{...}}] } (format Grist-like)
      if (Array.isArray(j.records)) {
        const rows = j.records.map((rec) => ({ id: rec.id, ...(rec.fields || {}) }));
        return rowsToGristTable(rows);
      }

      // 4) { tables: {TableName: {id:[], ...}} }
      if (j.tables && j.tables[tableName]) return j.tables[tableName];

      return j;
    }

    window.PP_fetchTable = async function (tableName) {
      if (window.PP_IS_GRIST) return window.grist.docApi.fetchTable(tableName);
      return sbFetchTable(tableName);
    };

    // ✅ Shim: pour éviter de retoucher 50 scripts existants
    // Beaucoup de vos pages appellent grist.docApi.fetchTable(...) et grist.rowsToRecords(...)
    // En mode GitHub, on "simule" juste ces fonctions.
    if (!window.PP_IS_GRIST) {
      window.grist = window.grist || {};
      window.grist.docApi = window.grist.docApi || {};
      window.grist.docApi.fetchTable = window.PP_fetchTable;

      if (typeof window.grist.rowsToRecords !== "function") {
        window.grist.rowsToRecords = function (table) {
          const ids = table.id || [];
          const records = [];
          let cols = {};

          if (table.fields && typeof table.fields === "object") cols = table.fields;
          else {
            for (const [k, v] of Object.entries(table)) {
              if (k === "id") continue;
              if (Array.isArray(v)) cols[k] = v;
            }
          }

          for (let i = 0; i < ids.length; i++) {
            const rec = { id: ids[i] };
            for (const [k, arr] of Object.entries(cols)) rec[k] = arr[i];
            records.push(rec);
          }
          return records;
        };
      }
    }
  })();
</script>

<style>
    /* ==========================================================
       CONTACT — CSS SCOPÉ (ne touche pas au header commun)
       ========================================================== */

    body.pp-page-contact{ margin:0; }

    .pp-page-contact .ppc-wrap{
      width: 100%;
      max-width: 1180px;
      margin: 0 auto;
      padding: 18px 10px 28px;
    }

    .pp-page-contact .ppc-layout{
      display: grid;
      grid-template-columns: minmax(0, 1.45fr) minmax(0, 1fr);
      grid-template-rows: auto auto;
      column-gap: 20px;
      row-gap: 20px;
      align-items: stretch;
      margin-top: 18px;
    }

    @media (max-width: 900px){
      .pp-page-contact .ppc-layout{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
    }

    .pp-page-contact .ppc-card{
      border-radius: 16px;
      padding: 16px 18px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
      backdrop-filter: blur(4px);
    }

    body.light-theme .pp-page-contact .ppc-card{
      background: #ffffff;
      border-color: rgba(148,163,184,0.55);
      box-shadow: 0 10px 18px rgba(15,23,42,0.10);
    }

    .pp-page-contact .ppc-card--contact{
      grid-column: 1;
      grid-row: 1 / span 2;
      display: flex;
      flex-direction: column;
    }
    .pp-page-contact .ppc-card--team{
      grid-column: 2;
      grid-row: 1;
    }
    .pp-page-contact .ppc-card--survey{
      grid-column: 2;
      grid-row: 2;
      display: flex;
      flex-direction: column;
    }

    @media (max-width: 900px){
      .pp-page-contact .ppc-card--contact{ grid-column: 1; grid-row: 1; }
      .pp-page-contact .ppc-card--team{    grid-column: 1; grid-row: 2; }
      .pp-page-contact .ppc-card--survey{  grid-column: 1; grid-row: 3; }
    }

    .pp-page-contact .ppc-title{
      font-size: 1.05rem;
      font-weight: 700;
      margin: 0 0 10px;
    }
    .pp-page-contact .ppc-subtitle{
      font-size: 0.88rem;
      margin: 0 0 16px;
      opacity: 0.85;
    }

    .pp-page-contact .ppc-form{
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1 0 auto;
    }
    .pp-page-contact .ppc-field label{
      display: block;
      font-size: 0.86rem;
      margin-bottom: 6px;
      font-weight: 600;
      opacity: 0.92;
    }

    .pp-page-contact .ppc-input,
    .pp-page-contact .ppc-textarea{
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.35);
      color: inherit;
      outline: none;
      font: inherit;
      transition: border-color 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .pp-page-contact .ppc-textarea{
      min-height: 180px;
      resize: vertical;
    }

    body.light-theme .pp-page-contact .ppc-input,
    body.light-theme .pp-page-contact .ppc-textarea{
      background: #f9fafb;
    }

    .pp-page-contact .ppc-input:focus,
    .pp-page-contact .ppc-textarea:focus{
      border-color: rgba(59,130,246,0.9);
      box-shadow: 0 0 0 2px rgba(59,130,246,0.18);
    }

    .pp-page-contact .ppc-helper{
      font-size: 0.78rem;
      opacity: 0.75;
      margin-top: 4px;
    }

    .pp-page-contact .ppc-actions{
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }

    .pp-page-contact .ppc-btn{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 18px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.45);
      background: rgba(255,255,255,0.10);
      color: inherit;
      cursor: pointer;
      font-weight: 600;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
    }
    .pp-page-contact .ppc-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
      background: rgba(255,255,255,0.14);
    }

    .pp-page-contact .ppc-team{
      margin: 0;
      padding-left: 1.2rem;
      font-size: 0.9rem;
    }
    .pp-page-contact .ppc-team li + li{ margin-top: 4px; }
    .pp-page-contact .ppc-team-placeholder{
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .pp-page-contact .ppc-surveybox{
      margin-top: 4px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15,23,42,0.22);
      border: 1px solid rgba(148,163,184,0.40);
      font-size: 0.9rem;
    }
    body.light-theme .pp-page-contact .ppc-surveybox{
      background: #eef2ff;
    }

    .pp-page-contact .ppc-q{
      margin-top: 10px;
      margin-bottom: 4px;
      font-weight: 600;
      opacity: 0.95;
    }

    .pp-page-contact .ppc-options{
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.86rem;
    }
    .pp-page-contact .ppc-options label{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .pp-page-contact .ppc-confirm{
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,0.55);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 180ms ease-out;
    }
    .pp-page-contact .ppc-confirm.is-on{
      opacity: 1;
      pointer-events: auto;
    }
    .pp-page-contact .ppc-confirmbox{
      max-width: 380px;
      width: calc(100% - 28px);
      border-radius: 16px;
      padding: 18px 18px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(148,163,184,0.45);
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
      text-align: center;
      backdrop-filter: blur(6px);
    }
    body.light-theme .pp-page-contact .ppc-confirmbox{
      background: #ffffff;
    }
  </style>
</head>

<body class="pp-page-contact">

  <!-- ✅ IMPORTANT : le host du header est ICI, dans le body -->
  <div id="header-container"></div>

  <div class="page-wrap">
    <main class="ppc-wrap">
      <div class="ppc-layout">

        <section class="ppc-card ppc-card--contact">
          <h2 class="ppc-title">Formulaire de contact</h2>
          <p class="ppc-subtitle">
            Pour toute question sur les travaux réglementés ou l’utilisation de ce site,
            vous pouvez nous écrire via ce formulaire.
          </p>

          <form class="ppc-form contact-form"
                action="https://formsubmit.co/guide.preventionpaca@lycee-les-eucalyptus.org"
                method="POST">
            <input type="hidden" name="_captcha" value="false" />
            <input type="hidden" name="_template" value="table" />
            <input type="hidden" name="_subject" value="Message – Guide Prévention PACA" />

            <div class="ppc-field">
              <label for="nom">Nom / Prénom *</label>
              <input id="nom" name="Nom" class="ppc-input" type="text" required />
            </div>

            <div class="ppc-field">
              <label for="email">Adresse e-mail *</label>
              <input id="email" name="Email" class="ppc-input" type="email" required />
              <div class="ppc-helper">Nous utiliserons votre e-mail uniquement pour vous répondre.</div>
            </div>

            <div class="ppc-field">
              <label for="etab">Établissement (facultatif)</label>
              <input id="etab" name="Établissement" class="ppc-input" type="text" />
            </div>

            <div class="ppc-field">
              <label for="message">Votre message *</label>
              <textarea id="message" name="Message" class="ppc-textarea" rows="5" required></textarea>
            </div>

            <div class="ppc-actions">
              <button type="submit" class="ppc-btn">
                <span aria-hidden="true">✉</span>
                <span>Envoyer le message</span>
              </button>
            </div>
          </form>
        </section>

        <aside class="ppc-card ppc-card--team">
          <h2 class="ppc-title">Équipe du projet</h2>
          <ul id="teamList" class="ppc-team">
            <li class="ppc-team-placeholder">Chargement des membres de l’équipe depuis Grist…</li>
          </ul>
        </aside>

        <section class="ppc-card ppc-card--survey">
          <h2 class="ppc-title">Sondage rapide</h2>

          <form class="ppc-form survey-form"
                action="https://formsubmit.co/guide.preventionpaca@lycee-les-eucalyptus.org"
                method="POST">
            <input type="hidden" name="_captcha" value="false" />
            <input type="hidden" name="_template" value="table" />
            <input type="hidden" name="_subject" value="Sondage – Guide Prévention PACA" />

            <div class="ppc-surveybox">
              <strong>Ce site vous a-t-il été utile&nbsp;?</strong>
              <div class="ppc-helper">Merci de répondre en quelques clics. Les réponses sont anonymes.</div>

              <div class="ppc-q">1. Ce site vous a-t-il rendu service&nbsp;?</div>
              <div class="ppc-options">
                <label><input type="radio" name="Site_rendu_service" value="Oui" /> Oui</label>
                <label><input type="radio" name="Site_rendu_service" value="Non" /> Non</label>
              </div>

              <div class="ppc-q">2. Le trouvez-vous utile&nbsp;?</div>
              <div class="ppc-options">
                <label><input type="radio" name="Site_utile" value="Oui" /> Oui</label>
                <label><input type="radio" name="Site_utile" value="Non" /> Non</label>
              </div>

              <div class="ppc-q">3. Souhaitez-vous proposer des améliorations&nbsp;?</div>
              <div class="ppc-options">
                <label><input type="radio" name="Améliorations" value="Oui" id="ameliYes" /> Oui</label>
                <label><input type="radio" name="Améliorations" value="Non" id="ameliNo" /> Non</label>
              </div>

              <div id="ameliCommentBlock" style="display:none; margin-top:10px;">
                <div class="ppc-helper">Veuillez compléter le formulaire de contact ci-contre.</div>
              </div>
            </div>

            <div class="ppc-actions">
              <button type="submit" class="ppc-btn">
                <span aria-hidden="true">✅</span>
                <span>Envoyer le sondage</span>
              </button>
            </div>
          </form>
        </section>

      </div>
    </main>
  </div>

  <div id="ppcConfirm" class="ppc-confirm" aria-hidden="true">
    <div class="ppc-confirmbox" role="dialog" aria-modal="true" aria-label="Confirmation d’envoi">
      <h3>Merci&nbsp;!</h3>
      <p id="ppcConfirmMain"></p>
      <p id="ppcConfirmSub" style="margin-top:6px;"></p>
    </div>
  </div>

  <script>
    function rowsToRecordsCompat(table) {
      if (window.grist && typeof grist.rowsToRecords === 'function') return grist.rowsToRecords(table);
      const ids = table.id || [];
      const records = [];
      let columnArrays = table.fields && typeof table.fields === 'object' ? table.fields : {};
      if (!Object.keys(columnArrays).length) {
        for (const [k, v] of Object.entries(table)) if (k !== 'id' && Array.isArray(v)) columnArrays[k] = v;
      }
      for (let i = 0; i < ids.length; i++) {
        const rec = { id: ids[i] };
        for (const [col, values] of Object.entries(columnArrays)) rec[col] = values[i];
        records.push(rec);
      }
      return records;
    }

    function normalizeName(v) {
      if (!v) return '';
      let s = String(v).trim().toLowerCase();
      try { s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, ''); } catch(e){}
      return s.replace(/[_\s]+/g, ' ').replace(/\s+/g, ' ');
    }

    function buildTeamBlock(blocsRows) {
      const listEl = document.getElementById('teamList');
      if (!listEl) return;

      const targetPageNorm = normalizeName('Contact_sondage');
      const lines = [];

      blocsRows
        .filter(b => normalizeName(b.Page) === targetPageNorm)
        .forEach(b => {
          const raw = (b.Titre_bloc || '').toString();
          raw.split(/\r?\n/).forEach(part => {
            const t = part.trim();
            if (t) lines.push(t);
          });
        });

      listEl.innerHTML = '';
      if (lines.length) {
        lines.slice(0, 12).forEach(line => {
          const li = document.createElement('li');
          li.textContent = line;
          listEl.appendChild(li);
        });
      } else {
        const li = document.createElement('li');
        li.textContent = 'Configuration à compléter dans la table « Blocs » (Page = Contact_sondage, Titre_bloc).';
        li.className = 'ppc-team-placeholder';
        listEl.appendChild(li);
      }
    }

    async function loadTeamFromGrist() {
      if (!window.grist || !grist.docApi) return;
      const tBlocs = await grist.docApi.fetchTable('Blocs');
      buildTeamBlock(rowsToRecordsCompat(tBlocs));
    }

    function showConfirmOverlay(mainText, subText) {
      const overlay = document.getElementById('ppcConfirm');
      const mainEl = document.getElementById('ppcConfirmMain');
      const subEl = document.getElementById('ppcConfirmSub');
      if (mainEl) mainEl.textContent = mainText || '';
      if (subEl) subEl.textContent = subText || '';
      overlay?.classList.add('is-on');
      setTimeout(() => overlay?.classList.remove('is-on'), 2500);
    }

    function installFormSubmitHandler(formSelector, type) {
      const form = document.queryi = document.querySelector(formSelector);
      if (!form) return;
      form.addEventListener('submit', e => {
        e.preventDefault();
        const data = new FormData(form);
        fetch(form.action, { method: 'POST', body: data, mode: 'no-cors' })
          .catch(err => console.error('Erreur FormSubmit', err))
          .finally(() => {
            showConfirmOverlay(
              type === 'survey' ? 'Votre réponse au sondage a bien été enregistrée.' : 'Votre message a bien été envoyé.',
              'Merci pour votre contribution.'
            );
            form.reset();
            if (type === 'survey') document.getElementById('ameliCommentBlock')?.style && (document.getElementById('ameliCommentBlock').style.display = 'none');
          });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const ameliYes = document.getElementById('ameliYes');
      const ameliNo = document.getElementById('ameliNo');
      const ameliBlock = document.getElementById('ameliCommentBlock');
      const updateAmeli = () => ameliBlock && (ameliBlock.style.display = (ameliYes && ameliYes.checked) ? 'block' : 'none');
      ameliYes?.addEventListener('change', updateAmeli);
      ameliNo?.addEventListener('change', updateAmeli);
      updateAmeli();

      if (window.grist) { try { if (window.PP_IS_GRIST && window.grist && window.grist.ready) { grist.ready(); } loadTeamFromGrist(); } catch(e){ console.error(e); } }

      installFormSubmitHandler('.contact-form', 'contact');
      installFormSubmitHandler('.survey-form', 'survey');
    });
  </script>

<script src="https://preventionpaca.github.io/guide/js/pp-config.js"></script>
<script>window.PP_PAGE = "contact";</script> <!-- optionnel -->
<script src="https://preventionpaca.github.io/guide/js/pp-header.js"></script>


</body>
</html>
