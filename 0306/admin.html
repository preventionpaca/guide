<!DOCTYPE html>
<!-- PATCH 2026-02-01: single lock overlay + cancel button + no duplicate pp-config -->
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Portail prévention PACA – Accès administrateur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
<link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-core.css" />
  <link rel="stylesheet" href="https://preventionpaca.github.io/guide/css/pp-portail.css" />

  <script>
  // Supabase (Edge Functions)
  window.PP_SUPABASE_URL = window.PP_SUPABASE_URL || "https://hpiqwvwpxzppxpxhjede.supabase.co";
</script>
<script src="https://preventionpaca.github.io/guide/js/pp-config.js?v=20260128a"></script>

  <style>
    .pp-lock-overlay{position:fixed;inset:0;background:rgba(15,23,42,.9);z-index:9999;display:flex;align-items:center;justify-content:center}
    .pp-lock-modal{background:#0b2238;color:#e5f0ff;border-radius:18px;padding:24px 28px;max-width:420px;width:92%;
      box-shadow:0 20px 45px rgba(0,0,0,.6);border:1px solid #f97316;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    .pp-lock-title{margin:0 0 4px;font-size:1.15rem;font-weight:600}
    .pp-lock-sub{margin:0 0 14px;font-size:.85rem;color:#9ca3af}
    .pp-lock-input{width:100%;border-radius:999px;border:1px solid #374151;padding:10px 14px;margin-bottom:8px;background:#020617;color:#e5f0ff;font-size:.95rem}
    .pp-lock-input:focus{outline:none;border-color:#f97316;box-shadow:0 0 0 1px rgba(249,115,22,.7)}
    .pp-lock-actions{display:flex;justify-content:flex-end;align-items:center;gap:10px;margin-top:8px}
    .pp-lock-btn{border-radius:999px;border:none;padding:8px 18px;font-size:.9rem;cursor:pointer;background:transparent;color:#e5f0ff}
    .pp-lock-btn-primary{background:#f97316;color:#111827;font-weight:700}
    .pp-lock-error{margin:6px 0 0;font-size:.85rem;color:#fecaca;min-height:1.1em;white-space:pre-wrap}
    .pp-lock-attempts{margin-top:4px;font-size:.75rem;color:#9ca3af}
  </style>
</head>

<body>
<div class="page-wrap">
  <div id="header-container"></div>

  <section class="ppaca-section">
    <div class="ppaca-card">
      <div class="ppaca-card-header">
        <div class="ppaca-avatar">AA</div>
        <div>
          <h2 class="ppaca-card-title">Accès administrateur – Portail Prévention PACA</h2>
          <p class="ppaca-card-subtitle"></p>
        </div>
      </div>
      <div class="ppaca-card-body">
        <p>L’espace <strong>administrateur</strong> est réservé aux personnes en charge de la structure du portail.</p>
      </div>
    </div>
  </section>

  <section class="tile-frame"><main id="tileGrid" class="tile-grid"></main></section>
</div>

<div id="ppLockOverlay" class="pp-lock-overlay" aria-modal="true" role="dialog">
  <div class="pp-lock-modal">
    <h2 class="pp-lock-title">Accès réservé</h2>
    <p class="pp-lock-sub">Cette page est réservée aux administrateurs. Merci de saisir le code d’accès.</p>
    <input id="ppLockInput" class="pp-lock-input" type="password" autocomplete="off" placeholder="Code administrateur" />
    <div id="ppLockError" class="pp-lock-error"></div>
    <div id="ppLockAttempts" class="pp-lock-attempts"></div>
    <div class="pp-lock-actions">
      <button id="ppLockCancel" class="pp-lock-btn" type="button">Annuler</button>
      <button id="ppLockSubmit" class="pp-lock-btn pp-lock-btn-primary" type="button">Valider</button>
    </div>
  </div>
</div>

<script>
  const PAGE_NAME = 'Acces_Admin';
  const MAX_ATTEMPTS = 3;
  let attemptCount = 0, accessGranted = false;

  const PORTAL_ROOT = 'https://preventionpaca.github.io/guide/';
  const HOME_URL = PORTAL_ROOT + '#home';

  function goHome(evt){
    if(evt && evt.preventDefault) evt.preventDefault();
    try{ if(window.parent && window.parent!==window){ window.parent.postMessage({type:'pp:navigate', key:'home'}, '*'); } }catch(e){}
    try{ if(window.top && window.top!==window){ window.top.location.href = HOME_URL; return; } }catch(e){}
    try{ window.location.href = HOME_URL; }catch(e){}
  }

  function rowsToRecordsCompat(table){
    if(window.grist && typeof grist.rowsToRecords==='function') return grist.rowsToRecords(table);
    const ids = table.id || [];
    const fields = table.fields || {};
    const recs = [];
    for(let i=0;i<ids.length;i++){
      const r={id:ids[i]};
      for(const [k,arr] of Object.entries(fields)) r[k]=arr[i];
      recs.push(r);
    }
    return recs;
  }


  function tableToRecords(table){
    // grist plugin fetchTable() returns {id:[], fields:{col:[]}}
    if(table && Array.isArray(table.id) && table.fields) return rowsToRecordsCompat(table);

    // REST /records returns {records:[{id, fields:{...}}, ...]}
    if(table && Array.isArray(table.records)){
      return table.records.map(r => ({id:r.id, ...(r.fields||{})}));
    }
    return [];
  }

  async function fetchTableSmart(tableName){
    // 1) Inside Grist widget
    if(window.grist && grist.docApi && typeof grist.docApi.fetchTable === 'function'){
      return await grist.docApi.fetchTable(tableName);
    }

    // 2) If pp-config exposes helpers (most robust for your portal)
    const candidates = [
      () => (window.PP && PP.grist && typeof PP.grist.fetchTable === 'function') ? PP.grist.fetchTable(tableName) : null,
      () => (window.PP && typeof PP.fetchTable === 'function') ? PP.fetchTable(tableName) : null,
      () => (window.PP && typeof PP.rpcFetch === 'function') ? PP.rpcFetch({type:'grist', table: tableName}) : null,
    ];
    for(const fn of candidates){
      try{
        const res = await fn();
        if(res) return res;
      }catch(e){ /* try next */ }
    }

    // 3) Direct REST call (works if doc/table is accessible publicly or via API key in pp-config)
    const docId = window.PP_GRIST_DOC_ID;
    if(!docId) throw new Error("PP_GRIST_DOC_ID manquant (pp-config).");
    const base = `https://docs.getgrist.com/api/docs/${encodeURIComponent(docId)}/tables/${encodeURIComponent(tableName)}/records`;
    const headers = {'Accept':'application/json'};
    const apiKey = window.PP_GRIST_API_KEY || window.PP_GRIST_TOKEN || window.PP_GRIST_KEY;
    if(apiKey) headers['Authorization'] = 'Bearer ' + apiKey;

    const r = await fetch(base, {method:'GET', headers});
    const j = await r.json().catch(()=> ({}));
    if(!r.ok){
      const msg = (j && (j.error || j.message)) ? (j.error || j.message) : ('HTTP '+r.status);
      throw new Error("Grist API: " + msg + " (table: "+tableName+")");
    }
    return j;
  }



  function getField(rec, names, fallback=''){
    if(!rec) return fallback;
    for(const n of names){
      if(n in rec && rec[n] !== null && rec[n] !== undefined && String(rec[n]).trim()!=='') return rec[n];
    }
    // try case-insensitive match
    const keys = Object.keys(rec);
    for(const n of names){
      const k = keys.find(x => String(x).toLowerCase() === String(n).toLowerCase());
      if(k && rec[k] !== null && rec[k] !== undefined && String(rec[k]).trim()!=='') return rec[k];
    }
    return fallback;
  }

  function guessPageKey(recs){
    if(!recs || !recs.length) return 'Page';
    const keys = Object.keys(recs[0]||{});
    const cands = keys.filter(k => String(k).toLowerCase().includes('page'));
    return cands[0] || 'Page';
  }

  function normalizeName(v){
    if(!v) return '';
    let s = String(v).trim().toLowerCase();
    try{s=s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');}catch(e){}
    return s.replace(/[_\s]+/g,' ').replace(/\s+/g,' ');
  }
  function colorToClass(c){
    if(!c) return '';
    const v = String(c).toLowerCase();
    if(v.includes('blanc')) return 'tile--white';
    if(v.includes('vert')) return 'tile--green';
    if(v.includes('orange')) return 'tile--orange';
    if(v.includes('noir')) return 'tile--dark';
    if(v.includes('marron clair')) return 'tile--brown-light';
    if(v.includes('marron fon')) return 'tile--brown-dark';
    if(v.includes('gris')) return 'tile--gray-light';
    return '';
  }
  function buildTiles(blocsRowsAll, layoutRow){
    const grid = document.getElementById('tileGrid');
    grid.innerHTML='';

    const colsRaw = getField(layoutRow, ['Nbre_colonne','Nbre_colonnes','Colonnes','Colonnes_par_ligne'], 4);
    const cols = Number(colsRaw)||4;
    document.documentElement.style.setProperty('--grid-columns', cols);

    blocsRowsAll
      .slice()
      .sort((a,b)=> (Number(getField(a,['num_bloc','Num_bloc','Numero','Ordre'],0))||0) - (Number(getField(b,['num_bloc','Num_bloc','Numero','Ordre'],0))||0))
      .forEach(bloc=>{
        const tile=document.createElement('div'); tile.className='tile';
        const cc=colorToClass(getField(bloc,['Couleur','couleur','Color','Couleur_bloc'],'')); if(cc) tile.classList.add(cc);

        const icon=document.createElement('div'); icon.className='tile-icon'; icon.textContent=getField(bloc,['Initiale_bloc','Initiale','Icone','Icône'], '');
        const main=document.createElement('div'); main.className='tile-main';
        const t=document.createElement('div'); t.className='tile-title'; t.textContent=getField(bloc,['Titre_bloc','Titre','Titre_bloc_1','Nom','Libelle','Libellé'], '(sans titre)');
        const d=document.createElement('div'); d.className='tile-desc'; d.textContent=getField(bloc,['Sous_titre1','Sous_titre','Sous-titre','Description','Desc'], '');
        main.appendChild(t); main.appendChild(d);
        tile.appendChild(icon); tile.appendChild(main);

        const url = String(getField(bloc,['Url_bloc','URL','Url','Lien','Lien_bloc'], '')||'').trim();
        if(url){
          tile.tabIndex=0; tile.setAttribute('role','link');
          tile.addEventListener('click', ()=>{ try{ window.top.location.href=url; }catch(e){ window.location.href=url; } });
          tile.addEventListener('keypress', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); try{ window.top.location.href=url; }catch(err){ window.location.href=url; } } });
        }
        grid.appendChild(tile);
      });
  }

  async function loadTiles(){
    const grid = document.getElementById('tileGrid');
    try{
      const [tAgencRaw, tBlocsRaw] = await Promise.all([
        fetchTableSmart('Agencement_portail'),
        fetchTableSmart('Blocs')
      ]);

      const agRows = tableToRecords(tAgencRaw);
      const blocsAll = tableToRecords(tBlocsRaw);

      if(!agRows.length && !blocsAll.length){
        throw new Error("Aucune donnée reçue depuis Grist (tables vides ou accès refusé).");
      }

      const pageKeyAg = guessPageKey(agRows);
      const pageKeyBl = guessPageKey(blocsAll);

      const layoutRow =
        agRows.find(r=>normalizeName(getField(r,[pageKeyAg,'Page','page'],''))===normalizeName(PAGE_NAME)) ||
        agRows.find(r=>normalizeName(getField(r,[pageKeyAg,'Page','page'],''))===normalizeName('Accès administrateur')) ||
        agRows.find(r=>normalizeName(getField(r,[pageKeyAg,'Page','page'],''))===normalizeName('Acces administrateur')) ||
        agRows[0] || null;

      let blocsRowsAll = blocsAll.filter(b=>normalizeName(getField(b,[pageKeyBl,'Page','page'],''))===normalizeName(PAGE_NAME));

      if(!blocsRowsAll.length){
        const fallbacks = ['Acces_ADMIN','Acces_Admin','Accès administrateur','Acces administrateur','Admin','Administrateur'];
        for(const fb of fallbacks){
          blocsRowsAll = blocsAll.filter(b=>normalizeName(getField(b,[pageKeyBl,'Page','page'],''))===normalizeName(fb));
          if(blocsRowsAll.length) break;
        }
      }
      if(!blocsRowsAll.length){
        blocsRowsAll = blocsAll.slice();
        console.warn('[ADMIN] Aucun bloc trouvé pour la page "'+PAGE_NAME+'". Affichage de tous les blocs.');
      }

      buildTiles(blocsRowsAll, layoutRow);
    }catch(e){
      console.error('[ADMIN] Erreur chargement tuiles', e);
      grid.innerHTML =
        '<div class="ppaca-card" style="max-width:920px;margin:0 auto;">'
        +'<div class="ppaca-card-body">'
        +'<p><strong>Impossible de charger les tuiles.</strong></p>'
        +'<p style="opacity:.85">Détail : <code>'+String(e && e.message ? e.message : e)+'</code></p>'
        +'<p style="opacity:.75">Astuce : sur GitHub Pages, il faut que <code>PP_GRIST_DOC_ID</code> (et éventuellement une clé API) soient bien fournis par <code>pp-config.js</code>.</p>'
        +'</div></div>';
      throw e;
    }
  }
  function initLock(){
    const overlay=document.getElementById('ppLockOverlay');
    const input=document.getElementById('ppLockInput');
    const err=document.getElementById('ppLockError');
    const at=document.getElementById('ppLockAttempts');
    const btnOk=document.getElementById('ppLockSubmit');
    const btnCancel=document.getElementById('ppLockCancel');

    function updateAttempts(){
      const rem = MAX_ATTEMPTS - attemptCount;
      at.textContent = (rem<MAX_ATTEMPTS && rem>0) ? ('Tentatives restantes : '+rem) : '';
    }
    function freeze(state){
      btnOk.disabled = state; btnCancel.disabled = state; input.disabled = state;
      btnOk.style.opacity = state ? .65 : 1;
      btnCancel.style.opacity = state ? .65 : 1;
    }
    async function handle(){
      if(accessGranted) return;
      const code = String(input.value||'').trim();
      if(!code){ err.textContent='Merci de saisir un code.'; return; }
      err.textContent='';
      freeze(true);
      try{
        let data=null;
        if(window.PP && PP.auth && typeof PP.auth.authWithCode==='function'){
          data = await PP.auth.authWithCode(code);
        }else{
          const res = await fetch('https://hpiqwvwpxzppxpxhjede.supabase.co/functions/v1/auth-code', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})
          });
          data = await res.json();
          if(!res.ok || !data.ok) throw new Error(data.error || ('HTTP '+res.status));
          try{ localStorage.setItem('pp_token', data.token);}catch(e){}
          try{ sessionStorage.setItem('pp_auth', JSON.stringify(data)); }catch(e){}
        }

        const role = (data && data.role) ? String(data.role) : '';
        if(role !== 'admin'){
          throw new Error("Rôle non autorisé ("+role+").");
        }

        accessGranted = true;
        overlay.style.transition='opacity 200ms ease-out';
        overlay.style.opacity='0';
        setTimeout(()=>{ overlay.style.display='none'; }, 220);
        await loadTiles();
      }catch(e){
        attemptCount++;
        updateAttempts();
        err.textContent = (e && e.message) ? e.message : 'Erreur de connexion.';
        if(attemptCount>=MAX_ATTEMPTS){
          err.textContent += '\nAccès refusé. Retour au portail…';
          setTimeout(()=>goHome(), 900);
        }else{
          freeze(false);
          input.value='';
          input.focus();
        }
      }
    }

    btnOk.addEventListener('click', handle);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); handle(); }});
    btnCancel.addEventListener('click', goHome);

    updateAttempts();
    setTimeout(()=>input.focus(), 50);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    try{ if(window.grist && typeof grist.ready==='function') grist.ready(); }catch(e){}
    initLock();
  });
</script>

<script src="https://preventionpaca.github.io/guide/js/pp-header.js?v=20260128a"></script>
</body>
</html>
