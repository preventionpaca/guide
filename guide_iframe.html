<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA – Vue intégrée</title>

  <link rel="preconnect" href="https://docs.getgrist.com">
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root {
      --bg: #020617;
      --grist-offset: 56px;
    }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); }
    #wrapper { position:fixed; inset:0; overflow:hidden; background:var(--bg); }
    #gristFrame { position:absolute; top:calc(-1 * var(--grist-offset)); left:0; width:100%; height:calc(100% + var(--grist-offset)); border:0; }
  </style>
</head>
<body>
  <div id="wrapper">
    <iframe id="gristFrame" src="about:blank" allowfullscreen></iframe>
  </div>

  <script>
    // Nettoyage / normalisation de l'URL qui arrive après le #
    // IMPORTANT : on ne touche PAS au fragment Grist "#?table=...&rowId=..."
    function cleanUrl(raw) {
      if (!raw) return "";

      let u = decodeURIComponent(raw.trim());

      // On sépare la partie "avant hash" et le fragment (ex: "#?table=...&rowId=...")
      const hashIndex = u.indexOf('#');
      const basePart  = (hashIndex >= 0) ? u.slice(0, hashIndex) : u;
      const hashPart  = (hashIndex >= 0) ? u.slice(hashIndex) : "";

      // 1) On nettoie seulement la partie base (query string), pas le hash Grist
      let base = basePart;

      // On enlève éventuellement des paramètres parasites
      base = base.replace(/([?&])(themeMode|tour|layout|view)=[^&]*/g, '$1');
      // On enlève d'éventuels anciens embed/style/exclude-headers pour éviter les doublons
      base = base.replace(/([?&])(embed|style|exclude-headers)=[^&]*/g, '$1');

      // Nettoyage des séparateurs ?/& résiduels
      base = base.replace(/[?&]$/,'');
      base = base.replace(/\?&/g,'?');

      // 2) On (re)pose les paramètres requis sur la query string
      const params = new URLSearchParams();
      // On repart de la query existante si elle existe
      const qIndex = base.indexOf('?');
      let origin = base;
      if (qIndex >= 0) {
        origin = base.slice(0, qIndex);
        const existingQs = base.slice(qIndex + 1);
        try { new URLSearchParams(existingQs).forEach((v,k)=>params.set(k,v)); } catch(e) {}
      }

      // Paramètres obligatoires
      params.set('style', 'singlePage');
      params.set('embed', 'true');
      params.set('exclude-headers', 'true');

      const rebuilt = origin + '?' + params.toString();

      // 3) On recolle le hash Grist intact (si présent)
      return rebuilt + hashPart;
    }

    function updateFrameFromHash() {
      const raw = window.location.hash ? window.location.hash.substring(1) : "";
      const url = cleanUrl(raw);
      if (!url) return;

      const frame = document.getElementById("gristFrame");
      if (frame.src !== url) frame.src = url;
    }

    updateFrameFromHash();
    window.addEventListener("hashchange", updateFrameFromHash);
  </script>
</body>
</html>
