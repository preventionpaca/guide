<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA – Vue intégrée</title>

  <link rel="preconnect" href="https://docs.getgrist.com">
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root{ --bg:#020617; --grist-offset:56px; }
    html,body{ margin:0; padding:0; height:100%; background:var(--bg); }
    #wrapper{ position:fixed; inset:0; overflow:hidden; background:var(--bg); }
    #gristFrame{ position:absolute; top:calc(-1 * var(--grist-offset)); left:0; width:100%; height:calc(100% + var(--grist-offset)); border:0; }
  </style>
</head>
<body>
  <div id="wrapper"><iframe id="gristFrame" src="about:blank" allowfullscreen></iframe></div>

  <script>
    // Decode defensively (QR scanners/OS may decode once, twice, or partially)
    function safeDecode(s, maxPasses=4){
      let out = (s || "").trim();
      for(let i=0;i<maxPasses;i++){
        try{
          const dec = decodeURIComponent(out);
          if(dec === out) break;
          out = dec;
        }catch(e){ break; }
      }
      return out;
    }

    function cleanBaseUrl(raw){
      if(!raw) return "";
      let u = safeDecode(raw, 4);

      // Drop any fragment/hash entirely; we rebuild a clean deep-link ourselves.
      u = u.split('#')[0];

      let url;
      try{ url = new URL(u); }catch(e){ return u; }

      // Remove noisy params
      ['themeMode','tour','layout','view','embed','style','exclude-headers','rowId','recordId','table'].forEach(k=>url.searchParams.delete(k));

      // Force embed params
      url.searchParams.set('style','singlePage');
      url.searchParams.set('embed','true');
      url.searchParams.set('exclude-headers','true');
      return url.toString();
    }

    function buildDeepLink(baseUrl, table, rowId){
      const r = String(rowId || '').trim();
      if(!r) return baseUrl;
      const t = String(table || '').trim();
      if(t) return baseUrl + '#?table=' + encodeURIComponent(t) + '&rowId=' + encodeURIComponent(r);
      return baseUrl + '#?rowId=' + encodeURIComponent(r);
    }

    function updateFrame(){
      const frame = document.getElementById('gristFrame');

      // Preferred: guide_iframe.html?src=<BASE_GRIST_URL>&table=...&rowId=...
      const usp = new URLSearchParams(window.location.search || '');
      const srcQ = usp.get('src');
      const tableQ = usp.get('table');
      const rowIdQ = usp.get('rowId') || usp.get('recordId');

      // Fallback legacy: hash
      const hashRaw = window.location.hash ? window.location.hash.substring(1) : '';
      const baseRaw = srcQ || hashRaw;
      if(!baseRaw) return;

      const base = cleanBaseUrl(baseRaw);
      const finalUrl = buildDeepLink(base, tableQ, rowIdQ);
      if(frame.src !== finalUrl) frame.src = finalUrl;
    }

    updateFrame();
    window.addEventListener('hashchange', updateFrame);
  </script>
</body>
</html>
