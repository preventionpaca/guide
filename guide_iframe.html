<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Prévention PACA – Vue intégrée</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    /* ====== BARRE HAUTE / FIL D’ARIANE ====== */

    .topbar {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, #0b1f3a 0, #020617 55%, #000 100%);
      font-size: 0.88rem;
    }

    .topbar-title {
      font-weight: 600;
      margin-right: 8px;
      white-space: nowrap;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
      color: #9ca3af;
    }

    .breadcrumb a {
      color: #e5e7eb;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .topbar-spacer {
      flex: 1;
    }

    .back-btn {
      flex: 0 0 auto;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 120ms ease-out, transform 120ms ease-out,
                  box-shadow 120ms ease-out, border-color 120ms ease-out;
    }

    .back-btn:hover {
      background: rgba(30, 64, 175, 0.9);
      border-color: rgba(191, 219, 254, 0.9);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.7);
      transform: translateY(-1px);
    }

    .back-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    /* ====== ZONE PRINCIPALE AVEC IFRAME ====== */

    .main {
      flex: 1 1 auto;
      min-height: 0;
      position: relative;
      background: #020617;
    }

    .frame-shell {
      position: absolute;
      inset: 0;
      overflow: hidden;
      background: #020617;
    }

    #gristFrame {
      width: 100%;
      height: 100%;
      border: 0;
      position: relative;
      top: 0;
      display: none; /* affiché seulement quand on a une URL */
    }

    /* Quand c’est une page Grist, on décale l’iframe vers le haut
       pour masquer le titre + filtres */
    body.is-grist #gristFrame {
      top: -48px;                 /* ajuste si besoin (42–60 px) */
      height: calc(100% + 48px);
    }

    /* ====== OVERLAY MESSAGE + SPINNER ====== */

    #message {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 10px;
      padding: 20px;
      text-align: center;
      font-size: 0.95rem;
      color: #e5e7eb;
      background: radial-gradient(circle at top, rgba(15,23,42,0.85) 0, rgba(2,6,23,0.95) 55%);
      z-index: 5;
    }

    #message code {
      background: rgba(15, 23, 42, 0.85);
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.8rem;
    }

    #message a {
      color: #38bdf8;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 3px solid rgba(148, 163, 184, 0.5);
      border-top-color: #38bdf8;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-title">Prévention PACA</div>

    <nav class="breadcrumb">
      <a id="portalLink" href="#">Portail</a>
      <span>&gt;</span>
      <span id="crumbLabel">Vue intégrée</span>
    </nav>

    <div class="topbar-spacer"></div>

    <button id="backBtn" class="back-btn" type="button">
      &#8592; Retour
    </button>
  </header>

  <main class="main">
    <div id="shell" class="frame-shell">
      <div id="message">
        <div class="spinner"></div>
        <div id="messageText">Chargement de la vue…</div>
      </div>
      <iframe
        id="gristFrame"
        loading="lazy"
        referrerpolicy="no-referrer"
      ></iframe>
    </div>
  </main>

  <script>
    (function () {
      // URL du portail (à adapter si tu changes de dossier)
      const PORTAL_URL = 'https://preventionpaca.github.io/guide/';

      const body        = document.body;
      const frame       = document.getElementById('gristFrame');
      const messageBox  = document.getElementById('message');
      const messageText = document.getElementById('messageText');
      const back        = document.getElementById('backBtn');
      const crumb       = document.getElementById('crumbLabel');
      const portalLink  = document.getElementById('portalLink');

      portalLink.href = PORTAL_URL;

      function showMessage(text) {
        messageText.innerHTML = text;
        messageBox.style.display = 'flex';
        frame.style.display = 'none';
      }

      function hideMessage() {
        messageBox.style.display = 'none';
        frame.style.display = 'block';
      }

      // Récupération de l’URL passée après #
      // ex : guide_iframe.html#https://docs.getgrist.com/...
      let url = window.location.hash ? window.location.hash.slice(1) : '';
      url = url.trim();

      // On essaye de décoder, mais sans planter si jamais il y a un % bizarre
      try {
        if (url) {
          url = decodeURIComponent(url);
        }
      } catch (e) {
        console.warn('decodeURIComponent a échoué, on garde l’URL brute :', e);
      }

      if (!url) {
        crumb.textContent = 'Aucune vue sélectionnée';
        showMessage(
          'Aucune URL de vue n’a été fournie.<br><br>' +
          'Utilisez cette page en ajoutant l’URL après le <code>#</code>, par exemple :<br>' +
          '<code>https://preventionpaca.github.io/guide/guide_iframe.html#https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/59?embed=true</code>'
        );
      } else {
        crumb.textContent = 'Outil';

        // On affiche le spinner + message
        showMessage('Chargement de la vue…');

        let loaded = false;

        frame.addEventListener('load', () => {
          loaded = true;
          hideMessage();
        });

        // Fallback : si au bout de 7 secondes rien n’a chargé,
        // on arrête le spinner et on explique le problème.
        setTimeout(() => {
          if (!loaded) {
            messageText.innerHTML =
              'Impossible de charger la vue demandée.<br><br>' +
              'Il est possible que le site cible bloque l’affichage dans une iframe ' +
              '(ex. certains services externes), ou que l’URL soit incorrecte.';
            // On arrête seulement l’animation visuelle en supprimant le spinner
            const spin = messageBox.querySelector('.spinner');
            if (spin) {
              spin.style.display = 'none';
            }
          }
        }, 7000);

        frame.src = url;

        if (url.indexOf('docs.getgrist.com') !== -1) {
          body.classList.add('is-grist');
        }
      }

      // Bouton "Retour" : on renvoie systématiquement vers le portail
      back.addEventListener('click', () => {
        window.location.href = PORTAL_URL;
      });
    })();
  </script>
</body>
</html>
