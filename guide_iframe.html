<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prévention PACA – Vue intégrée</title>
<link rel="preconnect" href="https://docs.getgrist.com">
<link rel="dns-prefetch" href="https://docs.getgrist.com">
<style>
:root{--bg:#020617;--grist-offset:56px}
html,body{margin:0;padding:0;height:100%;background:var(--bg)}
#wrapper{position:fixed;inset:0;overflow:hidden;background:var(--bg)}
#gristFrame{position:absolute;top:calc(-1*var(--grist-offset));left:0;width:100%;height:calc(100% + var(--grist-offset));border:0;background:#0b1220}
#ppBadge{position:fixed;right:10px;bottom:10px;z-index:99999;font:12px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:rgba(226,232,240,.85);
background:rgba(2,6,23,.55);border:1px solid rgba(148,163,184,.18);border-radius:999px;padding:6px 10px;user-select:none;pointer-events:none}
#ppDebug{position:fixed;left:10px;right:10px;top:10px;z-index:99999;display:none;
font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
color:#e2e8f0;background:rgba(2,6,23,.82);border:1px solid rgba(148,163,184,.25);border-radius:12px;padding:10px;white-space:pre-wrap}
</style>
</head>
<body>
<div id="wrapper"><iframe id="gristFrame" src="about:blank" allowfullscreen></iframe></div>
<div id="ppBadge">guide_iframe V19_rowid_hash_only</div>
<div id="ppDebug"></div>
<script>
  // V20 : priorité à src= (conserve #a1.s452.rX), sinon fallback home/page/rowId
  const HOME_PAGE = 'https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/59';
  const DOC_BASE  = 'https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/';
  const DEFAULT_TABLE = 'Liste_des_equipements';

  // IMPORTANT : ton "prefix" d’ancre Grist (celui que tu as trouvé)
  // On l'utilise seulement si on doit reconstruire une URL à partir de rowId
  const GRIST_ANCHOR_PREFIX = 'a1.s452.r';

  function decodeMany(s, max=4) {
    let out = (s || "");
    for (let i=0;i<max;i++) {
      try {
        const dec = decodeURIComponent(out);
        if (dec === out) break;
        out = dec;
      } catch(e) { break; }
    }
    return out;
  }

  function qs() { return new URLSearchParams(window.location.search); }

  function readRowId() {
    const sp = qs();
    return sp.get("rowId") || sp.get("recordId") || "";
  }

  function readTableName() {
    const sp = qs();
    return sp.get("table") || DEFAULT_TABLE;
  }

  function readPageParamUrl() {
    const sp = qs();
    const page = sp.get("page");
    if (!page) return "";
    if (!/^\d+$/.test(page)) return "";
    return DOC_BASE + page;
  }

  // Conserve le hash si présent (#a1.s452.rX)
  function ensureEmbedParamsPreserveHash(fullUrl) {
    const u = new URL(fullUrl);
    const h = u.hash; // on garde le hash tel quel
    u.searchParams.set("embed","true");
    u.searchParams.set("style","singlePage");
    u.searchParams.set("exclude-headers","true");
    u.hash = h; // on le remet
    return u;
  }

  // Si on doit reconstruire à partir d’un rowId (sans src), on utilise l’ancre fiable
  function addAnchorRow(u, rowId) {
    if (!rowId) return u;
    u.hash = GRIST_ANCHOR_PREFIX + encodeURIComponent(String(rowId));
    return u;
  }

  function buildInitialTarget() {
    const sp = qs();

    // 1) src= a PRIORITÉ ABSOLUE (QR code mobile-safe)
    const srcRaw = sp.get("src");
    const src = srcRaw ? decodeMany(srcRaw, 4) : "";

    // 2) fallback page=...
    const pageTarget = readPageParamUrl();

    // 3) fallback HOME
    const rowId = readRowId();
    const tableName = readTableName();

    let finalUrl;
    let reason = "";

    if (src && /^https?:\/\//i.test(src)) {
      // On ne touche PAS au hash de src (sinon on perd rX)
      const u = ensureEmbedParamsPreserveHash(src);
      finalUrl = u.toString();
      reason = "srcParam";
    } else {
      // Pas de src => on construit une URL
      const base = (pageTarget || HOME_PAGE);
      const u = ensureEmbedParamsPreserveHash(base);
      // Si on a rowId, on met l’ancre Grist robuste
      addAnchorRow(u, rowId);
      finalUrl = u.toString();
      reason = pageTarget ? "pageParam" : "home";
    }

    return {
      iframeSrc: finalUrl,
      reason,
      srcParam: src,
      pageTarget,
      rowId,
      table: tableName
    };
  }

  (function initOnce() {
    const data = buildInitialTarget();
    document.getElementById("gristFrame").src = data.iframeSrc;

    if (qs().get("debug") === "1") {
      const d = document.getElementById("ppDebug");
      if (d){
        d.style.display = "block";
        d.textContent =
          "Wrapper: V20_src_priority_anchor\n" +
          "location.href: " + window.location.href + "\n\n" +
          "reason: " + data.reason + "\n" +
          "pageTarget: " + (data.pageTarget || "(none)") + "\n" +
          "srcParam: " + (data.srcParam || "(none)") + "\n" +
          "rowId: " + (data.rowId || "(none)") + "\n" +
          "table: " + (data.table || "(none)") + "\n\n" +
          "iframe.src: " + data.iframeSrc;
      }
    }
  })();
</script>

</body>
</html>

