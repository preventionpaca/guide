<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Portail prévention PACA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Script Grist -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    :root {
      --bg: #041221;
      --card: #1b396a;
      --card-hover: #24508f;
      --card-active: #122548;
      --text: #ffffff;
      --muted: #cbd5f5;
      --green: #059669;
      --orange: #ea580c;
      --dark: #020617;
      --shadow-soft: 0 8px 16px rgba(0, 0, 0, 0.35);
      --shadow-pressed: inset 0 4px 6px rgba(0, 0, 0, 0.45);
      --radius: 16px;

      --grid-columns: 4;

      --tile-min-height: 145px;
      --tile-gap: 16px;
      --tile-padding: 12px;
      --title-size: 0.9rem;
      --desc-size: 0.75rem;
      --icon-size: 38px;
    }

    body.light-theme {
      --bg: #f3f4f6;
      --card: #ffffff;
      --card-hover: #e5f0ff;
      --card-active: #dbeafe;
      --text: #111827;
      --muted: #4b5563;
      --shadow-soft: 0 8px 14px rgba(15, 23, 42, 0.12);
      --shadow-pressed: inset 0 3px 5px rgba(148, 163, 184, 0.8);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #0b1f3a 0, var(--bg) 50%, #020814 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      padding: 16px 10px 12px;
      transition: background 200ms ease-out, color 200ms ease-out;
    }

    body.light-theme {
      background: radial-gradient(circle at top, #e5edff 0, #f3f4f6 45%, #e5e7eb 100%);
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0);      }
    }

    .portal-outer {
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .portal-wrapper {
      width: 100%;
      max-width: 1180px;
      margin: 0 auto;
      min-height: calc(100vh - 32px);
      display: flex;
      flex-direction: column;
      animation: fadeInUp 450ms ease-out both;
    }

    .portal-header {
      margin-bottom: 10px;
      position: relative;
    }

    .logo-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
      padding-right: 120px;
    }

    .logo-block {
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      font-size: 0.72rem;
      line-height: 1.3;
      color: var(--muted);
      text-align: center;
      white-space: nowrap;
    }

    body.light-theme .logo-block {
      background: #e5edf8;
      color: #1f2937;
    }

    .portal-title {
      font-size: clamp(1.5rem, 2vw, 1.9rem);
      font-weight: 700;
      text-align: center;
      margin-top: 4px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .portal-subtitle {
      text-align: center;
      margin-top: 4px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .header-separator {
      width: min(240px, 40%);
      height: 1px;
      margin: 8px auto 0;
      background: linear-gradient(
        to right,
        transparent,
        rgba(255, 255, 255, 0.7),
        transparent
      );
      opacity: 0.8;
    }

    body.light-theme .header-separator {
      background: linear-gradient(
        to right,
        transparent,
        rgba(15, 23, 42, 0.35),
        transparent
      );
    }

    .header-tools {
      position: absolute;
      top: 0;
      right: 0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .theme-toggle {
      font-size: 0.72rem;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      background: rgba(0, 0, 0, 0.18);
      color: var(--text);
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      transition: background 150ms ease-out, transform 150ms ease-out,
                  box-shadow 150ms ease-out, border-color 150ms ease-out;
    }

    body.light-theme .theme-toggle {
      background: #ffffff;
      border-color: #cbd5e1;
      color: #111827;
    }

    .theme-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .theme-toggle:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .page-nav {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.78rem;
    }

    .page-nav a {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      text-decoration: none;
      color: var(--muted);
      background: rgba(0,0,0,0.16);
      transition: background 120ms ease-out, color 120ms ease-out, border-color 120ms ease-out;
    }

    .page-nav a.active {
      color: var(--text);
      border-color: rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.12);
    }

    .page-nav a.nav-admin {
      background: #020617;
      border-color: #020617;
      color: #f9fafb;
    }
    .page-nav a.nav-admin:hover,
    .page-nav a.nav-admin.active {
      background: #0b1120;
      border-color: #020617;
      color: #ffffff;
    }

    .page-nav a.nav-ddfpt {
      background: #059669;
      border-color: #059669;
      color: #f9fafb;
    }
    .page-nav a.nav-ddfpt:hover,
    .page-nav a.nav-ddfpt.active {
      background: #047857;
      border-color: #059669;
      color: #ffffff;
    }

    body.light-theme .page-nav a {
      border-color: #cbd5e1;
      background: #ffffff;
      color: #4b5563;
    }
    body.light-theme .page-nav a.active {
      background: #1b396a;
      color: #f9fafb;
      border-color: #1b396a;
    }

    body.light-theme .page-nav a.nav-admin,
    body.light-theme .page-nav a.nav-admin.active {
      background: #020617;
      border-color: #020617;
      color: #f9fafb;
    }
    body.light-theme .page-nav a.nav-ddfpt,
    body.light-theme .page-nav a.nav-ddfpt.active {
      background: #059669;
      border-color: #059669;
      color: #f9fafb;
    }

    .tile-frame {
      margin-top: 14px;
      margin-bottom: 4px;
      padding: 16px;
      border-radius: 22px;
      border: 6px solid #f97316;
      background: rgba(0, 0, 0, 0.12);
    }

    body.light-theme .tile-frame {
      background: #f3f4f6;
      border-color: #f97316;
    }

    .tile-grid {
      flex: 1 0 auto;
      display: grid;
      justify-content: center;
      grid-template-columns: repeat(var(--grid-columns), minmax(0, 1fr));
      grid-auto-rows: minmax(var(--tile-min-height), auto);
      gap: var(--tile-gap);
      margin-top: 0;
      margin-bottom: 0;
      align-content: flex-start;
    }

    .tile {
      position: relative;
      min-height: var(--tile-min-height);
      border-radius: var(--radius);
      padding: var(--tile-padding);
      background: linear-gradient(145deg, var(--card), #284a86);
      box-shadow: var(--shadow-soft);
      text-decoration: none;
      color: var(--text);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
      transition:
        transform 140ms ease-out,
        box-shadow 140ms ease-out,
        background 140ms ease-out,
        color 140ms ease-out;
    }

    .tile:hover {
      transform: translateY(-3px);
      background: linear-gradient(145deg, var(--card-hover), #2f5ea1);
      box-shadow: 0 14px 22px rgba(0, 0, 0, 0.45);
    }

    .tile:active {
      transform: translateY(0);
      box-shadow: var(--shadow-pressed);
      background: linear-gradient(145deg, var(--card-active), #1d4b84);
    }

    body.light-theme .tile:not(.tile--green):not(.tile--orange):not(.tile--dark):not(.tile--brown-light):not(.tile--brown-dark):not(.tile--gray-light):not(.tile--white) {
      background: linear-gradient(145deg, #ffffff, #e5edf8);
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.35);
    }
    body.light-theme .tile:not(.tile--green):not(.tile--orange):not(.tile--dark):not(.tile--brown-light):not(.tile--brown-dark):not(.tile--gray-light):not(.tile--white):hover {
      background: linear-gradient(145deg, #f9fafb, #dde9ff);
    }
    body.light-theme .tile:not(.tile--green):not(.tile--orange):not(.tile--dark):not(.tile--brown-light):not(.tile--brown-dark):not(.tile--gray-light):not(.tile--white):active {
      background: linear-gradient(145deg, #e5e7eb, #d4def5);
    }

    .tile--white {
      background: #ffffff;
      color: #111827;
    }
    .tile--white:hover {
      background: #f3f4f6;
      box-shadow: 0 14px 22px rgba(15,23,42,0.16);
    }
    .tile--white:active {
      background: #e5e7eb;
      box-shadow: var(--shadow-pressed);
    }
    .tile--white .tile-desc {
      color: #4b5563;
    }
    .tile--white .tile-icon {
      background: #1f2937;
      border-color: #0f172a;
      color: #f9fafb;
    }

    .tile--green {
      background: linear-gradient(145deg, #059669, #22c55e);
    }
    .tile--green:hover {
      background: linear-gradient(145deg, #16a34a, #22c55e);
    }
    .tile--green:active {
      background: linear-gradient(145deg, #15803d, #16a34a);
    }

    .tile--orange {
      background: linear-gradient(145deg, #f97316, #fdba74);
      box-shadow: 0 10px 20px rgba(249, 115, 22, 0.45);
    }
    .tile--orange:hover {
      background: linear-gradient(145deg, #fb923c, #fed7aa);
      box-shadow: 0 14px 24px rgba(249, 115, 22, 0.55);
    }
    .tile--orange:active {
      background: linear-gradient(145deg, #ea580c, #f97316);
      box-shadow: var(--shadow-pressed);
    }

    .tile--dark {
      background: linear-gradient(145deg, #020617, #020617);
    }
    .tile--dark:hover {
      background: linear-gradient(145deg, #111827, #020617);
    }
    .tile--dark:active {
      background: linear-gradient(145deg, #020617, #000000);
    }

    .tile--brown-light {
      background: linear-gradient(145deg, #fbbf24, #fed7aa);
      box-shadow: 0 10px 20px rgba(217, 119, 6, 0.35);
      color: #111827;
    }
    .tile--brown-light:hover {
      background: linear-gradient(145deg, #facc15, #fee2b3);
      box-shadow: 0 14px 24px rgba(217, 119, 6, 0.45);
    }
    .tile--brown-light:active {
      background: linear-gradient(145deg, #eab308, #fbbf24);
      box-shadow: var(--shadow-pressed);
    }

    .tile--brown-dark {
      background: linear-gradient(145deg, #7c2d12, #b45309);
      box-shadow: 0 10px 20px rgba(124, 45, 18, 0.55);
    }
    .tile--brown-dark:hover {
      background: linear-gradient(145deg, #9a3412, #ea580c);
      box-shadow: 0 14px 24px rgba(124, 45, 18, 0.65);
    }
    .tile--brown-dark:active {
      background: linear-gradient(145deg, #4a1d0b, #c2410c);
      box-shadow: var(--shadow-pressed);
    }

    .tile--gray-light {
      background: linear-gradient(145deg, #4b5563, #6b7280);
    }
    .tile--gray-light:hover {
      background: linear-gradient(145deg, #6b7280, #9ca3af);
    }
    .tile--gray-light:active {
      background: linear-gradient(145deg, #374151, #4b5563);
    }

    .tile--tall { grid-row: span 2; }
    .tile--wide { grid-column: span 2; }

    .tile-icon {
      width: var(--icon-size);
      height: var(--icon-size);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.78rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 6px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.16), rgba(255, 255, 255, 0.02));
      backdrop-filter: blur(3px);
    }

    .tile-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .tile-title {
      font-size: var(--title-size);
      font-weight: 600;
      line-height: 1.25;
    }

    .tile-desc {
      font-size: var(--desc-size);
      color: var(--muted);
      line-height: 1.15;
      margin-top: 4px;
    }

    .tile--green .tile-desc,
    .tile--orange .tile-desc,
    .tile--dark .tile-desc,
    .tile--brown-dark .tile-desc,
    .tile--gray-light .tile-desc {
      color: rgba(255, 255, 255, 0.94);
    }

    .tile--brown-light .tile-title,
    .tile--brown-light .tile-desc {
      color: #111827;
    }
    .tile--brown-light .tile-icon {
      border-color: rgba(15, 23, 42, 0.5);
      color: #111827;
      background: rgba(255, 255, 255, 0.5);
    }

    .tile-bottom-links {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.72rem;
    }

    .tile-link {
      text-decoration: none;
      color: inherit;
      opacity: 0.95;
    }

    .tile-link:hover { text-decoration: underline; }

    .news-viewport {
      margin-top: 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.55);
      padding: 8px 10px;
      overflow: hidden;
      position: relative;
      max-height: 200px;
      min-height: 160px;
    }

    body.light-theme .news-viewport {
      background: #e5edf8;
    }

    .tile--tall .news-viewport {
      max-height: 230px;
      min-height: 180px;
    }

    .news-track {
      display: flex;
      flex-direction: column;
      gap: 4px;
      animation: newsScroll 18s linear infinite;
    }

    .news-viewport:hover .news-track {
      animation-play-state: paused;
    }

    .news-item {
      font-size: 0.75rem;
      color: #e5e7eb;
      text-decoration: none;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    body.light-theme .news-item {
      color: #1f2937;
    }

    .news-item:hover {
      text-decoration: underline;
      color: #ffffff;
    }

    body.light-theme .news-item:hover {
      color: #111827;
    }

    @keyframes newsScroll {
      0%   { transform: translateY(0); }
      100% { transform: translateY(-50%); }
    }

    .portal-footer {
      margin-top: 4px;
      padding-top: 4px;
      font-size: 0.7rem;
      text-align: center;
      color: var(--muted);
      opacity: 0.9;
    }

    body[data-page="Portail"] .tile-grid {
      max-width: 1180px;
    }

    body[data-page="Acces_Admin"] .tile-grid,
    body[data-page="Acces_DDFPT"] .tile-grid {
      max-width: 1100px;
    }

    body[data-page="Acces_Admin"] .tile,
    body[data-page="Acces_DDFPT"] .tile {
      min-height: 180px;
      max-height: 260px;
    }

    @media (max-width: 900px) {
      .tile-grid {
        grid-template-columns: repeat(2, minmax(160px, 1fr));
      }
      .tile--wide {
        grid-column: span 2;
      }
      .logo-row {
        padding-right: 0;
      }
    }

    @media (max-width: 600px) {
      body { padding: 14px 8px; }

      .header-tools {
        position: static;
        margin: 0 auto 6px;
        justify-content: center;
      }

      .portal-header { padding-top: 2px; }
      .logo-block { white-space: normal; }
    }
  </style>
</head>
<body>
  <div class="portal-outer">
    <div class="portal-wrapper">
      <header class="portal-header">
        <div class="header-tools">
          <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="false">
            Mode clair
          </button>
        </div>

        <div id="logoRow" class="logo-row"></div>

        <h1 id="mainTitle" class="portal-title">Portail prévention PACA</h1>
        <p id="subTitle" class="portal-subtitle">
          Accès centralisé aux outils de prévention, dérogations et évaluations des risques.
        </p>

        <div class="header-separator"></div>
        <nav id="pageNav" class="page-nav"></nav>
      </header>

      <section class="tile-frame">
        <main id="tileGrid" class="tile-grid"></main>
      </section>

      <footer class="portal-footer" id="footerText">
        Portail prévention PACA — D.R.E.E.T.S / D.R.A.A.F PACA — Région académique Aix-Marseille &amp; Nice —
        CFA académique de Nice (GIP FIPAN)
      </footer>
    </div>
  </div>

  <script>
    const PAGE_NAME = 'Portail';

    function rowsToRecordsCompat(table) {
      if (window.grist && typeof grist.rowsToRecords === 'function') {
        return grist.rowsToRecords(table);
      }
      const ids = table.id || [];
      const records = [];
      let columnArrays = {};

      if (table.fields && typeof table.fields === 'object') {
        columnArrays = table.fields;
      } else {
        for (const [key, value] of Object.entries(table)) {
          if (key === 'id') continue;
          if (Array.isArray(value)) {
            columnArrays[key] = value;
          }
        }
      }

      for (let i = 0; i < ids.length; i++) {
        const rec = { id: ids[i] };
        for (const [col, values] of Object.entries(columnArrays)) {
          rec[col] = values[i];
        }
        records.push(rec);
      }
      return records;
    }

    function normalizeName(v) {
      if (!v) return '';
      let s = String(v).trim().toLowerCase();
      try {
        s = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      } catch (e) {}
      s = s.replace(/[_\s]+/g, ' ');
      s = s.replace(/\s+/g, ' ');
      return s;
    }

    function colorToClass(c) {
      if (!c) return '';
      const v = String(c).toLowerCase();
      if (v.includes('blanc')) return 'tile--white';
      if (v.includes('vert')) return 'tile--green';
      if (v.includes('orange')) return 'tile--orange';
      if (v.includes('noir')) return 'tile--dark';
      if (v.includes('marron clair')) return 'tile--brown-light';
      if (v.includes('marron fon')) return 'tile--brown-dark';
      if (v.includes('gris')) return 'tile--gray-light';
      return '';
    }

    function truncate(str, n) {
      const s = String(str || '');
      return s.length > n ? s.slice(0, n - 1) + '…' : s;
    }

    function normalizeUrl(url) {
      if (!url) return '';
      const u = String(url).trim();
      if (!u) return '';
      if (/^https?:\/\//i.test(u)) return u;
      return 'https://' + u;
    }

    // Base du wrapper GitHub
    const WRAPPER_BASE = 'https://preventionpaca.github.io/guide/guide_iframe.html#';

    // Choix du mode d'ouverture (wrapper ou direct)
    function makePortalUrl(url, modeOuverture) {
      const u = normalizeUrl(url);
      if (!u) return '';

      const m = (modeOuverture || '').toString().trim().toLowerCase();

      // si "direct" : on ouvre l'URL telle quelle
      if (m === 'direct') {
        return u;
      }

      // sinon : si c'est une URL Grist, on passe par le wrapper, sinon direct
      if (u.includes('docs.getgrist.com')) {
        return WRAPPER_BASE + u;
      }
      return u;
    }

    function buildHeader(configRows) {
      const logoRow = document.getElementById('logoRow');
      const footerEl = document.getElementById('footerText');
      logoRow.innerHTML = '';

      if (!configRows.length) return;
      const row = configRows[0];

      if (row.Header) {
        const lines = String(row.Header).split(/\r?\n/);
        lines.forEach(l => {
          const txt = l.trim();
          if (!txt) return;
          const div = document.createElement('div');
          div.className = 'logo-block';
          div.textContent = txt;
          logoRow.appendChild(div);
        });
      }

      if (row.Footer) {
        footerEl.textContent = row.Footer;
      }
    }

    function buildPageHeader(pagesRows) {
      const mainTitle = document.getElementById('mainTitle');
      const subTitle = document.getElementById('subTitle');
      const nav = document.getElementById('pageNav');

      const currentNorm = normalizeName(PAGE_NAME);
      const current = pagesRows.find(
        p => normalizeName(p.Nom_page) === currentNorm
      ) || null;

      if (current) {
        if (current.Titre_principal) mainTitle.textContent = current.Titre_principal;
        if (current.Sous_titre) subTitle.textContent = current.Sous_titre;
      }

      nav.innerHTML = '';
      pagesRows.forEach(p => {
        const a = document.createElement('a');
        a.textContent = p.Titre_principal || p.Nom_page || 'Page';

        const url = makePortalUrl(p.Url_page, p.Mode_ouverture);
        a.href = url || '#';   // même onglet

        const normName = normalizeName(p.Nom_page);

        if (normName === normalizeName('Acces_Admin')) {
          a.classList.add('nav-admin');
        }
        if (normName === normalizeName('Acces_DDFPT')
            || normName === normalizeName('Accès_DDFPT')) {
          a.classList.add('nav-ddfpt');
        }

        if (normName === currentNorm) {
          a.classList.add('active');
        }
        nav.appendChild(a);
      });
    }

    function buildTiles(blocsRowsAll, filInfoRows, layoutRow) {
      const grid = document.getElementById('tileGrid');
      grid.innerHTML = '';

      const layoutCols = layoutRow && layoutRow.Nbre_colonne
        ? Number(layoutRow.Nbre_colonne) || 4
        : 4;

      const maxBlocks = layoutRow && layoutRow.Nbre_Bloc
        ? Number(layoutRow.Nbre_Bloc) || blocsRowsAll.length
        : blocsRowsAll.length;

      if (!blocsRowsAll.length) {
        const msg = document.createElement('div');
        msg.style.gridColumn = '1 / -1';
        msg.style.padding = '12px 16px';
        msg.style.borderRadius = '12px';
        msg.style.background = 'rgba(220, 38, 38, 0.12)';
        msg.style.border = '1px solid rgba(248, 113, 113, 0.4)';
        msg.style.fontSize = '0.8rem';
        msg.textContent =
          `Aucun bloc trouvé pour la page "${PAGE_NAME}". ` +
          `Vérifie la colonne "Page" dans la table "Blocs".`;
        grid.appendChild(msg);
        return;
      }

      const blocsRows = blocsRowsAll
        .slice()
        .sort((a, b) => (a.num_bloc || 0) - (b.num_bloc || 0))
        .slice(0, maxBlocks);

      const nbBlocs = blocsRows.length;

      const cssCols = Math.min(layoutCols, nbBlocs || layoutCols);
      document.documentElement.style.setProperty('--grid-columns', cssCols);

      const cols = layoutCols;

      const counts = {};
      blocsRows.forEach(b => {
        const t = b.Titre_bloc || '';
        counts[t] = (counts[t] || 0) + 1;
      });
      const duplicates = new Set(Object.keys(counts).filter(t => counts[t] > 1));
      const already = new Set();

      const newsNorm = normalizeName('Fil info');
      const byTitle = {};
      blocsRows.forEach(b => {
        const t = b.Titre_bloc || '';
        if (!byTitle[t]) byTitle[t] = [];
        byTitle[t].push(b);
      });

      blocsRows.forEach(bloc => {
        const title = bloc.Titre_bloc || '';
        const dup = duplicates.has(title);
        if (dup) {
          if (already.has(title)) return;
          already.add(title);
        }

        const tile = document.createElement('div');
        tile.className = 'tile';

        const colorClass = colorToClass(bloc.Couleur);
        if (colorClass) tile.classList.add(colorClass);

        if (dup && byTitle[title].length === 2) {
          const [b1, b2] = byTitle[title].sort((x, y) => x.num_bloc - y.num_bloc);
          const pos1 = (b1.num_bloc || 1) - 1;
          const pos2 = (b2.num_bloc || 1) - 1;
          const r1 = Math.floor(pos1 / cols), c1 = pos1 % cols;
          const r2 = Math.floor(pos2 / cols), c2 = pos2 % cols;

          if (normalizeName(title) === newsNorm) {
            tile.classList.add('tile--tall');
          } else if (r1 === r2 && Math.abs(c1 - c2) === 1) {
            tile.classList.add('tile--wide');
          } else if (c1 === c2 && Math.abs(r1 - r2) === 1) {
            tile.classList.add('tile--tall');
          }
        }

        const icon = document.createElement('div');
        icon.className = 'tile-icon';
        icon.textContent = bloc.Initiale_bloc || '';
        tile.appendChild(icon);

        const main = document.createElement('div');
        main.className = 'tile-main';
        tile.appendChild(main);

        const titleEl = document.createElement('div');
        titleEl.className = 'tile-title';
        titleEl.textContent = title || '(sans titre)';
        main.appendChild(titleEl);

        const descEl = document.createElement('div');
        descEl.className = 'tile-desc';
        descEl.textContent = bloc.Sous_titre1 || '';
        main.appendChild(descEl);

        const isNews = normalizeName(title) === newsNorm;

        if (isNews && filInfoRows.length) {
          tile.style.cursor = 'default';

          const viewport = document.createElement('div');
          viewport.className = 'news-viewport';
          const track = document.createElement('div');
          track.className = 'news-track';
          viewport.appendChild(track);

          const makeItem = row => {
            const a = document.createElement('a');
            a.className = 'news-item';

            const t = row.Titre || '';
            const st = row.Sous_titre || '';
            const c = truncate(row.Contenu || '', 20);
            a.textContent = `${t} — ${st} : ${c}`;

            const url = makePortalUrl(row.Lien, row.Mode_ouverture);
            if (url) {
              a.href = url;   // même onglet
            } else {
              a.href = '#';
            }
            return a;
          };

          const items = filInfoRows.map(makeItem);
          [...items, ...items].forEach(it => track.appendChild(it));
          main.appendChild(viewport);

        } else {
          const sousG = bloc.Sous_titre_G;
          const sousD = bloc.Sous_titre_D;

          if (sousG || sousD) {
            const bottom = document.createElement('div');
            bottom.className = 'tile-bottom-links';

            if (sousG) {
              const aG = document.createElement('a');
              aG.className = 'tile-link';
              aG.textContent = sousG;
              if (bloc.Url_G) {
                const urlG = makePortalUrl(bloc.Url_G, bloc.Mode_ouverture);
                aG.href = urlG || '#';
              } else {
                aG.href = '#';
              }
              bottom.appendChild(aG);
            }

            if (sousD) {
              const aD = document.createElement('a');
              aD.className = 'tile-link';
              aD.textContent = sousD;
              if (bloc.Url_D) {
                const urlD = makePortalUrl(bloc.Url_D, bloc.Mode_ouverture);
                aD.href = urlD || '#';
              } else {
                aD.href = '#';
              }
              bottom.appendChild(aD);
            }

            main.appendChild(bottom);

          } else if (bloc.Url_bloc) {
            const urlBloc = makePortalUrl(bloc.Url_bloc, bloc.Mode_ouverture);

            tile.addEventListener('click', () => {
              if (!urlBloc) return;
              window.location.href = urlBloc;   // même onglet
            });
            tile.tabIndex = 0;
            tile.setAttribute('role', 'link');
            tile.addEventListener('keypress', e => {
              if ((e.key === 'Enter' || e.key === ' ') && urlBloc) {
                e.preventDefault();
                tile.click();
              }
            });
          }
        }

        grid.appendChild(tile);
      });
    }

    async function loadFromGrist() {
      const doc = grist.docApi;

      const [tConfig, tPages, tAgenc, tBlocs, tFil] = await Promise.all([
        doc.fetchTable('Config_site'),
        doc.fetchTable('Pages'),
        doc.fetchTable('Agencement_portail'),
        doc.fetchTable('Blocs'),
        doc.fetchTable('Fil_info'),
      ]);

      const configRows = rowsToRecordsCompat(tConfig);
      const pagesRows  = rowsToRecordsCompat(tPages);
      const agRows     = rowsToRecordsCompat(tAgenc);
      const blocsAll   = rowsToRecordsCompat(tBlocs);
      const filInfo    = rowsToRecordsCompat(tFil);

      if (configRows.length) buildHeader(configRows);
      if (pagesRows.length)  buildPageHeader(pagesRows);

      const currentNorm = normalizeName(PAGE_NAME);

      let agencementName = PAGE_NAME;
      if (currentNorm === normalizeName('Portail')) {
        agencementName = 'Accueil';
      } else if (currentNorm === normalizeName('Acces_Admin')) {
        agencementName = 'Accès Admin';
      } else if (currentNorm === normalizeName('Acces_DDFPT')) {
        agencementName = 'Accès DDFPT';
      }

      const layoutRow =
        agRows.find(r => normalizeName(r.Page) === normalizeName(agencementName)) ||
        agRows[0] || null;

      const blocsPageName = PAGE_NAME;
      const blocsRowsAll = blocsAll.filter(
        b => normalizeName(b.Page) === normalizeName(blocsPageName)
      );

      buildTiles(blocsRowsAll, filInfo, layoutRow);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const body = document.body;
      body.dataset.page = PAGE_NAME;

      const toggle = document.getElementById('themeToggle');

      try {
        const saved = localStorage.getItem('ppaca-theme');
        if (saved === 'light') {
          body.classList.add('light-theme');
          toggle.textContent = 'Mode sombre';
          toggle.setAttribute('aria-pressed', 'true');
        }
      } catch (e) {}

      toggle.addEventListener('click', () => {
        const isLight = body.classList.toggle('light-theme');
        toggle.textContent = isLight ? 'Mode sombre' : 'Mode clair';
        toggle.setAttribute('aria-pressed', isLight ? 'true' : 'false');
        try {
          localStorage.setItem('ppaca-theme', isLight ? 'light' : 'dark');
        } catch (e) {}
      });

      if (window.grist) {
        grist.ready();
        loadFromGrist().catch(err => console.error('Erreur chargement Grist', err));
      } else {
        console.warn('Grist API non disponible');
      }
    });
  </script>
</body>
</html>
