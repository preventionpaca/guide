<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA – V</title>

  <link rel="preconnect" href="https://docs.getgrist.com">
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root {
      --bg: #020617;
      --grist-offset: 56px; /* ajuste si besoin */
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
    }
    #wrapper {
      position: fixed;
      inset: 0;
      overflow: hidden;
      background: var(--bg);
    }
    #gristFrame {
      position: absolute;
      top: calc(-1 * var(--grist-offset));
      left: 0;
      width: 100%;
      height: calc(100% + var(--grist-offset));
      border: 0;
      background: #0b1220;
    }

    /* Indicateur discret version */
    #ppVer {
      position: fixed;
      right: 10px;
      bottom: 10px;
      z-index: 99999;
      font: 12px/1 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: rgba(226,232,240,.8);
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.18);
      border-radius: 999px;
      padding: 6px 10px;
      user-select: none;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <iframe id="gristFrame" src="about:blank" allowfullscreen></iframe>
  </div>
  <div id="ppVer">guide_iframe V18</div>

  <script>
    // V18 : chargement INITIAL uniquement.
    // => On NE réagit PAS aux hashchange ensuite, pour ne pas casser/ralentir la navigation interne Grist.

    const HOME_PAGE = 'https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/59';
    const DEFAULT_TABLE = 'Liste_des_equipements';

    function decodeMany(s, max=4) {
      let out = (s || "");
      for (let i=0;i<max;i++) {
        try {
          const dec = decodeURIComponent(out);
          if (dec === out) break;
          out = dec;
        } catch(e) { break; }
      }
      return out;
    }

    function readRowId() {
      const sp = new URLSearchParams(window.location.search);
      return sp.get("rowId") || sp.get("recordId") || "";
    }

    function readTableName() {
      const sp = new URLSearchParams(window.location.search);
      return sp.get("table") || DEFAULT_TABLE;
    }

    function readHashTargetUrl() {
      if (!window.location.hash || window.location.hash.length <= 1) return "";
      const raw = window.location.hash.substring(1);
      const decoded = decodeMany(raw, 4);
      if (/^https?:\/\//i.test(decoded)) return decoded;
      return "";
    }

    function ensureEmbedParams(baseUrl) {
      const u = new URL(baseUrl);
      u.searchParams.set("embed", "true");
      u.searchParams.set("style", "singlePage");
      u.searchParams.set("exclude-headers", "true");
      return u;
    }

    function addRowSelection(u, rowId, tableName) {
      if (!rowId) return u;

      u.searchParams.set("table", tableName);
      u.searchParams.set("rowId", rowId);
      u.searchParams.set("recordId", rowId);

      u.hash = "?table=" + encodeURIComponent(tableName)
            + "&rowId=" + encodeURIComponent(rowId)
            + "&recordId=" + encodeURIComponent(rowId);

      return u;
    }

    function buildInitialTarget() {
      const sp = new URLSearchParams(window.location.search);
      const src = sp.get("src") ? decodeMany(sp.get("src"), 4) : "";
      const hashTarget = readHashTargetUrl();

      const rowId = readRowId();
      const tableName = readTableName();

      const base = (hashTarget || src || HOME_PAGE).split("#")[0];

      let u = ensureEmbedParams(base);
      u = addRowSelection(u, rowId, tableName);

      return u.toString();
    }

    (function initOnce() {
      const frame = document.getElementById("gristFrame");
      frame.src = buildInitialTarget();
    })();
  </script>
</body>
</html>
