<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prévention PACA – Porteur</title>
    <link rel="preconnect" href="https://docs.getgrist.com">
    <link rel="dns-prefetch" href="https://docs.getgrist.com">
    <style>
        :root{--bg:#020617;--grist-offset:56px}
        html,body{margin:0;padding:0;height:100%;background:var(--bg);overflow:hidden}
        #wrapper{position:fixed;inset:0;overflow:hidden;background:var(--bg)}
        #gristFrame{position:absolute;top:calc(-1*var(--grist-offset));left:0;width:100%;height:calc(100% + var(--grist-offset));border:0;background:var(--bg)}
        #ppBadge{position:fixed;right:10px;bottom:10px;z-index:9999;font:10px system-ui;color:rgba(226,232,240,.4);pointer-events:none}
    </style>
</head>
<body>
<div id="wrapper"><iframe id="gristFrame" src="about:blank" allowfullscreen></iframe></div>
<div id="ppBadge">V20_Performance_Optimized</div>

<script>
  const HOME_PAGE = 'https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/59';
  const GRIST_ANCHOR_PREFIX = 'a1.s452.r';

  function ensureEmbedParams(urlStr) {
    try {
      const u = new URL(urlStr);
      u.searchParams.set("embed", "true");
      u.searchParams.set("style", "singlePage");
      u.searchParams.set("exclude-headers", "true");
      return u.toString();
    } catch(e) { return urlStr; }
  }

  function getTargetUrl() {
    const sp = new URLSearchParams(window.location.search);
    // 1. Priorité au paramètre ?src= (QR Codes)
    if (sp.has("src")) return ensureEmbedParams(decodeURIComponent(sp.get("src")));
    
    // 2. Priorité au Hash (Navigation entre pages via le Portail)
    if (window.location.hash.length > 1) {
      const hashContent = decodeURIComponent(window.location.hash.substring(1));
      if (/^https?:\/\//i.test(hashContent)) return ensureEmbedParams(hashContent);
    }
    return ensureEmbedParams(HOME_PAGE);
  }

  const fr = document.getElementById("gristFrame");
  let lastUrl = "";

  function updateIframe() {
    const nextUrl = getTargetUrl();
    if (nextUrl !== lastUrl) {
      lastUrl = nextUrl;
      fr.src = nextUrl;
    }
  }

  // Initialisation
  updateIframe();

  // Écoute uniquement le changement de hash (plus performant que le click)
  window.addEventListener("hashchange", updateIframe);

  // Écoute les messages envoyés par le widget HTML pour une transition fluide
  window.addEventListener("message", (e) => {
    if (e.data.type === "GOTO_PAGE" && e.data.url) {
      window.location.hash = encodeURIComponent(e.data.url);
    }
  });
</script>
</body>
</html>
