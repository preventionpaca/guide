<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA – Vue intégrée</title>

  <link rel="preconnect" href="https://docs.getgrist.com">
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root{
      --bg:#020617;
      --grist-offset:56px;
    }
    html,body{margin:0;padding:0;height:100%;background:var(--bg);}
    #wrapper{position:fixed;inset:0;overflow:hidden;background:var(--bg);}
    #gristFrame{
      position:absolute;
      top:calc(-1 * var(--grist-offset));
      left:0;
      width:100%;
      height:calc(100% + var(--grist-offset));
      border:0;
      background:var(--bg);
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <iframe id="gristFrame" src="about:blank" allowfullscreen></iframe>
  </div>

  <script>
    // Fixed targets for this project
    const DOC_BASE = "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/119";
    const TABLE_NAME = "Liste_des_equipements";

    function buildGristUrl(rowId){
      // Keep Grist embed options in query, and table/row selection in hash.
      const base = new URL(DOC_BASE);
      base.searchParams.set("embed","true");
      base.searchParams.set("style","singlePage");
      base.searchParams.set("exclude-headers","true");
      const rid = String(rowId||"").trim();
      const hash = rid ? `#?table=${encodeURIComponent(TABLE_NAME)}&rowId=${encodeURIComponent(rid)}` : "";
      return base.toString() + hash;
    }

    function update(){
      const sp = new URLSearchParams(window.location.search);
      const rowId = sp.get("rowId") || sp.get("recordId") || "";

      // Backward compat: allow ?src=... (encoded) + optional rowId, for older QR links
      const src = sp.get("src");
      let finalUrl = "";
      if(src){
        try{
          const decoded = decodeURIComponent(src);
          // If caller provides its own grist base, we just add/replace embed params,
          // then append hash selection.
          const u = new URL(decoded);
          u.searchParams.set("embed","true");
          u.searchParams.set("style","singlePage");
          u.searchParams.set("exclude-headers","true");
          const hash = rowId ? `#?table=${encodeURIComponent(TABLE_NAME)}&rowId=${encodeURIComponent(String(rowId))}` : "";
          finalUrl = u.toString() + hash;
        }catch(e){
          finalUrl = buildGristUrl(rowId);
        }
      }else{
        finalUrl = buildGristUrl(rowId);
      }

      const frame = document.getElementById("gristFrame");
      if(frame && frame.src !== finalUrl){
        frame.src = finalUrl;
      }
    }

    update();
    window.addEventListener("popstate", update);
  </script>
</body>
</html>
