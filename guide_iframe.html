<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Pr√©vention PACA ‚Äì Outil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
      min-height:100vh;
    }

    .wrapper{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
    }

    /* Barre haute breadcrumb + bouton retour */
    .topbar{
      height:40px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      font-size:0.8rem;
      background:rgba(15,23,42,0.95);
      border-bottom:1px solid rgba(148,163,184,0.35);
    }

    .breadcrumb{
      display:flex;
      align-items:center;
      gap:4px;
      color:#cbd5f5;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .breadcrumb span:nth-child(1){
      font-weight:600;
      color:#ffffff;
    }

    .topbar button{
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      padding:3px 9px;
      background:transparent;
      color:#e5e7eb;
      font-size:0.75rem;
      cursor:pointer;
    }

    .topbar button:hover{
      background:rgba(15,23,42,0.8);
    }

    .main{
      flex:1;
      position:relative;
      background:#020617;
    }

    .frame-shell{
      position:absolute;
      inset:0;
      overflow:hidden;
      background:#020617;
    }

    #gristFrame{
      width:100%;
      height:100%;
      border:0;
      position:relative;
      top:0;
      display:none;
    }

    /* recadrage pour cacher le titre / filtres Grist */
    .frame-shell.is-grist #gristFrame{
      top:-48px;
      height:calc(100% + 48px);
    }

    /* Overlays spinner + erreur */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      text-align:center;
    }

    #loader{
      flex-direction:column;
      gap:10px;
      font-size:0.9rem;
      color:#e5e7eb;
      background:radial-gradient(circle at center,rgba(15,23,42,0.9),rgba(15,23,42,0.96));
      backdrop-filter:blur(4px);
      z-index:10;
    }

    .spinner{
      width:32px;
      height:32px;
      border-radius:999px;
      border:3px solid rgba(148,163,184,0.4);
      border-top-color:#38bdf8;
      animation:spin 0.8s linear infinite;
      margin:0 auto;
    }

    #errorBox{
      display:none;
      flex-direction:column;
      gap:8px;
      font-size:0.85rem;
      color:#e5e7eb;
      background:radial-gradient(circle at center,rgba(15,23,42,0.9),rgba(15,23,42,0.96));
      backdrop-filter:blur(3px);
      z-index:9;
    }

    #errorBox strong{
      font-weight:600;
      color:#fee2e2;
    }

    a.error-link{
      color:#38bdf8;
      text-decoration:underline;
      font-size:0.8rem;
      word-break:break-all;
    }

    @keyframes spin{
      to{transform:rotate(360deg)}
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="topbar">
      <div class="breadcrumb">
        <span>Pr√©vention PACA</span>
        <span>&gt;</span>
        <span>Portail</span>
        <span>&gt;</span>
        <span>Outil</span>
      </div>
      <button type="button" onclick="history.back()">‚Üê Retour</button>
    </div>

    <div class="main">
      <div id="shell" class="frame-shell">
        <iframe id="gristFrame" loading="lazy" referrerpolicy="no-referrer"></iframe>

        <!-- SPINNER -->
        <div id="loader" class="overlay">
          <div class="spinner"></div>
          <div>Chargement de la vue‚Ä¶<br/>Merci de patienter quelques instants.</div>
        </div>

        <!-- MESSAGE D'ERREUR -->
        <div id="errorBox" class="overlay">
          <strong>Impossible de charger la vue demand√©e.</strong>
          <div>
            Il est possible que le site cible bloque l‚Äôaffichage dans une iframe
            (par exemple certains services externes), ou que l‚ÄôURL soit incorrecte.
          </div>
          <div id="rawUrl" style="margin-top:6px;font-size:0.8rem;opacity:0.9;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const shell   = document.getElementById('shell');
      const frame   = document.getElementById('gristFrame');
      const loader  = document.getElementById('loader');
      const errorBox= document.getElementById('errorBox');
      const rawUrlEl= document.getElementById('rawUrl');

      // R√©cup√©ration de l‚ÄôURL pass√©e apr√®s #
      let raw = window.location.hash ? window.location.hash.slice(1) : "";
      raw = raw.trim();

      if (!raw) {
        loader.style.display = 'none';
        errorBox.style.display = 'flex';
        rawUrlEl.textContent = "Aucune URL fournie.";
        return;
      }

      // üîß D√âNESTAGE :
      // si on re√ßoit d√©j√† un guide_iframe.html#... dans l‚ÄôURL,
      // on r√©cup√®re la vraie cible derri√®re.
      const MARKER = "guide_iframe.html#";
      const idx = raw.lastIndexOf(MARKER);
      if (idx !== -1) {
        raw = raw.slice(idx + MARKER.length);
      }

      const targetUrl = raw;
      rawUrlEl.innerHTML =
        'URL cible : <br><a class="error-link" href="'+targetUrl+'" target="_blank" rel="noopener noreferrer">'
        + targetUrl + '</a>';

      // On consid√®re que c‚Äôest une vue Grist ‚Üí recadrage pour cacher le bandeau
      if (targetUrl.indexOf("docs.getgrist.com") !== -1) {
        shell.classList.add("is-grist");
      }

      frame.src = targetUrl;
      frame.style.display = 'block';

      let loaded = false;

      frame.addEventListener('load', () => {
        loaded = true;
        loader.style.display = 'none';
        errorBox.style.display = 'none';
      });

      frame.addEventListener('error', () => {
        loader.style.display = 'none';
        errorBox.style.display = 'flex';
      });

      // S√©curit√© : si au bout de 12 s rien n‚Äôa charg√©, on affiche l‚Äôerreur
      setTimeout(() => {
        if (!loaded) {
          loader.style.display = 'none';
          errorBox.style.display = 'flex';
        }
      }, 12000);
    })();
  </script>
</body>
</html>
