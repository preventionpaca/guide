<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA – Vue intégrée</title>

  <link rel="preconnect" href="https://docs.getgrist.com">
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root{--bg:#020617;--grist-offset:56px}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);overflow:hidden}
    #wrapper{position:fixed;inset:0;overflow:hidden;background:var(--bg)}
    #gristFrame{position:absolute;top:calc(-1* var(--grist-offset));left:0;width:100%;height:calc(100% + var(--grist-offset));border:0;background:var(--bg)}

    /* Loader / fallback */
    #ppLoader{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(2,6,23,.92);z-index:999999;
      font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#e2e8f0;
    }
    #ppLoader.hidden{display:none}
    .ppCard{
      width:min(520px,92vw);border-radius:16px;
      background:rgba(15,23,42,.88);border:1px solid rgba(148,163,184,.18);
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      padding:16px 16px 14px;
    }
    .ppRow{display:flex;gap:12px;align-items:flex-start}
    .ppSpin{
      width:22px;height:22px;border-radius:999px;border:3px solid rgba(148,163,184,.25);
      border-top-color:rgba(249,115,22,.95);
      animation:spin 1s linear infinite;flex:0 0 auto;margin-top:2px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .ppTitle{font-weight:650;font-size:15px;margin:0}
    .ppMsg{opacity:.9;margin:8px 0 0;line-height:1.35}
    .ppSmall{opacity:.65;font-size:12px;margin:10px 0 0}
    .ppActions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
    .ppBtn{
      display:inline-flex;align-items:center;justify-content:center;
      appearance:none;border:1px solid rgba(148,163,184,.25);
      background:rgba(30,41,59,.55);color:#e2e8f0;
      padding:8px 10px;border-radius:10px;
      font:13px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      cursor:pointer;text-decoration:none;
    }
    .ppBtn:hover{background:rgba(30,41,59,.75)}
    .ppBtn.primary{background:rgba(249,115,22,.85);border-color:rgba(249,115,22,.9);color:#0b1220}
    .ppBtn.primary:hover{background:rgba(249,115,22,.95)}
  </style>
</head>
<body>
  <div id="wrapper">
    <iframe id="gristFrame" src="about:blank" allowfullscreen></iframe>
  </div>

  <!-- Loader + fallback (mobile/in-app) -->
  <div id="ppLoader" aria-live="polite">
    <div class="ppCard">
      <div class="ppRow">
        <div class="ppSpin" aria-hidden="true"></div>
        <div>
          <p class="ppTitle">Chargement…</p>
          <p class="ppMsg">Si l’écran reste noir sur mobile, c’est souvent le navigateur “intégré” du lecteur de QR code qui bloque l’iframe.</p>
          <p class="ppSmall">Essayez “Ouvrir dans le navigateur” (Chrome/Safari). Si vous êtes dans un lecteur de QR code avec navigateur “intégré”, c’est souvent lui le coupable.</p>
        </div>
      </div>
      <div class="ppActions">
        <a id="ppReloadBtn" class="ppBtn" href="#">Recharger</a>
        <a id="ppOpenBrowserBtn" class="ppBtn primary" href="#" target="_blank" rel="noopener noreferrer">Ouvrir dans le navigateur</a>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const HOME_PAGE = "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/59";
  const DOC_BASE  = "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/";
  const DEFAULT_TABLE = "Liste_des_equipements";

  // ========= UTILS =========
  function decodeMany(s, max=4){
    let out = (s || "");
    for(let i=0;i<max;i++){
      try{
        const d = decodeURIComponent(out);
        if(d === out) break;
        out = d;
      }catch(e){ break; }
    }
    return out;
  }
  function qs(){ return new URLSearchParams(window.location.search); }

  function ensureEmbedParams(baseUrl){
    const u = new URL(baseUrl);
    u.searchParams.set("embed","true");
    u.searchParams.set("style","singlePage");
    u.searchParams.set("exclude-headers","true");
    return u;
  }

  // ========= TARGET BUILD =========
  function getBaseTarget(){
    const sp = qs();

    // 1) src= (recommandé pour QR)
    const src = sp.get("src");
    if(src) return decodeMany(src, 4);

    // 2) compat: wrapper#https://...
    const h = window.location.hash ? window.location.hash.slice(1) : "";
    const dh = decodeMany(h, 2);
    if(dh && /^https?:\/\//i.test(dh)) return dh;

    // 3) page=119 etc.
    const page = sp.get("page");
    if(page && /^\d+$/.test(page)) return (DOC_BASE + page);

    return HOME_PAGE;
  }

  function addRowSelection(u){
    const sp = qs();
    const rowId = sp.get("rowId") || sp.get("recordId") || "";
    const table = sp.get("table") || DEFAULT_TABLE;
    if(!rowId) return u;
    // IMPORTANT: row selection is in hash (#?table=...&rowId=...)
    u.hash = "?table=" + encodeURIComponent(table) + "&rowId=" + encodeURIComponent(String(rowId));
    return u;
  }

  function buildUrls(){
    // base target (can itself include a #... anchor — we drop it, we rebuild ours)
    const base = (getBaseTarget() || HOME_PAGE).split("#")[0];

    // iframe URL: embed params + row selection hash
    let iframeU = ensureEmbedParams(base);
    iframeU = addRowSelection(iframeU);

    // direct URL: NO iframe. We still add the row selection hash to help Grist position.
    // (embed params left ON; that keeps the UI light even in direct mode)
    const directU = iframeU.toString();

    return { iframeSrc: iframeU.toString(), directUrl: directU, baseUsed: base };
  }

  function showLoader(show){
    const el = document.getElementById("ppLoader");
    if(!el) return;
    if(show) el.classList.remove("hidden");
    else el.classList.add("hidden");
  }

  // ========= INIT =========
  (function init(){
    const { iframeSrc, directUrl } = buildUrls();

    // Make buttons work even if JS later gets blocked (we set real hrefs)
    const reloadA = document.getElementById("ppReloadBtn");
    const openA = document.getElementById("ppOpenBrowserBtn");
    if(reloadA){
      reloadA.href = window.location.href;
      reloadA.addEventListener("click", (e)=>{ e.preventDefault(); window.location.reload(); });
    }
    if(openA){
      openA.href = directUrl;
      openA.addEventListener("click", ()=>{ /* keep default anchor behavior */ });
    }

    // Start loading
    showLoader(true);
    const fr = document.getElementById("gristFrame");
    fr.src = iframeSrc;

    // Hide loader when iframe loads
    fr.addEventListener("load", ()=> {
      // Certains navigateurs "in-app" déclenchent load même si la page est blanche.
      // On attend un peu : si rien n’affiche, l’utilisateur a toujours "Accès direct".
      setTimeout(()=>showLoader(false), 250);
    });

    // Safety timeout: if still black after 6s, keep loader visible (user can use direct)
    setTimeout(()=>showLoader(true), 6000);
  })();
</script>
</body>
</html>
