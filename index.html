<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA</title>

  <link rel="preconnect" href="https://docs.getgrist.com" crossorigin>
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root{--bg:#020617;--grist-offset:56px}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);overflow:hidden}
    #app{position:fixed;inset:0;background:var(--bg);overflow:hidden}

    .frame{position:absolute;inset:0;display:none;overflow:hidden;background:var(--bg)}
    .frame.active{display:block}

    .frame iframe{
      position:absolute;
      top:calc(-1*var(--grist-offset));
      left:0;
      width:100%;
      height:calc(100% + var(--grist-offset));
      border:0;
      background:var(--bg);
    }

    #mini{position:fixed;left:12px;bottom:12px;z-index:9999;display:none;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(15,23,42,.75);color:rgba(226,232,240,.85);font:12px system-ui;border:1px solid rgba(148,163,184,.2)}
    #mini .dot{width:10px;height:10px;border-radius:50%;border:2px solid rgba(226,232,240,.25);border-top-color:#fb923c;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    #preloadStatus{position:fixed;right:12px;bottom:12px;z-index:9998;display:none;max-width:min(420px,calc(100vw - 24px));padding:10px 12px;border-radius:14px;background:rgba(2,6,23,.78);color:rgba(226,232,240,.9);font:12px system-ui;border:1px solid rgba(148,163,184,.22);backdrop-filter:blur(3px)}
    #preloadStatus b{font-weight:800}
    #preloadStatus .small{opacity:.75}

    #diag{position:fixed;left:12px;top:12px;z-index:9997;display:none;max-width:min(680px,calc(100vw - 24px));padding:12px 14px;border-radius:14px;background:rgba(2,6,23,.86);color:rgba(226,232,240,.92);font:12px system-ui;border:1px solid rgba(148,163,184,.22)}
    #diag code{display:block;white-space:pre-wrap;word-break:break-word;opacity:.92;margin-top:6px}
  </style>

  <!-- Config centralisée -->
  <script>
  window.PP_SUPABASE_URL = window.PP_SUPABASE_URL || "https://hpiqwvwpxzppxpxhjede.supabase.co";
</script>
<script src="https://preventionpaca.github.io/guide/js/pp-config.js"></script>
</head>
<body>
  <div id="app">
    <div id="mini"><span class="dot"></span><span>Chargement…</span></div>
    <div id="preloadStatus"><b>Préchargement</b> <span id="psCount">0/0</span><div class="small" id="psLabel"></div></div>
    <div id="diag"><b>Diagnostic</b><code id="diagTxt"></code></div>

    <div class="frame" id="f-home"><iframe title="Portail" loading="eager"></iframe></div>
    <div class="frame" id="f-dashboard"><iframe title="Tableau de bord" loading="lazy"></iframe></div>

    <div class="frame" id="f-derogp"><iframe title="Dérogation personnalisée" loading="lazy"></iframe></div>
    <div class="frame" id="f-derogm"><iframe title="Dérogation mutualisée" loading="lazy"></iframe></div>

    <div class="frame" id="f-avisp"><iframe title="Avis médical personnalisé" loading="lazy"></iframe></div>
    <div class="frame" id="f-avism"><iframe title="Avis médical mutualisé" loading="lazy"></iframe></div>

    <div class="frame" id="f-ddfpt"><iframe title="Accès DDFPT" loading="lazy"></iframe></div>
    <div class="frame" id="f-admin"><iframe title="Accès Admin" loading="lazy"></iframe></div>

    <div class="frame" id="f-contact"><iframe title="Contacts" loading="lazy"></iframe></div>
    <div class="frame" id="f-analyse"><iframe title="Analyse" loading="lazy"></iframe></div>
    <div class="frame" id="f-ressources"><iframe title="Ressources" loading="lazy"></iframe></div>

    <div class="frame" id="f-presentation"><iframe title="Présentation" loading="lazy"></iframe></div>
    <div class="frame" id="f-schema"><iframe title="Schéma fonctionnel" loading="lazy"></iframe></div>

    <div class="frame" id="f-base"><iframe title="Base" loading="lazy"></iframe></div>

    <div class="frame" id="f-dyn"><iframe title="Lien direct (QR/deep-link)" loading="eager"></iframe></div>
  </div>

<script>
  // ====== Config ======
  const DOC_ID   = window.PP_GRIST_DOC_ID;
  const DOC_PATH = window.PP_GRIST_DOC_PATH;

  if(!DOC_ID || !DOC_PATH){
    document.body.innerHTML = "<div style='padding:16px;font:14px system-ui'>PP_GRIST_DOC_ID / PP_GRIST_DOC_PATH manquants dans pp-config.js</div>";
    throw new Error("Config Grist manquante");
  }

  const GRIST_ROOT = `https://docs.getgrist.com/${DOC_ID}/${DOC_PATH}`;
  const IFRAME_PARAMS = (window.PP_GRIST_IFRAME_PARAMS || "embed=true&style=singlePage&exclude-headers=true");

  const PAGES = window.PP_PAGES || {};
  function pageUrl(pageId){ return `${GRIST_ROOT}/p/${pageId}?${IFRAME_PARAMS}`; }

  const ROUTES = {
    home:        { frame: "f-home",        url: pageUrl(PAGES.home?.id || 59) },
    dashboard:   { frame: "f-dashboard",   url: pageUrl(PAGES.dashboard?.id || 143) },

    derogp:      { frame: "f-derogp",      url: pageUrl(PAGES.derogp?.id || 60) },
    derogm:      { frame: "f-derogm",      url: pageUrl(PAGES.derogm?.id || 136) },

    avisp:       { frame: "f-avisp",       url: pageUrl(PAGES.avisp?.id || 141) },
    avism:       { frame: "f-avism",       url: pageUrl(PAGES.avism?.id || 67) },

   ddfpt: { frame: "f-ddfpt", url: pageUrl(PAGES.ddfpt?.id || 74) },


    admin:       { frame: "f-admin",       url: pageUrl(PAGES.admin?.id || 75) },

    contact:     { frame: "f-contact",     url: pageUrl(PAGES.contact?.id || 91) },
    analyse:     { frame: "f-analyse",     url: pageUrl(PAGES.analyse?.id || 138) },
    ressources:  { frame: "f-ressources",  url: pageUrl(PAGES.ressources?.id || 79) },

    presentation:{ frame: "f-presentation",url: pageUrl(PAGES.presentation?.id || 78) },
    schema:      { frame: "f-schema",      url: pageUrl(PAGES.schema?.id || 102) },

    base:        { frame: "f-base",        url: pageUrl(PAGES.base?.id || 119) }
  };

  // ====== Deep-link ======
  function decodeMany(s, max=12){
    let out = s || "";
    for(let i=0;i<max;i++){
      try{ const d = decodeURIComponent(out); if(d === out) break; out = d; }
      catch(e){ break; }
    }
    return out;
  }
  function getSrcParamTarget(){
    const sp = new URLSearchParams(window.location.search);
    if(!sp.has('src')) return null; // ignore ?v=123 etc.
    const src = sp.get('src');
    return src ? decodeMany(src, 12) : null;
  }

  // ====== UI ======
  const mini = document.getElementById("mini");
  const ps = document.getElementById("preloadStatus");
  const psCount = document.getElementById("psCount");
  const psLabel = document.getElementById("psLabel");
  const diag = document.getElementById("diag");
  const diagTxt = document.getElementById("diagTxt");

  const frames = {};
  for (const k of Object.keys(ROUTES)){
    frames[k] = document.querySelector(`#${ROUTES[k].frame} iframe`);
  }
  const ifDyn = document.querySelector("#f-dyn iframe");

  const state = Object.fromEntries(Object.keys(ROUTES).map(k => [k, {loaded:false, url:""}]));
  const dynState = {loaded:false, url:""};

  function showFrame(frameId){
    document.querySelectorAll(".frame").forEach(el => el.classList.remove("active"));
    const el = document.getElementById(frameId);
    if(el) el.classList.add("active");
  }

  function loadOnce(key){
    const r = ROUTES[key];
    if(!r) return;
    const st = state[key];
    if(st.loaded) return;

    const iframe = frames[key];
    if(!iframe) return;

    st.url = r.url;
    iframe.addEventListener("load", () => { st.loaded = true; }, { once:true });
    iframe.src = r.url;
  }

  function openDynamic(url){
    showFrame("f-dyn");
    if(dynState.url === url && dynState.loaded) return;

    dynState.url = url;
    dynState.loaded = false;
    mini.style.display = "flex";

    ifDyn.addEventListener("load", () => {
      dynState.loaded = true;
      mini.style.display = "none";
    }, { once:true });

    ifDyn.src = url;
  }

  function routeKeyFromHash(){
    const raw = (window.location.hash || "#home").slice(1).trim().toLowerCase();
    if(!raw) return "home";

    const map = {
      accueil:"home", portail:"home", home:"home",
      tableau:"dashboard", dashboard:"dashboard", "tableau_de_bord":"dashboard",
      base:"base",
      admin:"admin", acces_admin:"admin",
      ddfpt:"ddfpt", acces_ddfpt:"ddfpt",
      derogp:"derogp", derogm:"derogm",
      avisp:"avisp", avism:"avism",
      contact:"contact", contacts:"contact",
      analyse:"analyse",
      ressources:"ressources",
      guide:"presentation",
      presentation:"presentation",
      schema:"schema"
    };
    return map[raw] || raw;
  }

  function showDiag(obj){
    diagTxt.textContent = JSON.stringify(obj, null, 2);
    diag.style.display = 'block';
  }

  function route(){
    const rawHash = (window.location.hash || '#home').slice(1).trim().toLowerCase();
    const srcTarget = getSrcParamTarget();
    if(srcTarget && (rawHash === '' || rawHash === 'dyn')){
      openDynamic(srcTarget);
      return;
    }

    const key = routeKeyFromHash();
    const r = ROUTES[key] ? key : "home";

    showFrame(ROUTES[r].frame);
    if(!state[r].loaded) mini.style.display = "flex";
    loadOnce(r);

    // Watchdog : si pas de load (iframe bloque / erreur), on ne laisse pas la page en boucle.
    const started = Date.now();
    const check = setInterval(() => {
      if(state[r].loaded){
        clearInterval(check);
        mini.style.display = "none";
        diag.style.display = 'none';
        return;
      }
      if(Date.now() - started > 12000){
        clearInterval(check);
        mini.style.display = "none";
        showDiag({
          msg: "L'iframe ne declenche pas l'evenement load (bloquee ou tres lente).",
          route: r,
          iframeSrc: frames[r]?.src || null,
          doc: { id: DOC_ID, path: DOC_PATH },
          params: IFRAME_PARAMS,
          hint: "Ouvre directement iframeSrc dans un nouvel onglet pour verifier si Grist repond."
        });
      }
    }, 200);
  }

  window.addEventListener("hashchange", route);

  function navigateTo(key){
    const k = String(key || 'home').trim().toLowerCase();
    const wanted = '#' + k;

    // Nettoie uniquement ?src (on laisse ?v=123 etc.)
    try {
      const u = new URL(window.location.href);
      if (u.searchParams.has('src') && k !== 'dyn') {
        u.searchParams.delete('src');
        const qs = u.searchParams.toString();
        window.history.replaceState(null, '', u.pathname + (qs ? ('?' + qs) : '') + window.location.hash);
      }
    } catch(e) {}

    if(window.location.hash === wanted){
      window.location.hash = '';
      setTimeout(()=>{ window.location.hash = wanted; }, 25);
    } else {
      window.location.hash = wanted;
    }
  }
  window.PP_NAVIGATE = navigateTo;

  window.addEventListener('message', (ev) => {
    try{
      const d = ev.data;
      if(!d) return;
      if(typeof d === 'object' && d.type === 'pp:navigate'){ navigateTo(d.key || 'home'); return; }
      if(typeof d === 'string' && d.startsWith('pp:navigate:')){ navigateTo(d.split(':',3)[2] || 'home'); }
    } catch(e) {}
  });

  // ====== Preload (respecte strictement PP_PRELOAD_ENABLED) ======
  function requestIdle(fn){
    if('requestIdleCallback' in window){ window.requestIdleCallback(fn, { timeout: 1500 }); }
    else { setTimeout(fn, 350); }
  }

  const PRELOAD_ENABLED = (window.PP_PRELOAD_ENABLED === true);
  const PRELOAD_KEYS = Array.isArray(window.PP_PRELOAD_KEYS) ? window.PP_PRELOAD_KEYS : [];

  function runPreload(){
    if(!PRELOAD_ENABLED || PRELOAD_KEYS.length === 0){
      ps.style.display = 'none';
      return;
    }

    ps.style.display = 'block';
    const keys = PRELOAD_KEYS.filter(k => ROUTES[k]);
    const total = keys.length;
    let done = 0;
    psCount.textContent = `${done}/${total}`;

    const queue = [...keys];
    const active = new Set();

    function tick(){
      while(active.size < 2 && queue.length){
        const k = queue.shift();
        if(state[k].loaded){ done++; psCount.textContent = `${done}/${total}`; continue; }
        active.add(k);
        psLabel.textContent = (PAGES[k]?.label || k);
        loadOnce(k);

        const start = Date.now();
        const wait = setInterval(()=>{
          if(state[k].loaded || Date.now()-start > 12000){
            clearInterval(wait);
            active.delete(k);
            done++;
            psCount.textContent = `${done}/${total}`;
            if(done >= total){ psLabel.textContent = 'Termine'; setTimeout(()=>ps.style.display='none', 1200); }
            tick();
          }
        }, 250);
      }
    }
    tick();
  }

  // ====== Boot ======
  if(!window.location.hash) window.location.hash = '#home';
  route();
  requestIdle(runPreload);
</script>
</body>
</html>


