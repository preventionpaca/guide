<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pr√©vention PACA</title>

  <link rel="preconnect" href="https://docs.getgrist.com" crossorigin>
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root{--bg:#020617;--grist-offset:56px}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);overflow:hidden}
    #app{position:fixed;inset:0;background:var(--bg);overflow:hidden}

    .frame{position:absolute;inset:0;display:none;overflow:hidden;background:var(--bg)}
    .frame.active{display:block}

    .frame iframe{
      position:absolute;
      top:calc(-1*var(--grist-offset));
      left:0;
      width:100%;
      height:calc(100% + var(--grist-offset));
      border:0;
      background:var(--bg);
    }

    #mini{position:fixed;left:12px;bottom:12px;z-index:9999;display:none;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(15,23,42,.75);color:rgba(226,232,240,.85);font:12px system-ui;border:1px solid rgba(148,163,184,.2)}
    #mini .dot{width:10px;height:10px;border-radius:50%;border:2px solid rgba(226,232,240,.25);border-top-color:#fb923c;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    #preloadStatus{position:fixed;right:12px;bottom:12px;z-index:9998;display:none;max-width:min(420px,calc(100vw - 24px));padding:10px 12px;border-radius:14px;background:rgba(2,6,23,.78);color:rgba(226,232,240,.9);font:12px system-ui;border:1px solid rgba(148,163,184,.22);backdrop-filter:blur(3px)}
    #preloadStatus b{font-weight:800}
    #preloadStatus .small{opacity:.75}
  </style>

  <!-- Config (docId + liens + preload list) -->
  <script src="https://preventionpaca.github.io/guide/js/pp-config.js"></script>

</head>
<body>
  <div id="app">
    <div id="mini"><span class="dot"></span><span>Chargement‚Ä¶</span></div>
    <div id="preloadStatus"><b>Pr√©chargement</b> <span id="psCount">0/0</span><div class="small" id="psLabel"></div></div>

    <div class="frame" id="f-home"><iframe title="Portail" loading="eager"></iframe></div>
    <div class="frame" id="f-dashboard"><iframe title="Tableau de bord" loading="lazy"></iframe></div>

    <div class="frame" id="f-derogp"><iframe title="D√©rogation personnalis√©e" loading="lazy"></iframe></div>
    <div class="frame" id="f-derogm"><iframe title="D√©rogation mutualis√©e" loading="lazy"></iframe></div>

    <div class="frame" id="f-avisp"><iframe title="Avis m√©dical personnalis√©" loading="lazy"></iframe></div>
    <div class="frame" id="f-avism"><iframe title="Avis m√©dical mutualis√©" loading="lazy"></iframe></div>

    <div class="frame" id="f-ddfpt"><iframe title="Acc√®s DDFPT" loading="lazy"></iframe></div>
    <div class="frame" id="f-admin"><iframe title="Acc√®s Admin" loading="lazy"></iframe></div>

    <div class="frame" id="f-contact"><iframe title="Contacts" loading="lazy"></iframe></div>
    <div class="frame" id="f-analyse"><iframe title="Analyse par dipl√¥me" loading="lazy"></iframe></div>
    <div class="frame" id="f-ressources"><iframe title="Ressources" loading="lazy"></iframe></div>
    <div class="frame" id="f-guide"><iframe title="Guide de pr√©vention" loading="lazy"></iframe></div>
    <div class="frame" id="f-base"><iframe title="Base" loading="lazy"></iframe></div>

    <div class="frame" id="f-dyn"><iframe title="Lien direct (QR/deep-link)" loading="eager"></iframe></div>
  </div>

<script>
  // ==========================================================
  // CONFIG centralis√©e (vient de pp-config.js)
  // ==========================================================
  const DOC_ID   = window.PP_GRIST_DOC_ID;
  const DOC_PATH = window.PP_GRIST_DOC_PATH;

  if(!DOC_ID || !DOC_PATH){
    document.body.innerHTML = "<div style='padding:16px;font:14px system-ui'>PP_GRIST_DOC_ID / PP_GRIST_DOC_PATH manquants dans pp-config.js</div>";
    throw new Error("Config Grist manquante");
  }

  const GRIST_ROOT = `https://docs.getgrist.com/${DOC_ID}/${DOC_PATH}`;
  const IFRAME_PARAMS = (window.PP_GRIST_IFRAME_PARAMS || "embed=true&style=singlePage&exclude-headers=true");

  const PAGES = window.PP_PAGES || {
    home:{id:59,label:"Portail (Accueil)"},
    dashboard:{id:143,label:"Tableau de bord"},
    derogp:{id:60,label:"D√©rogation personnalis√©e"},
    derogm:{id:136,label:"D√©rogation mutualis√©e"},
    avisp:{id:141,label:"Avis m√©dical personnalis√©"},
    avism:{id:67,label:"Avis m√©dical mutualis√©"},
    ddfpt:{id:74,label:"Acc√®s DDFPT"},
    admin:{id:75,label:"Acc√®s Admin"},
    contact:{id:91,label:"Contacts"},
    analyse:{id:138,label:"Analyse par dipl√¥me"},
    ressources:{id:79,label:"Ressources"},
    guide:{id:78,label:"Guide de pr√©vention"},
    base:{id:119,label:"Base"}
  };

  function pageUrl(pageId){
    return `${GRIST_ROOT}/p/${pageId}?${IFRAME_PARAMS}`;
  }

  // ==========================================================
  // ROUTES : #home, #base, #admin, etc.
  // ==========================================================
  const ROUTES = {
    home:      { frame: "f-home",      url: pageUrl(PAGES.home.id) },
    dashboard: { frame: "f-dashboard", url: pageUrl(PAGES.dashboard.id) },

    derogp:    { frame: "f-derogp",    url: pageUrl(PAGES.derogp.id) },
    derogm:    { frame: "f-derogm",    url: pageUrl(PAGES.derogm.id) },

    avisp:     { frame: "f-avisp",     url: pageUrl(PAGES.avisp.id) },
    avism:     { frame: "f-avism",     url: pageUrl(PAGES.avism.id) },

    ddfpt:     { frame: "f-ddfpt",     url: pageUrl(PAGES.ddfpt.id) },
    admin:     { frame: "f-admin",     url: pageUrl(PAGES.admin.id) },

    contact:   { frame: "f-contact",   url: pageUrl(PAGES.contact.id) },
    analyse:   { frame: "f-analyse",   url: pageUrl(PAGES.analyse.id) },
    ressources:{ frame: "f-ressources",url: pageUrl(PAGES.ressources.id) },
    guide:     { frame: "f-guide",     url: pageUrl(PAGES.guide.id) },

    base:      { frame: "f-base",      url: pageUrl(PAGES.base.id) }
  };

  // ==========================================================
  // DEEP LINK QR : ?src=...  + compat ancien #https://...
  // ==========================================================
  function decodeMany(s, max=12){
    let out = s || "";
    for(let i=0;i<max;i++){
      try{ const d = decodeURIComponent(out); if(d === out) break; out = d; }
      catch(e){ break; }
    }
    return out;
  }

  function getSrcParamTarget(){
    const sp = new URLSearchParams(window.location.search);
    const src = sp.get("src");
    return src ? decodeMany(src, 12) : null;
  }

  function getHashTargetUrl(){
    const h = (window.location.hash || "").slice(1);
    const hd = decodeMany(h, 8);
    return /^https?:\/\//i.test(hd) ? hd : null;
  }

  // ==========================================================
  // FRAME CACHE ENGINE
  // ==========================================================
  const mini = document.getElementById("mini");
  const ps = document.getElementById("preloadStatus");
  const psCount = document.getElementById("psCount");
  const psLabel = document.getElementById("psLabel");

  const frames = {};
  for (const k of Object.keys(ROUTES)){
    frames[k] = document.querySelector(`#${ROUTES[k].frame} iframe`);
  }
  const ifDyn = document.querySelector("#f-dyn iframe");

  const state = Object.fromEntries(Object.keys(ROUTES).map(k => [k, {loaded:false, url:""}]));
  const dynState = {loaded:false, url:""};

  function showFrame(frameId){
    document.querySelectorAll(".frame").forEach(el => el.classList.remove("active"));
    const el = document.getElementById(frameId);
    if(el) el.classList.add("active");
  }

  function loadOnce(key){
    const r = ROUTES[key];
    if(!r) return;
    const st = state[key];
    if(st.loaded) return;

    const iframe = frames[key];
    if(!iframe) return;

    st.url = r.url;
    iframe.addEventListener("load", () => { st.loaded = true; }, { once:true });
    iframe.src = r.url;
  }

  function openDynamic(url){
    showFrame("f-dyn");
    if(dynState.url === url && dynState.loaded) return;

    dynState.url = url;
    dynState.loaded = false;
    mini.style.display = "flex";

    ifDyn.addEventListener("load", () => {
      dynState.loaded = true;
      mini.style.display = "none";
    }, { once:true });

    ifDyn.src = url;
  }

  function routeKeyFromHash(){
    const raw = (window.location.hash || "#home").slice(1).trim().toLowerCase();
    if(!raw) return "home";

    const map = {
      accueil:"home", portail:"home", home:"home",
      tableau:"dashboard", dashboard:"dashboard", "tableau_de_bord":"dashboard",
      base:"base",
      admin:"admin", acces_admin:"admin",
      ddfpt:"ddfpt", acces_ddfpt:"ddfpt",
      derogp:"derogp", "derogation-personnalisee":"derogp",
      derogm:"derogm", "derogation-mutualisee":"derogm",
      avisp:"avisp", "avis-personnalise":"avisp",
      avism:"avism", "avis-mutualise":"avism",
      contact:"contact", contacts:"contact",
      analyse:"analyse", "analyse-diplome":"analyse",
      ressources:"ressources",
      guide:"guide"
    };

    return map[raw] || raw;
  }

  function route(){
    const srcTarget = getSrcParamTarget();
    if(srcTarget){ openDynamic(srcTarget); return; }

    const hashUrl = getHashTargetUrl();
    if(hashUrl){ openDynamic(hashUrl); return; }

    const key = routeKeyFromHash();
    const r = ROUTES[key] ? key : "home";

    showFrame(ROUTES[r].frame);

    // loader visible seulement pour la page demand√©e (pas pour le preload)
    if(!state[r].loaded) mini.style.display = "flex";
    loadOnce(r);

    // on masque quand la page a fini
    const check = setInterval(() => {
      if(state[r].loaded){
        clearInterval(check);
        mini.style.display = "none";
      }
    }, 120);
  }

  window.addEventListener("hashchange", route);

  // ==========================================================
  // NAVIGATION ROBUSTE DEPUIS DES IFRAMES (Grist sandbox)
  // Les pages embarqu√©es peuvent envoyer : parent.postMessage({type:'pp:navigate', key:'home'}, '*')
  // ==========================================================
  function navigateTo(key){
    const k = String(key || 'home').trim().toLowerCase();
    const wanted = '#' + k;
    // Si on redemande la meme route, on force un hashchange
    if(window.location.hash === wanted){
      window.location.hash = '';
      setTimeout(()=>{ window.location.hash = wanted; }, 25);
    } else {
      window.location.hash = wanted;
    }
  }

  window.PP_NAVIGATE = navigateTo;

  window.addEventListener('message', (ev) => {
    try{
      const d = ev.data;
      if(!d) return;
      // format objet
      if(typeof d === 'object' && d.type === 'pp:navigate'){
        navigateTo(d.key || 'home');
        return;
      }
      // format string (plus simple a taper)
      if(typeof d === 'string' && d.startsWith('pp:navigate:')){
        navigateTo(d.split(':',3)[2] || 'home');
      }
    } catch(e){ /* silencieux */ }
  });


  // ==========================================================
  // PRELOAD ‚Äî 2 en parall√®le max (copier-coller demand√©)
  // ==========================================================
  function requestIdle(fn){
    if("requestIdleCallback" in window){
      window.requestIdleCallback(fn, { timeout: 1500 });
    } else {
      setTimeout(fn, 350);
    }
  }

  function loadOnceAsync(key, timeoutMs=20000){
    return new Promise((resolve) => {
      if(!ROUTES[key]) return resolve({key, ok:false, reason:"no-route"});
      if(state[key].loaded) return resolve({key, ok:true, cached:true});

      const iframe = frames[key];
      if(!iframe) return resolve({key, ok:false, reason:"no-iframe"});

      let done = false;
      const onLoad = () => {
        if(done) return;
        done = true;
        state[key].loaded = true;
        resolve({key, ok:true});
      };

      iframe.addEventListener("load", onLoad, { once:true });

      // lancer le chargement
      loadOnce(key);

      // timeout s√©curit√© (on ne bloque pas tout)
      setTimeout(() => {
        if(done) return;
        done = true;
        resolve({key, ok:false, reason:"timeout"});
      }, timeoutMs);
    });
  }

  function startPreloadParallel2(){
    const list = (window.PP_PRELOAD_KEYS || [
      "dashboard","derogp","derogm","avism","avisp","ddfpt","admin","contact","analyse","ressources","guide","base"
    ]).filter(k => ROUTES[k] && k !== "home");

    if(!list.length) return;

    ps.style.display = "block";
    psCount.textContent = `0/${list.length}`;

    let doneCount = 0;
    let idx = 0;
    let active = 0;

    function pump(){
      while(active < 2 && idx < list.length){
        const key = list[idx++];
        active++;

        const label = (PAGES[key] && PAGES[key].label) ? PAGES[key].label : key;
        psLabel.textContent = label;

        requestIdle(() => {
          loadOnceAsync(key, 25000).then(() => {
            active--;
            doneCount++;
            psCount.textContent = `${doneCount}/${list.length}`;

            if(doneCount >= list.length){
              psLabel.textContent = "Termin√©.";
              setTimeout(()=>{ ps.style.display = "none"; }, 2500);
            } else {
              pump();
            }
          });
        });
      }
    }

    pump();
  }
  // Init : route imm√©diate, puis pr√©chargement doux.
  route();

  // Pr√©chargement activable/d√©sactivable via pp-config (PP_PRELOAD_ENABLED).
  // IMPORTANT : mettre EXACTEMENT false (pas "fails" üòÑ)
  if (window.PP_PRELOAD_ENABLED === false) {
    // on s'assure que l'UI ne s'affiche jamais
    try { ps.style.display = 'none'; } catch(e) {}
  } else {
    setTimeout(startPreloadParallel2, 900);
  }
</script>
</body>
</html>

