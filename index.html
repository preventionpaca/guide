<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA</title>

  <link rel="preconnect" href="https://docs.getgrist.com" crossorigin>
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root{--bg:#020617;--grist-offset:56px}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);overflow:hidden}
    #app{position:fixed;inset:0;background:var(--bg);overflow:hidden}

    .frame{position:absolute;inset:0;display:none;overflow:hidden;background:var(--bg)}
    .frame.active{display:block}

    /* Iframe Grist + offset : masque la barre du haut (3 points / titre / filtre) */
    .frame iframe{
      position:absolute;
      top:calc(-1*var(--grist-offset));
      left:0;
      width:100%;
      height:calc(100% + var(--grist-offset));
      border:0;
      background:var(--bg);
    }

    /* Mini loader discret */
    #mini{
      position:fixed;left:12px;bottom:12px;z-index:9999;
      display:none;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(15,23,42,.75);
      color:rgba(226,232,240,.85);
      font:12px system-ui;
      border:1px solid rgba(148,163,184,.2);
    }
    #mini .dot{
      width:10px;height:10px;border-radius:50%;
      border:2px solid rgba(226,232,240,.25);
      border-top-color:#fb923c;
      animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="app">
    <div id="mini"><span class="dot"></span><span>Chargement…</span></div>

    <!-- Vues persistantes (ne pas changer les src après le 1er chargement) -->
    <div class="frame" id="f-home"><iframe title="Accueil" loading="eager"></iframe></div>
    <div class="frame" id="f-base"><iframe title="Base" loading="lazy"></iframe></div>
    <div class="frame" id="f-med-std"><iframe title="Avis médical standard" loading="lazy"></iframe></div>
    <div class="frame" id="f-med-custom"><iframe title="Avis médical personnalisé" loading="lazy"></iframe></div>

    <!-- Deep-links QR / liens directs ( ?src=... ou #https://docs... ) -->
    <div class="frame" id="f-dyn"><iframe title="QR / lien direct" loading="eager"></iframe></div>
  </div>

<script>
  // === URLs Grist (persistantes) ===
  const HOME_URL =
    "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/59?embed=true&style=singlePage&exclude-headers=true";
  const BASE_URL =
    "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/119?embed=true&style=singlePage&exclude-headers=true";
  const MEDICAL_STD_URL =
    "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/67?embed=true&style=singlePage&exclude-headers=true";
  const MEDICAL_CUSTOM_URL =
    "https://docs.getgrist.com/gvPEJV3qAHS9/Equipements-de-travail-et-produits/p/141?embed=true&style=singlePage&exclude-headers=true";

  const mini = document.getElementById('mini');

  function decodeMany(s, max=10){
    let out = s || "";
    for(let i=0;i<max;i++){
      try{ const d = decodeURIComponent(out); if(d === out) break; out = d; }
      catch(e){ break; }
    }
    return out;
  }

  // Format QR : ?src=<urlenc>
  function getSrcParamTarget(){
    const sp = new URLSearchParams(window.location.search);
    const src = sp.get('src');
    return src ? decodeMany(src, 12) : null;
  }

  // Compat ancien : #https://docs.getgrist.com/...
  function getHashTargetUrl(){
    const h = (window.location.hash || '').slice(1);
    const hd = decodeMany(h, 8);
    return /^https?:\/\//i.test(hd) ? hd : null;
  }

  function showFrame(id){
    ['f-home','f-base','f-med-std','f-med-custom','f-dyn'].forEach(x=>{
      document.getElementById(x).classList.toggle('active', x === id);
    });
  }

  function loadOnce(iframe, url, state){
    if(state.loaded) return;
    mini.style.display = 'flex';
    iframe.addEventListener('load', ()=>{
      state.loaded = true;
      mini.style.display = 'none';
    }, { once:true });
    iframe.src = url;
  }

  const ifHome = document.querySelector('#f-home iframe');
  const ifBase = document.querySelector('#f-base iframe');
  const ifMedStd = document.querySelector('#f-med-std iframe');
  const ifMedCustom = document.querySelector('#f-med-custom iframe');
  const ifDyn  = document.querySelector('#f-dyn iframe');

  const state = {
    home:{loaded:false},
    base:{loaded:false},
    medStd:{loaded:false},
    medCustom:{loaded:false},
    dyn:{loaded:false, url:''}
  };

  function routeFromHash(){
    const h = (window.location.hash || '#home').replace('#','').trim().toLowerCase();
    if(h === 'base') return 'base';
    if(h === 'medical' || h === 'avis' || h === 'avismedical') return 'medical';
    if(h === 'medical-custom' || h === 'avismedical-custom' || h === 'avisperso' || h === 'medicalperso') return 'medical-custom';
    return 'home';
  }

  function openDynamic(url){
    showFrame('f-dyn');
    if(state.dyn.url === url) return; // évite un reload si même cible

    state.dyn.url = url;
    state.dyn.loaded = false;

    mini.style.display = 'flex';
    ifDyn.addEventListener('load', ()=>{
      state.dyn.loaded = true;
      mini.style.display = 'none';
    }, { once:true });

    ifDyn.src = url;
  }

  function route(){
    // 1) Priorité au QR (vos fiches de poste)
    const srcTarget = getSrcParamTarget();
    if(srcTarget){
      // IMPORTANT : conserve l'ancre (#a1.s... etc.) si incluse dans src
      openDynamic(srcTarget);
      return;
    }

    // 2) Compat ancien hash direct
    const hashUrl = getHashTargetUrl();
    if(hashUrl){
      openDynamic(hashUrl);
      return;
    }

    // 3) Routes propres
    const r = routeFromHash();
    if(r === 'base'){
      showFrame('f-base');
      loadOnce(ifBase, BASE_URL, state.base);
      return;
    }
    if(r === 'medical-custom'){
      showFrame('f-med-custom');
      loadOnce(ifMedCustom, MEDICAL_CUSTOM_URL, state.medCustom);
      return;
    }
    if(r === 'medical'){
      showFrame('f-med-std');
      loadOnce(ifMedStd, MEDICAL_STD_URL, state.medStd);
      return;
    }

    // home
    showFrame('f-home');
    loadOnce(ifHome, HOME_URL, state.home);
  }

  // init
  route();
  window.addEventListener('hashchange', route);

  // Préchargement doux (optionnel) : évite 20 s au 1er clic
  setTimeout(()=>loadOnce(ifBase, BASE_URL, state.base), 2500);
  setTimeout(()=>loadOnce(ifMedStd, MEDICAL_STD_URL, state.medStd), 4200);
  setTimeout(()=>loadOnce(ifMedCustom, MEDICAL_CUSTOM_URL, state.medCustom), 5600);
</script>
</body>
</html>
