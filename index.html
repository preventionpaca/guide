<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prévention PACA</title>

  <link rel="preconnect" href="https://docs.getgrist.com" crossorigin>
  <link rel="dns-prefetch" href="https://docs.getgrist.com">

  <style>
    :root{--bg:#020617;--grist-offset:56px}
    html,body{margin:0;padding:0;height:100%;background:var(--bg);overflow:hidden}
    #app{position:fixed;inset:0;background:var(--bg);overflow:hidden}

    .frame{position:absolute;inset:0;display:none;overflow:hidden;background:var(--bg)}
    .frame.active{display:block}

    .frame iframe{
      position:absolute;
      top:calc(-1*var(--grist-offset));
      left:0;
      width:100%;
      height:calc(100% + var(--grist-offset));
      border:0;
      background:var(--bg);
    }

    #mini{
      position:fixed;left:12px;bottom:12px;z-index:9999;
      display:none;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(15,23,42,.75);
      color:rgba(226,232,240,.85);
      font:12px system-ui;
      border:1px solid rgba(148,163,184,.2);
    }
    #mini .dot{
      width:10px;height:10px;border-radius:50%;
      border:2px solid rgba(226,232,240,.25);
      border-top-color:#fb923c;
      animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="app">
    <div id="mini"><span class="dot"></span><span>Chargement…</span></div>

    <div class="frame" id="f-home"><iframe title="Accueil" loading="eager"></iframe></div>
    <div class="frame" id="f-base"><iframe title="Base" loading="lazy"></iframe></div>
    <div class="frame" id="f-med"><iframe title="Avis médical" loading="lazy"></iframe></div>
    <div class="frame" id="f-medc"><iframe title="Avis médical personnalisé" loading="lazy"></iframe></div>
    <div class="frame" id="f-dyn"><iframe title="Lien direct (QR/deep-link)" loading="eager"></iframe></div>
  </div>

<script>
  // === Votre nouveau document Grist ===
  const DOC_ID   = "bFa3ksN92YFd";
  const DOC_PATH = "Base-Equipements-et-Produits"; // slug dans l'URL
  const GRIST_ROOT = `https://docs.getgrist.com/${DOC_ID}/${DOC_PATH}`;

  // Pages (à adapter si vous changez vos p/xxx)
  const HOME_URL  = `${GRIST_ROOT}/p/59?embed=true&style=singlePage&exclude-headers=true`;
  const BASE_URL  = `${GRIST_ROOT}/p/119?embed=true&style=singlePage&exclude-headers=true`;
  const MED_URL   = `${GRIST_ROOT}/p/67?embed=true&style=singlePage&exclude-headers=true`;
  const MEDC_URL  = `${GRIST_ROOT}/p/141?embed=true&style=singlePage&exclude-headers=true`;

  const mini = document.getElementById("mini");

  function decodeMany(s, max=10){
    let out = s || "";
    for(let i=0;i<max;i++){
      try{ const d = decodeURIComponent(out); if(d === out) break; out = d; }
      catch(e){ break; }
    }
    return out;
  }

  // Deep-link QR : ?src=<url encodée>
  function getSrcParamTarget(){
    const sp = new URLSearchParams(window.location.search);
    const src = sp.get("src");
    return src ? decodeMany(src, 12) : null;
  }

  // Compat ancien : #https://docs.getgrist.com/...
  function getHashTargetUrl(){
    const h = (window.location.hash || "").slice(1);
    const hd = decodeMany(h, 8);
    return /^https?:\/\//i.test(hd) ? hd : null;
  }

  function showFrame(id){
    ["f-home","f-base","f-med","f-medc","f-dyn"].forEach(x=>{
      document.getElementById(x).classList.toggle("active", x === id);
    });
  }

  function loadOnce(iframe, url, state){
    if(state.loaded) return;
    state.url = url;
    mini.style.display = "flex";
    iframe.addEventListener("load", ()=>{
      state.loaded = true;
      mini.style.display = "none";
    }, { once:true });
    iframe.src = url;
  }

  const ifHome = document.querySelector("#f-home iframe");
  const ifBase = document.querySelector("#f-base iframe");
  const ifMed  = document.querySelector("#f-med iframe");
  const ifMedc = document.querySelector("#f-medc iframe");
  const ifDyn  = document.querySelector("#f-dyn iframe");

  const state = {
    home:{loaded:false, url:""},
    base:{loaded:false, url:""},
    med:{loaded:false, url:""},
    medc:{loaded:false, url:""},
    dyn:{loaded:false, url:""}
  };

  function routeFromHash(){
    const h = (window.location.hash || "#home").replace("#","").trim().toLowerCase();
    if(h === "base") return "base";
    if(h === "medical" || h === "avis" || h === "avismedical") return "medical";
    if(h === "medical-custom" || h === "medicalcustom" || h === "avismedicalcustom") return "medical-custom";
    return "home";
  }

  function openDynamic(url){
    showFrame("f-dyn");
    if(state.dyn.url === url) return; // pas de reload si même cible
    state.dyn.url = url;
    state.dyn.loaded = false;

    mini.style.display = "flex";
    ifDyn.addEventListener("load", ()=>{
      state.dyn.loaded = true;
      mini.style.display = "none";
    }, { once:true });
    ifDyn.src = url;
  }

  function route(){
    // Priorité : ?src= (QR/deep-link)
    const srcTarget = getSrcParamTarget();
    if(srcTarget){
      openDynamic(srcTarget);
      return;
    }

    // Compat ancien : #https://...
    const hashUrl = getHashTargetUrl();
    if(hashUrl){
      openDynamic(hashUrl);
      return;
    }

    // Navigation interne : #home/#base/#medical/#medical-custom
    const r = routeFromHash();
    if(r === "base"){
      showFrame("f-base");
      loadOnce(ifBase, BASE_URL, state.base);
      return;
    }
    if(r === "medical"){
      showFrame("f-med");
      loadOnce(ifMed, MED_URL, state.med);
      return;
    }
    if(r === "medical-custom"){
      showFrame("f-medc");
      loadOnce(ifMedc, MEDC_URL, state.medc);
      return;
    }
    showFrame("f-home");
    loadOnce(ifHome, HOME_URL, state.home);
  }

  route();
  window.addEventListener("hashchange", route);

  // Préchargement doux (facultatif mais pratique)
  setTimeout(()=>loadOnce(ifBase, BASE_URL, state.base), 2500);
  setTimeout(()=>loadOnce(ifMed,  MED_URL,  state.med),  4500);
  setTimeout(()=>loadOnce(ifMedc, MEDC_URL, state.medc), 6500);
</script>
</body>
</html>
